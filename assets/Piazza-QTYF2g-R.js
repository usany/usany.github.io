import{r as N,j as a,N as A,O as _,S as Y,M as G,v as pe,bg as he,U as V,a6 as ee,bh as J,aZ as xe,aj as we,a1 as E,W as x,a2 as B,a3 as Ne,a4 as F,a5 as H,V as C,X as U,af as R,aK as Q,bi as ue}from"./index-Chfd6bxp.js";import{f as ye,g as Ce,i as Ue}from"./drawer-CrJJNG-2.js";import{B as O}from"./Button-BtHYVGf0.js";import{w as D}from"./webSocket-BpFYzTQr.js";import{P as ke}from"./PageTitle-Cyz9Q3ha.js";const ve=({multiple:t,user:e,userObj:f,handleMsgList:M,handleChangeMessage:k,displayedName:u})=>{const[L,j]=N.useState(null);return N.useEffect(()=>{e&&((e==null?void 0:e.uid)<f.uid?j((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]):j(f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsx("div",{children:a.jsxs(ye,{children:[a.jsx(Ce,{children:a.jsx("div",{id:"drawer"})}),a.jsxs(Ue,{className:"bg-light-3 dark:bg-dark-3",children:[a.jsx("div",{className:"flex justify-center",children:a.jsx("div",{className:"bg-light-2 dark:bg-dark-2 h-2 w-[100px] rounded-full bg-muted",children:" "})}),a.jsxs("div",{className:"flex flex-col items-center pt-3",children:[a.jsxs(A,{className:"bg-profile-blue",children:[a.jsx(_,{src:e==null?void 0:e.profileImageUrl}),a.jsx(Y,{className:"text-xl border-none	",children:e==null?void 0:e.displayName[0]})]}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==u&&a.jsxs("div",{children:["(",u,"에서 개명)"]})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(G,{to:"/profile",state:{element:e},children:a.jsx(O,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),t&&f.uid!==(e==null?void 0:e.uid)&&a.jsx(G,{to:"/piazza",state:{conversation:L,displayName:e==null?void 0:e.displayName,userUid:f.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(O,{variant:"outlined",onClick:()=>{M([]),k(!0)},children:"개인 대화"})})]})]})]})})},De=pe(he)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Se(){const t=V(M=>M.piazzaSwitch.value),e=ee(),f=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),e(J("false"))):(window.localStorage.setItem("piazza","true"),e(J("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(De,{onClick:()=>f(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const ze=({multiple:t,displayName:e})=>a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(ke,{title:t?"단체 대화":`개인 대화 ${e}`}),t&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx(Se,{})})]});function Ee({userObj:t}){const e=N.useRef(null),[f,M]=N.useState(""),[k,u]=N.useState([]),[L,j]=N.useState(!0),[se,ae]=N.useState(null),T=V(s=>s.profileColor.value),I=V(s=>s.profileUrl.value),[te,ie]=N.useState(""),Z=ee(),{state:r}=xe(),$=(r==null?void 0:r.multiple)||!0,w=r==null?void 0:r.conversation;N.useEffect(()=>{if(!D)return;function s(n){const{msg:c,userUid:i,id:l,target:g,messageClock:d,messageClockNumber:o,conversation:p}=n;u(m=>[...m,{msg:c,type:g?"private":"other",userUid:i,id:l,messageClock:d,messageClockNumber:o,conversation:null,profileImageUrl:I,profileColor:T}])}return D.on("sMessagePiazza",s),()=>{D.off("sMessagePiazza",s)}},[]),N.useEffect(()=>{if(!D)return;function s(n){const{msg:c,userUid:i,id:l,target:g,messageClock:d,messageClockNumber:o,conversation:p}=n;u(m=>[...m,{msg:c,type:g?"private":"other",userUid:i,id:l,messageClock:d,messageClockNumber:o,conversation:null}])}return D.on(`sMessage${w}`,s),()=>{D.off(`sMessage${w}`,s)}},[]),N.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),N.useEffect(()=>{oe(),(async()=>{if($){const n=E(x,"chats_group"),c=B(n,F("messageClockNumber","desc"),Ne(1));(await H(c)).forEach(async l=>{const g=C(x,`chats_group/${l.id}`),o=(await U(g)).data(),p=o.piazzaChecked||[];p.indexOf(t.uid)===-1&&(p.push(t.uid),await R(g,{...o,piazzaChecked:p}))})}else{const n=C(x,`members/${t.uid}`),i=(await U(n)).data().chattings;i[w].messageCount=0,await R(n,{chattings:i})}})()},[k]),N.useEffect(()=>{Z(we(5))});const oe=()=>{var s;(s=e.current)==null||s.scrollIntoView()},ne=async s=>{var h;s.preventDefault();const n=f,c=t.uid,i=t.displayName,l=Date.now(),g=new Date().toString();let d,o,p;r.chattingUid&&(d=C(x,`members/${r.chattingUid}`),o=await U(d),p=(h=o.data())==null?void 0:h.messagingToken);const m={msg:n,userUid:c,id:i,messageClockNumber:l,messageClock:g,conversation:w,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:I,sendingToken:p};$?m&&n&&(D.emit("piazzaMessage",m),le()):n&&(k.length!==0?(D.emit("message",m),console.log("message")):(D.emit("messageNew",m),console.log("messageNew")),de(),re()),M("")},ce=s=>{M(s.target.value)},q=async({userUid:s,displayName:n})=>{const c=C(x,`members/${s}`),l=(await U(c)).data();ae(l),ie(n)},le=async()=>{try{const s=f,n=t.uid,c=t.displayName,i=new Date().toString(),l=Date.now();s&&(await Q(E(x,"chats_group"),{userUid:n,userName:c,message:s,messageClock:i,messageClockNumber:l,profileImageUrl:I,profileColor:T,piazzaChecked:[t.uid]}),u(g=>[...g,{msg:s,type:"me",userUid:t.uid,id:t.displayName,messageClock:i,conversation:null,profileImageUrl:I,profileColor:T}]))}catch(s){console.log(s)}};N.useEffect(()=>{L&&($?((async()=>{const c=[],i=E(x,"chats_group"),l=B(i,F("messageClockNumber"));(await H(l)).forEach(d=>{var y,b;const o=d.data().message,p=d.data().userUid,m=d.data().userName,h=d.data().messageClock,S=d.data().messageClockNumber,v=(y=d.data())==null?void 0:y.profileColor,z=(b=d.data())==null?void 0:b.profileImageUrl;c.push({msg:o,type:"me",userUid:p,id:m,messageClockNumber:S,messageClock:h,conversation:null,profileColor:v,profileImageUrl:z}),u(c)})})(),j(!1)):((async c=>{const i=E(x,`chats_${c}`),l=B(i,F("messageClockNumber")),g=await H(l),d=[];g.forEach(o=>{const p=o.data().message,m=o.data().userUid,h=o.data().userName,S=o.data().messageClock,v=o.data().messageClockNumber||0;d.push({msg:p,type:"me",userUid:m,id:h,messageClock:S,messageClockNumber:v}),u(d)})})(w),j(!1)))},[L]);const de=async()=>{var n,c,i;const s=f;try{const l=t.uid,g=t.displayName,d=Date.now(),o=new Date().toString();let p,m,h,S,v,z;if(r.userUid<r.chattingUid?(p=r.userUid,m=r.chattingUid,h=t.displayName,S=r.displayName,v=I,z=r.profileUrl):(p=r.chattingUid,m=r.userUid,h=r.displayName,S=t.displayName,v=r.profileUrl,z=I),!v){const y=C(x,`members/${p}`);v=(n=(await U(y)).data())==null?void 0:n.profileImageUrl}if(!z){const y=C(x,`members/${m}`);z=(c=(await U(y)).data())==null?void 0:c.profileImageUrl}if(s){const y={userUid:l,userName:g,message:s,messageClock:o,messageClockNumber:d,userOne:p,userTwo:m,userOneDisplayName:h,userTwoDisplayName:S,userOneProfileUrl:v,userTwoProfileUrl:z};await Q(E(x,`chats_${w}`),y);const b=C(x,`members/${l}`),W=(await U(b)).data().chattings||{},X=C(x,`members/${r.chattingUid}`),P=(await U(X)).data().chattings||{},me=((i=P[w])==null?void 0:i.messageCount)||0;W[w]=y,P[w]={...y,messageCount:me+1},await R(b,{chattings:W}),await R(X,{chattings:P}),u(fe=>[...fe,{msg:s,type:"me",userUid:t.uid,id:t.displayName,messageClock:o,conversation:w}])}}catch(l){console.log(l)}},re=async()=>{try{const s=t.uid,n=r.chattingUid,c=C(x,`members/${s}`),l=(await U(c)).data().conversation||[],g=C(x,`members/${n}`),o=(await U(g)).data().conversation||[];l.indexOf(w)===-1&&(await R(c,{conversation:[...l,w]}),Z(ue())),o.indexOf(w)===-1&&await R(g,{conversation:[...o,w]})}catch(s){console.log(s)}},ge=r==null?void 0:r.displayName;return a.jsxs(a.Fragment,{children:[a.jsx(ze,{multiple:$,displayName:ge}),a.jsxs("div",{className:"flex flex-col pt-5",children:[a.jsx("div",{className:"p-1 border-t rounded-xl h-[350px] overflow-auto",children:a.jsxs("ul",{children:[k.map((s,n)=>{let c;const i=new Date(s.messageClock);s.userUid===t.uid?c="text-right":c="text-left";let l,g;n>0&&(l=k[n-1].userUid),n<k.length-1&&k[n+1].userUid===t.uid&&(g=new Date(k[n+1].messageClock),i.getFullYear()===g.getFullYear()&&i.getMonth()===g.getMonth()&&i.getDate()===g.getDate()&&i.getHours()===g.getHours()&&(i.getMinutes(),g.getMinutes()));let d,o=i.getHours(),p=(i.getMonth()+1).toString(),m=i.getDate().toString();return o>=13?(d="오후",o!==12&&(o=o-12)):(d="오전",o===0&&(o=o+12)),i.getMonth()+1<10&&(p="0"+p),m.length===1&&(m="0"+m),a.jsxs("li",{className:c,children:[l!==s.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${s.userUid!==t.uid?"start":"end"}`,children:c==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsxs(A,{onClick:()=>{var h;(h=document.getElementById("drawer"))==null||h.click(),q({userUid:s.userUid,displayName:s.id})},className:"bg-profile-blue",children:[a.jsx(_,{src:s==null?void 0:s.profileImageUrl}),a.jsx(Y,{className:"text-xl border-none	",children:s==null?void 0:s.id[0]})]}),a.jsx("div",{children:s.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:s.id}),a.jsxs(A,{onClick:()=>{var h;(h=document.getElementById("drawer"))==null||h.click(),q({userUid:s.userUid,displayName:s.id})},className:"bg-profile-blue",children:[a.jsx(_,{src:s==null?void 0:s.profileImageUrl}),a.jsx(Y,{className:"text-xl border-none	",children:s==null?void 0:s.id[0]})]})]})})}),s.userUid!==t.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),a.jsxs("div",{children:[i.getFullYear(),"-",p,"-",m," ",d," ",o,":",i.getMinutes()]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[i.getFullYear(),"-",p,"-",m," ",d," ",o,":",i.getMinutes()]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]})}),a.jsx("li",{ref:e})]})}),a.jsxs("form",{className:"flex gap-px",onSubmit:ne,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:ce,value:f,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})]}),a.jsx(ve,{multiple:$,user:se,userObj:t,handleMsgList:s=>u(s),handleChangeMessage:s=>j(s),displayedName:te})]})}export{Ee as default};
