import{b2 as Pe,u as ie,c as ae,O as xe,aV as ne,r as c,j as e,P as ue,Y as le,b1 as pe,X as ke,b3 as Ce,aX as Me,v as Y,m as U,I as q,$ as w,a_ as ze,l as oe,C as se,b4 as Te,N as he,B as ce,b5 as Ne,q as de,Z as ge,_ as fe,n as me,aY as Se,s as $e,S as Re,Q as Ie,D as Ve,b6 as Fe,aJ as Be,aa as Ae,b7 as Le,b8 as He,b9 as _e,ba as Ye}from"./index-DHWeW_KP.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Pe("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=Pe("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ze={ko:"메세지를 작성해 주세요",en:"Input message"},Ge={ko:"전송",en:"send"};function Xe({chattingUser:n,userObj:g,multiple:C,messages:t,handleMessages:i,messagesList:E,handleMessagesList:d}){const j=ie(r=>r.profileColor.value),R=ie(r=>r.piazzaForm.value),l=ae(r=>r.profile.value),K=xe(),{state:z}=ne(),y=z==null?void 0:z.conversation,M=ae(r=>r.languages.value),B=M==="ko"||M==="en"?M:"ko",[k,V]=c.useState(!1),F=async r=>{var N;r.preventDefault();const S=t,P=g.uid,T=g.displayName,v=Date.now(),a=new Date().toString(),s=l==null?void 0:l.profileImageUrl,o=l==null?void 0:l.defaultProfile,u=l==null?void 0:l.profileImage;let f,p,m;n&&(f=Y(U,`members/${n.uid}`),p=await q(f),m=(N=p.data())==null?void 0:N.messagingToken);const h=l.profileImage?l.profileImageUrl:l.defaultProfile;console.log(l);const x={msg:S,userUid:P,id:T,messageClockNumber:v,messageClock:a,conversation:y,conversationUid:n==null?void 0:n.uid,conversationName:n==null?void 0:n.displayName,profileImage:u,defaultProfile:o,profileImageUrl:s,profileUrl:h,sendingToken:m};C?x&&S&&(w.emit("piazzaMessage",x),ee()):S&&(E.length!==0?(w.emit("message",x),console.log("message")):(w.emit("messageNew",x),console.log("messageNew")),b(),W()),i("")},A=r=>{i(r.target.value)},ee=async()=>{try{const r=t,S=g.uid,P=g.displayName,T=new Date().toString(),v=Date.now(),a=l==null?void 0:l.profileImageUrl,s=l==null?void 0:l.defaultProfile,o=l==null?void 0:l.profileImage;r&&(await ze(oe(U,"chats_group"),{userUid:S,userName:P,message:r,messageClock:T,messageClockNumber:v,profileImageUrl:a,defaultProfile:s,profileColor:j,piazzaChecked:[g.uid],profileImage:o}),d(u=>[...u,{msg:r,type:"me",userUid:g.uid,id:g.displayName,messageClock:T,conversation:null,profileColor:j,messageClockNumber:v,defaultProfile:s,profileImageUrl:a,profileImage:o||!1}]))}catch(r){console.log(r)}},b=async()=>{var S,P,T;const r=t;try{const v=g.uid,a=g.displayName,s=Date.now(),o=new Date().toString(),u=l.profileImage,f=n.profileImage,p=l.profileImageUrl,m=n.profileImageUrl,h=l.defaultProfile,x=n.defaultProfile;let N,I,_,L,H,Z,O,J,Q,G;if(g.uid<n.uid?(N=g.uid,I=n.uid,_=g.displayName,L=n.displayName,H=p,Z=m,O=h,J=x,Q=l.profileImage,G=n.profileImage):(N=n.uid,I=g.uid,_=n.displayName,L=g.displayName,H=m,Z=p,O=x,J=h,Q=n.profileImage,G=l.profileImage),!H){const X=Y(U,`members/${N}`);H=(S=(await q(X)).data())==null?void 0:S.profileImageUrl}if(!Z){const X=Y(U,`members/${I}`);Z=(P=(await q(X)).data())==null?void 0:P.profileImageUrl}if(r){const X={userUid:v,userName:a,message:r,messageClock:o,messageClockNumber:s,userOne:N,userTwo:I,userOneDisplayName:_,userTwoDisplayName:L,userOneProfileUrl:H,userTwoProfileUrl:Z,userOneDefaultProfile:O,userTwoDefaultProfile:J,userOneProfileImage:Q,userTwoProfileImage:G};await ze(oe(U,`chats_${y}`),X);const te=Y(U,`members/${v}`),we=(await q(te)).data().chattings||{},ye=Y(U,`members/${n.uid}`),re=(await q(ye)).data().chattings||{},Ee=((T=re[y])==null?void 0:T.messageCount)||0;we[y]=X,re[y]={...X,messageCount:Ee+1},await se(te,{chattings:we}),await se(ye,{chattings:re}),d(Ue=>[...Ue,{msg:r,type:"me",userUid:g.uid,id:g.displayName,messageClock:o,conversation:y,userName:a,messageClockNumber:s,userOne:N,userTwo:I,userOneDisplayName:_,userTwoDisplayName:L,userOneProfileUrl:H,userTwoProfileUrl:Z,userOneDefaultProfile:O,userTwoDefaultProfile:J,userOneProfileImage:Q,userTwoProfileImage:G}])}}catch(v){console.log(v)}},W=async()=>{try{const r=g.uid,S=n.uid,P=Y(U,`members/${r}`),v=(await q(P)).data().conversation||[],a=Y(U,`members/${S}`),o=(await q(a)).data().conversation||[];v.indexOf(y)===-1&&(await se(P,{conversation:[...v,y]}),K(Te())),o.indexOf(y)===-1&&await se(a,{conversation:[...o,y]})}catch(r){console.log(r)}};return c.useEffect(()=>{if(k){document.getElementById("mute"),document.getElementById("stream");const r=document.getElementById("videoInput");document.getElementById("myFace");let S;async function P(){try{const v={video:!0,audio:!0};S=await navigator.mediaDevices.getUserMedia(v),S.getVideoTracks().forEach(a=>a.enabled=!a.enabled),S.getAudioTracks().forEach(a=>a.enabled=!a.enabled),T()}catch(v){console.log(v)}}P();async function T(){try{const a=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput");a.forEach(s=>{const o=document.createElement("option");o.value=s.deviceId,o.innerText=s.label,r==null||r.appendChild(o)}),console.log(a)}catch(v){console.log(v)}}}}),console.log(z),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${R?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:F,children:[y&&y!=="piazza"&&e.jsx(ue,{trigger:e.jsx("button",{className:"px-1 h-full rounded bg-light-2 dark:bg-dark-2",type:"submit",children:e.jsx(Ke,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(le,{to:`/piazza?id=${y}?calls=video`,state:z,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var r;(r=document.getElementById("calls"))==null||r.click()},children:[e.jsx(Me,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(le,{to:`/piazza?id=${y}?calls=audio`,state:z,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(qe,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ze[B],onChange:A,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ge[B]})]})})}const De=({initiateContinuing:n,multiple:g,handleMultiple:C,user:t,userObj:i,handleMessagesList:E,displayedName:d})=>{const{state:j}=ne(),R=(j==null?void 0:j.conversation)||"piazza",l=ae(y=>y.languages.value),[K,z]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<i.uid?z((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):z(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:i.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==d&&e.jsx("div",{children:l==="ko"?e.jsxs("div",{children:["(",d,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",d,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(le,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ce,{variant:"outlined",onClick:()=>{},children:l==="ko"?"프로필 확인":"Check Profile"})}),R==="piazza"&&i.uid!==(t==null?void 0:t.uid)&&e.jsx(le,{to:`${location.pathname}?id=${K}`,state:{conversation:K,displayName:t==null?void 0:t.displayName,userUid:i.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(ce,{variant:"outlined",onClick:()=>{E([]),C(!1),n()},children:l==="ko"?"개인 대화":"Private messaging"})})})]})]})};function je({userObj:n,multiple:g,handleMultiple:C,messagesList:t,handleMessagesList:i}){const E=c.useRef(null),d=c.useRef(null),[j,R]=c.useState(null),[l,K]=c.useState(""),[z,y]=c.useState(!1),[M,B]=c.useState(null),[k,V]=c.useState(0),[F,A]=c.useState("piazza"),{state:ee}=ne(),b=(ee==null?void 0:ee.conversation)||"piazza";c.useEffect(()=>{F!==b&&(i([]),B(null),V(0),A(b))},[b]);const W=ae(a=>a.languages.value),r=async({userUid:a,displayName:s})=>{const o=Y(U,`members/${a}`),f=(await q(o)).data();R(f),K(s),console.log("practice")},S=({userUid:a,displayName:s})=>{var o;(o=document.getElementById("drawer"))==null||o.click(),r({userUid:a,displayName:s})},P=20;c.useEffect(()=>{if(!w)return;function a(s){const{msg:o,userUid:u,id:f,target:p,messageClock:m,messageClockNumber:h,profileImageUrl:x,defaultProfile:N,profileImage:I,conversation:_}=s;i(L=>[...L,{msg:o,type:p?"private":"other",userUid:u,id:f,messageClock:m,messageClockNumber:h,conversation:null,profileImageUrl:x,defaultProfile:N,profileImage:I}])}return w.on("sMessagePiazza",a),()=>{w.off("sMessagePiazza",a)}},[]),c.useEffect(()=>{if(!w)return;function a(s){const{msg:o,userUid:u,id:f,target:p,messageClock:m,messageClockNumber:h,conversation:x,profileImageUrl:N,defaultProfile:I,profileImage:_,piazzaData:L}=s;i(H=>[...H,{msg:o,type:p?"private":"other",userUid:u,id:f,messageClock:m,messageClockNumber:h,conversation:null,profileImageUrl:N,defaultProfile:I,profileImage:_,...L}])}return w.on(`sMessage${b}`,a),()=>{w.off(`sMessage${b}`,a)}},[b]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{T(),(async()=>{if(g){const s=oe(U,"chats_group"),o=de(s,fe("messageClockNumber","desc"),ge(1));(await me(o)).forEach(async f=>{const p=Y(U,`chats_group/${f.id}`),h=(await q(p)).data(),x=h.piazzaChecked||[];x.indexOf(n.uid)===-1&&(x.splice(-1,n.uid,0),x.push(n.uid),await se(p,{...h,piazzaChecked:x}))})}else{const s=Y(U,`members/${n.uid}`),u=(await q(s)).data().chattings;u[b]&&(u[b].messageCount=0),await se(s,{chattings:u})}})()},[t]);const T=()=>{var a;(a=E.current)==null||a.scrollIntoView()};c.useEffect(()=>{const a=async()=>{const o=[],u=oe(U,"chats_group"),f=de(u,fe("messageClockNumber","desc"),ge(P),Se(M||"")),p=await me(f);p.docs.length||V(p.docs.length),p.forEach(m=>{var J,Q,G;o.length===p.docs.length-1&&(B(m),V(p.docs.length-1));const h=m.data().message,x=m.data().userUid,N=m.data().userName,I=m.data().messageClock,_=m.data().messageClockNumber,L=(J=m.data())==null?void 0:J.profileImageUrl,H=(Q=m.data())==null?void 0:Q.defaultProfile,Z=(G=m.data())==null?void 0:G.profileImage,O=m.data();o.push({msg:h,userUid:x,id:N,messageClockNumber:_,messageClock:I,conversation:null,profileImageUrl:L,defaultProfile:H,profileImage:Z||!1,...O})}),o.reverse(),i([...o,...t]),y(!1)},s=async o=>{const u=oe(U,`chats_${o}`),f=de(u,fe("messageClockNumber","desc"),ge(P),Se(M||"")),p=await me(f),m=[];p.docs.length||V(p.docs.length),p.forEach((h,x)=>{var G,X,te;m.length===p.docs.length-1&&(B(h),V(p.docs.length-1));const N=h.data().message,I=h.data().userUid,_=h.data().userName,L=h.data().messageClock,H=h.data().messageClockNumber||0,Z=(G=h.data())==null?void 0:G.profileImageUrl,O=(X=h.data())==null?void 0:X.defaultProfile,J=(te=h.data())==null?void 0:te.profileImage,Q=h.data();m.push({msg:N,userUid:I,id:_,messageClockNumber:H,messageClock:L,conversation:null,profileImageUrl:Z,defaultProfile:O,profileImage:J||!1,...Q})}),m.reverse(),i([...m,...t]),y(!1)};b==="piazza"?(z||!t.length)&&a():(z||!t.length)&&s(b)},[z,b]);const v=()=>{d.current.scrollTop!==0||z||(console.log("scroll"),y(!0))};return c.useEffect(()=>{var a;return(a=d.current)==null||a.addEventListener("scroll",v),()=>{var s;return(s=d.current)==null?void 0:s.removeEventListener("scroll",v)}},[z]),console.log(b),console.log(t),console.log(j),e.jsx(e.Fragment,{children:e.jsx("div",{ref:d,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[z&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,s)=>{let o;b==="piazza"?o=a:a.userUid===a.userOne?o={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:o={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let u;const f=new Date(a.messageClock);a.userUid===n.uid?u="text-right":u="text-left";let p,m;s>0&&(p=t[s-1].userUid),s<t.length-1&&t[s+1].userUid===n.uid&&(m=new Date(t[s+1].messageClock),f.getFullYear()===m.getFullYear()&&f.getMonth()===m.getMonth()&&f.getDate()===m.getDate()&&f.getHours()===m.getHours()&&(f.getMinutes(),m.getMinutes()));let h,x=f.getHours(),N=(f.getMonth()+1).toString(),I=f.getDate().toString();return x>=13?(h="오후",x!==12&&(x=x-12)):(h="오전",x===0&&(x=x+12)),f.getMonth()+1<10&&(N="0"+N),I.length===1&&(I="0"+I),e.jsxs("li",{ref:s===k?E:null,className:u,children:[p!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==n.uid?"start":"end"}`,children:u==="text-left"?e.jsxs("div",{className:"flex gap-3",children:[e.jsx(ue,{trigger:e.jsx(he,{element:o,piazza:()=>S({userUid:o.userUid,displayName:o.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(De,{initiateContinuing:()=>B(null),multiple:g,handleMultiple:C,user:j,userObj:n,handleMessagesList:i,displayedName:l})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{children:a.id}),e.jsx(ue,{trigger:e.jsx(he,{element:o,piazza:()=>S({userUid:o.userUid,displayName:o.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(De,{initiateContinuing:()=>B(null),multiple:g,handleMultiple:C,user:j,userObj:n,handleMessagesList:i,displayedName:l})})]})})}),a.userUid!==n.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[f.getFullYear(),"-",N,"-",I," ",W==="ko"&&h," ",x,":",f.getMinutes()<10&&"0",f.getMinutes(),W==="en"&&(h==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[f.getFullYear(),"-",N,"-",I," ",W==="ko"&&h," ",x,":",f.getMinutes()<10&&"0",f.getMinutes(),W==="en"&&(h==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},s)}),e.jsx("li",{ref:E})]})})})}function Je({isKeyboardOpen:n,userObj:g,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:E}){return e.jsx(e.Fragment,{children:n?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(je,{userObj:g,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:E})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(je,{userObj:g,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:E})})})}const Qe=$e(Re)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function We(){const n=ae(i=>i.languages.value),g=ie(i=>i.piazzaSwitch.value),C=xe(),t=()=>{g==="true"?(window.localStorage.setItem("piazza","false"),C(Ie("false"))):(window.localStorage.setItem("piazza","true"),C(Ie("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Qe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:g==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Oe=({multiple:n,displayName:g})=>{const C=ae(d=>d.languages.value),t=C==="ko"||C==="en"?C:"ko",{state:i}=ne(),E=(i==null?void 0:i.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Ve,{icon:e.jsx(Fe,{}),title:E==="piazza"?be[t][0]:`${be[t][1]} ${g}`}),n&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(We,{})})]})};let D,$;function et(){const[n,g]=c.useState([]),[C,t]=c.useState(!0),[i,E]=c.useState(!0),[d,j]=c.useState(""),[R,l]=c.useState(null),K=Be(),z=document.getElementById("myScreen");document.getElementById("devices");const y={audio:!0,video:!0},M=location.search.slice(4);console.log(location.search.slice(4));async function B(){const s=D;s&&s.getAudioTracks().forEach(o=>o.enabled=!o.enabled),t(!C)}async function k(){const s=D;s&&s.getVideoTracks().forEach(o=>o.enabled=!o.enabled),E(!i)}async function V(s){if(D.getTracks().forEach(u=>u.stop()),l(s.target.value),$){console.log($.getSenders());const u=D.getVideoTracks()[0];$.getSenders().find(p=>p.track.kind==="video").replaceTrack(u)}}c.useEffect(()=>{D?(D.getTracks().forEach(s=>s.stop()),setTimeout(()=>A(R),1e3)):A(R),d&&A(R),!d&&!D&&A(R)},[R,z]);async function F(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(u=>u.kind==="videoinput");g(o)}catch(s){console.log(s)}}async function A(s){try{const u=s?{audio:!0,video:{deviceId:{exact:s}}}:y;D&&D.getTracks().forEach(p=>p.stop()),D=await navigator.mediaDevices.getUserMedia(u);const f=await navigator.mediaDevices.enumerateDevices();z.srcObject=D,await F(),j(""),console.log(D.getVideoTracks()[0].label)}catch(o){j(o)}}function ee(s){console.log("icecandidate"),console.log(s),w.emit("ice",s.candidate,M)}function b(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",D);const o=document.getElementById("yourScreen");o.srcObject=s.stream}function W(){const s=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];$=new RTCPeerConnection({iceServers:[{urls:s.map(o=>o.urls)}]}),$.addEventListener("icecandidate",ee),$.addEventListener("addstream",b),D&&D.getTracks().forEach(o=>$.addTrack(o,D))}async function r(){await A(null),W()}async function S(){await r(),w.emit("joinRoom",M,r)}c.useEffect(()=>{S()},[]);const P=async()=>{console.log("sent the offer"),console.log($);const s=await $.createOffer();$.setLocalDescription(s),console.log(s),w.emit("offer",s,M)};c.useEffect(()=>{if(w)return w.on("welcome",P),()=>{w.off("welcome",P)}});const T=async s=>{console.log("received the offer"),$.setRemoteDescription(s);const o=await $.createAnswer();console.log("sent the answer"),$.setLocalDescription(o),w.emit("answer",o,M)};c.useEffect(()=>{if(w)return w.on("offer",T),()=>{w.off("offer",T)}});const v=s=>{console.log("received the answer"),$.setRemoteDescription(s)};c.useEffect(()=>{if(w)return w.on("answer",v),()=>{w.off("answer",v)}});const a=s=>{console.log("received candidate"),$.addIceCandidate(s)};return c.useEffect(()=>{if(w)return w.on("ice",a),()=>{w.off("ice",a)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!K&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ce,{onClick:B,children:C?"unmute":"mute"}),e.jsx(ce,{onClick:k,children:i?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:V,children:n.map((s,o)=>e.jsx("option",{value:s.deviceId,selected:(D==null?void 0:D.getVideoTracks()[0].id)===s.deviceId,children:s.label},o))})]}),d&&e.jsx("div",{children:d.toString()})]})}function at({userObj:n}){const[g,C]=c.useState(""),[t,i]=c.useState([]),E=xe(),{state:d}=ne(),[j,R]=c.useState(!0),[l,K]=c.useState(!1),[z,y]=c.useState(null);c.useEffect(()=>{const k=async()=>{if(d!=null&&d.chattingUid){const V=Y(U,`members/${d.chattingUid}`),F=await q(V);y(F.data())}};d!=null&&d.multiple||k()},[d]);const M=ie(k=>k.piazzaForm.value);c.useEffect(()=>{var V;const k=()=>{var A;const F=window.screen.height-300>(((A=window.visualViewport)==null?void 0:A.height)||window.screen.height);l!==F&&K(F)};return window.addEventListener("resize",k),typeof visualViewport<"u"&&((V=window.visualViewport)==null||V.addEventListener("resize",k)),visualViewport==null||visualViewport.addEventListener("resize",k),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",k)),()=>{var F;typeof visualViewport<"u"&&((F=window.visualViewport)==null||F.removeEventListener("resize",k))}},[l]),c.useEffect(()=>{(d==null?void 0:d.multiple)!==void 0&&R(d==null?void 0:d.multiple)},[]),c.useEffect(()=>{E(Ae(5))});const B=d==null?void 0:d.displayName;return e.jsxs(e.Fragment,{children:[!l&&e.jsx(Oe,{multiple:j,displayName:B}),e.jsx(Je,{isKeyboardOpen:M,userObj:n,multiple:j,handleMultiple:k=>R(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsx(Xe,{chattingUser:z,userObj:n,multiple:j,messages:g,handleMessages:k=>C(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsxs(Le,{children:[e.jsx(He,{children:e.jsx("div",{id:"calls"})}),e.jsx(_e,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(et,{})}),e.jsx(Ye,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{at as default};
