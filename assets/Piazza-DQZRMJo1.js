import{u as K,K as ne,aE as se,c as X,j as s,k as _,g as M,V as B,S as j,aJ as le,f as Y,v as L,aL as we,r,I as oe,O as re,B as de,as as xe,P as ge,aM as me,q as Z,U as J,E as Q,h as W,aH as te,ad as ve,aN as Ce,Q as fe,w as ke,a5 as ye}from"./index-DU0IuM8_.js";const Ne={ko:"메세지를 작성해 주세요",en:"Input message"},Ue={ko:"전송",en:"send"};function ze({userObj:d,multiple:p,messages:k,handleMessages:e,messagesList:a,handleMessagesList:S}){const y=K(w=>w.profileColor.value),D=K(w=>w.profileUrl.value),R=ne(),{state:l}=se(),N=l==null?void 0:l.conversation,A=X(w=>w.languages.value),U=A==="ko"||A==="en"?A:"ko",V=async w=>{var t;w.preventDefault();const P=k,I=d.uid,c=d.displayName,h=Date.now(),C=new Date().toString();let b,z,x;l.chattingUid&&(b=_(M,`members/${l.chattingUid}`),z=await B(b),x=(t=z.data())==null?void 0:t.messagingToken);const f={msg:P,userUid:I,id:c,messageClockNumber:h,messageClock:C,conversation:N,conversationUid:l.chattingUid,conversationName:l.displayName,profileUrl:D,sendingToken:x};p?f&&P&&(j.emit("piazzaMessage",f),H()):P&&(a.length!==0?(j.emit("message",f),console.log("message")):(j.emit("messageNew",f),console.log("messageNew")),q(),F()),e("")},$=w=>{e(w.target.value)},H=async()=>{try{const w=k,P=d.uid,I=d.displayName,c=new Date().toString(),h=Date.now();w&&(await le(Y(M,"chats_group"),{userUid:P,userName:I,message:w,messageClock:c,messageClockNumber:h,profileImageUrl:D,profileColor:y,piazzaChecked:[d.uid]}),S(C=>[...C,{msg:w,type:"me",userUid:d.uid,id:d.displayName,messageClock:c,conversation:null,profileImageUrl:D,profileColor:y}]))}catch(w){console.log(w)}},q=async()=>{var P,I,c;const w=k;try{const h=d.uid,C=d.displayName,b=Date.now(),z=new Date().toString();let x,f,t,o,i,n;if(l.userUid<l.chattingUid?(x=l.userUid,f=l.chattingUid,t=d.displayName,o=l.displayName,i=D,n=l.profileUrl):(x=l.chattingUid,f=l.userUid,t=l.displayName,o=d.displayName,i=l.profileUrl,n=D),!i){const v=_(M,`members/${x}`);i=(P=(await B(v)).data())==null?void 0:P.profileImageUrl}if(!n){const v=_(M,`members/${f}`);n=(I=(await B(v)).data())==null?void 0:I.profileImageUrl}if(w){const v={userUid:h,userName:C,message:w,messageClock:z,messageClockNumber:b,userOne:x,userTwo:f,userOneDisplayName:t,userTwoDisplayName:o,userOneProfileUrl:i,userTwoProfileUrl:n};await le(Y(M,`chats_${N}`),v);const g=_(M,`members/${h}`),u=(await B(g)).data().chattings||{},E=_(M,`members/${l.chattingUid}`),G=(await B(E)).data().chattings||{},O=((c=G[N])==null?void 0:c.messageCount)||0;u[N]=v,G[N]={...v,messageCount:O+1},await L(g,{chattings:u}),await L(E,{chattings:G}),S(ee=>[...ee,{msg:w,type:"me",userUid:d.uid,id:d.displayName,messageClock:z,conversation:N}])}}catch(h){console.log(h)}},F=async()=>{try{const w=d.uid,P=l.chattingUid,I=_(M,`members/${w}`),h=(await B(I)).data().conversation||[],C=_(M,`members/${P}`),z=(await B(C)).data().conversation||[];h.indexOf(N)===-1&&(await L(I,{conversation:[...h,N]}),R(we())),z.indexOf(N)===-1&&await L(C,{conversation:[...z,N]})}catch(w){console.log(w)}};return s.jsx(s.Fragment,{children:s.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:V,children:[s.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ne[U],onChange:$,value:k,autoFocus:!0}),s.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ue[U]})]})})}const ue=({initiateContinuing:d,multiple:p,handleMultiple:k,user:e,userObj:a,handleMessagesList:S,displayedName:y})=>{const[D,R]=r.useState(null),l=X(N=>N.languages.value);return r.useEffect(()=>{e&&((e==null?void 0:e.uid)<a.uid?R((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+a.uid[0]+a.uid[1]+a.uid[2]+a.uid[3]+a.uid[4]+a.uid[5]):R(a.uid[0]+a.uid[1]+a.uid[2]+a.uid[3]+a.uid[4]+a.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),s.jsxs("div",{children:[s.jsxs("div",{className:"flex flex-col items-center pt-5",children:[s.jsx(oe,{uid:a.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),s.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==y&&s.jsx("div",{children:l==="ko"?s.jsxs("div",{children:["(",y,"에서 개명)"]}):s.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),s.jsxs("div",{className:"flex justify-center p-5",children:[s.jsx(re,{to:"/profile",state:{element:e},children:s.jsx(de,{variant:"outlined",onClick:()=>{},children:l==="ko"?"프로필 확인":"Check Profile"})}),p&&a.uid!==(e==null?void 0:e.uid)&&s.jsx(re,{to:"/piazza",state:{conversation:D,displayName:e==null?void 0:e.displayName,userUid:a.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:s.jsx(xe,{children:s.jsx(de,{variant:"outlined",onClick:()=>{S([]),k(!1),d()},children:l==="ko"?"개인 대화":"Private messaging"})})})]})]})};function pe({isKeyboardOpen:d,userObj:p,multiple:k,handleMultiple:e,messagesList:a,handleMessagesList:S}){const y=r.useRef(null),D=r.useRef(null),[R,l]=r.useState(null),[N,A]=r.useState(""),[U,V]=r.useState(!1),[$,H]=r.useState(null),[q,F]=r.useState(0),w=K(t=>t.profileColor.value),P=K(t=>t.profileUrl.value),{state:I}=se(),c=I==null?void 0:I.conversation,h=X(t=>t.languages.value),C=async({userUid:t,displayName:o})=>{const i=_(M,`members/${t}`),v=(await B(i)).data();l(v),A(o)},b=({userUid:t,displayName:o})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),C({userUid:t,displayName:o})},z=20;r.useEffect(()=>{if(!j)return;function t(o){const{msg:i,userUid:n,id:v,target:g,messageClock:m,messageClockNumber:u,conversation:E}=o;S(T=>[...T,{msg:i,type:g?"private":"other",userUid:n,id:v,messageClock:m,messageClockNumber:u,conversation:null,profileImageUrl:P,profileColor:w}])}return j.on("sMessagePiazza",t),()=>{j.off("sMessagePiazza",t)}},[]),r.useEffect(()=>{if(!j)return;function t(o){const{msg:i,userUid:n,id:v,target:g,messageClock:m,messageClockNumber:u,conversation:E}=o;S(T=>[...T,{msg:i,type:g?"private":"other",userUid:n,id:v,messageClock:m,messageClockNumber:u,conversation:null}])}return j.on(`sMessage${c}`,t),()=>{j.off(`sMessage${c}`,t)}},[]),r.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),r.useEffect(()=>{x(),(async()=>{if(k){const o=Y(M,"chats_group"),i=Z(o,Q("messageClockNumber","desc"),J(1));(await W(i)).forEach(async v=>{const g=_(M,`chats_group/${v.id}`),u=(await B(g)).data(),E=u.piazzaChecked||[];E.indexOf(p.uid)===-1&&(E.splice(-1,p.uid,0),E.push(p.uid),await L(g,{...u,piazzaChecked:E}))})}else{const o=_(M,`members/${p.uid}`),n=(await B(o)).data().chattings;n[c].messageCount=0,await L(o,{chattings:n})}})()},[a]);const x=()=>{var t;(t=y.current)==null||t.scrollIntoView()};r.useEffect(()=>{const t=async()=>{const i=[],n=Y(M,"chats_group"),v=Z(n,Q("messageClockNumber","desc"),J(z),te($||"")),g=await W(v);g.docs.length||F(g.docs.length),g.forEach(m=>{var ie,ce;i.length===g.docs.length-1&&(H(m),F(g.docs.length-1));const u=m.data().message,E=m.data().userUid,T=m.data().userName,G=m.data().messageClock,O=m.data().messageClockNumber,ee=(ie=m.data())==null?void 0:ie.profileColor,ae=(ce=m.data())==null?void 0:ce.profileImageUrl;i.push({msg:u,type:"me",userUid:E,id:T,messageClockNumber:O,messageClock:G,conversation:null,profileColor:ee,profileImageUrl:ae})}),i.reverse(),S([...i,...a]),V(!1)},o=async i=>{const n=Y(M,`chats_${i}`),v=Z(n,Q("messageClockNumber","desc"),J(z),te($||"")),g=await W(v),m=[];g.docs.length||F(g.docs.length),g.forEach((u,E)=>{m.length===g.docs.length-1&&(H(u),F(g.docs.length-1));const T=u.data().message,G=u.data().userUid,O=u.data().userName,ee=u.data().messageClock,ae=u.data().messageClockNumber||0;m.push({msg:T,type:"me",userUid:G,id:O,messageClock:ee,messageClockNumber:ae})}),m.reverse(),S([...m,...a]),V(!1)};c?(U||!a.length)&&o(c):(U||!a.length)&&t()},[U,c]);const f=()=>{D.current.scrollTop!==0||U||(console.log("scroll"),V(!0))};return r.useEffect(()=>{var t;return(t=D.current)==null||t.addEventListener("scroll",f),()=>{var o;return(o=D.current)==null?void 0:o.removeEventListener("scroll",f)}},[U]),s.jsx(s.Fragment,{children:s.jsx(s.Fragment,{children:s.jsx("div",{ref:D,className:"p-1 border-t rounded-xl overflow-auto",children:s.jsxs("ul",{children:[U&&s.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),a.map((t,o)=>{let i;const n=new Date(t.messageClock);t.userUid===p.uid?i="text-right":i="text-left";let v,g;o>0&&(v=a[o-1].userUid),o<a.length-1&&a[o+1].userUid===p.uid&&(g=new Date(a[o+1].messageClock),n.getFullYear()===g.getFullYear()&&n.getMonth()===g.getMonth()&&n.getDate()===g.getDate()&&n.getHours()===g.getHours()&&(n.getMinutes(),g.getMinutes()));let m,u=n.getHours(),E=(n.getMonth()+1).toString(),T=n.getDate().toString();return u>=13?(m="오후",u!==12&&(u=u-12)):(m="오전",u===0&&(u=u+12)),n.getMonth()+1<10&&(E="0"+E),T.length===1&&(T="0"+T),s.jsxs("li",{ref:o===q?y:null,className:i,children:[v!==t.userUid&&s.jsx("div",{children:s.jsx("div",{className:`flex justify-${t.userUid!==p.uid?"start":"end"}`,children:i==="text-left"?s.jsxs("div",{className:"flex gap-3",children:[s.jsx(ge,{trigger:s.jsx(oe,{uid:p.uid,profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,piazza:()=>b({userUid:t.userUid,displayName:t.id})}),title:s.jsx(me,{}),content:s.jsx(ue,{initiateContinuing:()=>H(null),multiple:k,handleMultiple:e,user:R,userObj:p,handleMessagesList:S,displayedName:N})}),s.jsx("div",{children:t.id})]}):s.jsxs("div",{className:"flex gap-3",children:[s.jsx("div",{children:t.id}),s.jsx(ge,{trigger:s.jsx(oe,{uid:p.uid,profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,piazza:()=>b({userUid:t.userUid,displayName:t.id})}),title:s.jsx(me,{}),content:s.jsx(ue,{initiateContinuing:()=>H(null),multiple:k,handleMultiple:e,user:R,userObj:p,handleMessagesList:S,displayedName:N})})]})})}),t.userUid!==p.uid?s.jsxs("div",{className:"flex gap-3 justify-start",children:[s.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),s.jsxs("div",{children:[n.getFullYear(),"-",E,"-",T," ",h==="ko"&&m," ",u,":",n.getMinutes()<10&&"0",n.getMinutes(),h==="en"&&(m==="오전"?"am":"pm")]})]}):s.jsxs("div",{className:"flex gap-3 justify-end",children:[s.jsxs("div",{children:[n.getFullYear(),"-",E,"-",T," ",h==="ko"&&m," ",u,":",n.getMinutes()<10&&"0",n.getMinutes(),h==="en"&&(m==="오전"?"am":"pm")]}),s.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},o)}),s.jsx("li",{ref:y})]})})})})}function Se({isKeyboardOpen:d,userObj:p,multiple:k,handleMultiple:e,messagesList:a,handleMessagesList:S}){const y=r.useRef(null),D=r.useRef(null);r.useState(null),r.useState("");const[R,l]=r.useState(!1),[N,A]=r.useState(null),[U,V]=r.useState(0),$=K(c=>c.profileColor.value),H=K(c=>c.profileUrl.value),{state:q}=se(),F=q==null?void 0:q.conversation;X(c=>c.languages.value);const w=20;r.useEffect(()=>{if(!j)return;function c(h){const{msg:C,userUid:b,id:z,target:x,messageClock:f,messageClockNumber:t,conversation:o}=h;S(i=>[...i,{msg:C,type:x?"private":"other",userUid:b,id:z,messageClock:f,messageClockNumber:t,conversation:null,profileImageUrl:H,profileColor:$}])}return j.on("sMessagePiazza",c),()=>{j.off("sMessagePiazza",c)}},[]),r.useEffect(()=>{if(!j)return;function c(h){const{msg:C,userUid:b,id:z,target:x,messageClock:f,messageClockNumber:t,conversation:o}=h;S(i=>[...i,{msg:C,type:x?"private":"other",userUid:b,id:z,messageClock:f,messageClockNumber:t,conversation:null}])}return j.on(`sMessage${F}`,c),()=>{j.off(`sMessage${F}`,c)}},[]),r.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),r.useEffect(()=>{P(),(async()=>{if(k){const h=Y(M,"chats_group"),C=Z(h,Q("messageClockNumber","desc"),J(1));(await W(C)).forEach(async z=>{const x=_(M,`chats_group/${z.id}`),t=(await B(x)).data(),o=t.piazzaChecked||[];o.indexOf(p.uid)===-1&&(o.splice(-1,p.uid,0),o.push(p.uid),await L(x,{...t,piazzaChecked:o}))})}else{const h=_(M,`members/${p.uid}`),b=(await B(h)).data().chattings;b[F].messageCount=0,await L(h,{chattings:b})}})()},[a]);const P=()=>{var c;(c=y.current)==null||c.scrollIntoView()};r.useEffect(()=>{const c=async()=>{const C=[],b=Y(M,"chats_group"),z=Z(b,Q("messageClockNumber","desc"),J(w),te(N||"")),x=await W(z);x.docs.length||V(x.docs.length),x.forEach(f=>{var u,E;C.length===x.docs.length-1&&(A(f),V(x.docs.length-1));const t=f.data().message,o=f.data().userUid,i=f.data().userName,n=f.data().messageClock,v=f.data().messageClockNumber,g=(u=f.data())==null?void 0:u.profileColor,m=(E=f.data())==null?void 0:E.profileImageUrl;C.push({msg:t,type:"me",userUid:o,id:i,messageClockNumber:v,messageClock:n,conversation:null,profileColor:g,profileImageUrl:m})}),C.reverse(),S([...C,...a]),l(!1)},h=async C=>{const b=Y(M,`chats_${C}`),z=Z(b,Q("messageClockNumber","desc"),J(w),te(N||"")),x=await W(z),f=[];x.docs.length||V(x.docs.length),x.forEach((t,o)=>{f.length===x.docs.length-1&&(A(t),V(x.docs.length-1));const i=t.data().message,n=t.data().userUid,v=t.data().userName,g=t.data().messageClock,m=t.data().messageClockNumber||0;f.push({msg:i,type:"me",userUid:n,id:v,messageClock:g,messageClockNumber:m})}),f.reverse(),S([...f,...a]),l(!1)};F?(R||!a.length)&&h(F):(R||!a.length)&&c()},[R,F]);const I=()=>{D.current.scrollTop!==0||R||(console.log("scroll"),l(!0))};return r.useEffect(()=>{var c;return(c=D.current)==null||c.addEventListener("scroll",I),()=>{var h;return(h=D.current)==null?void 0:h.removeEventListener("scroll",I)}},[R]),s.jsx(s.Fragment,{children:d?s.jsx("div",{className:"fixed bottom-[110px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-5",children:s.jsx(pe,{isKeyboardOpen:d,userObj:p,multiple:k,handleMultiple:e,messagesList:a,handleMessagesList:S})}):s.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col pt-5",children:s.jsx(pe,{isKeyboardOpen:d,userObj:p,multiple:k,handleMultiple:e,messagesList:a,handleMessagesList:S})})})}const De=ve(Ce)(({theme:d})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(d.palette.getContrastText(d.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(d.palette.getContrastText(d.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function be(){const d=X(a=>a.languages.value),p=K(a=>a.piazzaSwitch.value),k=ne(),e=()=>{p==="true"?(window.localStorage.setItem("piazza","false"),k(fe("false"))):(window.localStorage.setItem("piazza","true"),k(fe("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:d==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(De,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:p==="true"})})]})}const he={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Ee=({multiple:d,displayName:p})=>{const k=X(a=>a.languages.value),e=k==="ko"||k==="en"?k:"ko";return s.jsxs("div",{className:"flex w-screen justify-between",children:[s.jsx(ke,{title:d?he[e][0]:`${he[e][1]} ${p}`}),d&&s.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:s.jsx(be,{})})]})};function Re({userObj:d}){const[p,k]=r.useState(""),[e,a]=r.useState([]),S=ne(),{state:y}=se(),[D,R]=r.useState(!0),[l,N]=r.useState(!1);r.useEffect(()=>{var V;const U=()=>{var H;const $=window.screen.height-300>(((H=window.visualViewport)==null?void 0:H.height)||window.screen.height);l!==$&&N($)};return window.addEventListener("resize",U),typeof visualViewport<"u"&&((V=window.visualViewport)==null||V.addEventListener("resize",U)),()=>{var $;typeof visualViewport<"u"&&(($=window.visualViewport)==null||$.removeEventListener("resize",U))}},[l]),console.log(l),r.useEffect(()=>{(y==null?void 0:y.multiple)!==void 0&&R(y==null?void 0:y.multiple)},[]),window.addEventListener("resize",()=>{window.visualViewport}),visualViewport.addEventListener("resize",()=>{window.visualViewport&&console.log(window.visualViewport.height)}),r.useEffect(()=>{S(ye(5))});const A=y==null?void 0:y.displayName;return s.jsxs(s.Fragment,{children:[!l&&s.jsx(Ee,{multiple:D,displayName:A}),s.jsx(Se,{isKeyboardOpen:l,userObj:d,multiple:D,handleMultiple:U=>R(U),messagesList:e,handleMessagesList:U=>a(U)}),s.jsx(ze,{userObj:d,multiple:D,messages:p,handleMessages:U=>k(U),messagesList:e,handleMessagesList:U=>a(U)})]})}export{Re as default};
