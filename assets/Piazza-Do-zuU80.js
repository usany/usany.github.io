import{r as u,c as q,j as t,O as te,X as oe,B as le,aG as he,u as Z,aS as ae,_ as P,aE as ce,aY as re,l as V,m as v,q as K,a2 as Q,J as O,n as ee,t as E,$ as I,A,aW as de,R as se,aX as ge,aZ as ue,aj as xe,a_ as Ce,Y as me,P as we,ab as ke}from"./index-JmaPyCck.js";const fe=({initiateContinuing:s,multiple:y,handleMultiple:x,user:e,userObj:i,handleMessagesList:M,displayedName:p})=>{const[U,$]=u.useState(null),r=q(f=>f.languages.value);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?$((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):$(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(te,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&t.jsx("div",{children:r==="ko"?t.jsxs("div",{children:["(",p,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(oe,{to:"/profile",state:{element:e},children:t.jsx(le,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),y&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(oe,{to:"/piazza",state:{conversation:U,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(he,{children:t.jsx(le,{variant:"outlined",onClick:()=>{M([]),x(!1),s()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ve({userObj:s,multiple:y,handleMultiple:x,messagesList:e,handleMessagesList:i}){const M=u.useRef(null),p=u.useRef(null),[U,$]=u.useState(null),[r,f]=u.useState(""),[j,B]=u.useState(!1),[H,_]=u.useState(null),[J,Y]=u.useState(0),W=Z(a=>a.profileColor.value),m=Z(a=>a.profileUrl.value),{state:N}=ae(),w=N==null?void 0:N.conversation,z=q(a=>a.languages.value),S=async({userUid:a,displayName:l})=>{const g=E(v,`members/${a}`),h=(await I(g)).data();$(h),f(l)},D=({userUid:a,displayName:l})=>{var g;(g=document.getElementById("drawer"))==null||g.click(),S({userUid:a,displayName:l})},T=10;u.useEffect(()=>{if(!P)return;function a(l){const{msg:g,userUid:n,id:h,target:o,messageClock:c,messageClockNumber:d,conversation:C}=l;i(k=>[...k,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:c,messageClockNumber:d,conversation:null,profileImageUrl:m,profileColor:W}])}return P.on("sMessagePiazza",a),()=>{P.off("sMessagePiazza",a)}},[]),u.useEffect(()=>{if(!P)return;function a(l){const{msg:g,userUid:n,id:h,target:o,messageClock:c,messageClockNumber:d,conversation:C}=l;i(k=>[...k,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:c,messageClockNumber:d,conversation:null}])}return P.on(`sMessage${w}`,a),()=>{P.off(`sMessage${w}`,a)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{b(),(async()=>{if(y){const l=V(v,"chats_group"),g=K(l,O("messageClockNumber","desc"),Q(1));(await ee(g)).forEach(async h=>{const o=E(v,`chats_group/${h.id}`),d=(await I(o)).data(),C=d.piazzaChecked||[];C.indexOf(s.uid)===-1&&(C.splice(-1,s.uid,0),C.push(s.uid),await A(o,{...d,piazzaChecked:C}))})}else{const l=E(v,`members/${s.uid}`),n=(await I(l)).data().chattings;n[w].messageCount=0,await A(l,{chattings:n})}})()},[e]);const b=()=>{var a;(a=M.current)==null||a.scrollIntoView()};u.useEffect(()=>{const a=async()=>{const g=[],n=V(v,"chats_group"),h=K(n,O("messageClockNumber","desc"),Q(T),de(H||"")),o=await ee(h);o.docs.length||Y(o.docs.length),o.forEach(c=>{var ie,ne;g.length===o.docs.length-1&&(_(c),Y(o.docs.length-1));const d=c.data().message,C=c.data().userUid,k=c.data().userName,X=c.data().messageClock,F=c.data().messageClockNumber,L=(ie=c.data())==null?void 0:ie.profileColor,G=(ne=c.data())==null?void 0:ne.profileImageUrl;g.push({msg:d,type:"me",userUid:C,id:k,messageClockNumber:F,messageClock:X,conversation:null,profileColor:L,profileImageUrl:G})}),g.reverse(),i([...g,...e]),B(!1)},l=async g=>{const n=V(v,`chats_${g}`),h=K(n,O("messageClockNumber","desc"),Q(T),de(H||"")),o=await ee(h),c=[];o.docs.length||Y(o.docs.length),o.forEach((d,C)=>{c.length===o.docs.length-1&&(_(d),Y(o.docs.length-1));const k=d.data().message,X=d.data().userUid,F=d.data().userName,L=d.data().messageClock,G=d.data().messageClockNumber||0;c.push({msg:k,type:"me",userUid:X,id:F,messageClock:L,messageClockNumber:G})}),c.reverse(),i([...c,...e]),B(!1)};w?(j||!e.length)&&l(w):(j||!e.length)&&a()},[j,w]);const R=()=>{p.current.scrollTop!==0||j||(console.log("scroll"),B(!0))};return u.useEffect(()=>{var a;return(a=p.current)==null||a.addEventListener("scroll",R),()=>{var l;return(l=p.current)==null?void 0:l.removeEventListener("scroll",R)}},[j]),t.jsx(t.Fragment,{children:t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{ref:p,className:"p-1 border-t rounded-xl h-[60vh] overflow-auto",children:t.jsxs("ul",{children:[j&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((a,l)=>{let g;const n=new Date(a.messageClock);a.userUid===s.uid?g="text-right":g="text-left";let h,o;l>0&&(h=e[l-1].userUid),l<e.length-1&&e[l+1].userUid===s.uid&&(o=new Date(e[l+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let c,d=n.getHours(),C=(n.getMonth()+1).toString(),k=n.getDate().toString();return d>=13?(c="오후",d!==12&&(d=d-12)):(c="오전",d===0&&(d=d+12)),n.getMonth()+1<10&&(C="0"+C),k.length===1&&(k="0"+k),t.jsxs("li",{ref:l===J?M:null,className:g,children:[h!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:g==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(ce,{trigger:t.jsx(te,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>D({userUid:a.userUid,displayName:a.id})}),title:t.jsx(re,{}),content:t.jsx(fe,{initiateContinuing:()=>_(null),multiple:y,handleMultiple:x,user:U,userObj:s,handleMessagesList:i,displayedName:r})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(ce,{trigger:t.jsx(te,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>D({userUid:a.userUid,displayName:a.id})}),title:t.jsx(re,{}),content:t.jsx(fe,{initiateContinuing:()=>_(null),multiple:y,handleMultiple:x,user:U,userObj:s,handleMessagesList:i,displayedName:r})})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",C,"-",k," ",z==="ko"&&c," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),z==="en"&&(c==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",C,"-",k," ",z==="ko"&&c," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),z==="en"&&(c==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},l)}),t.jsx("li",{ref:M})]})})})})}const ye={ko:"메세지를 작성해 주세요",en:"Input message"},Ue={ko:"전송",en:"send"};function Ne({userObj:s,multiple:y,messages:x,handleMessages:e,messagesList:i,handleMessagesList:M}){const p=Z(m=>m.profileColor.value),U=Z(m=>m.profileUrl.value),$=se(),{state:r}=ae(),f=r==null?void 0:r.conversation,j=q(m=>m.languages.value),B=j==="ko"||j==="en"?j:"ko",H=async m=>{var l;m.preventDefault();const N=x,w=s.uid,z=s.displayName,S=Date.now(),D=new Date().toString();let T,b,R;r.chattingUid&&(T=E(v,`members/${r.chattingUid}`),b=await I(T),R=(l=b.data())==null?void 0:l.messagingToken);const a={msg:N,userUid:w,id:z,messageClockNumber:S,messageClock:D,conversation:f,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:U,sendingToken:R};y?a&&N&&(P.emit("piazzaMessage",a),J()):N&&(i.length!==0?(P.emit("message",a),console.log("message")):(P.emit("messageNew",a),console.log("messageNew")),Y(),W()),e("")},_=m=>{e(m.target.value)},J=async()=>{try{const m=x,N=s.uid,w=s.displayName,z=new Date().toString(),S=Date.now();m&&(await ge(V(v,"chats_group"),{userUid:N,userName:w,message:m,messageClock:z,messageClockNumber:S,profileImageUrl:U,profileColor:p,piazzaChecked:[s.uid]}),M(D=>[...D,{msg:m,type:"me",userUid:s.uid,id:s.displayName,messageClock:z,conversation:null,profileImageUrl:U,profileColor:p}]))}catch(m){console.log(m)}},Y=async()=>{var N,w,z;const m=x;try{const S=s.uid,D=s.displayName,T=Date.now(),b=new Date().toString();let R,a,l,g,n,h;if(r.userUid<r.chattingUid?(R=r.userUid,a=r.chattingUid,l=s.displayName,g=r.displayName,n=U,h=r.profileUrl):(R=r.chattingUid,a=r.userUid,l=r.displayName,g=s.displayName,n=r.profileUrl,h=U),!n){const o=E(v,`members/${R}`);n=(N=(await I(o)).data())==null?void 0:N.profileImageUrl}if(!h){const o=E(v,`members/${a}`);h=(w=(await I(o)).data())==null?void 0:w.profileImageUrl}if(m){const o={userUid:S,userName:D,message:m,messageClock:b,messageClockNumber:T,userOne:R,userTwo:a,userOneDisplayName:l,userTwoDisplayName:g,userOneProfileUrl:n,userTwoProfileUrl:h};await ge(V(v,`chats_${f}`),o);const c=E(v,`members/${S}`),C=(await I(c)).data().chattings||{},k=E(v,`members/${r.chattingUid}`),F=(await I(k)).data().chattings||{},L=((z=F[f])==null?void 0:z.messageCount)||0;C[f]=o,F[f]={...o,messageCount:L+1},await A(c,{chattings:C}),await A(k,{chattings:F}),M(G=>[...G,{msg:m,type:"me",userUid:s.uid,id:s.displayName,messageClock:b,conversation:f}])}}catch(S){console.log(S)}},W=async()=>{try{const m=s.uid,N=r.chattingUid,w=E(v,`members/${m}`),S=(await I(w)).data().conversation||[],D=E(v,`members/${N}`),b=(await I(D)).data().conversation||[];S.indexOf(f)===-1&&(await A(w,{conversation:[...S,f]}),$(ue())),b.indexOf(f)===-1&&await A(D,{conversation:[...b,f]})}catch(m){console.log(m)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:H,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ye[B],onChange:_,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ue[B]})]})})}const ze=xe(Ce)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Se(){const s=q(i=>i.languages.value),y=Z(i=>i.piazzaSwitch.value),x=se(),e=()=>{y==="true"?(window.localStorage.setItem("piazza","false"),x(me("false"))):(window.localStorage.setItem("piazza","true"),x(me("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ze,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:y==="true"})})]})}const pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},De=({multiple:s,displayName:y})=>{const x=q(i=>i.languages.value),e=x==="ko"||x==="en"?x:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(we,{title:s?pe[e][0]:`${pe[e][1]} ${y}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Se,{})})]})};function je({userObj:s}){const[y,x]=u.useState(""),[e,i]=u.useState([]),M=se(),{state:p}=ae(),[U,$]=u.useState(!0);u.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&$(p==null?void 0:p.multiple)},[]),u.useEffect(()=>{M(ke(5))});const r=p==null?void 0:p.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(De,{multiple:U,displayName:r}),t.jsx(ve,{userObj:s,multiple:U,handleMultiple:f=>$(f),messagesList:e,handleMessagesList:f=>i(f)}),t.jsx(Ne,{userObj:s,multiple:U,messages:y,handleMessages:f=>x(f),messagesList:e,handleMessagesList:f=>i(f)})]})}export{je as default};
