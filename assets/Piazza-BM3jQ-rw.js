import{u as O,c as ee,I as ce,aT as re,j as a,m as $,h as N,z as R,U as G,aY as me,g as ae,w as X,b1 as Ie,r as h,H as le,Q as pe,B as ue,a$ as Ue,P as he,b2 as xe,q as se,R as oe,S as ie,i as ne,aW as we,as as be,b3 as Pe,J as ve,x as je,b4 as Me,a7 as Ee}from"./index-DG1J3xgw.js";const ke={ko:"메세지를 작성해 주세요",en:"Input message"},ye={ko:"전송",en:"send"};function Te({chattingUser:s,userObj:l,multiple:k,messages:e,handleMessages:i,messagesList:P,handleMessagesList:p}){const S=O(m=>m.profileColor.value),_=O(m=>m.piazzaForm.value),f=ee(m=>m.profile.value),J=ce(),{state:D}=re(),z=D==null?void 0:D.conversation,F=ee(m=>m.languages.value),T=F==="ko"||F==="en"?F:"ko";console.log(s);const w=async m=>{var c;m.preventDefault();const U=e,E=l.uid,V=l.displayName,C=Date.now(),t=new Date().toString();let n,o,u;s&&(n=$(N,`members/${s.uid}`),o=await R(n),u=(c=o.data())==null?void 0:c.messagingToken);const r=f.profileImage?f.profileUrl:f.defaultProfile,d={msg:U,userUid:E,id:V,messageClockNumber:C,messageClock:t,conversation:z,conversationUid:s==null?void 0:s.uid,conversationName:s==null?void 0:s.displayName,profileUrl:r,sendingToken:u};k?d&&U&&(G.emit("piazzaMessage",d),I()):U&&(P.length!==0?(G.emit("message",d),console.log("message")):(G.emit("messageNew",d),console.log("messageNew")),M(),W()),i("")},j=m=>{i(m.target.value)},I=async()=>{try{const m=e,U=l.uid,E=l.displayName,V=new Date().toString(),C=Date.now(),t=f==null?void 0:f.profileImageUrl,n=f==null?void 0:f.defaultProfile,o=f==null?void 0:f.profileImage;m&&(await me(ae(N,"chats_group"),{userUid:U,userName:E,message:m,messageClock:V,messageClockNumber:C,profileImageUrl:t,defaultProfile:n,profileColor:S,piazzaChecked:[l.uid],profileImage:o}),p(u=>[...u,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:V,conversation:null,profileColor:S,messageClockNumber:C,defaultProfile:n,profileImageUrl:t,profileImage:o||!1}]))}catch(m){console.log(m)}},M=async()=>{var U,E,V;const m=e;try{const C=l.uid,t=l.displayName,n=Date.now(),o=new Date().toString(),u=f.profileImage,r=s.profileImage,d=f.profileImageUrl,c=s.profileImageUrl,g=f.defaultProfile,x=s.defaultProfile;let y,v,A,H,B,L,Z,q,K,Y;if(l.uid<s.uid?(y=l.uid,v=s.uid,A=l.displayName,H=s.displayName,B=d,L=c,Z=g,q=x,K=f.profileImage,Y=s.profileImage):(y=s.uid,v=l.uid,A=s.displayName,H=l.displayName,B=c,L=d,Z=x,q=g,K=s.profileImage,Y=f.profileImage),!B){const b=$(N,`members/${y}`);B=(U=(await R(b)).data())==null?void 0:U.profileImageUrl}if(!L){const b=$(N,`members/${v}`);L=(E=(await R(b)).data())==null?void 0:E.profileImageUrl}if(m){const b={userUid:C,userName:t,message:m,messageClock:o,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:Z,userTwoDefaultProfile:q,userOneProfileImage:K,userTwoProfileImage:Y};await me(ae(N,`chats_${z}`),b);const Q=$(N,`members/${C}`),ge=(await R(Q)).data().chattings||{},fe=$(N,`members/${s.uid}`),te=(await R(fe)).data().chattings||{},Se=((V=te[z])==null?void 0:V.messageCount)||0;ge[z]=b,te[z]={...b,messageCount:Se+1},await X(Q,{chattings:ge}),await X(fe,{chattings:te}),p(De=>[...De,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:o,conversation:z,userName:t,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:Z,userTwoDefaultProfile:q,userOneProfileImage:K,userTwoProfileImage:Y}])}}catch(C){console.log(C)}},W=async()=>{try{const m=l.uid,U=s.uid,E=$(N,`members/${m}`),C=(await R(E)).data().conversation||[],t=$(N,`members/${U}`),o=(await R(t)).data().conversation||[];C.indexOf(z)===-1&&(await X(E,{conversation:[...C,z]}),J(Ie())),o.indexOf(z)===-1&&await X(t,{conversation:[...o,z]})}catch(m){console.log(m)}};return a.jsx(a.Fragment,{children:_?a.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[T],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[T]})]}):a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[T],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[T]})]})})}const ze=({initiateContinuing:s,multiple:l,handleMultiple:k,user:e,userObj:i,handleMessagesList:P,displayedName:p})=>{const[S,_]=h.useState(null),f=ee(J=>J.languages.value);return h.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?_((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):_(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(le,{element:e,uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&a.jsx("div",{children:f==="ko"?a.jsxs("div",{children:["(",p,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(pe,{to:`${location.pathname}?id=${S}`,state:{element:e},children:a.jsx(ue,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),l&&i.uid!==(e==null?void 0:e.uid)&&a.jsx(pe,{to:`${location.pathname}?id=${S}`,state:{conversation:S,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(Ue,{children:a.jsx(ue,{variant:"outlined",onClick:()=>{P([]),k(!1),s()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:s,multiple:l,handleMultiple:k,messagesList:e,handleMessagesList:i}){const P=h.useRef(null),p=h.useRef(null),[S,_]=h.useState(null),[f,J]=h.useState(""),[D,z]=h.useState(!1),[F,T]=h.useState(null),[w,j]=h.useState(0);O(t=>t.profileColor.value),O(t=>t.profileUrl.value);const{state:I}=re(),M=(I==null?void 0:I.conversation)||"piazza",W=ee(t=>t.languages.value),m=async({userUid:t,displayName:n})=>{const o=$(N,`members/${t}`),r=(await R(o)).data();_(r),J(n)},U=({userUid:t,displayName:n})=>{var o;(o=document.getElementById("drawer"))==null||o.click(),m({userUid:t,displayName:n})},E=20;h.useEffect(()=>{if(!G)return;function t(n){const{msg:o,userUid:u,id:r,target:d,messageClock:c,messageClockNumber:g,profileImageUrl:x,defaultProfile:y,profileImage:v,conversation:A}=n;i(H=>[...H,{msg:o,type:d?"private":"other",userUid:u,id:r,messageClock:c,messageClockNumber:g,conversation:null,profileImageUrl:x,defaultProfile:y,profileImage:v}])}return G.on("sMessagePiazza",t),()=>{G.off("sMessagePiazza",t)}},[]),h.useEffect(()=>{if(!G)return;function t(n){const{msg:o,userUid:u,id:r,target:d,messageClock:c,messageClockNumber:g,conversation:x,piazzaData:y}=n;i(v=>[...v,{msg:o,type:d?"private":"other",userUid:u,id:r,messageClock:c,messageClockNumber:g,conversation:null,...y}])}return G.on(`sMessage${M}`,t),()=>{G.off(`sMessage${M}`,t)}},[]),h.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),h.useEffect(()=>{V(),(async()=>{if(l){const n=ae(N,"chats_group"),o=se(n,ie("messageClockNumber","desc"),oe(1));(await ne(o)).forEach(async r=>{const d=$(N,`chats_group/${r.id}`),g=(await R(d)).data(),x=g.piazzaChecked||[];x.indexOf(s.uid)===-1&&(x.splice(-1,s.uid,0),x.push(s.uid),await X(d,{...g,piazzaChecked:x}))})}else{const n=$(N,`members/${s.uid}`),u=(await R(n)).data().chattings;u[M]&&(u[M].messageCount=0),await X(n,{chattings:u})}})()},[e]);const V=()=>{var t;(t=P.current)==null||t.scrollIntoView()};h.useEffect(()=>{const t=async()=>{const o=[],u=ae(N,"chats_group"),r=se(u,ie("messageClockNumber","desc"),oe(E),we(F||"")),d=await ne(r);d.docs.length||j(d.docs.length),d.forEach(c=>{var q,K,Y,b;o.length===d.docs.length-1&&(T(c),j(d.docs.length-1));const g=c.data().message,x=c.data().userUid,y=c.data().userName,v=c.data().messageClock,A=c.data().messageClockNumber;(q=c.data())==null||q.profileColor;const H=(K=c.data())==null?void 0:K.profileImageUrl,B=(Y=c.data())==null?void 0:Y.defaultProfile,L=(b=c.data())==null?void 0:b.profileImage,Z=c.data();o.push({msg:g,userUid:x,id:y,messageClockNumber:A,messageClock:v,conversation:null,profileImageUrl:H,defaultProfile:B,profileImage:L||!1,...Z})}),o.reverse(),i([...o,...e]),z(!1)},n=async o=>{const u=ae(N,`chats_${o}`),r=se(u,ie("messageClockNumber","desc"),oe(E),we(F||"")),d=await ne(r),c=[];d.docs.length||j(d.docs.length),d.forEach((g,x)=>{var Y,b,Q;c.length===d.docs.length-1&&(T(g),j(d.docs.length-1));const y=g.data().message,v=g.data().userUid,A=g.data().userName,H=g.data().messageClock,B=g.data().messageClockNumber||0,L=(Y=g.data())==null?void 0:Y.profileImageUrl,Z=(b=g.data())==null?void 0:b.defaultProfile,q=(Q=g.data())==null?void 0:Q.profileImage,K=g.data();c.push({msg:y,userUid:v,id:A,messageClockNumber:B,messageClock:H,conversation:null,profileImageUrl:L,defaultProfile:Z,profileImage:q||!1,...K})}),c.reverse(),i([...c,...e]),z(!1)};M==="piazza"?(D||!e.length)&&t():(D||!e.length)&&n(M)},[D,M]);const C=()=>{p.current.scrollTop!==0||D||(console.log("scroll"),z(!0))};return h.useEffect(()=>{var t;return(t=p.current)==null||t.addEventListener("scroll",C),()=>{var n;return(n=p.current)==null?void 0:n.removeEventListener("scroll",C)}},[D]),console.log(e),a.jsx(a.Fragment,{children:a.jsx(a.Fragment,{children:a.jsx("div",{ref:p,className:"p-1 border-t rounded-xl overflow-auto",children:a.jsxs("ul",{children:[D&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((t,n)=>{let o;l?o=t:(console.log(t.userUid===s.uid),t.userUid===t.userOne?o={userUid:t.userOne,id:t.userOneDisplayName,profileImage:t.userOneProfileImage,defaultProfile:t.userOneDefaultProfile,profileImageUrl:t.userOneProfileUrl}:o={userUid:t.userTwo,id:t.userTwoDisplayName,profileImage:t.userTwoProfileImage,defaultProfile:t.userTwoDefaultProfile,profileImageUrl:t.userTwoProfileUrl});let u;const r=new Date(t.messageClock);t.userUid===s.uid?u="text-right":u="text-left";let d,c;n>0&&(d=e[n-1].userUid),n<e.length-1&&e[n+1].userUid===s.uid&&(c=new Date(e[n+1].messageClock),r.getFullYear()===c.getFullYear()&&r.getMonth()===c.getMonth()&&r.getDate()===c.getDate()&&r.getHours()===c.getHours()&&(r.getMinutes(),c.getMinutes()));let g,x=r.getHours(),y=(r.getMonth()+1).toString(),v=r.getDate().toString();return x>=13?(g="오후",x!==12&&(x=x-12)):(g="오전",x===0&&(x=x+12)),r.getMonth()+1<10&&(y="0"+y),v.length===1&&(v="0"+v),a.jsxs("li",{ref:n===w?P:null,className:u,children:[d!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==s.uid?"start":"end"}`,children:u==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(he,{trigger:a.jsx(le,{element:o,piazza:()=>U({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>T(null),multiple:l,handleMultiple:k,user:S,userObj:s,handleMessagesList:i,displayedName:f})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(he,{trigger:a.jsx(le,{element:o,piazza:()=>U({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>T(null),multiple:l,handleMultiple:k,user:S,userObj:s,handleMessagesList:i,displayedName:f})})]})})}),t.userUid!==s.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",W==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),W==="en"&&(g==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",W==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),W==="en"&&(g==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},n)}),a.jsx("li",{ref:P})]})})})})}function $e({isKeyboardOpen:s,userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:P}){return a.jsx(a.Fragment,{children:s?a.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:P})}):a.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:P})})})}const Re=be(Pe)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Fe(){const s=ee(i=>i.languages.value),l=O(i=>i.piazzaSwitch.value),k=ce(),e=()=>{l==="true"?(window.localStorage.setItem("piazza","false"),k(ve("false"))):(window.localStorage.setItem("piazza","true"),k(ve("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Re,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:l==="true"})})]})}const Ce={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Ve=({multiple:s,displayName:l})=>{const k=ee(i=>i.languages.value),e=k==="ko"||k==="en"?k:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(je,{icon:a.jsx(Me,{}),title:s?Ce[e][0]:`${Ce[e][1]} ${l}`}),s&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx(Fe,{})})]})};function Le({userObj:s}){const[l,k]=h.useState(""),[e,i]=h.useState([]),P=ce(),{state:p}=re(),[S,_]=h.useState(!0),[f,J]=h.useState(!1),[D,z]=h.useState(null);h.useEffect(()=>{const w=async()=>{if(p.chattingUid){const j=$(N,`members/${p.chattingUid}`),I=await R(j);z(I.data())}};p.multiple||w()},[p]);const F=O(w=>w.piazzaForm.value);h.useEffect(()=>{var j;const w=()=>{var M;const I=window.screen.height-300>(((M=window.visualViewport)==null?void 0:M.height)||window.screen.height);f!==I&&J(I)};return window.addEventListener("resize",w),typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.addEventListener("resize",w)),visualViewport==null||visualViewport.addEventListener("resize",w),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",w)),()=>{var I;typeof visualViewport<"u"&&((I=window.visualViewport)==null||I.removeEventListener("resize",w))}},[f]),h.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&_(p==null?void 0:p.multiple)},[]),h.useEffect(()=>{P(Ee(5))});const T=p==null?void 0:p.displayName;return console.log(p),console.log(D),a.jsxs(a.Fragment,{children:[!f&&a.jsx(Ve,{multiple:S,displayName:T}),a.jsx($e,{isKeyboardOpen:F,userObj:s,multiple:S,handleMultiple:w=>_(w),messagesList:e,handleMessagesList:w=>i(w)}),a.jsx(Te,{chattingUser:D,userObj:s,multiple:S,messages:l,handleMessages:w=>k(w),messagesList:e,handleMessagesList:w=>i(w)})]})}export{Le as default};
