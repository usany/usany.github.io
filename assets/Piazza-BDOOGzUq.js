import{r as h,j as s,N as J,v as ha,bl as xa,M as Y,a8 as O,bm as K,aY as ua,aP as Na,O as wa,Q as ya,S as Ca,a1 as L,V as x,a2 as _,a3 as Ua,a4 as F,a5 as H,U as y,W as C,$ as R,aO as X,bn as va}from"./index-BqqFVuG5.js";import{a as ka,b as Sa,D as Da,w as D}from"./webSocket-Do-bPuCO.js";import{A as za}from"./Avatar-BUUXz-nz.js";import{B as V}from"./Button-B-s51mRQ.js";import"./useSlot-BBCABK9P.js";const Ma=({multiple:t,selectUser:U,user:a,handleClose:v,userObj:r,handleMsgList:k,handleChangeMessage:E,displayedName:b})=>{const[T,P]=h.useState(null);return h.useEffect(()=>{U&&((a==null?void 0:a.uid)<r.uid?P((a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):P(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])))},[U]),s.jsxs(ka,{open:U,onClose:v,children:[s.jsxs(Sa,{children:[s.jsx("div",{children:s.jsx(za,{alt:a==null?void 0:a.displayName,sx:{bgcolor:(a==null?void 0:a.profileColor)||"#2196f3"},src:(a==null?void 0:a.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:a==null?void 0:a.displayName}),(a==null?void 0:a.displayName)!==b&&s.jsxs("div",{children:["(",b,"에서 개명)"]})]}),s.jsxs(Da,{children:[s.jsx(J,{to:"/profile",state:{element:a},children:s.jsx(V,{variant:"outlined",onClick:()=>{v()},children:"프로필 확인"})}),t&&r.uid!==(a==null?void 0:a.uid)&&s.jsx(J,{to:"/piazza",state:{conversation:T,displayName:a==null?void 0:a.displayName,userUid:r.uid,chattingUid:a==null?void 0:a.uid,multiple:!1,profileUrl:a==null?void 0:a.profileImageUrl},children:s.jsx(V,{variant:"outlined",onClick:()=>{k([]),E(!0),v()},children:"개인 대화"})}),s.jsx(V,{variant:"outlined",onClick:()=>{v()},children:"닫기"})]})]})},$a=ha(xa)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function ba(){const t=Y(v=>v.piazzaSwitch.value),U=O(),a=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),U(K("false"))):(window.localStorage.setItem("piazza","true"),U(K("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx($a,{onClick:()=>a(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}function Pa({userObj:t}){const U=h.useRef(null),[a,v]=h.useState(""),[r,k]=h.useState([]),[E,b]=h.useState(!0),[T,P]=h.useState(""),[aa,ea]=h.useState(null),[sa,Z]=h.useState(!1),A=Y(e=>e.profileColor.value),j=Y(e=>e.profileUrl.value),[ta,ia]=h.useState(null),q=O(),{state:o}=ua(),I=o==null?void 0:o.multiple,u=o==null?void 0:o.conversation;h.useEffect(()=>{if(!D)return;function e(n){const{msg:i,userUid:l,id:c,target:g,messageClock:m,messageClockNumber:d,conversation:f}=n;k(p=>[...p,{msg:i,type:g?"private":"other",userUid:l,id:c,messageClock:m,messageClockNumber:d,conversation:null,profileImageUrl:j,profileColor:A}])}return D.on("sMessagePiazza",e),()=>{D.off("sMessagePiazza",e)}},[]),h.useEffect(()=>{if(!D)return;function e(n){const{msg:i,userUid:l,id:c,target:g,messageClock:m,messageClockNumber:d,conversation:f}=n;k(p=>[...p,{msg:i,type:g?"private":"other",userUid:l,id:c,messageClock:m,messageClockNumber:d,conversation:null}])}return D.on(`sMessage${u}`,e),()=>{D.off(`sMessage${u}`,e)}},[]),h.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),h.useEffect(()=>{oa(),(async()=>{if(I){const n=L(x,"chats_group"),i=_(n,F("messageClockNumber","desc"),Ua(1));(await H(i)).forEach(async c=>{const g=y(x,`chats_group/${c.id}`),d=(await C(g)).data(),f=d.piazzaChecked||[];f.indexOf(t.uid)===-1&&(f.push(t.uid),await R(g,{...d,piazzaChecked:f}))})}else{const n=y(x,`members/${t.uid}`),l=(await C(n)).data().chattings;l[u].messageCount=0,await R(n,{chattings:l})}})()},[r]),h.useEffect(()=>{q(Na(5))});const oa=()=>{var e;(e=U.current)==null||e.scrollIntoView()},na=async e=>{var w;e.preventDefault();const n=a,i=t.uid,l=t.displayName,c=Date.now(),g=new Date().toString(),m=y(x,`members/${o.chattingUid}`),f=(w=(await C(m)).data())==null?void 0:w.messagingToken,p={msg:n,userUid:i,id:l,messageClockNumber:c,messageClock:g,target:T,conversation:u,conversationUid:o.chattingUid,conversationName:o.displayName,profileUrl:j,sendingToken:f};I?p&&n&&(D.emit("piazzaMessage",p),ma()):n&&(r.length!==0?(D.emit("message",p),console.log("message")):(D.emit("messageNew",p),console.log("messageNew")),ra(),ga()),v("")},ca=e=>{v(e.target.value)},la=async({userUid:e,displayName:n})=>{const i=y(x,`members/${e}`),c=(await C(i)).data();ea(c),Z(!0),ia(n)},da=()=>{Z(!1)},ma=async()=>{try{const e=a,n=t.uid,i=t.displayName,l=new Date().toString(),c=Date.now();e&&(await X(L(x,"chats_group"),{userUid:n,userName:i,message:e,messageClock:l,messageClockNumber:c,profileImageUrl:j,profileColor:A,piazzaChecked:[t.uid]}),k(g=>[...g,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:l,conversation:null,profileImageUrl:j,profileColor:A}]))}catch(e){console.log(e)}};h.useEffect(()=>{E&&(I?((async()=>{const i=[],l=L(x,"chats_group"),c=_(l,F("messageClockNumber"));(await H(c)).forEach(m=>{var N,$;const d=m.data().message,f=m.data().userUid,p=m.data().userName,w=m.data().messageClock,z=m.data().messageClockNumber,S=(N=m.data())==null?void 0:N.profileColor,M=($=m.data())==null?void 0:$.profileImageUrl;i.push({msg:d,type:"me",userUid:f,id:p,messageClockNumber:z,messageClock:w,conversation:null,profileColor:S,profileImageUrl:M}),k(i)})})(),b(!1)):((async i=>{const l=L(x,`chats_${i}`),c=_(l,F("messageClockNumber")),g=await H(c),m=[];g.forEach(d=>{const f=d.data().message,p=d.data().userUid,w=d.data().userName,z=d.data().messageClock,S=d.data().messageClockNumber||0;m.push({msg:f,type:"me",userUid:p,id:w,messageClock:z,messageClockNumber:S}),k(m)})})(u),b(!1)))},[E]);const ra=async()=>{var n,i,l;const e=a;try{const c=t.uid,g=t.displayName,m=Date.now(),d=new Date().toString();let f,p,w,z,S,M;if(o.userUid<o.chattingUid?(f=o.userUid,p=o.chattingUid,w=t.displayName,z=o.displayName,S=j,M=o.profileUrl):(f=o.chattingUid,p=o.userUid,w=o.displayName,z=t.displayName,S=o.profileUrl,M=j),!S){const N=y(x,`members/${f}`);S=(n=(await C(N)).data())==null?void 0:n.profileImageUrl}if(!M){const N=y(x,`members/${p}`);M=(i=(await C(N)).data())==null?void 0:i.profileImageUrl}if(e){const N={userUid:c,userName:g,message:e,messageClock:d,messageClockNumber:m,userOne:f,userTwo:p,userOneDisplayName:w,userTwoDisplayName:z,userOneProfileUrl:S,userTwoProfileUrl:M};console.log(N),await X(L(x,`chats_${u}`),N);const $=y(x,`members/${c}`),W=(await C($)).data().chattings||{},G=y(x,`members/${o.chattingUid}`),B=(await C(G)).data().chattings||{},pa=((l=B[u])==null?void 0:l.messageCount)||0;W[u]=N,B[u]={...N,messageCount:pa+1},await R($,{chattings:W}),await R(G,{chattings:B}),k(fa=>[...fa,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:d,conversation:u}])}}catch(c){console.log(c)}},ga=async()=>{try{const e=t.uid,n=o.chattingUid,i=y(x,`members/${e}`),c=(await C(i)).data().conversation||[],g=y(x,`members/${n}`),d=(await C(g)).data().conversation||[];c.indexOf(u)===-1&&(await R(i,{conversation:[...c,u]}),q(va())),d.indexOf(u)===-1&&await R(g,{conversation:[...d,u]})}catch(e){console.log(e)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"flex text-2xl p-5",children:[s.jsx("div",{className:"w-screen",children:I?"단체 대화":`개인 대화 ${o==null?void 0:o.displayName}`}),I&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(ba,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[r.map((e,n)=>{if(e.type==="welcome")return s.jsxs("li",{className:"welcome",children:[s.jsx("div",{className:"line"}),s.jsx("div",{children:e.msg}),s.jsx("div",{className:"line"})]});{let i;return e.userUid===t.uid?i="me":i="other",s.jsxs("li",{className:i,name:e.id,"data-id":e.id,children:[s.jsx("div",{className:`flex justify-${e.userUid!==t.uid?"start":"end"}`,children:s.jsxs(wa,{onClick:()=>la({userUid:e.userUid,displayName:e.id}),className:"bg-profile-blue",children:[s.jsx(ya,{src:e.profileImageUrl}),s.jsx(Ca,{className:"text-xl border-none	",children:e.id[0]})]})}),s.jsx("div",{className:e.id===T?"private-user":"userId","data-id":e.id,name:e.id,children:e.id}),e.userUid!==t.uid?s.jsxs("div",{className:"flex justify-start",children:[s.jsx("div",{className:"other","data-id":e.id,name:e.id,children:e.msg}),s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock})]}):s.jsxs("div",{className:"flex justify-end",children:[s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock}),s.jsx("div",{className:"me","data-id":e.id,name:e.id,children:e.msg})]})]},`${n}_li`)}}),s.jsx("li",{ref:U})]}),s.jsxs("form",{className:"send-form",onSubmit:na,children:[s.jsx("input",{placeholder:"메세지를 작성해 주세요",onChange:ca,value:a,autoFocus:!0}),s.jsx("button",{type:"submit",children:"전송"})]})]}),s.jsx(Ma,{multiple:I,selectUser:sa,user:aa,handleClose:da,userObj:t,handleMsgList:e=>k(e),handleChangeMessage:e=>b(e),displayedName:ta})]})})]})}export{Pa as default};
