import{r as f,j as s,aR as ra,N as W,v as pa,bl as fa,M as V,a8 as J,bm as Y,aZ as ha,aP as xa,O as Na,Q as ya,S as wa,a1 as I,V as N,a2 as B,a3 as Ca,a4 as _,a5 as F,U,W as k,$,aO as G,bn as ua}from"./index-CgopwaNM.js";import{D as va,a as Ua,B as H}from"./DialogContent-rGCRu4to.js";import{D as ka,w as v}from"./webSocket-DJLUT5Le.js";const Da=({multiple:t,selectUser:w,user:a,handleClose:C,userObj:r,handleMsgList:u,handleChangeMessage:L,displayedName:S})=>{const[E,T]=f.useState(null);return f.useEffect(()=>{w&&((a==null?void 0:a.uid)<r.uid?T((a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):T(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])))},[w]),s.jsxs(va,{open:w,onClose:C,children:[s.jsxs(Ua,{children:[s.jsx("div",{children:s.jsx(ra,{alt:a==null?void 0:a.displayName,sx:{bgcolor:(a==null?void 0:a.profileColor)||"#2196f3"},src:(a==null?void 0:a.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:a==null?void 0:a.displayName}),(a==null?void 0:a.displayName)!==S&&s.jsxs("div",{children:["(",S,"에서 개명)"]})]}),s.jsxs(ka,{children:[s.jsx(W,{to:"/profile",state:{element:a},children:s.jsx(H,{variant:"outlined",onClick:()=>{C()},children:"프로필 확인"})}),t&&r.uid!==(a==null?void 0:a.uid)&&s.jsx(W,{to:"/piazza",state:{conversation:E,displayName:a==null?void 0:a.displayName,userUid:r.uid,chattingUid:a==null?void 0:a.uid,multiple:!1,profileUrl:a==null?void 0:a.profileImageUrl},children:s.jsx(H,{variant:"outlined",onClick:()=>{u([]),L(!0),C()},children:"개인 대화"})}),s.jsx(H,{variant:"outlined",onClick:()=>{C()},children:"닫기"})]})]})},Sa=pa(fa)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function za(){const t=V(C=>C.piazzaSwitch.value),w=J(),a=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),w(Y("false"))):(window.localStorage.setItem("piazza","true"),w(Y("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(Sa,{onClick:()=>a(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}function ba({userObj:t}){const w=f.useRef(null),[a,C]=f.useState(""),[r,u]=f.useState([]),[L,S]=f.useState(!0),[E,T]=f.useState(""),[K,X]=f.useState(null),[O,Z]=f.useState(!1),P=V(e=>e.profileColor.value),z=V(e=>e.profileUrl.value),[aa,ea]=f.useState(null),q=J(),{state:n}=ha(),M=n==null?void 0:n.multiple,x=n==null?void 0:n.conversation;f.useEffect(()=>{if(!v)return;function e(i){const{msg:o,userUid:m,id:d,target:g,messageClock:c,messageClockNumber:l,conversation:h}=i;u(p=>[...p,{msg:o,type:g?"private":"other",userUid:m,id:d,messageClock:c,messageClockNumber:l,conversation:null,profileImageUrl:z,profileColor:P}])}return v.on("sMessagePiazza",e),()=>{v.off("sMessagePiazza",e)}},[]),f.useEffect(()=>{if(!v)return;function e(i){const{msg:o,userUid:m,id:d,target:g,messageClock:c,messageClockNumber:l,conversation:h}=i;u(p=>[...p,{msg:o,type:g?"private":"other",userUid:m,id:d,messageClock:c,messageClockNumber:l,conversation:null}])}return v.on(`sMessage${x}`,e),()=>{v.off(`sMessage${x}`,e)}},[]),f.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),f.useEffect(()=>{sa(),(async()=>{if(M){const i=I(N,"chats_group"),o=B(i,_("messageClockNumber","desc"),Ca(1));(await F(o)).forEach(async d=>{const g=U(N,`chats_group/${d.id}`),l=(await k(g)).data(),h=l.piazzaChecked||[];h.indexOf(t.uid)===-1&&(h.push(t.uid),await $(g,{...l,piazzaChecked:h}))})}else{const i=U(N,`members/${t.uid}`),m=(await k(i)).data().chattings;m[x].messageCount=0,await $(i,{chattings:m})}})()},[r]),f.useEffect(()=>{q(xa(5))});const sa=()=>{var e;(e=w.current)==null||e.scrollIntoView()},ta=async e=>{var y;e.preventDefault();const i=a,o=t.uid,m=t.displayName,d=Date.now(),g=new Date().toString(),c=U(N,`members/${n.chattingUid}`),h=(y=(await k(c)).data())==null?void 0:y.messagingToken,p={msg:i,userUid:o,id:m,messageClockNumber:d,messageClock:g,target:E,conversation:x,conversationUid:n.chattingUid,conversationName:n.displayName,profileUrl:z,sendingToken:h};M?p&&i&&(v.emit("message",p),ca()):i&&(r.length!==0?(v.emit("message",p),console.log("message")):(v.emit("messageNew",p),console.log("messageNew")),la(),da()),C("")},ia=e=>{C(e.target.value)},oa=async({userUid:e,displayName:i})=>{const o=U(N,`members/${e}`),d=(await k(o)).data();X(d),Z(!0),ea(i)},na=()=>{Z(!1)},ca=async()=>{try{const e=a,i=t.uid,o=t.displayName,m=new Date().toString(),d=Date.now();e&&(await G(I(N,"chats_group"),{userUid:i,userName:o,message:e,messageClock:m,messageClockNumber:d,profileImageUrl:z,profileColor:P,piazzaChecked:[t.uid]}),u(g=>[...g,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileImageUrl:z,profileColor:P}]))}catch(e){console.log(e)}};f.useEffect(()=>{L&&(M?((async()=>{const o=[],m=I(N,"chats_group"),d=B(m,_("messageClockNumber"));(await F(d)).forEach(c=>{var R,b;const l=c.data().message,h=c.data().userUid,p=c.data().userName,y=c.data().messageClock,D=c.data().messageClockNumber,j=(R=c.data())==null?void 0:R.profileColor,Q=(b=c.data())==null?void 0:b.profileImageUrl;o.push({msg:l,type:"me",userUid:h,id:p,messageClockNumber:D,messageClock:y,conversation:null,profileColor:j,profileImageUrl:Q}),u(o)})})(),S(!1)):((async o=>{const m=I(N,`chats_${o}`),d=B(m,_("messageClockNumber")),g=await F(d),c=[];g.forEach(l=>{const h=l.data().message,p=l.data().userUid,y=l.data().userName,D=l.data().messageClock,j=l.data().messageClockNumber||0;c.push({msg:h,type:"me",userUid:p,id:y,messageClock:D,messageClockNumber:j}),u(c)})})(x),S(!1)))},[L]);const la=async()=>{const e=a;try{const i=t.uid,o=t.displayName,m=Date.now(),d=new Date().toString();let g,c,l,h,p,y;if(n.userUid<n.chattingUid?(g=n.userUid,c=n.chattingUid,l=t.displayName,h=n.displayName,p=z,y=n.profileUrl):(g=n.chattingUid,c=n.userUid,l=n.displayName,h=t.displayName,p=n.profileUrl,y=z),e){const D={userUid:i,userName:o,message:e,messageClock:d,messageClockNumber:m,userOne:g,userTwo:c,userOneDisplayName:l,userTwoDisplayName:h,userOneProfileUrl:p,userTwoProfileUrl:y};await G(I(N,`chats_${x}`),D);const j=U(N,`members/${i}`),R=(await k(j)).data().chattings||{},b=U(N,`members/${n.chattingUid}`),A=(await k(b)).data().chattings||{},ma=A[x].messageCount||0;R[x]=D,A[x]={...D,messageCount:ma+1},await $(j,{chattings:R}),await $(b,{chattings:A}),u(ga=>[...ga,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:d,conversation:x}])}}catch(i){console.log(i)}},da=async()=>{try{const e=t.uid,i=n.chattingUid,o=U(N,`members/${e}`),d=(await k(o)).data().conversation||[],g=U(N,`members/${i}`),l=(await k(g)).data().conversation||[];d.indexOf(x)===-1&&(await $(o,{conversation:[...d,x]}),q(ua())),l.indexOf(x)===-1&&await $(g,{conversation:[...l,x]})}catch(e){console.log(e)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"flex text-2xl p-5",children:[s.jsx("div",{className:"w-screen",children:M?"단체 대화":`개인 대화 ${n==null?void 0:n.displayName}`}),M&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(za,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[r.map((e,i)=>{if(e.type==="welcome")return s.jsxs("li",{className:"welcome",children:[s.jsx("div",{className:"line"}),s.jsx("div",{children:e.msg}),s.jsx("div",{className:"line"})]});{let o;return e.userUid===t.uid?o="me":o="other",s.jsxs("li",{className:o,name:e.id,"data-id":e.id,children:[s.jsx("div",{className:`flex justify-${e.userUid!==t.uid?"start":"end"}`,children:s.jsxs(Na,{onClick:()=>oa({userUid:e.userUid,displayName:e.id}),className:"bg-profile-blue",children:[s.jsx(ya,{src:e.profileImageUrl}),s.jsx(wa,{className:"text-xl border-none	",children:e.id[0]})]})}),s.jsx("div",{className:e.id===E?"private-user":"userId","data-id":e.id,name:e.id,children:e.id}),e.userUid!==t.uid?s.jsxs("div",{className:"flex justify-start",children:[s.jsx("div",{className:"other","data-id":e.id,name:e.id,children:e.msg}),s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock})]}):s.jsxs("div",{className:"flex justify-end",children:[s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock}),s.jsx("div",{className:"me","data-id":e.id,name:e.id,children:e.msg})]})]},`${i}_li`)}}),s.jsx("li",{ref:w})]}),s.jsxs("form",{className:"send-form",onSubmit:ta,children:[s.jsx("input",{placeholder:"메세지를 작성해 주세요",onChange:ia,value:a,autoFocus:!0}),s.jsx("button",{type:"submit",children:"전송"})]})]}),s.jsx(Da,{multiple:M,selectUser:O,user:K,handleClose:na,userObj:t,handleMsgList:e=>u(e),handleChangeMessage:e=>S(e),displayedName:aa})]})})]})}export{ba as default};
