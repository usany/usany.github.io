import{c as Ue,u as le,d as se,G as xe,j as e,P as me,a0 as ve,b8 as we,b7 as pe,b0 as $e,x as Y,p as R,O,a4 as f,b4 as ye,n as oe,E as te,b9 as Ve,a_ as Me,r as a,W as he,a1 as Ce,B as Q,ba as ke,q as de,a2 as fe,a3 as ge,t as ue,b2 as ze,s as Ae,S as Fe,X as Se,H as Be,bb as Le,aN as Te,af as He,bc as je,bd as Ne,be as De,bf as Ie}from"./index-BDFzuCPa.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ue("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Ue("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Oe={ko:"메세지를 작성해 주세요",en:"Input message"},qe={ko:"전송",en:"send"};function Ge({chattingUser:c,userObj:t,multiple:r,messages:C,handleMessages:w,messagesList:$,handleMessagesList:T}){const j=le(i=>i.profileColor.value),E=le(i=>i.piazzaForm.value),d=se(i=>i.profile.value),V=xe(),x=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",N=se(i=>i.languages.value),M=N==="ko"||N==="en"?N:"ko",b=async i=>{var s;i.preventDefault();const S=C,P=t.uid,g=t.displayName,y=Date.now(),z=new Date().toString(),U=d==null?void 0:d.profileImageUrl,n=d==null?void 0:d.defaultProfile,p=d==null?void 0:d.profileImage;let m,v,u;c&&(m=Y(R,`members/${c.uid}`),v=await O(m),u=(s=v.data())==null?void 0:s.messagingToken);const h=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const o={msg:S,userUid:P,id:g,messageClockNumber:y,messageClock:z,conversation:x,conversationUid:c==null?void 0:c.uid,conversationName:c==null?void 0:c.displayName,profileImage:p,defaultProfile:n,profileImageUrl:U,profileUrl:h,sendingToken:u};r?o&&S&&(f.emit("piazzaMessage",o),F()):S&&($.length!==0?(f.emit("message",o),console.log("message")):(f.emit("messageNew",o),console.log("messageNew")),D(),L()),w("")},Z=i=>{w(i.target.value)},F=async()=>{try{const i=C,S=t.uid,P=t.displayName,g=new Date().toString(),y=Date.now(),z=d==null?void 0:d.profileImageUrl,U=d==null?void 0:d.defaultProfile,n=d==null?void 0:d.profileImage;i&&(await ye(oe(R,"chats_group"),{userUid:S,userName:P,message:i,messageClock:g,messageClockNumber:y,profileImageUrl:z,defaultProfile:U,profileColor:j,piazzaChecked:[t.uid],profileImage:n}),T(p=>[...p,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:g,conversation:null,profileColor:j,messageClockNumber:y,defaultProfile:U,profileImageUrl:z,profileImage:n||!1}]))}catch(i){console.log(i)}},D=async()=>{var S,P,g;const i=C;try{const y=t.uid,z=t.displayName,U=Date.now(),n=new Date().toString(),p=d.profileImage,m=c.profileImage,v=d.profileImageUrl,u=c.profileImageUrl,h=d.defaultProfile,o=c.defaultProfile;let s,l,k,I,B,A,q,X,J,W;if(t.uid<c.uid?(s=t.uid,l=c.uid,k=t.displayName,I=c.displayName,B=v,A=u,q=h,X=o,J=d.profileImage,W=c.profileImage):(s=c.uid,l=t.uid,k=c.displayName,I=t.displayName,B=u,A=v,q=o,X=h,J=c.profileImage,W=d.profileImage),!B){const H=Y(R,`members/${s}`);B=(S=(await O(H)).data())==null?void 0:S.profileImageUrl}if(!A){const H=Y(R,`members/${l}`);A=(P=(await O(H)).data())==null?void 0:P.profileImageUrl}if(i){const H={userUid:y,userName:z,message:i,messageClock:n,messageClockNumber:U,userOne:s,userTwo:l,userOneDisplayName:k,userTwoDisplayName:I,userOneProfileUrl:B,userTwoProfileUrl:A,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W};await ye(oe(R,`chats_${x}`),H);const G=Y(R,`members/${y}`),ae=(await O(G)).data().chattings||{},ie=Y(R,`members/${c.uid}`),ee=(await O(ie)).data().chattings||{},ce=((g=ee[x])==null?void 0:g.messageCount)||0;ae[x]=H,ee[x]={...H,messageCount:ce+1},await te(G,{chattings:ae}),await te(ie,{chattings:ee}),T(Re=>[...Re,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:n,conversation:x,userName:z,messageClockNumber:U,userOne:s,userTwo:l,userOneDisplayName:k,userTwoDisplayName:I,userOneProfileUrl:B,userTwoProfileUrl:A,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W}])}}catch(y){console.log(y)}},L=async()=>{try{const i=t.uid,S=c.uid,P=Y(R,`members/${i}`),y=(await O(P)).data().conversation||[],z=Y(R,`members/${S}`),n=(await O(z)).data().conversation||[];y.indexOf(x)===-1&&(await te(P,{conversation:[...y,x]}),V(Ve())),n.indexOf(x)===-1&&await te(z,{conversation:[...n,x]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${E?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:b,children:[x&&x!=="piazza"&&e.jsx(me,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_e,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Oe[M],onChange:Z,value:C,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:qe[M]})]})}const be=({initiateContinuing:c,user:t,userObj:r,handleMessagesList:C,displayedName:w,handleChatUid:$,handleChatDisplayName:T})=>{const{state:j}=Me(),E=(j==null?void 0:j.conversation)||"piazza",d=se(N=>N.languages.value),[V,x]=a.useState("");return a.useEffect(()=>{t&&((t==null?void 0:t.uid)<r.uid?x((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):x(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:r.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==w&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",w,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(Q,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),E==="piazza"&&r.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${V}`,state:{conversation:V,displayName:t==null?void 0:t.displayName,userUid:r.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(Q,{variant:"outlined",onClick:()=>{C([]),c()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ee({userObj:c,messagesList:t,handleMessagesList:r,handleChatUid:C,handleChatDisplayName:w}){const $=a.useRef(null),T=a.useRef(null),[j,E]=a.useState(null),[d,V]=a.useState(""),[x,N]=a.useState(!1),[M,b]=a.useState(null),[Z,F]=a.useState(0),[D,L]=a.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";a.useEffect(()=>{(D!==i||i==="piazza")&&(r([]),b(null),F(0),L(i))},[i]);const S=se(n=>n.languages.value),P=async({userUid:n,displayName:p})=>{const m=Y(R,`members/${n}`),u=(await O(m)).data();E(u),V(p),console.log("practice")},g=({userUid:n,displayName:p})=>{var m;(m=document.getElementById("drawer"))==null||m.click(),P({userUid:n,displayName:p})},y=20;a.useEffect(()=>{if(!f)return;function n(p){const{msg:m,userUid:v,id:u,target:h,messageClock:o,messageClockNumber:s,profileImageUrl:l,defaultProfile:k,profileImage:I,conversation:B}=p;r(A=>[...A,{msg:m,type:h?"private":"other",userUid:v,id:u,messageClock:o,messageClockNumber:s,conversation:null,profileImageUrl:l,defaultProfile:k,profileImage:I}])}return f.on("sMessagePiazza",n),()=>{f.off("sMessagePiazza",n)}},[]),a.useEffect(()=>{if(!f)return;function n(p){const{msg:m,userUid:v,id:u,target:h,messageClock:o,messageClockNumber:s,conversation:l,profileImageUrl:k,defaultProfile:I,profileImage:B,piazzaData:A}=p;r(q=>[...q,{msg:m,type:h?"private":"other",userUid:v,id:u,messageClock:o,messageClockNumber:s,conversation:null,profileImageUrl:k,defaultProfile:I,profileImage:B,...A}])}return f.on(`sMessage${i}`,n),()=>{f.off(`sMessage${i}`,n)}},[i]),a.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),a.useEffect(()=>{z(),(async()=>{if(i==="piazza"){const p=oe(R,"chats_group"),m=de(p,ge("messageClockNumber","desc"),fe(1));(await ue(m)).forEach(async u=>{const h=Y(R,`chats_group/${u.id}`),s=(await O(h)).data(),l=s.piazzaChecked||[];l.indexOf(c.uid)===-1&&(l.splice(-1,c.uid,0),l.push(c.uid),await te(h,{...s,piazzaChecked:l}))})}else{const p=Y(R,`members/${c.uid}`),v=(await O(p)).data().chattings;v[i]&&(v[i].messageCount=0),await te(p,{chattings:v})}})()},[t]);const z=()=>{var n;(n=$.current)==null||n.scrollIntoView()};a.useEffect(()=>{const n=async()=>{const m=[],v=oe(R,"chats_group"),u=de(v,ge("messageClockNumber","desc"),fe(y),ze(M||"")),h=await ue(u);h.docs.length||F(h.docs.length),h.forEach(o=>{var W,H,G;m.length===h.docs.length-1&&(b(o),F(h.docs.length-1));const s=o.data().message,l=o.data().userUid,k=o.data().userName,I=o.data().messageClock,B=o.data().messageClockNumber,A=(W=o.data())==null?void 0:W.profileImageUrl,q=(H=o.data())==null?void 0:H.defaultProfile,X=(G=o.data())==null?void 0:G.profileImage,J=o.data();m.push({msg:s,userUid:l,id:k,messageClockNumber:B,messageClock:I,conversation:null,profileImageUrl:A,defaultProfile:q,profileImage:X||!1,...J})}),m.reverse(),r([...m,...t]),N(!1)},p=async m=>{const v=oe(R,`chats_${m}`),u=de(v,ge("messageClockNumber","desc"),fe(y),ze(M||"")),h=await ue(u),o=[];h.docs.length||F(h.docs.length),h.forEach((s,l)=>{var re,ee,ce;o.length===h.docs.length-1&&(b(s),F(h.docs.length-1));const k=s.data().message,I=s.data().userUid,B=s.data().userName,A=s.data().messageClock,q=s.data().messageClockNumber||0,X=(re=s.data())==null?void 0:re.profileImageUrl,J=(ee=s.data())==null?void 0:ee.defaultProfile,W=(ce=s.data())==null?void 0:ce.profileImage,H=s.data(),G=s.data().userOne,ne=s.data().userOneDisplayName,ae=s.data().userTwo,ie=s.data().userTwoDisplayName;G!==c.uid?(C(G),w(ne)):(C(ae),w(ie)),o.push({msg:k,userUid:I,id:B,messageClockNumber:q,messageClock:A,conversation:null,profileImageUrl:X,defaultProfile:J,profileImage:W||!1,...H})}),o.reverse(),r([...o,...t]),N(!1)};console.log(t.length),i==="piazza"?(x||!t.length)&&n():(x||!t.length)&&p(i)},[x,D]);const U=()=>{T.current.scrollTop!==0||x||(console.log("scroll"),N(!0))};return a.useEffect(()=>{var n;return(n=T.current)==null||n.addEventListener("scroll",U),()=>{var p;return(p=T.current)==null?void 0:p.removeEventListener("scroll",U)}},[x]),console.log(i),console.log(t),console.log(j),e.jsx(e.Fragment,{children:e.jsx("div",{ref:T,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[x&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((n,p)=>{let m;i==="piazza"?m=n:n.userUid===n.userOne?m={userUid:n.userOne,id:n.userOneDisplayName,profileImage:n.userOneProfileImage||n.profileImage,defaultProfile:n.userOneDefaultProfile||n.defaultProfile,profileImageUrl:n.userOneProfileUrl||n.profileImageUrl}:m={userUid:n.userTwo,id:n.userTwoDisplayName,profileImage:n.userTwoProfileImage||n.profileImage,defaultProfile:n.userTwoDefaultProfile||n.defaultProfile,profileImageUrl:n.userTwoProfileUrl||n.profileImageUrl};let v;const u=new Date(n.messageClock);n.userUid===c.uid?v="text-right":v="text-left";let h,o;p>0&&(h=t[p-1].userUid),p<t.length-1&&t[p+1].userUid===c.uid&&(o=new Date(t[p+1].messageClock),u.getFullYear()===o.getFullYear()&&u.getMonth()===o.getMonth()&&u.getDate()===o.getDate()&&u.getHours()===o.getHours()&&(u.getMinutes(),o.getMinutes()));let s,l=u.getHours(),k=(u.getMonth()+1).toString(),I=u.getDate().toString();return l>=13?(s="오후",l!==12&&(l=l-12)):(s="오전",l===0&&(l=l+12)),u.getMonth()+1<10&&(k="0"+k),I.length===1&&(I="0"+I),e.jsxs("li",{ref:p===Z?$:null,className:v,children:[h!==n.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${n.userUid!==c.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(me,{trigger:e.jsx(he,{element:m,piazza:()=>g({userUid:m.userUid,displayName:m.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>b(null),user:j,userObj:c,handleMessagesList:r,displayedName:d})}),e.jsx("div",{children:n.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:n.id}),e.jsx(me,{trigger:e.jsx(he,{element:m,piazza:()=>g({userUid:m.userUid,displayName:m.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>b(null),user:j,userObj:c,handleMessagesList:r,displayedName:d,handleChatUid:C,handleChatDisplayName:w})})]})})}),n.userUid!==c.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg}),e.jsxs("div",{children:[u.getFullYear(),"-",k,"-",I," ",S==="ko"&&s," ",l,":",u.getMinutes()<10&&"0",u.getMinutes(),S==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[u.getFullYear(),"-",k,"-",I," ",S==="ko"&&s," ",l,":",u.getMinutes()<10&&"0",u.getMinutes(),S==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg})]})]},p)}),e.jsx("li",{ref:$})]})})})}function Ke({isKeyboardOpen:c,userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$}){return e.jsx(e.Fragment,{children:c?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ee,{userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ee,{userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})})})}const We=Ae(Fe)(({theme:c})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ze(){const c=se(w=>w.languages.value),t=le(w=>w.piazzaSwitch.value),r=xe(),C=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),r(Se("false"))):(window.localStorage.setItem("piazza","true"),r(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:c==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(We,{onClick:()=>C(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:c})=>{const t=se(w=>w.languages.value),r=t==="ko"||t==="en"?t:"ko",C=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Be,{icon:e.jsx(Le,{}),title:C==="piazza"?Pe[r][0]:`${Pe[r][1]} ${c}`}),C==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ze,{})})]})};function Je(){const[c,t]=a.useState([]),[r,C]=a.useState(!0),[w,$]=a.useState(!0),[T,j]=a.useState(""),[E,d]=a.useState(null),[V,x]=a.useState(null),N=Te(),M=a.useRef(null),b=a.useRef(null),Z={audio:!0,video:!1},F=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:F.map(s=>s.urls)}]}),L=location.search.slice(4);console.log(location.search.slice(4)),a.useEffect(()=>{(async()=>{await g()})()},[]),a.useEffect(()=>{M.current&&(M.current.srcObject=E)},[E]);async function i(){const s=E;s&&s.getAudioTracks().forEach(l=>l.enabled=!l.enabled),C(!r)}async function S(){const s=E;s&&s.getVideoTracks().forEach(l=>l.enabled=!l.enabled),$(!w)}const P=()=>{M.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(M.current)};a.useEffect(()=>{V&&y(V)},[V]);async function g(){try{const l=(await navigator.mediaDevices.enumerateDevices()).filter(k=>k.kind==="videoinput");t(l)}catch(s){console.log(s)}}async function y(s){try{const k=s?{audio:!0,video:{deviceId:{exact:s}}}:Z,I=await navigator.mediaDevices.getUserMedia(k);d(I),j("")}catch(l){const k=l==null?void 0:l.toString();k&&j(k),console.log(l)}}function z(s){console.log("icecandidate"),console.log(s),f.emit("ice",s.candidate,L)}function U(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",E),b.current=s.stream}function n(){D.addEventListener("icecandidate",z),D.addEventListener("addstream",U),E&&E.getTracks().forEach(s=>D.addTrack(s,E))}async function p(){await y(null),n()}async function m(){await p(),f.emit("joinRoom",L,p)}a.useEffect(()=>{m()},[]);const v=async()=>{console.log("sent the offer"),console.log(D);const s=await D.createOffer();D.setLocalDescription(s),console.log(s),f.emit("offer",s,L)};a.useEffect(()=>{if(f)return f.on("welcome",v),()=>{f.off("welcome",v)}});const u=async s=>{console.log("received the offer"),D.setRemoteDescription(s);const l=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(l),f.emit("answer",l,L)};a.useEffect(()=>{if(f)return f.on("offer",u),()=>{f.off("offer",u)}});const h=s=>{console.log("received the answer"),D.setRemoteDescription(s)};a.useEffect(()=>{if(f)return f.on("answer",h),()=>{f.off("answer",h)}});const o=s=>{console.log("received candidate"),D.addIceCandidate(s)};return a.useEffect(()=>{if(f)return f.on("ice",o),()=>{f.off("ice",o)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!N&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:b,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:M,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:i,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:S,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:P,children:"stop"})]})}),T&&e.jsx("div",{children:T})]})}let K,_;function Qe(){const[c,t]=a.useState([]),[r,C]=a.useState(!0),[w,$]=a.useState(!0),[T,j]=a.useState(""),[E,d]=a.useState(null);a.useState(null);const V=Te(),x=document.getElementById("myScreen"),N=document.getElementById("devices"),M={audio:!0,video:!0},b=location.search.slice(4);console.log(location.search.slice(4));const Z=a.useRef(null),F=a.useRef(null);async function D(){const o=K;o&&o.getAudioTracks().forEach(s=>s.enabled=!s.enabled),C(!r)}async function L(){const o=K;o&&o.getVideoTracks().forEach(s=>s.enabled=!s.enabled),$(!w)}async function i(){console.log(N.value),K.getTracks().forEach(s=>s.stop()),d(N.value),await g(N.value)}const S=()=>{K.getTracks().forEach(s=>s.stop())};a.useEffect(()=>{g(E)},[N]);async function P(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput");t(s)}catch(o){console.log(o)}}async function g(o){try{const l=o?{audio:!0,video:{deviceId:{exact:o}}}:M;K=await navigator.mediaDevices.getUserMedia(l);const k=await navigator.mediaDevices.enumerateDevices();x.srcObject=K,await P(),j("")}catch(s){console.log(s),j(s)}}function y(o){console.log("icecandidate"),console.log(o),f.emit("ice",o.candidate,b)}function z(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",K);const s=document.getElementById("yourScreen");s.srcObject=o.stream}function U(){const o=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];_=new RTCPeerConnection({iceServers:[{urls:o.map(s=>s.urls)}]}),_.addEventListener("icecandidate",y),_.addEventListener("addstream",z),K&&K.getTracks().forEach(s=>_.addTrack(s,K))}async function n(){await g(null),U()}async function p(){await n(),f.emit("joinRoom",b,n)}a.useEffect(()=>{p()},[]);const m=async()=>{console.log("sent the offer"),console.log(_);const o=await _.createOffer();_.setLocalDescription(o),console.log(o),f.emit("offer",o,b)};a.useEffect(()=>{if(f)return f.on("welcome",m),()=>{f.off("welcome",m)}});const v=async o=>{console.log("received the offer"),_.setRemoteDescription(o);const s=await _.createAnswer();console.log("sent the answer"),_.setLocalDescription(s),f.emit("answer",s,b)};a.useEffect(()=>{if(f)return f.on("offer",v),()=>{f.off("offer",v)}});const u=o=>{console.log("received the answer"),_.setRemoteDescription(o)};a.useEffect(()=>{if(f)return f.on("answer",u),()=>{f.off("answer",u)}});const h=o=>{console.log("received candidate"),_.addIceCandidate(o)};return a.useEffect(()=>{if(f)return f.on("ice",h),()=>{f.off("ice",h)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!V&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"yourScreen",ref:F,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:Z,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:D,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:L,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:S,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:i,children:c.map((o,s)=>e.jsx("option",{value:o.deviceId,selected:(stream==null?void 0:stream.getVideoTracks()[0].id)===o.deviceId,children:o.label},s))})]}),errorMessage&&e.jsx("div",{children:errorMessage})]})}function tt({userObj:c}){const[t,r]=a.useState(""),[C,w]=a.useState([]),$=xe(),{state:T}=Me(),[j,E]=a.useState(!1),[d,V]=a.useState(null),[x,N]=a.useState(""),[M,b]=a.useState(""),[Z,F]=a.useState(""),D=g=>{N(g)},L=g=>{b(g)},i=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(x),a.useEffect(()=>{T?(N(T.chattingUid),b(T.displayName)):(N(""),b(""))},[i]),a.useEffect(()=>{i&&(async()=>{if(x){const y=Y(R,`members/${x}`),z=await O(y);V(z.data())}})()},[i,x]);const S=le(g=>g.piazzaForm.value);a.useEffect(()=>{var y;const g=()=>{var U;const z=window.screen.height-300>(((U=window.visualViewport)==null?void 0:U.height)||window.screen.height);j!==z&&E(z)};return window.addEventListener("resize",g),typeof visualViewport<"u"&&((y=window.visualViewport)==null||y.addEventListener("resize",g)),visualViewport==null||visualViewport.addEventListener("resize",g),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",g)),()=>{var z;typeof visualViewport<"u"&&((z=window.visualViewport)==null||z.removeEventListener("resize",g))}},[j]);const P=()=>{var g;F(""),(g=document.getElementById("myScreen"))==null||g.srcObject.getTracks().forEach(y=>y.stop())};return a.useEffect(()=>{$(He(5))}),e.jsxs(e.Fragment,{children:[!j&&e.jsx(Xe,{multiple:!i,displayName:M}),e.jsx(Ke,{isKeyboardOpen:S,userObj:c,messagesList:C,handleMessagesList:g=>w(g),handleChatUid:D,handleChatDisplayName:L}),e.jsx(Ge,{chattingUser:d,userObj:c,multiple:!i,messages:t,handleMessages:g=>r(g),messagesList:C,handleMessagesList:g=>w(g)}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Qe,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]})]})}export{tt as default};
