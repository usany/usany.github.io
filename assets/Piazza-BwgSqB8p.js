import{u as W,c as te,L as re,aE as de,j as t,k as E,g as z,V as R,S as q,aJ as pe,f as ae,v as ee,aL as Ie,r as x,J as ce,Q as ue,B as he,as as Pe,P as xe,aM as we,q as ie,U as oe,F as ne,h as le,aH as ve,ac as be,aN as je,R as Ue,w as Me,a4 as Ee}from"./index-ex5VpNxA.js";const ke={ko:"메세지를 작성해 주세요",en:"Input message"},ye={ko:"전송",en:"send"};function Re({chattingUser:u,userObj:o,multiple:U,messages:e,handleMessages:s,messagesList:C,handleMessagesList:m}){const I=W(r=>r.profileColor.value),T=W(r=>r.profileUrl.value),M=W(r=>r.piazzaForm.value),h=te(r=>r.profile.value),X=re(),{state:p}=de(),N=p==null?void 0:p.conversation,$=te(r=>r.languages.value),f=$==="ko"||$==="en"?$:"ko",_=async r=>{var l;r.preventDefault();const P=e,j=o.uid,F=o.displayName,S=Date.now(),a=new Date().toString();let n,i,w;p.chattingUid&&(n=E(z,`members/${p.chattingUid}`),i=await R(n),w=(l=i.data())==null?void 0:l.messagingToken);const c=h.profileImage?h.profileUrl:h.defaultProfile,d={msg:P,userUid:j,id:F,messageClockNumber:S,messageClock:a,conversation:N,conversationUid:p.chattingUid,conversationName:p.displayName,profileUrl:c,sendingToken:w};U?d&&P&&(q.emit("piazzaMessage",d),G()):P&&(C.length!==0?(q.emit("message",d),console.log("message")):(q.emit("messageNew",d),console.log("messageNew")),J(),O()),s("")},D=r=>{s(r.target.value)},G=async()=>{try{const r=e,P=o.uid,j=o.displayName,F=new Date().toString(),S=Date.now(),a=h==null?void 0:h.profileImageUrl,n=h==null?void 0:h.defaultProfile,i=h==null?void 0:h.profileImage;r&&(await pe(ae(z,"chats_group"),{userUid:P,userName:j,message:r,messageClock:F,messageClockNumber:S,profileImageUrl:a,defaultProfile:n,profileColor:I,piazzaChecked:[o.uid],profileImage:i}),m(w=>[...w,{msg:r,type:"me",userUid:o.uid,id:o.displayName,messageClock:F,conversation:null,profileImageUrl:T,profileColor:I,messageClockNumber:S,defaultProfile:n,profileImageUrl:a,profileImage:i||!1}]))}catch(r){console.log(r)}},J=async()=>{var P,j,F;const r=e;try{const S=o.uid,a=o.displayName,n=Date.now(),i=new Date().toString(),w=h.profileImage,c=u.profileImage,d=h.profileImageUrl,l=u.profileImageUrl,g=h.defaultProfile,v=u.defaultProfile;let y,k,A,V,H,L,Z,Y,K,B;if(p.userUid<p.chattingUid?(y=p.userUid,k=p.chattingUid,A=o.displayName,V=p.displayName,H=d,L=l,Z=g,Y=v,K=h.profileImage,B=u.profileImage):(y=p.chattingUid,k=p.userUid,A=p.displayName,V=o.displayName,H=l,L=d,Z=v,Y=g,K=u.profileImage,B=h.profileImage),!H){const b=E(z,`members/${y}`);H=(P=(await R(b)).data())==null?void 0:P.profileImageUrl}if(!L){const b=E(z,`members/${k}`);L=(j=(await R(b)).data())==null?void 0:j.profileImageUrl}if(r){const b={userUid:S,userName:a,message:r,messageClock:i,messageClockNumber:n,userOne:y,userTwo:k,userOneDisplayName:A,userTwoDisplayName:V,userOneProfileUrl:H,userTwoProfileUrl:L,userOneDefaultProfile:Z,userTwoDefaultProfile:Y,userOneProfileImage:K,userTwoProfileImage:B};await pe(ae(z,`chats_${N}`),b);const Q=E(z,`members/${S}`),fe=(await R(Q)).data().chattings||{},me=E(z,`members/${p.chattingUid}`),se=(await R(me)).data().chattings||{},De=((F=se[N])==null?void 0:F.messageCount)||0;fe[N]=b,se[N]={...b,messageCount:De+1},await ee(Q,{chattings:fe}),await ee(me,{chattings:se}),m(Se=>[...Se,{msg:r,type:"me",userUid:o.uid,id:o.displayName,messageClock:i,conversation:N,userName:a,messageClockNumber:n,userOne:y,userTwo:k,userOneDisplayName:A,userTwoDisplayName:V,userOneProfileUrl:H,userTwoProfileUrl:L,userOneDefaultProfile:Z,userTwoDefaultProfile:Y,userOneProfileImage:K,userTwoProfileImage:B}])}}catch(S){console.log(S)}},O=async()=>{try{const r=o.uid,P=p.chattingUid,j=E(z,`members/${r}`),S=(await R(j)).data().conversation||[],a=E(z,`members/${P}`),i=(await R(a)).data().conversation||[];S.indexOf(N)===-1&&(await ee(j,{conversation:[...S,N]}),X(Ie())),i.indexOf(N)===-1&&await ee(a,{conversation:[...i,N]})}catch(r){console.log(r)}};return t.jsx(t.Fragment,{children:M?t.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:_,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[f],onChange:D,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[f]})]}):t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:_,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[f],onChange:D,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[f]})]})})}const Ne=({initiateContinuing:u,multiple:o,handleMultiple:U,user:e,userObj:s,handleMessagesList:C,displayedName:m})=>{const[I,T]=x.useState(null),M=te(h=>h.languages.value);return x.useEffect(()=>{e&&((e==null?void 0:e.uid)<s.uid?T((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]):T(s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(ce,{element:e,uid:s.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==m&&t.jsx("div",{children:M==="ko"?t.jsxs("div",{children:["(",m,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",m,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(ue,{to:"/profile",state:{element:e},children:t.jsx(he,{variant:"outlined",onClick:()=>{},children:M==="ko"?"프로필 확인":"Check Profile"})}),o&&s.uid!==(e==null?void 0:e.uid)&&t.jsx(ue,{to:"/piazza",state:{conversation:I,displayName:e==null?void 0:e.displayName,userUid:s.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(Pe,{children:t.jsx(he,{variant:"outlined",onClick:()=>{C([]),U(!1),u()},children:M==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ze({chattingUser:u,userObj:o,multiple:U,handleMultiple:e,messagesList:s,handleMessagesList:C}){const m=x.useRef(null),I=x.useRef(null),[T,M]=x.useState(null),[h,X]=x.useState(""),[p,N]=x.useState(!1),[$,f]=x.useState(null),[_,D]=x.useState(0);W(a=>a.profileColor.value),W(a=>a.profileUrl.value);const{state:G}=de(),J=G==null?void 0:G.conversation,O=te(a=>a.languages.value),r=async({userUid:a,displayName:n})=>{const i=E(z,`members/${a}`),c=(await R(i)).data();M(c),X(n)},P=({userUid:a,displayName:n})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),r({userUid:a,displayName:n})};console.log(u);const j=20;x.useEffect(()=>{if(!q)return;function a(n){const{msg:i,userUid:w,id:c,target:d,messageClock:l,messageClockNumber:g,profileImageUrl:v,defaultProfile:y,profileImage:k,conversation:A}=n;C(V=>[...V,{msg:i,type:d?"private":"other",userUid:w,id:c,messageClock:l,messageClockNumber:g,conversation:null,profileImageUrl:v,defaultProfile:y,profileImage:k}])}return q.on("sMessagePiazza",a),()=>{q.off("sMessagePiazza",a)}},[]),x.useEffect(()=>{if(!q)return;function a(n){const{msg:i,userUid:w,id:c,target:d,messageClock:l,messageClockNumber:g,conversation:v,piazzaData:y}=n;C(k=>[...k,{msg:i,type:d?"private":"other",userUid:w,id:c,messageClock:l,messageClockNumber:g,conversation:null,...y}])}return q.on(`sMessage${J}`,a),()=>{q.off(`sMessage${J}`,a)}},[]),x.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),x.useEffect(()=>{F(),(async()=>{if(U){const n=ae(z,"chats_group"),i=ie(n,ne("messageClockNumber","desc"),oe(1));(await le(i)).forEach(async c=>{const d=E(z,`chats_group/${c.id}`),g=(await R(d)).data(),v=g.piazzaChecked||[];v.indexOf(o.uid)===-1&&(v.splice(-1,o.uid,0),v.push(o.uid),await ee(d,{...g,piazzaChecked:v}))})}else{const n=E(z,`members/${o.uid}`),w=(await R(n)).data().chattings;w[J].messageCount=0,await ee(n,{chattings:w})}})()},[s]);const F=()=>{var a;(a=m.current)==null||a.scrollIntoView()};x.useEffect(()=>{const a=async()=>{const i=[],w=ae(z,"chats_group"),c=ie(w,ne("messageClockNumber","desc"),oe(j),ve($||"")),d=await le(c);d.docs.length||D(d.docs.length),d.forEach(l=>{var Y,K,B,b;i.length===d.docs.length-1&&(f(l),D(d.docs.length-1));const g=l.data().message,v=l.data().userUid,y=l.data().userName,k=l.data().messageClock,A=l.data().messageClockNumber;(Y=l.data())==null||Y.profileColor;const V=(K=l.data())==null?void 0:K.profileImageUrl,H=(B=l.data())==null?void 0:B.defaultProfile,L=(b=l.data())==null?void 0:b.profileImage,Z=l.data();i.push({msg:g,userUid:v,id:y,messageClockNumber:A,messageClock:k,conversation:null,profileImageUrl:V,defaultProfile:H,profileImage:L||!1,...Z})}),i.reverse(),C([...i,...s]),N(!1)},n=async i=>{const w=ae(z,`chats_${i}`),c=ie(w,ne("messageClockNumber","desc"),oe(j),ve($||"")),d=await le(c),l=[];d.docs.length||D(d.docs.length),d.forEach((g,v)=>{var B,b,Q;l.length===d.docs.length-1&&(f(g),D(d.docs.length-1));const y=g.data().message,k=g.data().userUid,A=g.data().userName,V=g.data().messageClock,H=g.data().messageClockNumber||0,L=(B=g.data())==null?void 0:B.profileImageUrl,Z=(b=g.data())==null?void 0:b.defaultProfile,Y=(Q=g.data())==null?void 0:Q.profileImage,K=g.data();l.push({msg:y,userUid:k,id:A,messageClockNumber:H,messageClock:V,conversation:null,profileImageUrl:L,defaultProfile:Z,profileImage:Y||!1,...K})}),l.reverse(),C([...l,...s]),N(!1)};J?(p||!s.length)&&n(J):(p||!s.length)&&a()},[p,J]);const S=()=>{I.current.scrollTop!==0||p||(console.log("scroll"),N(!0))};return x.useEffect(()=>{var a;return(a=I.current)==null||a.addEventListener("scroll",S),()=>{var n;return(n=I.current)==null?void 0:n.removeEventListener("scroll",S)}},[p]),t.jsx(t.Fragment,{children:t.jsx(t.Fragment,{children:t.jsx("div",{ref:I,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[p&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),s.map((a,n)=>{let i;U?i=a:(console.log(a.userUid===o.uid),a.userUid===a.userOne?i={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage,defaultProfile:a.userOneDefaultProfile,profileImageUrl:a.userOneProfileUrl}:i={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage,defaultProfile:a.userTwoDefaultProfile,profileImageUrl:a.userTwoProfileUrl});let w;const c=new Date(a.messageClock);a.userUid===o.uid?w="text-right":w="text-left";let d,l;n>0&&(d=s[n-1].userUid),n<s.length-1&&s[n+1].userUid===o.uid&&(l=new Date(s[n+1].messageClock),c.getFullYear()===l.getFullYear()&&c.getMonth()===l.getMonth()&&c.getDate()===l.getDate()&&c.getHours()===l.getHours()&&(c.getMinutes(),l.getMinutes()));let g,v=c.getHours(),y=(c.getMonth()+1).toString(),k=c.getDate().toString();return v>=13?(g="오후",v!==12&&(v=v-12)):(g="오전",v===0&&(v=v+12)),c.getMonth()+1<10&&(y="0"+y),k.length===1&&(k="0"+k),console.log(a),t.jsxs("li",{ref:n===_?m:null,className:w,children:[d!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==o.uid?"start":"end"}`,children:w==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(xe,{trigger:t.jsx(ce,{element:i,piazza:()=>P({userUid:i.userUid,displayName:i.id}),profile:!1}),title:t.jsx(we,{}),content:t.jsx(Ne,{initiateContinuing:()=>f(null),multiple:U,handleMultiple:e,user:T,userObj:o,handleMessagesList:C,displayedName:h})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(xe,{trigger:t.jsx(ce,{element:i,piazza:()=>P({userUid:i.userUid,displayName:i.id}),profile:!1}),title:t.jsx(we,{}),content:t.jsx(Ne,{initiateContinuing:()=>f(null),multiple:U,handleMultiple:e,user:T,userObj:o,handleMessagesList:C,displayedName:h})})]})})}),a.userUid!==o.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[c.getFullYear(),"-",y,"-",k," ",O==="ko"&&g," ",v,":",c.getMinutes()<10&&"0",c.getMinutes(),O==="en"&&(g==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[c.getFullYear(),"-",y,"-",k," ",O==="ko"&&g," ",v,":",c.getMinutes()<10&&"0",c.getMinutes(),O==="en"&&(g==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},n)}),t.jsx("li",{ref:m})]})})})})}function Te({chattingUser:u,isKeyboardOpen:o,userObj:U,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m}){return t.jsx(t.Fragment,{children:o?t.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:t.jsx(ze,{chattingUser:u,userObj:U,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m})}):t.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:t.jsx(ze,{chattingUser:u,userObj:U,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m})})})}const $e=be(je)(({theme:u})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(u.palette.getContrastText(u.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(u.palette.getContrastText(u.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Fe(){const u=te(s=>s.languages.value),o=W(s=>s.piazzaSwitch.value),U=re(),e=()=>{o==="true"?(window.localStorage.setItem("piazza","false"),U(Ue("false"))):(window.localStorage.setItem("piazza","true"),U(Ue("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:u==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx($e,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:o==="true"})})]})}const Ce={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Ve=({multiple:u,displayName:o})=>{const U=te(s=>s.languages.value),e=U==="ko"||U==="en"?U:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(Me,{title:u?Ce[e][0]:`${Ce[e][1]} ${o}`}),u&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Fe,{})})]})};function Be({userObj:u}){const[o,U]=x.useState(""),[e,s]=x.useState([]),C=re(),{state:m}=de(),[I,T]=x.useState(!0),[M,h]=x.useState(!1),[X,p]=x.useState(null);x.useEffect(()=>{const f=async()=>{if(m.chattingUid){const _=E(z,`members/${m.chattingUid}`),D=await R(_);p(D.data())}};m.multiple||f()},[]);const N=W(f=>f.piazzaForm.value);x.useEffect(()=>{var _;const f=()=>{var G;const D=window.screen.height-300>(((G=window.visualViewport)==null?void 0:G.height)||window.screen.height);M!==D&&h(D)};return window.addEventListener("resize",f),typeof visualViewport<"u"&&((_=window.visualViewport)==null||_.addEventListener("resize",f)),visualViewport==null||visualViewport.addEventListener("resize",f),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",f)),()=>{var D;typeof visualViewport<"u"&&((D=window.visualViewport)==null||D.removeEventListener("resize",f))}},[M]),x.useEffect(()=>{(m==null?void 0:m.multiple)!==void 0&&T(m==null?void 0:m.multiple)},[]),x.useEffect(()=>{C(Ee(5))});const $=m==null?void 0:m.displayName;return t.jsxs(t.Fragment,{children:[!M&&t.jsx(Ve,{multiple:I,displayName:$}),t.jsx(Te,{chattingUser:X,isKeyboardOpen:N,userObj:u,multiple:I,handleMultiple:f=>T(f),messagesList:e,handleMessagesList:f=>s(f)}),t.jsx(Re,{chattingUser:X,userObj:u,multiple:I,messages:o,handleMessages:f=>U(f),messagesList:e,handleMessagesList:f=>s(f)})]})}export{Be as default};
