import{u as W,c as ee,N as re,aV as de,j as a,k as T,g as z,R as $,U as G,a_ as me,f as te,v as O,b0 as Se,r as x,G as ce,M as pe,B as ue,aI as Ie,P as he,b1 as xe,q as ie,aY as oe,aJ as ne,h as le,aX as we,as as Pe,b2 as be,O as ve,w as je,a7 as Me}from"./index-CwfG4IYM.js";const ke={ko:"메세지를 작성해 주세요",en:"Input message"},ye={ko:"전송",en:"send"};function Ee({chattingUser:n,userObj:i,multiple:w,messages:e,handleMessages:s,messagesList:C,handleMessagesList:p}){const U=W(r=>r.profileColor.value);W(r=>r.profileUrl.value);const F=W(r=>r.piazzaForm.value),f=ee(r=>r.profile.value),K=re(),{state:q}=de(),k=q==null?void 0:q.conversation,H=ee(r=>r.languages.value),E=H==="ko"||H==="en"?H:"ko",h=async r=>{var m;r.preventDefault();const b=e,j=i.uid,R=i.displayName,S=Date.now(),I=new Date().toString();let t,o,c;n&&(t=T(z,`members/${n.uid}`),o=await $(t),c=(m=o.data())==null?void 0:m.messagingToken);const v=f.profileImage?f.profileUrl:f.defaultProfile,l={msg:b,userUid:j,id:R,messageClockNumber:S,messageClock:I,conversation:k,conversationUid:n.uid,conversationName:n.displayName,profileUrl:v,sendingToken:c};w?l&&b&&(G.emit("piazzaMessage",l),D()):b&&(C.length!==0?(G.emit("message",l),console.log("message")):(G.emit("messageNew",l),console.log("messageNew")),Z(),J()),s("")},L=r=>{s(r.target.value)},D=async()=>{try{const r=e,b=i.uid,j=i.displayName,R=new Date().toString(),S=Date.now(),I=f==null?void 0:f.profileImageUrl,t=f==null?void 0:f.defaultProfile,o=f==null?void 0:f.profileImage;r&&(await me(te(z,"chats_group"),{userUid:b,userName:j,message:r,messageClock:R,messageClockNumber:S,profileImageUrl:I,defaultProfile:t,profileColor:U,piazzaChecked:[i.uid],profileImage:o}),p(c=>[...c,{msg:r,type:"me",userUid:i.uid,id:i.displayName,messageClock:R,conversation:null,profileColor:U,messageClockNumber:S,defaultProfile:t,profileImageUrl:I,profileImage:o||!1}]))}catch(r){console.log(r)}},Z=async()=>{var b,j,R;const r=e;try{const S=i.uid,I=i.displayName,t=Date.now(),o=new Date().toString(),c=f.profileImage,v=n.profileImage,l=f.profileImageUrl,m=n.profileImageUrl,d=f.defaultProfile,g=n.defaultProfile;let u,y,N,_,M,V,X,Q,Y,A;if(i.uid<n.uid?(u=i.uid,y=n.uid,N=i.displayName,_=n.displayName,M=l,V=m,X=d,Q=g,Y=f.profileImage,A=n.profileImage):(u=n.uid,y=i.uid,N=n.displayName,_=i.displayName,M=m,V=l,X=g,Q=d,Y=n.profileImage,A=f.profileImage),!M){const P=T(z,`members/${u}`);M=(b=(await $(P)).data())==null?void 0:b.profileImageUrl}if(!V){const P=T(z,`members/${y}`);V=(j=(await $(P)).data())==null?void 0:j.profileImageUrl}if(r){const P={userUid:S,userName:I,message:r,messageClock:o,messageClockNumber:t,userOne:u,userTwo:y,userOneDisplayName:N,userTwoDisplayName:_,userOneProfileUrl:M,userTwoProfileUrl:V,userOneDefaultProfile:X,userTwoDefaultProfile:Q,userOneProfileImage:Y,userTwoProfileImage:A};await me(te(z,`chats_${k}`),P);const B=T(z,`members/${S}`),ge=(await $(B)).data().chattings||{},fe=T(z,`members/${n.uid}`),se=(await $(fe)).data().chattings||{},Ue=((R=se[k])==null?void 0:R.messageCount)||0;ge[k]=P,se[k]={...P,messageCount:Ue+1},await O(B,{chattings:ge}),await O(fe,{chattings:se}),p(De=>[...De,{msg:r,type:"me",userUid:i.uid,id:i.displayName,messageClock:o,conversation:k,userName:I,messageClockNumber:t,userOne:u,userTwo:y,userOneDisplayName:N,userTwoDisplayName:_,userOneProfileUrl:M,userTwoProfileUrl:V,userOneDefaultProfile:X,userTwoDefaultProfile:Q,userOneProfileImage:Y,userTwoProfileImage:A}])}}catch(S){console.log(S)}},J=async()=>{try{const r=i.uid,b=n.uid,j=T(z,`members/${r}`),S=(await $(j)).data().conversation||[],I=T(z,`members/${b}`),o=(await $(I)).data().conversation||[];S.indexOf(k)===-1&&(await O(j,{conversation:[...S,k]}),K(Se())),o.indexOf(k)===-1&&await O(I,{conversation:[...o,k]})}catch(r){console.log(r)}};return a.jsx(a.Fragment,{children:F?a.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:h,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[E],onChange:L,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[E]})]}):a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:h,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[E],onChange:L,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[E]})]})})}const Ne=({initiateContinuing:n,multiple:i,handleMultiple:w,user:e,userObj:s,handleMessagesList:C,displayedName:p})=>{const[U,F]=x.useState(null),f=ee(K=>K.languages.value);return x.useEffect(()=>{e&&((e==null?void 0:e.uid)<s.uid?F((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]):F(s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(ce,{element:e,uid:s.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&a.jsx("div",{children:f==="ko"?a.jsxs("div",{children:["(",p,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(pe,{to:`${location.pathname}?id=${U}`,state:{element:e},children:a.jsx(ue,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),i&&s.uid!==(e==null?void 0:e.uid)&&a.jsx(pe,{to:`${location.pathname}?id=${U}`,state:{conversation:U,displayName:e==null?void 0:e.displayName,userUid:s.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(Ie,{children:a.jsx(ue,{variant:"outlined",onClick:()=>{C([]),w(!1),n()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ze({chattingUser:n,userObj:i,multiple:w,handleMultiple:e,messagesList:s,handleMessagesList:C}){const p=x.useRef(null),U=x.useRef(null),[F,f]=x.useState(null),[K,q]=x.useState(""),[k,H]=x.useState(!1),[E,h]=x.useState(null),[L,D]=x.useState(0);W(t=>t.profileColor.value),W(t=>t.profileUrl.value);const{state:Z}=de(),J=Z==null?void 0:Z.conversation,r=ee(t=>t.languages.value),b=async({userUid:t,displayName:o})=>{const c=T(z,`members/${t}`),l=(await $(c)).data();f(l),q(o)},j=({userUid:t,displayName:o})=>{var c;(c=document.getElementById("drawer"))==null||c.click(),b({userUid:t,displayName:o})},R=20;x.useEffect(()=>{if(!G)return;function t(o){const{msg:c,userUid:v,id:l,target:m,messageClock:d,messageClockNumber:g,profileImageUrl:u,defaultProfile:y,profileImage:N,conversation:_}=o;C(M=>[...M,{msg:c,type:m?"private":"other",userUid:v,id:l,messageClock:d,messageClockNumber:g,conversation:null,profileImageUrl:u,defaultProfile:y,profileImage:N}])}return G.on("sMessagePiazza",t),()=>{G.off("sMessagePiazza",t)}},[]),x.useEffect(()=>{if(!G)return;function t(o){const{msg:c,userUid:v,id:l,target:m,messageClock:d,messageClockNumber:g,conversation:u,piazzaData:y}=o;C(N=>[...N,{msg:c,type:m?"private":"other",userUid:v,id:l,messageClock:d,messageClockNumber:g,conversation:null,...y}])}return G.on(`sMessage${J}`,t),()=>{G.off(`sMessage${J}`,t)}},[]),x.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),x.useEffect(()=>{S(),(async()=>{if(w){const o=te(z,"chats_group"),c=ie(o,ne("messageClockNumber","desc"),oe(1));(await le(c)).forEach(async l=>{const m=T(z,`chats_group/${l.id}`),g=(await $(m)).data(),u=g.piazzaChecked||[];u.indexOf(i.uid)===-1&&(u.splice(-1,i.uid,0),u.push(i.uid),await O(m,{...g,piazzaChecked:u}))})}else{const o=T(z,`members/${i.uid}`),v=(await $(o)).data().chattings;v[J].messageCount=0,await O(o,{chattings:v})}})()},[s]);const S=()=>{var t;(t=p.current)==null||t.scrollIntoView()};x.useEffect(()=>{const t=async()=>{const c=[],v=te(z,"chats_group"),l=ie(v,ne("messageClockNumber","desc"),oe(R),we(E||"")),m=await le(l);m.docs.length||D(m.docs.length),m.forEach(d=>{var Y,A,P,B;c.length===m.docs.length-1&&(h(d),D(m.docs.length-1));const g=d.data().message,u=d.data().userUid,y=d.data().userName,N=d.data().messageClock,_=d.data().messageClockNumber;(Y=d.data())==null||Y.profileColor;const M=(A=d.data())==null?void 0:A.profileImageUrl,V=(P=d.data())==null?void 0:P.defaultProfile,X=(B=d.data())==null?void 0:B.profileImage,Q=d.data();c.push({msg:g,userUid:u,id:y,messageClockNumber:_,messageClock:N,conversation:null,profileImageUrl:M,defaultProfile:V,profileImage:X||!1,...Q})}),c.reverse(),C([...c,...s]),H(!1)},o=async c=>{const v=te(z,`chats_${c}`),l=ie(v,ne("messageClockNumber","desc"),oe(R),we(E||"")),m=await le(l),d=[];m.docs.length||D(m.docs.length),m.forEach((g,u)=>{var P,B,ae;d.length===m.docs.length-1&&(h(g),D(m.docs.length-1));const y=g.data().message,N=g.data().userUid,_=g.data().userName,M=g.data().messageClock,V=g.data().messageClockNumber||0,X=(P=g.data())==null?void 0:P.profileImageUrl,Q=(B=g.data())==null?void 0:B.defaultProfile,Y=(ae=g.data())==null?void 0:ae.profileImage,A=g.data();d.push({msg:y,userUid:N,id:_,messageClockNumber:V,messageClock:M,conversation:null,profileImageUrl:X,defaultProfile:Q,profileImage:Y||!1,...A})}),d.reverse(),C([...d,...s]),H(!1)};J?(k||!s.length)&&o(J):(k||!s.length)&&t()},[k,J]);const I=()=>{U.current.scrollTop!==0||k||(console.log("scroll"),H(!0))};return x.useEffect(()=>{var t;return(t=U.current)==null||t.addEventListener("scroll",I),()=>{var o;return(o=U.current)==null?void 0:o.removeEventListener("scroll",I)}},[k]),a.jsx(a.Fragment,{children:a.jsx(a.Fragment,{children:a.jsx("div",{ref:U,className:"p-1 border-t rounded-xl overflow-auto",children:a.jsxs("ul",{children:[k&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),s.map((t,o)=>{let c;w?c=t:(console.log(t.userUid===i.uid),t.userUid===t.userOne?c={userUid:t.userOne,id:t.userOneDisplayName,profileImage:t.userOneProfileImage,defaultProfile:t.userOneDefaultProfile,profileImageUrl:t.userOneProfileUrl}:c={userUid:t.userTwo,id:t.userTwoDisplayName,profileImage:t.userTwoProfileImage,defaultProfile:t.userTwoDefaultProfile,profileImageUrl:t.userTwoProfileUrl});let v;const l=new Date(t.messageClock);t.userUid===i.uid?v="text-right":v="text-left";let m,d;o>0&&(m=s[o-1].userUid),o<s.length-1&&s[o+1].userUid===i.uid&&(d=new Date(s[o+1].messageClock),l.getFullYear()===d.getFullYear()&&l.getMonth()===d.getMonth()&&l.getDate()===d.getDate()&&l.getHours()===d.getHours()&&(l.getMinutes(),d.getMinutes()));let g,u=l.getHours(),y=(l.getMonth()+1).toString(),N=l.getDate().toString();return u>=13?(g="오후",u!==12&&(u=u-12)):(g="오전",u===0&&(u=u+12)),l.getMonth()+1<10&&(y="0"+y),N.length===1&&(N="0"+N),a.jsxs("li",{ref:o===L?p:null,className:v,children:[m!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==i.uid?"start":"end"}`,children:v==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(he,{trigger:a.jsx(ce,{element:c,piazza:()=>j({userUid:c.userUid,displayName:c.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(Ne,{initiateContinuing:()=>h(null),multiple:w,handleMultiple:e,user:F,userObj:i,handleMessagesList:C,displayedName:K})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(he,{trigger:a.jsx(ce,{element:c,piazza:()=>j({userUid:c.userUid,displayName:c.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(Ne,{initiateContinuing:()=>h(null),multiple:w,handleMultiple:e,user:F,userObj:i,handleMessagesList:C,displayedName:K})})]})})}),t.userUid!==i.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[l.getFullYear(),"-",y,"-",N," ",r==="ko"&&g," ",u,":",l.getMinutes()<10&&"0",l.getMinutes(),r==="en"&&(g==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[l.getFullYear(),"-",y,"-",N," ",r==="ko"&&g," ",u,":",l.getMinutes()<10&&"0",l.getMinutes(),r==="en"&&(g==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},o)}),a.jsx("li",{ref:p})]})})})})}function Re({chattingUser:n,isKeyboardOpen:i,userObj:w,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:p}){return a.jsx(a.Fragment,{children:i?a.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:a.jsx(ze,{chattingUser:n,userObj:w,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:p})}):a.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:a.jsx(ze,{chattingUser:n,userObj:w,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:p})})})}const Te=Pe(be)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function $e(){const n=ee(s=>s.languages.value),i=W(s=>s.piazzaSwitch.value),w=re(),e=()=>{i==="true"?(window.localStorage.setItem("piazza","false"),w(ve("false"))):(window.localStorage.setItem("piazza","true"),w(ve("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Te,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:i==="true"})})]})}const Ce={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Fe=({multiple:n,displayName:i})=>{const w=ee(s=>s.languages.value),e=w==="ko"||w==="en"?w:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(je,{title:n?Ce[e][0]:`${Ce[e][1]} ${i}`}),n&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx($e,{})})]})};function He({userObj:n}){const[i,w]=x.useState(""),[e,s]=x.useState([]),C=re(),{state:p}=de(),[U,F]=x.useState(!0),[f,K]=x.useState(!1),[q,k]=x.useState(null);x.useEffect(()=>{const h=async()=>{if(p.chattingUid){const L=T(z,`members/${p.chattingUid}`),D=await $(L);k(D.data())}};p.multiple||h()},[]);const H=W(h=>h.piazzaForm.value);x.useEffect(()=>{var L;const h=()=>{var Z;const D=window.screen.height-300>(((Z=window.visualViewport)==null?void 0:Z.height)||window.screen.height);f!==D&&K(D)};return window.addEventListener("resize",h),typeof visualViewport<"u"&&((L=window.visualViewport)==null||L.addEventListener("resize",h)),visualViewport==null||visualViewport.addEventListener("resize",h),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",h)),()=>{var D;typeof visualViewport<"u"&&((D=window.visualViewport)==null||D.removeEventListener("resize",h))}},[f]),x.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&F(p==null?void 0:p.multiple)},[]),x.useEffect(()=>{C(Me(5))});const E=p==null?void 0:p.displayName;return a.jsxs(a.Fragment,{children:[!f&&a.jsx(Fe,{multiple:U,displayName:E}),a.jsx(Re,{chattingUser:q,isKeyboardOpen:H,userObj:n,multiple:U,handleMultiple:h=>F(h),messagesList:e,handleMessagesList:h=>s(h)}),a.jsx(Ee,{chattingUser:q,userObj:n,multiple:U,messages:i,handleMessages:h=>w(h),messagesList:e,handleMessagesList:h=>s(h)})]})}export{He as default};
