import{b2 as Ie,u as ne,c as te,O as pe,aV as oe,r as c,j as e,P as fe,Y as ie,b1 as me,X as we,b3 as ye,aX as Ue,v as Y,m as T,I as q,$ as k,a_ as ke,l as ae,C as ee,b4 as Ee,N as ue,B as se,b5 as Ce,q as ce,Z as re,_ as de,n as ge,aY as ze,s as Me,S as Te,Q as Ne,D as Re,b6 as $e,aJ as Ve,aa as Fe,b7 as Be,b8 as Ae,b9 as Le,ba as He}from"./index-wH0MCSPB.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ie("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Ie("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),qe={ko:"메세지를 작성해 주세요",en:"Input message"},Ke={ko:"전송",en:"send"};function Ze({chattingUser:o,userObj:m,multiple:D,messages:t,handleMessages:l,messagesList:M,handleMessagesList:u}){const b=ne(g=>g.profileColor.value),S=ne(g=>g.piazzaForm.value),d=te(g=>g.profile.value),L=pe(),{state:j}=oe(),C=j==null?void 0:j.conversation,P=te(g=>g.languages.value),B=P==="ko"||P==="en"?P:"ko",[y,A]=c.useState(!1),x=async g=>{var w;g.preventDefault();const I=t,E=m.uid,R=m.displayName,z=Date.now(),s=new Date().toString(),r=d==null?void 0:d.profileImageUrl,i=d==null?void 0:d.defaultProfile,v=d==null?void 0:d.profileImage;let p,h,f;o&&(p=Y(T,`members/${o.uid}`),h=await q(p),f=(w=h.data())==null?void 0:w.messagingToken);const a=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const n={msg:I,userUid:E,id:R,messageClockNumber:z,messageClock:s,conversation:C,conversationUid:o==null?void 0:o.uid,conversationName:o==null?void 0:o.displayName,profileImage:v,defaultProfile:i,profileImageUrl:r,profileUrl:a,sendingToken:f};D?n&&I&&(k.emit("piazzaMessage",n),W()):I&&(M.length!==0?(k.emit("message",n),console.log("message")):(k.emit("messageNew",n),console.log("messageNew")),U(),J()),l("")},H=g=>{l(g.target.value)},W=async()=>{try{const g=t,I=m.uid,E=m.displayName,R=new Date().toString(),z=Date.now(),s=d==null?void 0:d.profileImageUrl,r=d==null?void 0:d.defaultProfile,i=d==null?void 0:d.profileImage;g&&(await ke(ae(T,"chats_group"),{userUid:I,userName:E,message:g,messageClock:R,messageClockNumber:z,profileImageUrl:s,defaultProfile:r,profileColor:b,piazzaChecked:[m.uid],profileImage:i}),u(v=>[...v,{msg:g,type:"me",userUid:m.uid,id:m.displayName,messageClock:R,conversation:null,profileColor:b,messageClockNumber:z,defaultProfile:r,profileImageUrl:s,profileImage:i||!1}]))}catch(g){console.log(g)}},U=async()=>{var I,E,R;const g=t;try{const z=m.uid,s=m.displayName,r=Date.now(),i=new Date().toString(),v=d.profileImage,p=o.profileImage,h=d.profileImageUrl,f=o.profileImageUrl,a=d.defaultProfile,n=o.defaultProfile;let w,N,$,V,F,_,Q,G,X,K;if(m.uid<o.uid?(w=m.uid,N=o.uid,$=m.displayName,V=o.displayName,F=h,_=f,Q=a,G=n,X=d.profileImage,K=o.profileImage):(w=o.uid,N=m.uid,$=o.displayName,V=m.displayName,F=f,_=h,Q=n,G=a,X=o.profileImage,K=d.profileImage),!F){const Z=Y(T,`members/${w}`);F=(I=(await q(Z)).data())==null?void 0:I.profileImageUrl}if(!_){const Z=Y(T,`members/${N}`);_=(E=(await q(Z)).data())==null?void 0:E.profileImageUrl}if(g){const Z={userUid:z,userName:s,message:g,messageClock:i,messageClockNumber:r,userOne:w,userTwo:N,userOneDisplayName:$,userTwoDisplayName:V,userOneProfileUrl:F,userTwoProfileUrl:_,userOneDefaultProfile:Q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:K};await ke(ae(T,`chats_${C}`),Z);const O=Y(T,`members/${z}`),xe=(await q(O)).data().chattings||{},ve=Y(T,`members/${o.uid}`),le=(await q(ve)).data().chattings||{},be=((R=le[C])==null?void 0:R.messageCount)||0;xe[C]=Z,le[C]={...Z,messageCount:be+1},await ee(O,{chattings:xe}),await ee(ve,{chattings:le}),u(Pe=>[...Pe,{msg:g,type:"me",userUid:m.uid,id:m.displayName,messageClock:i,conversation:C,userName:s,messageClockNumber:r,userOne:w,userTwo:N,userOneDisplayName:$,userTwoDisplayName:V,userOneProfileUrl:F,userTwoProfileUrl:_,userOneDefaultProfile:Q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:K}])}}catch(z){console.log(z)}},J=async()=>{try{const g=m.uid,I=o.uid,E=Y(T,`members/${g}`),z=(await q(E)).data().conversation||[],s=Y(T,`members/${I}`),i=(await q(s)).data().conversation||[];z.indexOf(C)===-1&&(await ee(E,{conversation:[...z,C]}),L(Ee())),i.indexOf(C)===-1&&await ee(s,{conversation:[...i,C]})}catch(g){console.log(g)}};return c.useEffect(()=>{if(y){document.getElementById("mute"),document.getElementById("stream");const g=document.getElementById("videoInput");document.getElementById("myFace");let I;async function E(){try{const z={video:!0,audio:!0};I=await navigator.mediaDevices.getUserMedia(z),I.getVideoTracks().forEach(s=>s.enabled=!s.enabled),I.getAudioTracks().forEach(s=>s.enabled=!s.enabled),R()}catch(z){console.log(z)}}E();async function R(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");s.forEach(r=>{const i=document.createElement("option");i.value=r.deviceId,i.innerText=r.label,g==null||g.appendChild(i)}),console.log(s)}catch(z){console.log(z)}}}}),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${S?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:x,children:[C&&C!=="piazza"&&e.jsx(fe,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ie,{to:`/piazza?id=${C}?calls=video`,state:j,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var g;(g=document.getElementById("calls"))==null||g.click()},children:[e.jsx(Ue,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(ie,{to:`/piazza?id=${C}?calls=audio`,state:j,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(_e,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:qe[B],onChange:H,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ke[B]})]})})}const De=({initiateContinuing:o,multiple:m,handleMultiple:D,user:t,userObj:l,handleMessagesList:M,displayedName:u})=>{const{state:b}=oe(),S=(b==null?void 0:b.conversation)||"piazza",d=te(C=>C.languages.value),[L,j]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<l.uid?j((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]):j(l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(ue,{element:t,uid:l.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==u&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",u,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",u,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(ie,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(se,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),S==="piazza"&&l.uid!==(t==null?void 0:t.uid)&&e.jsx(ie,{to:`${location.pathname}?id=${L}`,state:{conversation:L,displayName:t==null?void 0:t.displayName,userUid:l.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(me,{children:e.jsx(se,{variant:"outlined",onClick:()=>{M([]),D(!1),o()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Se({userObj:o,multiple:m,handleMultiple:D,messagesList:t,handleMessagesList:l}){const M=c.useRef(null),u=c.useRef(null),[b,S]=c.useState(null),[d,L]=c.useState(""),[j,C]=c.useState(!1),[P,B]=c.useState(null),[y,A]=c.useState(0),[x,H]=c.useState("piazza"),{state:W}=oe(),U=(W==null?void 0:W.conversation)||"piazza";c.useEffect(()=>{x!==U&&(l([]),B(null),A(0),H(U))},[U]);const J=te(s=>s.languages.value),g=async({userUid:s,displayName:r})=>{const i=Y(T,`members/${s}`),p=(await q(i)).data();S(p),L(r),console.log("practice")},I=({userUid:s,displayName:r})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),g({userUid:s,displayName:r})},E=20;c.useEffect(()=>{if(!k)return;function s(r){const{msg:i,userUid:v,id:p,target:h,messageClock:f,messageClockNumber:a,profileImageUrl:n,defaultProfile:w,profileImage:N,conversation:$}=r;l(V=>[...V,{msg:i,type:h?"private":"other",userUid:v,id:p,messageClock:f,messageClockNumber:a,conversation:null,profileImageUrl:n,defaultProfile:w,profileImage:N}])}return k.on("sMessagePiazza",s),()=>{k.off("sMessagePiazza",s)}},[]),c.useEffect(()=>{if(!k)return;function s(r){const{msg:i,userUid:v,id:p,target:h,messageClock:f,messageClockNumber:a,conversation:n,profileImageUrl:w,defaultProfile:N,profileImage:$,piazzaData:V}=r;l(F=>[...F,{msg:i,type:h?"private":"other",userUid:v,id:p,messageClock:f,messageClockNumber:a,conversation:null,profileImageUrl:w,defaultProfile:N,profileImage:$,...V}])}return k.on(`sMessage${U}`,s),()=>{k.off(`sMessage${U}`,s)}},[U]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{R(),(async()=>{if(m){const r=ae(T,"chats_group"),i=ce(r,de("messageClockNumber","desc"),re(1));(await ge(i)).forEach(async p=>{const h=Y(T,`chats_group/${p.id}`),a=(await q(h)).data(),n=a.piazzaChecked||[];n.indexOf(o.uid)===-1&&(n.splice(-1,o.uid,0),n.push(o.uid),await ee(h,{...a,piazzaChecked:n}))})}else{const r=Y(T,`members/${o.uid}`),v=(await q(r)).data().chattings;v[U]&&(v[U].messageCount=0),await ee(r,{chattings:v})}})()},[t]);const R=()=>{var s;(s=M.current)==null||s.scrollIntoView()};c.useEffect(()=>{const s=async()=>{const i=[],v=ae(T,"chats_group"),p=ce(v,de("messageClockNumber","desc"),re(E),ze(P||"")),h=await ge(p);h.docs.length||A(h.docs.length),h.forEach(f=>{var G,X,K;i.length===h.docs.length-1&&(B(f),A(h.docs.length-1));const a=f.data().message,n=f.data().userUid,w=f.data().userName,N=f.data().messageClock,$=f.data().messageClockNumber,V=(G=f.data())==null?void 0:G.profileImageUrl,F=(X=f.data())==null?void 0:X.defaultProfile,_=(K=f.data())==null?void 0:K.profileImage,Q=f.data();i.push({msg:a,userUid:n,id:w,messageClockNumber:$,messageClock:N,conversation:null,profileImageUrl:V,defaultProfile:F,profileImage:_||!1,...Q})}),i.reverse(),l([...i,...t]),C(!1)},r=async i=>{const v=ae(T,`chats_${i}`),p=ce(v,de("messageClockNumber","desc"),re(E),ze(P||"")),h=await ge(p),f=[];h.docs.length||A(h.docs.length),h.forEach((a,n)=>{var K,Z,O;f.length===h.docs.length-1&&(B(a),A(h.docs.length-1));const w=a.data().message,N=a.data().userUid,$=a.data().userName,V=a.data().messageClock,F=a.data().messageClockNumber||0,_=(K=a.data())==null?void 0:K.profileImageUrl,Q=(Z=a.data())==null?void 0:Z.defaultProfile,G=(O=a.data())==null?void 0:O.profileImage,X=a.data();f.push({msg:w,userUid:N,id:$,messageClockNumber:F,messageClock:V,conversation:null,profileImageUrl:_,defaultProfile:Q,profileImage:G||!1,...X})}),f.reverse(),l([...f,...t]),C(!1)};U==="piazza"?(j||!t.length)&&s():(j||!t.length)&&r(U)},[j,U]);const z=()=>{u.current.scrollTop!==0||j||(console.log("scroll"),C(!0))};return c.useEffect(()=>{var s;return(s=u.current)==null||s.addEventListener("scroll",z),()=>{var r;return(r=u.current)==null?void 0:r.removeEventListener("scroll",z)}},[j]),console.log(U),console.log(t),console.log(b),e.jsx(e.Fragment,{children:e.jsx("div",{ref:u,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[j&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((s,r)=>{let i;U==="piazza"?i=s:s.userUid===s.userOne?i={userUid:s.userOne,id:s.userOneDisplayName,profileImage:s.userOneProfileImage||s.profileImage,defaultProfile:s.userOneDefaultProfile||s.defaultProfile,profileImageUrl:s.userOneProfileUrl||s.profileImageUrl}:i={userUid:s.userTwo,id:s.userTwoDisplayName,profileImage:s.userTwoProfileImage||s.profileImage,defaultProfile:s.userTwoDefaultProfile||s.defaultProfile,profileImageUrl:s.userTwoProfileUrl||s.profileImageUrl};let v;const p=new Date(s.messageClock);s.userUid===o.uid?v="text-right":v="text-left";let h,f;r>0&&(h=t[r-1].userUid),r<t.length-1&&t[r+1].userUid===o.uid&&(f=new Date(t[r+1].messageClock),p.getFullYear()===f.getFullYear()&&p.getMonth()===f.getMonth()&&p.getDate()===f.getDate()&&p.getHours()===f.getHours()&&(p.getMinutes(),f.getMinutes()));let a,n=p.getHours(),w=(p.getMonth()+1).toString(),N=p.getDate().toString();return n>=13?(a="오후",n!==12&&(n=n-12)):(a="오전",n===0&&(n=n+12)),p.getMonth()+1<10&&(w="0"+w),N.length===1&&(N="0"+N),e.jsxs("li",{ref:r===y?M:null,className:v,children:[h!==s.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${s.userUid!==o.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(De,{initiateContinuing:()=>B(null),multiple:m,handleMultiple:D,user:b,userObj:o,handleMessagesList:l,displayedName:d})}),e.jsx("div",{children:s.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:s.id}),e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(De,{initiateContinuing:()=>B(null),multiple:m,handleMultiple:D,user:b,userObj:o,handleMessagesList:l,displayedName:d})})]})})}),s.userUid!==o.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),e.jsxs("div",{children:[p.getFullYear(),"-",w,"-",N," ",J==="ko"&&a," ",n,":",p.getMinutes()<10&&"0",p.getMinutes(),J==="en"&&(a==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[p.getFullYear(),"-",w,"-",N," ",J==="ko"&&a," ",n,":",p.getMinutes()<10&&"0",p.getMinutes(),J==="en"&&(a==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},r)}),e.jsx("li",{ref:M})]})})})}function Ge({isKeyboardOpen:o,userObj:m,multiple:D,handleMultiple:t,messagesList:l,handleMessagesList:M}){return e.jsx(e.Fragment,{children:o?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Se,{userObj:m,multiple:D,handleMultiple:t,messagesList:l,handleMessagesList:M})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Se,{userObj:m,multiple:D,handleMultiple:t,messagesList:l,handleMessagesList:M})})})}const Xe=Me(Te)(({theme:o})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Je(){const o=te(l=>l.languages.value),m=ne(l=>l.piazzaSwitch.value),D=pe(),t=()=>{m==="true"?(window.localStorage.setItem("piazza","false"),D(Ne("false"))):(window.localStorage.setItem("piazza","true"),D(Ne("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:o==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Xe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:m==="true"})})]})}const je={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Qe=({multiple:o,displayName:m})=>{const D=te(u=>u.languages.value),t=D==="ko"||D==="en"?D:"ko",{state:l}=oe(),M=(l==null?void 0:l.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Re,{icon:e.jsx($e,{}),title:M==="piazza"?je[t][0]:`${je[t][1]} ${m}`}),o&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Je,{})})]})};function We(){const[o,m]=c.useState([]),[D,t]=c.useState(!0),[l,M]=c.useState(!0),[u,b]=c.useState(""),[S,d]=c.useState(null),[L,j]=c.useState(null),C=Ve(),P=c.useRef(null),B=c.useRef(null),y={audio:!0,video:!0},A=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],x=new RTCPeerConnection({iceServers:[{urls:A.map(a=>a.urls)}]}),H=location.search.slice(4);console.log(location.search.slice(4)),c.useEffect(()=>{(async()=>{await navigator.mediaDevices.getUserMedia(y),await I()})()},[]),c.useEffect(()=>{P.current&&(P.current.srcObject=S)},[S]);async function W(){const a=S;a&&a.getAudioTracks().forEach(n=>n.enabled=!n.enabled),t(!D)}async function U(){const a=S;a&&a.getVideoTracks().forEach(n=>n.enabled=!n.enabled),M(!l)}const J=()=>{P.current.srcObject.getTracks().forEach(a=>a.stop()),console.log(P.current)};async function g(a){if(P.current.srcObject.getTracks().forEach(n=>n.stop()),j(a.target.value),x){console.log(x.getSenders());const n=S.getVideoTracks()[0];x.getSenders().find(N=>N.track.kind==="video").replaceTrack(n)}}c.useEffect(()=>{L&&E(L)},[L]);async function I(){try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(w=>w.kind==="videoinput");m(n)}catch(a){console.log(a)}}async function E(a){const w=a?{audio:!0,video:{deviceId:{exact:a}}}:y;console.log("practice");const N=await navigator.mediaDevices.getUserMedia(w);d(N),await navigator.mediaDevices.enumerateDevices(),b("");try{const V=a?{audio:!0,video:{deviceId:{exact:a}}}:y;console.log("practice");const F=await navigator.mediaDevices.getUserMedia(V);d(F);const _=await navigator.mediaDevices.enumerateDevices();b("")}catch($){b($)}}function R(a){console.log("icecandidate"),console.log(a),k.emit("ice",a.candidate,H)}function z(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",S),B.current=a.stream}function s(){x.addEventListener("icecandidate",R),x.addEventListener("addstream",z),S&&S.getTracks().forEach(a=>x.addTrack(a,S))}async function r(){await E(null),s()}async function i(){await r(),k.emit("joinRoom",H,r)}c.useEffect(()=>{i()},[]);const v=async()=>{console.log("sent the offer"),console.log(x);const a=await x.createOffer();x.setLocalDescription(a),console.log(a),k.emit("offer",a,H)};c.useEffect(()=>{if(k)return k.on("welcome",v),()=>{k.off("welcome",v)}});const p=async a=>{console.log("received the offer"),x.setRemoteDescription(a);const n=await x.createAnswer();console.log("sent the answer"),x.setLocalDescription(n),k.emit("answer",n,H)};c.useEffect(()=>{if(k)return k.on("offer",p),()=>{k.off("offer",p)}});const h=a=>{console.log("received the answer"),x.setRemoteDescription(a)};c.useEffect(()=>{if(k)return k.on("answer",h),()=>{k.off("answer",h)}});const f=a=>{console.log("received candidate"),x.addIceCandidate(a)};return c.useEffect(()=>{if(k)return k.on("ice",f),()=>{k.off("ice",f)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!C&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:P,id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{ref:B,id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(se,{onClick:W,children:D?"unmute":"mute"}),e.jsx(se,{onClick:U,children:l?"turn stream on":"turn stream off"}),e.jsx(se,{onClick:J,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:g,children:o.map((a,n)=>e.jsx("option",{value:a.deviceId,selected:(S==null?void 0:S.getVideoTracks()[0].id)===a.deviceId,children:a.label},n))})]}),u&&e.jsx("div",{children:u.toString()})]})}function tt({userObj:o}){const[m,D]=c.useState(""),[t,l]=c.useState([]),M=pe(),{state:u}=oe(),[b,S]=c.useState(!0),[d,L]=c.useState(!1),[j,C]=c.useState(null);c.useEffect(()=>{const y=async()=>{if(u!=null&&u.chattingUid){const A=Y(T,`members/${u.chattingUid}`),x=await q(A);C(x.data())}};u!=null&&u.multiple||y()},[u]);const P=ne(y=>y.piazzaForm.value);c.useEffect(()=>{var A;const y=()=>{var H;const x=window.screen.height-300>(((H=window.visualViewport)==null?void 0:H.height)||window.screen.height);d!==x&&L(x)};return window.addEventListener("resize",y),typeof visualViewport<"u"&&((A=window.visualViewport)==null||A.addEventListener("resize",y)),visualViewport==null||visualViewport.addEventListener("resize",y),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",y)),()=>{var x;typeof visualViewport<"u"&&((x=window.visualViewport)==null||x.removeEventListener("resize",y))}},[d]),c.useEffect(()=>{(u==null?void 0:u.multiple)!==void 0&&S(u==null?void 0:u.multiple)},[]),c.useEffect(()=>{M(Fe(5))});const B=u==null?void 0:u.displayName;return e.jsxs(e.Fragment,{children:[!d&&e.jsx(Qe,{multiple:b,displayName:B}),e.jsx(Ge,{isKeyboardOpen:P,userObj:o,multiple:b,handleMultiple:y=>S(y),messagesList:t,handleMessagesList:y=>l(y)}),e.jsx(Ze,{chattingUser:j,userObj:o,multiple:b,messages:m,handleMessages:y=>D(y),messagesList:t,handleMessagesList:y=>l(y)}),e.jsxs(Be,{children:[e.jsx(Ae,{children:e.jsx("div",{id:"calls"})}),e.jsx(Le,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(We,{})}),e.jsx(He,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{tt as default};
