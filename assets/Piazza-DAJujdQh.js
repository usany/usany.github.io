import{r as p,j as s,az as pa,aB as fa,aO as K,ay as ha,O as Q,ae as _,v as xa,bl as ya,M as F,a5 as W,bm as G,aV as Na,N as u,aM as Ca,$ as R,S as x,a0 as A,a1 as wa,a2 as H,a3 as V,Q as S,U as D,Y as L,aL as J,bn as ua}from"./index-B7KiBrOL.js";const va=({multiple:t,selectUser:N,user:a,handleClose:C,userObj:r,handleMsgList:w,handleChangeMessage:E,displayedName:z})=>{const[b,P]=p.useState(null);return p.useEffect(()=>{N&&((a==null?void 0:a.uid)<r.uid?P((a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):P(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])))},[N]),s.jsxs(pa,{open:N,onClose:C,children:[s.jsxs(fa,{children:[s.jsx("div",{children:s.jsx(K,{alt:a==null?void 0:a.displayName,sx:{bgcolor:(a==null?void 0:a.profileColor)||"#2196f3"},src:(a==null?void 0:a.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:a==null?void 0:a.displayName}),(a==null?void 0:a.displayName)!==z&&s.jsxs("div",{children:["(",z,"에서 개명)"]})]}),s.jsxs(ha,{children:[s.jsx(Q,{to:"/profile",state:{element:a},children:s.jsx(_,{variant:"outlined",onClick:()=>{C()},children:"프로필 확인"})}),t&&r.uid!==(a==null?void 0:a.uid)&&s.jsx(Q,{to:"/piazza",state:{conversation:b,displayName:a==null?void 0:a.displayName,userUid:r.uid,chattingUid:a==null?void 0:a.uid,multiple:!1,profileUrl:a==null?void 0:a.profileImageUrl},children:s.jsx(_,{variant:"outlined",onClick:()=>{w([]),E(!0),C()},children:"개인 대화"})}),s.jsx(_,{variant:"outlined",onClick:()=>{C()},children:"닫기"})]})]})},Ua=xa(ya)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function ka(){const t=F(C=>C.piazzaSwitch.value),N=W(),a=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),N(G("false"))):(window.localStorage.setItem("piazza","true"),N(G("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(Ua,{onClick:()=>a(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}function za({userObj:t}){const N=p.useRef(null),[a,C]=p.useState(""),[r,w]=p.useState([]),[E,z]=p.useState(!0),[b,P]=p.useState(""),[X,O]=p.useState(null),[aa,Y]=p.useState(!1),T=F(e=>e.profileColor.value),v=F(e=>e.profileUrl.value),[ea,sa]=p.useState(null),Z=W(),{state:c}=Na(),M=c==null?void 0:c.multiple,f=c==null?void 0:c.conversation;p.useEffect(()=>{if(!u)return;function e(i){const{msg:o,userUid:m,id:l,target:g,messageClock:n,messageClockNumber:d,conversation:h}=i;w(y=>[...y,{msg:o,type:g?"private":"other",userUid:m,id:l,messageClock:n,messageClockNumber:d,conversation:null,profileImageUrl:v,profileColor:T}])}return u.on("sMessagePiazza",e),()=>{u.off("sMessagePiazza",e)}},[]),p.useEffect(()=>{if(!u)return;function e(i){const{msg:o,userUid:m,id:l,target:g,messageClock:n,messageClockNumber:d,conversation:h}=i;w(y=>[...y,{msg:o,type:g?"private":"other",userUid:m,id:l,messageClock:n,messageClockNumber:d,conversation:null}])}return u.on(`sMessage${f}`,e),()=>{u.off(`sMessage${f}`,e)}},[]),p.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),p.useEffect(()=>{ta(),(async()=>{if(M){const i=R(x,"chats_group"),o=A(i,H("messageClockNumber","desc"),wa(1));(await V(o)).forEach(async l=>{const g=S(x,`chats_group/${l.id}`),d=(await D(g)).data(),h=d.piazzaChecked||[];h.indexOf(t.uid)===-1&&(h.push(t.uid),await L(g,{...d,piazzaChecked:h}))})}else{const i=S(x,`members/${t.uid}`),m=(await D(i)).data().chattings;m[f].messageCount=0,await L(i,{chattings:m})}})()},[r]),p.useEffect(()=>{Z(Ca(5))});const ta=()=>{var e;(e=N.current)==null||e.scrollIntoView()},ia=e=>{e.preventDefault();const i=a,o=t.uid,m=t.displayName,l=Date.now(),g=new Date().toString(),n={msg:i,userUid:o,id:m,messageClockNumber:l,messageClock:g,target:b,conversation:f,conversationUid:c.chattingUid,conversationName:c.displayName,profileUrl:v};M?n&&i&&(u.emit("message",n),la()):i&&(r.length!==0?(u.emit("message",n),console.log("message")):(u.emit("messageNew",n),console.log("messageNew")),da(),ma()),C("")},oa=e=>{C(e.target.value)},na=async({userUid:e,displayName:i})=>{const o=S(x,`members/${e}`),l=(await D(o)).data();O(l),Y(!0),sa(i)},ca=()=>{Y(!1)},la=async()=>{try{const e=a,i=t.uid,o=t.displayName,m=new Date().toString(),l=Date.now();e&&(await J(R(x,"chats_group"),{userUid:i,userName:o,message:e,messageClock:m,messageClockNumber:l,profileImageUrl:v,profileColor:T,piazzaChecked:[t.uid]}),w(g=>[...g,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileImageUrl:v,profileColor:T}]))}catch(e){console.log(e)}};p.useEffect(()=>{E&&(M?((async()=>{const o=[],m=R(x,"chats_group"),l=A(m,H("messageClockNumber"));(await V(l)).forEach(n=>{var $,I;const d=n.data().message,h=n.data().userUid,y=n.data().userName,U=n.data().messageClock,k=n.data().messageClockNumber,j=($=n.data())==null?void 0:$.profileColor,q=(I=n.data())==null?void 0:I.profileImageUrl;o.push({msg:d,type:"me",userUid:h,id:y,messageClockNumber:k,messageClock:U,conversation:null,profileColor:j,profileImageUrl:q}),w(o)})})(),z(!1)):((async o=>{const m=R(x,`chats_${o}`),l=A(m,H("messageClockNumber")),g=await V(l),n=[];g.forEach(d=>{const h=d.data().message,y=d.data().userUid,U=d.data().userName,k=d.data().messageClock,j=d.data().messageClockNumber||0;n.push({msg:h,type:"me",userUid:y,id:U,messageClock:k,messageClockNumber:j}),w(n)})})(f),z(!1)))},[E]);const da=async()=>{const e=a;try{const i=t.uid,o=t.displayName,m=Date.now(),l=new Date().toString();let g,n,d,h,y,U;if(c.userUid<c.chattingUid?(g=c.userUid,n=c.chattingUid,d=t.displayName,h=c.displayName,y=v,U=c.profileUrl):(g=c.chattingUid,n=c.userUid,d=c.displayName,h=t.displayName,y=c.profileUrl,U=v),console.log(c),console.log(v),e){const k={userUid:i,userName:o,message:e,messageClock:l,messageClockNumber:m,userOne:g,userTwo:n,userOneDisplayName:d,userTwoDisplayName:h,userOneProfileUrl:y,userTwoProfileUrl:U};await J(R(x,`chats_${f}`),k);const j=S(x,`members/${i}`),$=(await D(j)).data().chattings||{},I=S(x,`members/${c.chattingUid}`),B=(await D(I)).data().chattings||{},ga=B[f].messageCount||0;$[f]=k,B[f]={...k,messageCount:ga+1},await L(j,{chattings:$}),await L(I,{chattings:B}),w(ra=>[...ra,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:l,conversation:f}])}}catch(i){console.log(i)}},ma=async()=>{try{const e=t.uid,i=c.chattingUid,o=S(x,`members/${e}`),l=(await D(o)).data().conversation||[],g=S(x,`members/${i}`),d=(await D(g)).data().conversation||[];l.indexOf(f)===-1&&(await L(o,{conversation:[...l,f]}),Z(ua())),d.indexOf(f)===-1&&await L(g,{conversation:[...d,f]})}catch(e){console.log(e)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"flex text-2xl p-5",children:[s.jsx("div",{className:"w-screen",children:M?"단체 대화":`개인 대화 ${c==null?void 0:c.displayName}`}),M&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(ka,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[r.map((e,i)=>{if(e.type==="welcome")return s.jsxs("li",{className:"welcome",children:[s.jsx("div",{className:"line"}),s.jsx("div",{children:e.msg}),s.jsx("div",{className:"line"})]});{let o;return e.userUid===t.uid?o="me":o="other",s.jsxs("li",{className:o,name:e.id,"data-id":e.id,onClick:()=>na({userUid:e.userUid,displayName:e.id}),children:[s.jsx("div",{className:`flex justify-${e.userUid!==t.uid?"start":"end"}`,children:s.jsx(K,{alt:e.id,sx:{bgcolor:e.profileColor||"#2196f3"},src:e.profileImageUrl||"./src",variant:"rounded"})}),s.jsx("div",{className:e.id===b?"private-user":"userId","data-id":e.id,name:e.id,children:e.id}),e.userUid!==t.uid?s.jsxs("div",{className:"flex justify-start",children:[s.jsx("div",{className:"other","data-id":e.id,name:e.id,children:e.msg}),s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock})]}):s.jsxs("div",{className:"flex justify-end",children:[s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock}),s.jsx("div",{className:"me","data-id":e.id,name:e.id,children:e.msg})]})]},`${i}_li`)}}),s.jsx("li",{ref:N})]}),s.jsxs("form",{className:"send-form",onSubmit:ia,children:[s.jsx("input",{placeholder:"메세지를 작성해 주세요",onChange:oa,value:a,autoFocus:!0}),s.jsx("button",{type:"submit",children:"전송"})]})]}),s.jsx(va,{multiple:M,selectUser:aa,user:X,handleClose:ca,userObj:t,handleMsgList:e=>w(e),handleChangeMessage:e=>z(e),displayedName:ea})]})})]})}export{za as default};
