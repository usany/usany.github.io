import{r as y,j as t,L as Z,M as q,O as Q,U as O,Q as F,b1 as W,W as D,X as N,Y as z,a1 as T,a2 as Y,a3 as oe,a4 as _,a5 as V,Z as $,S as X,aR as ee,br as ne,v as ce,bs as le,V as ae,ak as re}from"./index-J0Gka_Gw.js";import{w as b}from"./webSocket-B6unP-Tg.js";import{i as de,j as me,k as ge,l as fe,B as te,q as pe}from"./index-BRm8Azre.js";import{D as he}from"./DrawersBar-D8zgBRxc.js";import{P as xe}from"./PageTitle-G-kA0ark.js";const we=({multiple:s,handleMultiple:u,user:e,userObj:n,handleMessagesList:C,displayedName:k})=>{const[x,U]=y.useState(null);return y.useEffect(()=>{e&&((e==null?void 0:e.uid)<n.uid?U((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]):U(n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsx("div",{children:t.jsxs(de,{children:[t.jsx(me,{children:t.jsx("div",{id:"drawer"})}),t.jsx(ge,{className:"bg-light-3 dark:bg-dark-3",children:t.jsxs(fe,{className:"overflow-y-scroll",children:[t.jsx(he,{}),t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsxs(Z,{className:"bg-profile-blue",children:[t.jsx(q,{src:e==null?void 0:e.profileImageUrl}),t.jsx(Q,{className:"text-xl border-none	",children:e==null?void 0:e.displayName[0]})]}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==k&&t.jsxs("div",{children:["(",k,"에서 개명)"]})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(O,{to:"/profile",state:{element:e},children:t.jsx(te,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),s&&n.uid!==(e==null?void 0:e.uid)&&t.jsx(O,{to:"/piazza",state:{conversation:x,displayName:e==null?void 0:e.displayName,userUid:n.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(pe,{children:t.jsx(te,{variant:"outlined",onClick:()=>{C([]),u(!1)},children:"개인 대화"})})})]})]})})]})})};function ue({userObj:s,multiple:u,handleMultiple:e,messagesList:n,handleMessagesList:C}){const k=y.useRef(null),[x,U]=y.useState(null),[R,g]=y.useState(""),h=F(a=>a.profileColor.value),H=F(a=>a.profileUrl.value),{state:P}=W(),E=P==null?void 0:P.conversation,B=async({userUid:a,displayName:c})=>{const l=D(N,`members/${a}`),r=(await z(l)).data();U(r),g(c)};y.useEffect(()=>{if(!b)return;function a(c){const{msg:l,userUid:i,id:r,target:m,messageClock:d,messageClockNumber:o,conversation:p}=c;C(f=>[...f,{msg:l,type:m?"private":"other",userUid:i,id:r,messageClock:d,messageClockNumber:o,conversation:null,profileImageUrl:H,profileColor:h}])}return b.on("sMessagePiazza",a),()=>{b.off("sMessagePiazza",a)}},[]),y.useEffect(()=>{if(!b)return;function a(c){const{msg:l,userUid:i,id:r,target:m,messageClock:d,messageClockNumber:o,conversation:p}=c;C(f=>[...f,{msg:l,type:m?"private":"other",userUid:i,id:r,messageClock:d,messageClockNumber:o,conversation:null}])}return b.on(`sMessage${E}`,a),()=>{b.off(`sMessage${E}`,a)}},[]),y.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),y.useEffect(()=>{L(),(async()=>{if(u){const c=T(N,"chats_group"),l=Y(c,_("messageClockNumber","desc"),oe(1));(await V(l)).forEach(async r=>{const m=D(N,`chats_group/${r.id}`),o=(await z(m)).data(),p=o.piazzaChecked||[];p.indexOf(s.uid)===-1&&(p.push(s.uid),await $(m,{...o,piazzaChecked:p}))})}else{const c=D(N,`members/${s.uid}`),i=(await z(c)).data().chattings;i[E].messageCount=0,await $(c,{chattings:i})}})()},[n]);const L=()=>{var a;(a=k.current)==null||a.scrollIntoView()};return y.useEffect(()=>{u?(async()=>{const l=[],i=T(N,"chats_group"),r=Y(i,_("messageClockNumber"));(await V(r)).forEach(d=>{var v,I;const o=d.data().message,p=d.data().userUid,f=d.data().userName,w=d.data().messageClock,j=d.data().messageClockNumber,S=(v=d.data())==null?void 0:v.profileColor,M=(I=d.data())==null?void 0:I.profileImageUrl;l.push({msg:o,type:"me",userUid:p,id:f,messageClockNumber:j,messageClock:w,conversation:null,profileColor:S,profileImageUrl:M}),C(l)})})():(async l=>{const i=T(N,`chats_${l}`),r=Y(i,_("messageClockNumber")),m=await V(r),d=[];m.forEach(o=>{const p=o.data().message,f=o.data().userUid,w=o.data().userName,j=o.data().messageClock,S=o.data().messageClockNumber||0;d.push({msg:p,type:"me",userUid:f,id:w,messageClock:j,messageClockNumber:S}),C(d)})})(E)},[u]),t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{className:"p-1 border-t rounded-xl h-[350px] overflow-auto",children:t.jsxs("ul",{children:[n.map((a,c)=>{let l;const i=new Date(a.messageClock);a.userUid===s.uid?l="text-right":l="text-left";let r,m;c>0&&(r=n[c-1].userUid),c<n.length-1&&n[c+1].userUid===s.uid&&(m=new Date(n[c+1].messageClock),i.getFullYear()===m.getFullYear()&&i.getMonth()===m.getMonth()&&i.getDate()===m.getDate()&&i.getHours()===m.getHours()&&(i.getMinutes(),m.getMinutes()));let d,o=i.getHours(),p=(i.getMonth()+1).toString(),f=i.getDate().toString();return o>=13?(d="오후",o!==12&&(o=o-12)):(d="오전",o===0&&(o=o+12)),i.getMonth()+1<10&&(p="0"+p),f.length===1&&(f="0"+f),t.jsxs("li",{className:l,children:[r!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:l==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsxs(Z,{onClick:()=>{var w;(w=document.getElementById("drawer"))==null||w.click(),B({userUid:a.userUid,displayName:a.id})},className:"bg-profile-blue",children:[t.jsx(q,{src:a==null?void 0:a.profileImageUrl}),t.jsx(Q,{className:"text-xl border-none	",children:a==null?void 0:a.id[0]})]}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsxs(Z,{onClick:()=>{var w;(w=document.getElementById("drawer"))==null||w.click(),B({userUid:a.userUid,displayName:a.id})},className:"bg-profile-blue",children:[t.jsx(q,{src:a==null?void 0:a.profileImageUrl}),t.jsx(Q,{className:"text-xl border-none	",children:a==null?void 0:a.id[0]})]})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[i.getFullYear(),"-",p,"-",f," ",d," ",o,":",i.getMinutes()<10&&"0",i.getMinutes()]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[i.getFullYear(),"-",p,"-",f," ",d," ",o,":",i.getMinutes()<10&&"0",i.getMinutes()]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},c)}),t.jsx("li",{ref:k})]})})}),t.jsx(we,{multiple:u,handleMultiple:e,user:x,userObj:s,handleMessagesList:C,displayedName:R})]})}function Ne({userObj:s,multiple:u,messages:e,handleMessages:n,messagesList:C,handleMessagesList:k}){const x=F(a=>a.profileColor.value),U=F(a=>a.profileUrl.value),R=X(),{state:g}=W(),h=g==null?void 0:g.conversation,H=async a=>{var w;a.preventDefault();const c=e,l=s.uid,i=s.displayName,r=Date.now(),m=new Date().toString();let d,o,p;g.chattingUid&&(d=D(N,`members/${g.chattingUid}`),o=await z(d),p=(w=o.data())==null?void 0:w.messagingToken);const f={msg:c,userUid:l,id:i,messageClockNumber:r,messageClock:m,conversation:h,conversationUid:g.chattingUid,conversationName:g.displayName,profileUrl:U,sendingToken:p};u?f&&c&&(b.emit("piazzaMessage",f),E()):c&&(C.length!==0?(b.emit("message",f),console.log("message")):(b.emit("messageNew",f),console.log("messageNew")),B(),L()),n("")},P=a=>{n(a.target.value)},E=async()=>{try{const a=e,c=s.uid,l=s.displayName,i=new Date().toString(),r=Date.now();a&&(await ee(T(N,"chats_group"),{userUid:c,userName:l,message:a,messageClock:i,messageClockNumber:r,profileImageUrl:U,profileColor:x,piazzaChecked:[s.uid]}),k(m=>[...m,{msg:a,type:"me",userUid:s.uid,id:s.displayName,messageClock:i,conversation:null,profileImageUrl:U,profileColor:x}]))}catch(a){console.log(a)}},B=async()=>{var c,l,i;const a=e;try{const r=s.uid,m=s.displayName,d=Date.now(),o=new Date().toString();let p,f,w,j,S,M;if(g.userUid<g.chattingUid?(p=g.userUid,f=g.chattingUid,w=s.displayName,j=g.displayName,S=U,M=g.profileUrl):(p=g.chattingUid,f=g.userUid,w=g.displayName,j=s.displayName,S=g.profileUrl,M=U),!S){const v=D(N,`members/${p}`);S=(c=(await z(v)).data())==null?void 0:c.profileImageUrl}if(!M){const v=D(N,`members/${f}`);M=(l=(await z(v)).data())==null?void 0:l.profileImageUrl}if(a){const v={userUid:r,userName:m,message:a,messageClock:o,messageClockNumber:d,userOne:p,userTwo:f,userOneDisplayName:w,userTwoDisplayName:j,userOneProfileUrl:S,userTwoProfileUrl:M};await ee(T(N,`chats_${h}`),v);const I=D(N,`members/${r}`),J=(await z(I)).data().chattings||{},K=D(N,`members/${g.chattingUid}`),A=(await z(K)).data().chattings||{},se=((i=A[h])==null?void 0:i.messageCount)||0;J[h]=v,A[h]={...v,messageCount:se+1},await $(I,{chattings:J}),await $(K,{chattings:A}),k(ie=>[...ie,{msg:a,type:"me",userUid:s.uid,id:s.displayName,messageClock:o,conversation:h}])}}catch(r){console.log(r)}},L=async()=>{try{const a=s.uid,c=g.chattingUid,l=D(N,`members/${a}`),r=(await z(l)).data().conversation||[],m=D(N,`members/${c}`),o=(await z(m)).data().conversation||[];r.indexOf(h)===-1&&(await $(l,{conversation:[...r,h]}),R(ne())),o.indexOf(h)===-1&&await $(m,{conversation:[...o,h]})}catch(a){console.log(a)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:H,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:P,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})})}const ye=ce(le)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ue(){const s=F(n=>n.piazzaSwitch.value),u=X(),e=()=>{s==="true"?(window.localStorage.setItem("piazza","false"),u(ae("false"))):(window.localStorage.setItem("piazza","true"),u(ae("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ye,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:s==="true"})})]})}const Ce=({multiple:s,displayName:u})=>t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(xe,{title:s?"단체 대화":`개인 대화 ${u}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Ue,{})})]});function je({userObj:s}){const[u,e]=y.useState(""),[n,C]=y.useState([]),k=X(),{state:x}=W(),[U,R]=y.useState(!0);y.useEffect(()=>{(x==null?void 0:x.multiple)!==void 0&&R(x==null?void 0:x.multiple)},[]),y.useEffect(()=>{k(re(5))});const g=x==null?void 0:x.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(Ce,{multiple:U,displayName:g}),t.jsx(ue,{userObj:s,multiple:U,handleMultiple:h=>R(h),messagesList:n,handleMessagesList:h=>C(h)}),t.jsx(Ne,{userObj:s,multiple:U,messages:u,handleMessages:h=>e(h),messagesList:n,handleMessagesList:h=>C(h)})]})}export{je as default};
