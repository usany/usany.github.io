import{u as Z,K as ae,aE as ie,c as J,j as t,k as $,g as N,V as P,S as F,aJ as le,f as G,v as Y,aL as he,r as u,I as se,O as ce,B as re,as as we,P as de,aM as ge,q as X,U as O,E as ee,h as te,aH as me,ad as xe,aN as ve,Q as fe,w as ke,a5 as ye}from"./index-Dy5Ux55k.js";const Ce={ko:"메세지를 작성해 주세요",en:"Input message"},Ue={ko:"전송",en:"send"};function Ne({userObj:n,multiple:f,messages:x,handleMessages:e,messagesList:a,handleMessagesList:S}){const w=Z(m=>m.profileColor.value),y=Z(m=>m.profileUrl.value),I=ae(),{state:o}=ie(),v=o==null?void 0:o.conversation,B=J(m=>m.languages.value),h=B==="ko"||B==="en"?B:"ko",L=async m=>{var s;m.preventDefault();const b=x,D=n.uid,U=n.displayName,C=Date.now(),R=new Date().toString();let H,j,V;o.chattingUid&&(H=$(N,`members/${o.chattingUid}`),j=await P(H),V=(s=j.data())==null?void 0:s.messagingToken);const E={msg:b,userUid:D,id:U,messageClockNumber:C,messageClock:R,conversation:v,conversationUid:o.chattingUid,conversationName:o.displayName,profileUrl:y,sendingToken:V};f?E&&b&&(F.emit("piazzaMessage",E),T()):b&&(a.length!==0?(F.emit("message",E),console.log("message")):(F.emit("messageNew",E),console.log("messageNew")),Q(),A()),e("")},M=m=>{e(m.target.value)},T=async()=>{try{const m=x,b=n.uid,D=n.displayName,U=new Date().toString(),C=Date.now();m&&(await le(G(N,"chats_group"),{userUid:b,userName:D,message:m,messageClock:U,messageClockNumber:C,profileImageUrl:y,profileColor:w,piazzaChecked:[n.uid]}),S(R=>[...R,{msg:m,type:"me",userUid:n.uid,id:n.displayName,messageClock:U,conversation:null,profileImageUrl:y,profileColor:w}]))}catch(m){console.log(m)}},Q=async()=>{var b,D,U;const m=x;try{const C=n.uid,R=n.displayName,H=Date.now(),j=new Date().toString();let V,E,s,c,r,i;if(o.userUid<o.chattingUid?(V=o.userUid,E=o.chattingUid,s=n.displayName,c=o.displayName,r=y,i=o.profileUrl):(V=o.chattingUid,E=o.userUid,s=o.displayName,c=n.displayName,r=o.profileUrl,i=y),!r){const p=$(N,`members/${V}`);r=(b=(await P(p)).data())==null?void 0:b.profileImageUrl}if(!i){const p=$(N,`members/${E}`);i=(D=(await P(p)).data())==null?void 0:D.profileImageUrl}if(m){const p={userUid:C,userName:R,message:m,messageClock:j,messageClockNumber:H,userOne:V,userTwo:E,userOneDisplayName:s,userTwoDisplayName:c,userOneProfileUrl:r,userTwoProfileUrl:i};await le(G(N,`chats_${v}`),p);const l=$(N,`members/${C}`),g=(await P(l)).data().chattings||{},k=$(N,`members/${o.chattingUid}`),_=(await P(k)).data().chattings||{},K=((U=_[v])==null?void 0:U.messageCount)||0;g[v]=p,_[v]={...p,messageCount:K+1},await Y(l,{chattings:g}),await Y(k,{chattings:_}),S(q=>[...q,{msg:m,type:"me",userUid:n.uid,id:n.displayName,messageClock:j,conversation:v}])}}catch(C){console.log(C)}},A=async()=>{try{const m=n.uid,b=o.chattingUid,D=$(N,`members/${m}`),C=(await P(D)).data().conversation||[],R=$(N,`members/${b}`),j=(await P(R)).data().conversation||[];C.indexOf(v)===-1&&(await Y(D,{conversation:[...C,v]}),I(he())),j.indexOf(v)===-1&&await Y(R,{conversation:[...j,v]})}catch(m){console.log(m)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:L,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ce[h],onChange:M,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ue[h]})]})})}const pe=({initiateContinuing:n,multiple:f,handleMultiple:x,user:e,userObj:a,handleMessagesList:S,displayedName:w})=>{const[y,I]=u.useState(null),o=J(v=>v.languages.value);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<a.uid?I((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+a.uid[0]+a.uid[1]+a.uid[2]+a.uid[3]+a.uid[4]+a.uid[5]):I(a.uid[0]+a.uid[1]+a.uid[2]+a.uid[3]+a.uid[4]+a.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(se,{uid:a.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==w&&t.jsx("div",{children:o==="ko"?t.jsxs("div",{children:["(",w,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(ce,{to:"/profile",state:{element:e},children:t.jsx(re,{variant:"outlined",onClick:()=>{},children:o==="ko"?"프로필 확인":"Check Profile"})}),f&&a.uid!==(e==null?void 0:e.uid)&&t.jsx(ce,{to:"/piazza",state:{conversation:y,displayName:e==null?void 0:e.displayName,userUid:a.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(we,{children:t.jsx(re,{variant:"outlined",onClick:()=>{S([]),x(!1),n()},children:o==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ze({isKeyboardOpen:n,userObj:f,multiple:x,handleMultiple:e,messagesList:a,handleMessagesList:S}){const w=u.useRef(null),y=u.useRef(null),[I,o]=u.useState(null),[v,B]=u.useState(""),[h,L]=u.useState(!1),[M,T]=u.useState(null),[Q,A]=u.useState(0),m=Z(s=>s.profileColor.value),b=Z(s=>s.profileUrl.value),{state:D}=ie(),U=D==null?void 0:D.conversation,C=J(s=>s.languages.value),R=async({userUid:s,displayName:c})=>{const r=$(N,`members/${s}`),p=(await P(r)).data();o(p),B(c)},H=({userUid:s,displayName:c})=>{var r;(r=document.getElementById("drawer"))==null||r.click(),R({userUid:s,displayName:c})},j=20;u.useEffect(()=>{if(!F)return;function s(c){const{msg:r,userUid:i,id:p,target:l,messageClock:d,messageClockNumber:g,conversation:k}=c;S(z=>[...z,{msg:r,type:l?"private":"other",userUid:i,id:p,messageClock:d,messageClockNumber:g,conversation:null,profileImageUrl:b,profileColor:m}])}return F.on("sMessagePiazza",s),()=>{F.off("sMessagePiazza",s)}},[]),u.useEffect(()=>{if(!F)return;function s(c){const{msg:r,userUid:i,id:p,target:l,messageClock:d,messageClockNumber:g,conversation:k}=c;S(z=>[...z,{msg:r,type:l?"private":"other",userUid:i,id:p,messageClock:d,messageClockNumber:g,conversation:null}])}return F.on(`sMessage${U}`,s),()=>{F.off(`sMessage${U}`,s)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{V(),(async()=>{if(x){const c=G(N,"chats_group"),r=X(c,ee("messageClockNumber","desc"),O(1));(await te(r)).forEach(async p=>{const l=$(N,`chats_group/${p.id}`),g=(await P(l)).data(),k=g.piazzaChecked||[];k.indexOf(f.uid)===-1&&(k.splice(-1,f.uid,0),k.push(f.uid),await Y(l,{...g,piazzaChecked:k}))})}else{const c=$(N,`members/${f.uid}`),i=(await P(c)).data().chattings;i[U].messageCount=0,await Y(c,{chattings:i})}})()},[a]);const V=()=>{var s;(s=w.current)==null||s.scrollIntoView()};u.useEffect(()=>{const s=async()=>{const r=[],i=G(N,"chats_group"),p=X(i,ee("messageClockNumber","desc"),O(j),me(M||"")),l=await te(p);l.docs.length||A(l.docs.length),l.forEach(d=>{var ne,oe;r.length===l.docs.length-1&&(T(d),A(l.docs.length-1));const g=d.data().message,k=d.data().userUid,z=d.data().userName,_=d.data().messageClock,K=d.data().messageClockNumber,q=(ne=d.data())==null?void 0:ne.profileColor,W=(oe=d.data())==null?void 0:oe.profileImageUrl;r.push({msg:g,type:"me",userUid:k,id:z,messageClockNumber:K,messageClock:_,conversation:null,profileColor:q,profileImageUrl:W})}),r.reverse(),S([...r,...a]),L(!1)},c=async r=>{const i=G(N,`chats_${r}`),p=X(i,ee("messageClockNumber","desc"),O(j),me(M||"")),l=await te(p),d=[];l.docs.length||A(l.docs.length),l.forEach((g,k)=>{d.length===l.docs.length-1&&(T(g),A(l.docs.length-1));const z=g.data().message,_=g.data().userUid,K=g.data().userName,q=g.data().messageClock,W=g.data().messageClockNumber||0;d.push({msg:z,type:"me",userUid:_,id:K,messageClock:q,messageClockNumber:W})}),d.reverse(),S([...d,...a]),L(!1)};U?(h||!a.length)&&c(U):(h||!a.length)&&s()},[h,U]);const E=()=>{y.current.scrollTop!==0||h||(console.log("scroll"),L(!0))};return u.useEffect(()=>{var s;return(s=y.current)==null||s.addEventListener("scroll",E),()=>{var c;return(c=y.current)==null?void 0:c.removeEventListener("scroll",E)}},[h]),t.jsx(t.Fragment,{children:t.jsx("div",{className:`fixed bottom-[110px] w-screen h-${n?"full":"[60%]"} bg-light-3 dark:bg-dark-3 flex flex-col pt-5`,children:t.jsx("div",{ref:y,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[h&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),a.map((s,c)=>{let r;const i=new Date(s.messageClock);s.userUid===f.uid?r="text-right":r="text-left";let p,l;c>0&&(p=a[c-1].userUid),c<a.length-1&&a[c+1].userUid===f.uid&&(l=new Date(a[c+1].messageClock),i.getFullYear()===l.getFullYear()&&i.getMonth()===l.getMonth()&&i.getDate()===l.getDate()&&i.getHours()===l.getHours()&&(i.getMinutes(),l.getMinutes()));let d,g=i.getHours(),k=(i.getMonth()+1).toString(),z=i.getDate().toString();return g>=13?(d="오후",g!==12&&(g=g-12)):(d="오전",g===0&&(g=g+12)),i.getMonth()+1<10&&(k="0"+k),z.length===1&&(z="0"+z),t.jsxs("li",{ref:c===Q?w:null,className:r,children:[p!==s.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${s.userUid!==f.uid?"start":"end"}`,children:r==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(de,{trigger:t.jsx(se,{uid:f.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>H({userUid:s.userUid,displayName:s.id})}),title:t.jsx(ge,{}),content:t.jsx(pe,{initiateContinuing:()=>T(null),multiple:x,handleMultiple:e,user:I,userObj:f,handleMessagesList:S,displayedName:v})}),t.jsx("div",{children:s.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:s.id}),t.jsx(de,{trigger:t.jsx(se,{uid:f.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>H({userUid:s.userUid,displayName:s.id})}),title:t.jsx(ge,{}),content:t.jsx(pe,{initiateContinuing:()=>T(null),multiple:x,handleMultiple:e,user:I,userObj:f,handleMessagesList:S,displayedName:v})})]})})}),s.userUid!==f.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),t.jsxs("div",{children:[i.getFullYear(),"-",k,"-",z," ",C==="ko"&&d," ",g,":",i.getMinutes()<10&&"0",i.getMinutes(),C==="en"&&(d==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[i.getFullYear(),"-",k,"-",z," ",C==="ko"&&d," ",g,":",i.getMinutes()<10&&"0",i.getMinutes(),C==="en"&&(d==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},c)}),t.jsx("li",{ref:w})]})})})})}const Se=xe(ve)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function De(){const n=J(a=>a.languages.value),f=Z(a=>a.piazzaSwitch.value),x=ae(),e=()=>{f==="true"?(window.localStorage.setItem("piazza","false"),x(fe("false"))):(window.localStorage.setItem("piazza","true"),x(fe("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Se,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:f==="true"})})]})}const ue={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Me=({multiple:n,displayName:f})=>{const x=J(a=>a.languages.value),e=x==="ko"||x==="en"?x:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(ke,{title:n?ue[e][0]:`${ue[e][1]} ${f}`}),n&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(De,{})})]})};function Ee({userObj:n}){const[f,x]=u.useState(""),[e,a]=u.useState([]),S=ae(),{state:w}=ie(),[y,I]=u.useState(!0),[o,v]=u.useState(!1);u.useEffect(()=>{var L;const h=()=>{var T;const M=window.screen.height-300>(((T=window.visualViewport)==null?void 0:T.height)||window.screen.height);o!==M&&v(M)};return window.addEventListener("resize",h),typeof visualViewport<"u"&&((L=window.visualViewport)==null||L.addEventListener("resize",h)),()=>{var M;typeof visualViewport<"u"&&((M=window.visualViewport)==null||M.removeEventListener("resize",h))}},[o]),console.log(o),u.useEffect(()=>{(w==null?void 0:w.multiple)!==void 0&&I(w==null?void 0:w.multiple)},[]),window.addEventListener("resize",()=>{window.visualViewport}),visualViewport.addEventListener("resize",()=>{window.visualViewport&&console.log(window.visualViewport.height)}),u.useEffect(()=>{S(ye(5))});const B=w==null?void 0:w.displayName;return t.jsxs(t.Fragment,{children:[!o&&t.jsx(Me,{multiple:y,displayName:B}),t.jsx(ze,{isKeyboardOpen:o,userObj:n,multiple:y,handleMultiple:h=>I(h),messagesList:e,handleMessagesList:h=>a(h)}),t.jsx(Ne,{userObj:n,multiple:y,messages:f,handleMessages:h=>x(h),messagesList:e,handleMessagesList:h=>a(h)})]})}export{Ee as default};
