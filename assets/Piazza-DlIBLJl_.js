import{u as A,K as oe,aE as ae,c as O,j as t,k as B,g as z,V as H,S as L,aJ as ce,f as q,v as Y,aL as we,r as p,I as ne,O as le,B as re,as as ve,P as de,aM as ge,q as Z,U as J,E as Q,h as W,aH as se,ac as Ce,aN as ke,Q as me,w as ye,a4 as Ne}from"./index-CrVNIYYk.js";const fe={ko:"메세지를 작성해 주세요",en:"Input message"},pe={ko:"전송",en:"send"};function ze({userObj:a,multiple:y,messages:x,handleMessages:e,messagesList:n,handleMessagesList:R}){const w=A(o=>o.profileColor.value),S=A(o=>o.profileUrl.value),j=A(o=>o.piazzaForm.value),b=oe(),{state:g}=ae(),k=g==null?void 0:g.conversation,T=O(o=>o.languages.value),m=T==="ko"||T==="en"?T:"ko",P=async o=>{var l;o.preventDefault();const h=x,N=a.uid,U=a.displayName,u=Date.now(),v=new Date().toString();let I,$,s;g.chattingUid&&(I=B(z,`members/${g.chattingUid}`),$=await H(I),s=(l=$.data())==null?void 0:l.messagingToken);const i={msg:h,userUid:N,id:U,messageClockNumber:u,messageClock:v,conversation:k,conversationUid:g.chattingUid,conversationName:g.displayName,profileUrl:S,sendingToken:s};y?i&&h&&(L.emit("piazzaMessage",i),_()):h&&(n.length!==0?(L.emit("message",i),console.log("message")):(L.emit("messageNew",i),console.log("messageNew")),E(),F()),e("")},V=o=>{e(o.target.value)},_=async()=>{try{const o=x,h=a.uid,N=a.displayName,U=new Date().toString(),u=Date.now();o&&(await ce(q(z,"chats_group"),{userUid:h,userName:N,message:o,messageClock:U,messageClockNumber:u,profileImageUrl:S,profileColor:w,piazzaChecked:[a.uid]}),R(v=>[...v,{msg:o,type:"me",userUid:a.uid,id:a.displayName,messageClock:U,conversation:null,profileImageUrl:S,profileColor:w}]))}catch(o){console.log(o)}},E=async()=>{var h,N,U;const o=x;try{const u=a.uid,v=a.displayName,I=Date.now(),$=new Date().toString();let s,i,l,c,C,r;if(g.userUid<g.chattingUid?(s=g.userUid,i=g.chattingUid,l=a.displayName,c=g.displayName,C=S,r=g.profileUrl):(s=g.chattingUid,i=g.userUid,l=g.displayName,c=a.displayName,C=g.profileUrl,r=S),!C){const d=B(z,`members/${s}`);C=(h=(await H(d)).data())==null?void 0:h.profileImageUrl}if(!r){const d=B(z,`members/${i}`);r=(N=(await H(d)).data())==null?void 0:N.profileImageUrl}if(o){const d={userUid:u,userName:v,message:o,messageClock:$,messageClockNumber:I,userOne:s,userTwo:i,userOneDisplayName:l,userTwoDisplayName:c,userOneProfileUrl:C,userTwoProfileUrl:r};await ce(q(z,`chats_${k}`),d);const f=B(z,`members/${u}`),M=(await H(f)).data().chattings||{},K=B(z,`members/${g.chattingUid}`),G=(await H(K)).data().chattings||{},X=((U=G[k])==null?void 0:U.messageCount)||0;M[k]=d,G[k]={...d,messageCount:X+1},await Y(f,{chattings:M}),await Y(K,{chattings:G}),R(te=>[...te,{msg:o,type:"me",userUid:a.uid,id:a.displayName,messageClock:$,conversation:k}])}}catch(u){console.log(u)}},F=async()=>{try{const o=a.uid,h=g.chattingUid,N=B(z,`members/${o}`),u=(await H(N)).data().conversation||[],v=B(z,`members/${h}`),$=(await H(v)).data().conversation||[];u.indexOf(k)===-1&&(await Y(N,{conversation:[...u,k]}),b(we())),$.indexOf(k)===-1&&await Y(v,{conversation:[...$,k]})}catch(o){console.log(o)}};return t.jsx(t.Fragment,{children:j?t.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:P,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:fe[m],onChange:V,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:pe[m]})]}):t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:P,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:fe[m],onChange:V,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:pe[m]})]})})}const ue=({initiateContinuing:a,multiple:y,handleMultiple:x,user:e,userObj:n,handleMessagesList:R,displayedName:w})=>{const[S,j]=p.useState(null),b=O(g=>g.languages.value);return p.useEffect(()=>{e&&((e==null?void 0:e.uid)<n.uid?j((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]):j(n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(ne,{uid:n.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==w&&t.jsx("div",{children:b==="ko"?t.jsxs("div",{children:["(",w,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:"/profile",state:{element:e},children:t.jsx(re,{variant:"outlined",onClick:()=>{},children:b==="ko"?"프로필 확인":"Check Profile"})}),y&&n.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:"/piazza",state:{conversation:S,displayName:e==null?void 0:e.displayName,userUid:n.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ve,{children:t.jsx(re,{variant:"outlined",onClick:()=>{R([]),x(!1),a()},children:b==="ko"?"개인 대화":"Private messaging"})})})]})]})};function he({userObj:a,multiple:y,handleMultiple:x,messagesList:e,handleMessagesList:n}){const R=p.useRef(null),w=p.useRef(null),[S,j]=p.useState(null),[b,g]=p.useState(""),[k,T]=p.useState(!1),[m,P]=p.useState(null),[V,_]=p.useState(0),E=A(s=>s.profileColor.value),F=A(s=>s.profileUrl.value),{state:o}=ae(),h=o==null?void 0:o.conversation,N=O(s=>s.languages.value),U=async({userUid:s,displayName:i})=>{const l=B(z,`members/${s}`),C=(await H(l)).data();j(C),g(i)},u=({userUid:s,displayName:i})=>{var l;(l=document.getElementById("drawer"))==null||l.click(),U({userUid:s,displayName:i})},v=20;p.useEffect(()=>{if(!L)return;function s(i){const{msg:l,userUid:c,id:C,target:r,messageClock:d,messageClockNumber:f,conversation:D}=i;n(M=>[...M,{msg:l,type:r?"private":"other",userUid:c,id:C,messageClock:d,messageClockNumber:f,conversation:null,profileImageUrl:F,profileColor:E}])}return L.on("sMessagePiazza",s),()=>{L.off("sMessagePiazza",s)}},[]),p.useEffect(()=>{if(!L)return;function s(i){const{msg:l,userUid:c,id:C,target:r,messageClock:d,messageClockNumber:f,conversation:D}=i;n(M=>[...M,{msg:l,type:r?"private":"other",userUid:c,id:C,messageClock:d,messageClockNumber:f,conversation:null}])}return L.on(`sMessage${h}`,s),()=>{L.off(`sMessage${h}`,s)}},[]),p.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),p.useEffect(()=>{I(),(async()=>{if(y){const i=q(z,"chats_group"),l=Z(i,Q("messageClockNumber","desc"),J(1));(await W(l)).forEach(async C=>{const r=B(z,`chats_group/${C.id}`),f=(await H(r)).data(),D=f.piazzaChecked||[];D.indexOf(a.uid)===-1&&(D.splice(-1,a.uid,0),D.push(a.uid),await Y(r,{...f,piazzaChecked:D}))})}else{const i=B(z,`members/${a.uid}`),c=(await H(i)).data().chattings;c[h].messageCount=0,await Y(i,{chattings:c})}})()},[e]);const I=()=>{var s;(s=R.current)==null||s.scrollIntoView()};p.useEffect(()=>{const s=async()=>{const l=[],c=q(z,"chats_group"),C=Z(c,Q("messageClockNumber","desc"),J(v),se(m||"")),r=await W(C);r.docs.length||_(r.docs.length),r.forEach(d=>{var te,ie;l.length===r.docs.length-1&&(P(d),_(r.docs.length-1));const f=d.data().message,D=d.data().userUid,M=d.data().userName,K=d.data().messageClock,ee=d.data().messageClockNumber,G=(te=d.data())==null?void 0:te.profileColor,X=(ie=d.data())==null?void 0:ie.profileImageUrl;l.push({msg:f,type:"me",userUid:D,id:M,messageClockNumber:ee,messageClock:K,conversation:null,profileColor:G,profileImageUrl:X})}),l.reverse(),n([...l,...e]),T(!1)},i=async l=>{const c=q(z,`chats_${l}`),C=Z(c,Q("messageClockNumber","desc"),J(v),se(m||"")),r=await W(C),d=[];r.docs.length||_(r.docs.length),r.forEach((f,D)=>{d.length===r.docs.length-1&&(P(f),_(r.docs.length-1));const M=f.data().message,K=f.data().userUid,ee=f.data().userName,G=f.data().messageClock,X=f.data().messageClockNumber||0;d.push({msg:M,type:"me",userUid:K,id:ee,messageClock:G,messageClockNumber:X})}),d.reverse(),n([...d,...e]),T(!1)};h?(k||!e.length)&&i(h):(k||!e.length)&&s()},[k,h]);const $=()=>{w.current.scrollTop!==0||k||(console.log("scroll"),T(!0))};return p.useEffect(()=>{var s;return(s=w.current)==null||s.addEventListener("scroll",$),()=>{var i;return(i=w.current)==null?void 0:i.removeEventListener("scroll",$)}},[k]),t.jsx(t.Fragment,{children:t.jsx(t.Fragment,{children:t.jsx("div",{ref:w,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[k&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((s,i)=>{let l;const c=new Date(s.messageClock);s.userUid===a.uid?l="text-right":l="text-left";let C,r;i>0&&(C=e[i-1].userUid),i<e.length-1&&e[i+1].userUid===a.uid&&(r=new Date(e[i+1].messageClock),c.getFullYear()===r.getFullYear()&&c.getMonth()===r.getMonth()&&c.getDate()===r.getDate()&&c.getHours()===r.getHours()&&(c.getMinutes(),r.getMinutes()));let d,f=c.getHours(),D=(c.getMonth()+1).toString(),M=c.getDate().toString();return f>=13?(d="오후",f!==12&&(f=f-12)):(d="오전",f===0&&(f=f+12)),c.getMonth()+1<10&&(D="0"+D),M.length===1&&(M="0"+M),t.jsxs("li",{ref:i===V?R:null,className:l,children:[C!==s.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${s.userUid!==a.uid?"start":"end"}`,children:l==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(de,{trigger:t.jsx(ne,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>u({userUid:s.userUid,displayName:s.id})}),title:t.jsx(ge,{}),content:t.jsx(ue,{initiateContinuing:()=>P(null),multiple:y,handleMultiple:x,user:S,userObj:a,handleMessagesList:n,displayedName:b})}),t.jsx("div",{children:s.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:s.id}),t.jsx(de,{trigger:t.jsx(ne,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>u({userUid:s.userUid,displayName:s.id})}),title:t.jsx(ge,{}),content:t.jsx(ue,{initiateContinuing:()=>P(null),multiple:y,handleMultiple:x,user:S,userObj:a,handleMessagesList:n,displayedName:b})})]})})}),s.userUid!==a.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),t.jsxs("div",{children:[c.getFullYear(),"-",D,"-",M," ",N==="ko"&&d," ",f,":",c.getMinutes()<10&&"0",c.getMinutes(),N==="en"&&(d==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[c.getFullYear(),"-",D,"-",M," ",N==="ko"&&d," ",f,":",c.getMinutes()<10&&"0",c.getMinutes(),N==="en"&&(d==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},i)}),t.jsx("li",{ref:R})]})})})})}function Ue({isKeyboardOpen:a,userObj:y,multiple:x,handleMultiple:e,messagesList:n,handleMessagesList:R}){const w=p.useRef(null),S=p.useRef(null),[j,b]=p.useState(!1),[g,k]=p.useState(null);A(E=>E.profileColor.value),A(E=>E.profileUrl.value);const{state:T}=ae(),m=T==null?void 0:T.conversation,P=20;p.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),p.useEffect(()=>{V(),(async()=>{if(x){const F=q(z,"chats_group"),o=Z(F,Q("messageClockNumber","desc"),J(1));(await W(o)).forEach(async N=>{const U=B(z,`chats_group/${N.id}`),v=(await H(U)).data(),I=v.piazzaChecked||[];I.indexOf(y.uid)===-1&&(I.splice(-1,y.uid,0),I.push(y.uid),await Y(U,{...v,piazzaChecked:I}))})}else{const F=B(z,`members/${y.uid}`),h=(await H(F)).data().chattings;h[m].messageCount=0,await Y(F,{chattings:h})}})()},[n]);const V=()=>{var E;(E=w.current)==null||E.scrollIntoView()};p.useEffect(()=>{const E=async()=>{const o=[],h=q(z,"chats_group"),N=Z(h,Q("messageClockNumber","desc"),J(P),se(g||"")),U=await W(N);U.forEach(u=>{var C,r;o.length===U.docs.length-1&&k(u);const v=u.data().message,I=u.data().userUid,$=u.data().userName,s=u.data().messageClock,i=u.data().messageClockNumber,l=(C=u.data())==null?void 0:C.profileColor,c=(r=u.data())==null?void 0:r.profileImageUrl;o.push({msg:v,type:"me",userUid:I,id:$,messageClockNumber:i,messageClock:s,conversation:null,profileColor:l,profileImageUrl:c})}),o.reverse(),R([...o,...n]),b(!1)},F=async o=>{const h=q(z,`chats_${o}`),N=Z(h,Q("messageClockNumber","desc"),J(P),se(g||"")),U=await W(N),u=[];U.forEach((v,I)=>{u.length===U.docs.length-1&&k(v);const $=v.data().message,s=v.data().userUid,i=v.data().userName,l=v.data().messageClock,c=v.data().messageClockNumber||0;u.push({msg:$,type:"me",userUid:s,id:i,messageClock:l,messageClockNumber:c})}),u.reverse(),R([...u,...n]),b(!1)};m?(j||!n.length)&&F(m):(j||!n.length)&&E()},[j,m]);const _=()=>{S.current.scrollTop!==0||j||b(!0)};return p.useEffect(()=>{var E;return(E=S.current)==null||E.addEventListener("scroll",_),()=>{var F;return(F=S.current)==null?void 0:F.removeEventListener("scroll",_)}},[j]),t.jsx(t.Fragment,{children:a?t.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:t.jsx(he,{isKeyboardOpen:a,userObj:y,multiple:x,handleMultiple:e,messagesList:n,handleMessagesList:R})}):t.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:t.jsx(he,{isKeyboardOpen:a,userObj:y,multiple:x,handleMultiple:e,messagesList:n,handleMessagesList:R})})})}const Se=Ce(ke)(({theme:a})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function De(){const a=O(n=>n.languages.value),y=A(n=>n.piazzaSwitch.value),x=oe(),e=()=>{y==="true"?(window.localStorage.setItem("piazza","false"),x(me("false"))):(window.localStorage.setItem("piazza","true"),x(me("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:a==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Se,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:y==="true"})})]})}const xe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},be=({multiple:a,displayName:y})=>{const x=O(n=>n.languages.value),e=x==="ko"||x==="en"?x:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(ye,{title:a?xe[e][0]:`${xe[e][1]} ${y}`}),a&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(De,{})})]})};function Me({userObj:a}){const[y,x]=p.useState(""),[e,n]=p.useState([]),R=oe(),{state:w}=ae(),[S,j]=p.useState(!0),[b,g]=p.useState(!1),k=A(m=>m.piazzaForm.value);p.useEffect(()=>{var P;const m=()=>{var _;const V=window.screen.height-300>(((_=window.visualViewport)==null?void 0:_.height)||window.screen.height);b!==V&&g(V)};return window.addEventListener("resize",m),typeof visualViewport<"u"&&((P=window.visualViewport)==null||P.addEventListener("resize",m)),visualViewport==null||visualViewport.addEventListener("resize",m),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",m)),()=>{var V;typeof visualViewport<"u"&&((V=window.visualViewport)==null||V.removeEventListener("resize",m))}},[b]),p.useEffect(()=>{(w==null?void 0:w.multiple)!==void 0&&j(w==null?void 0:w.multiple)},[]),p.useEffect(()=>{R(Ne(5))});const T=w==null?void 0:w.displayName;return t.jsxs(t.Fragment,{children:[!b&&t.jsx(be,{multiple:S,displayName:T}),t.jsx(Ue,{isKeyboardOpen:k,userObj:a,multiple:S,handleMultiple:m=>j(m),messagesList:e,handleMessagesList:m=>n(m)}),t.jsx(ze,{userObj:a,multiple:S,messages:y,handleMessages:m=>x(m),messagesList:e,handleMessagesList:m=>n(m)})]})}export{Me as default};
