import{r as u,c as G,j as t,J as te,Q as oe,B as ce,av as he,u as q,aH as ae,V as P,P as le,aL as re,f as Z,g as k,q as W,Z as X,E as O,h as ee,k as E,W as I,v as A,aJ as de,L as se,aK as ge,aM as ue,ag as xe,aN as ve,R as me,w as we,a8 as Ce}from"./index-CfHOS5c7.js";const fe=({initiateContinuing:s,multiple:y,handleMultiple:x,user:e,userObj:i,handleMessagesList:M,displayedName:p})=>{const[N,$]=u.useState(null),r=G(f=>f.languages.value);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?$((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):$(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(te,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&t.jsx("div",{children:r==="ko"?t.jsxs("div",{children:["(",p,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(oe,{to:"/profile",state:{element:e},children:t.jsx(ce,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),y&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(oe,{to:"/piazza",state:{conversation:N,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(he,{children:t.jsx(ce,{variant:"outlined",onClick:()=>{M([]),x(!1),s()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ke({userObj:s,multiple:y,handleMultiple:x,messagesList:e,handleMessagesList:i}){const M=u.useRef(null),p=u.useRef(null),[N,$]=u.useState(null),[r,f]=u.useState(""),[j,H]=u.useState(!1),[B,L]=u.useState(null),[K,_]=u.useState(0),Q=q(a=>a.profileColor.value),m=q(a=>a.profileUrl.value),{state:U}=ae(),w=U==null?void 0:U.conversation,z=G(a=>a.languages.value),S=async({userUid:a,displayName:c})=>{const g=E(k,`members/${a}`),h=(await I(g)).data();$(h),f(c)},D=({userUid:a,displayName:c})=>{var g;(g=document.getElementById("drawer"))==null||g.click(),S({userUid:a,displayName:c})},T=10;u.useEffect(()=>{if(!P)return;function a(c){const{msg:g,userUid:n,id:h,target:o,messageClock:l,messageClockNumber:d,conversation:v}=c;i(C=>[...C,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:l,messageClockNumber:d,conversation:null,profileImageUrl:m,profileColor:Q}])}return P.on("sMessagePiazza",a),()=>{P.off("sMessagePiazza",a)}},[]),u.useEffect(()=>{if(!P)return;function a(c){const{msg:g,userUid:n,id:h,target:o,messageClock:l,messageClockNumber:d,conversation:v}=c;i(C=>[...C,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:l,messageClockNumber:d,conversation:null}])}return P.on(`sMessage${w}`,a),()=>{P.off(`sMessage${w}`,a)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{b(),(async()=>{if(y){const c=Z(k,"chats_group"),g=W(c,O("messageClockNumber","desc"),X(1));(await ee(g)).forEach(async h=>{const o=E(k,`chats_group/${h.id}`),d=(await I(o)).data(),v=d.piazzaChecked||[];v.indexOf(s.uid)===-1&&(v.splice(-1,s.uid,0),v.push(s.uid),await A(o,{...d,piazzaChecked:v}))})}else{const c=E(k,`members/${s.uid}`),n=(await I(c)).data().chattings;n[w].messageCount=0,await A(c,{chattings:n})}})()},[e]);const b=()=>{var a;(a=M.current)==null||a.scrollIntoView()};u.useEffect(()=>{const a=async()=>{const g=[],n=Z(k,"chats_group"),h=W(n,O("messageClockNumber","desc"),X(T),de(B||"")),o=await ee(h);o.docs.length||_(o.docs.length),o.forEach(l=>{var ie,ne;g.length===o.docs.length-1&&(L(l),_(o.docs.length-1));const d=l.data().message,v=l.data().userUid,C=l.data().userName,J=l.data().messageClock,F=l.data().messageClockNumber,Y=(ie=l.data())==null?void 0:ie.profileColor,V=(ne=l.data())==null?void 0:ne.profileImageUrl;g.push({msg:d,type:"me",userUid:v,id:C,messageClockNumber:F,messageClock:J,conversation:null,profileColor:Y,profileImageUrl:V})}),g.reverse(),i([...g,...e]),H(!1)},c=async g=>{const n=Z(k,`chats_${g}`),h=W(n,O("messageClockNumber","desc"),X(T),de(B||"")),o=await ee(h),l=[];o.docs.length||_(o.docs.length),o.forEach((d,v)=>{l.length===o.docs.length-1&&(L(d),_(o.docs.length-1));const C=d.data().message,J=d.data().userUid,F=d.data().userName,Y=d.data().messageClock,V=d.data().messageClockNumber||0;l.push({msg:C,type:"me",userUid:J,id:F,messageClock:Y,messageClockNumber:V})}),l.reverse(),i([...l,...e]),H(!1)};w?(j||!e.length)&&c(w):(j||!e.length)&&a()},[j,w]);const R=()=>{p.current.scrollTop!==0||j||(console.log("scroll"),H(!0))};return u.useEffect(()=>{var a;return(a=p.current)==null||a.addEventListener("scroll",R),()=>{var c;return(c=p.current)==null?void 0:c.removeEventListener("scroll",R)}},[j]),t.jsx(t.Fragment,{children:t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{ref:p,className:"p-1 border-t rounded-xl h-[60vh] overflow-auto",children:t.jsxs("ul",{children:[j&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((a,c)=>{let g;const n=new Date(a.messageClock);a.userUid===s.uid?g="text-right":g="text-left";let h,o;c>0&&(h=e[c-1].userUid),c<e.length-1&&e[c+1].userUid===s.uid&&(o=new Date(e[c+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let l,d=n.getHours(),v=(n.getMonth()+1).toString(),C=n.getDate().toString();return d>=13?(l="오후",d!==12&&(d=d-12)):(l="오전",d===0&&(d=d+12)),n.getMonth()+1<10&&(v="0"+v),C.length===1&&(C="0"+C),t.jsxs("li",{ref:c===K?M:null,className:g,children:[h!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:g==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(le,{trigger:t.jsx(te,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>D({userUid:a.userUid,displayName:a.id})}),title:t.jsx(re,{}),content:t.jsx(fe,{initiateContinuing:()=>L(null),multiple:y,handleMultiple:x,user:N,userObj:s,handleMessagesList:i,displayedName:r})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(le,{trigger:t.jsx(te,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>D({userUid:a.userUid,displayName:a.id})}),title:t.jsx(re,{}),content:t.jsx(fe,{initiateContinuing:()=>L(null),multiple:y,handleMultiple:x,user:N,userObj:s,handleMessagesList:i,displayedName:r})})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",C," ",z==="ko"&&l," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),z==="en"&&(l==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",C," ",z==="ko"&&l," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),z==="en"&&(l==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},c)}),t.jsx("li",{ref:M})]})})})})}const ye={ko:"메세지를 작성해 주세요",en:"Input message"},Ne={ko:"전송",en:"send"};function Ue({userObj:s,multiple:y,messages:x,handleMessages:e,messagesList:i,handleMessagesList:M}){const p=q(m=>m.profileColor.value),N=q(m=>m.profileUrl.value),$=se(),{state:r}=ae(),f=r==null?void 0:r.conversation,j=G(m=>m.languages.value),H=j==="ko"||j==="en"?j:"ko",B=async m=>{var c;m.preventDefault();const U=x,w=s.uid,z=s.displayName,S=Date.now(),D=new Date().toString();let T,b,R;r.chattingUid&&(T=E(k,`members/${r.chattingUid}`),b=await I(T),R=(c=b.data())==null?void 0:c.messagingToken);const a={msg:U,userUid:w,id:z,messageClockNumber:S,messageClock:D,conversation:f,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:N,sendingToken:R};y?a&&U&&(P.emit("piazzaMessage",a),K()):U&&(i.length!==0?(P.emit("message",a),console.log("message")):(P.emit("messageNew",a),console.log("messageNew")),_(),Q()),e("")},L=m=>{e(m.target.value)},K=async()=>{try{const m=x,U=s.uid,w=s.displayName,z=new Date().toString(),S=Date.now();m&&(await ge(Z(k,"chats_group"),{userUid:U,userName:w,message:m,messageClock:z,messageClockNumber:S,profileImageUrl:N,profileColor:p,piazzaChecked:[s.uid]}),M(D=>[...D,{msg:m,type:"me",userUid:s.uid,id:s.displayName,messageClock:z,conversation:null,profileImageUrl:N,profileColor:p}]))}catch(m){console.log(m)}},_=async()=>{var U,w,z;const m=x;try{const S=s.uid,D=s.displayName,T=Date.now(),b=new Date().toString();let R,a,c,g,n,h;if(r.userUid<r.chattingUid?(R=r.userUid,a=r.chattingUid,c=s.displayName,g=r.displayName,n=N,h=r.profileUrl):(R=r.chattingUid,a=r.userUid,c=r.displayName,g=s.displayName,n=r.profileUrl,h=N),!n){const o=E(k,`members/${R}`);n=(U=(await I(o)).data())==null?void 0:U.profileImageUrl}if(!h){const o=E(k,`members/${a}`);h=(w=(await I(o)).data())==null?void 0:w.profileImageUrl}if(m){const o={userUid:S,userName:D,message:m,messageClock:b,messageClockNumber:T,userOne:R,userTwo:a,userOneDisplayName:c,userTwoDisplayName:g,userOneProfileUrl:n,userTwoProfileUrl:h};await ge(Z(k,`chats_${f}`),o);const l=E(k,`members/${S}`),v=(await I(l)).data().chattings||{},C=E(k,`members/${r.chattingUid}`),F=(await I(C)).data().chattings||{},Y=((z=F[f])==null?void 0:z.messageCount)||0;v[f]=o,F[f]={...o,messageCount:Y+1},await A(l,{chattings:v}),await A(C,{chattings:F}),M(V=>[...V,{msg:m,type:"me",userUid:s.uid,id:s.displayName,messageClock:b,conversation:f}])}}catch(S){console.log(S)}},Q=async()=>{try{const m=s.uid,U=r.chattingUid,w=E(k,`members/${m}`),S=(await I(w)).data().conversation||[],D=E(k,`members/${U}`),b=(await I(D)).data().conversation||[];S.indexOf(f)===-1&&(await A(w,{conversation:[...S,f]}),$(ue())),b.indexOf(f)===-1&&await A(D,{conversation:[...b,f]})}catch(m){console.log(m)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:B,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ye[H],onChange:L,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ne[H]})]})})}const ze=xe(ve)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Se(){const s=G(i=>i.languages.value),y=q(i=>i.piazzaSwitch.value),x=se(),e=()=>{y==="true"?(window.localStorage.setItem("piazza","false"),x(me("false"))):(window.localStorage.setItem("piazza","true"),x(me("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ze,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:y==="true"})})]})}const pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},De=({multiple:s,displayName:y})=>{const x=G(i=>i.languages.value),e=x==="ko"||x==="en"?x:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(we,{title:s?pe[e][0]:`${pe[e][1]} ${y}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Se,{})})]})};function je({userObj:s}){const[y,x]=u.useState(""),[e,i]=u.useState([]),M=se(),{state:p}=ae(),[N,$]=u.useState(!0);u.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&$(p==null?void 0:p.multiple)},[]),u.useEffect(()=>{M(Ce(5))});const r=p==null?void 0:p.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(De,{multiple:N,displayName:r}),t.jsx(ke,{userObj:s,multiple:N,handleMultiple:f=>$(f),messagesList:e,handleMessagesList:f=>i(f)}),t.jsx(Ue,{userObj:s,multiple:N,messages:y,handleMessages:f=>x(f),messagesList:e,handleMessagesList:f=>i(f)})]})}export{je as default};
