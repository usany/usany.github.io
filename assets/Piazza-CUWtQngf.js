import{c as Ue,u as le,d as se,G as xe,j as e,P as me,a0 as ve,b8 as we,b7 as pe,b0 as $e,x as Y,p as $,O as q,a4 as u,b4 as ye,n as oe,E as te,b9 as Ve,a_ as Me,r as i,W as he,a1 as Ce,B as Q,ba as ke,q as de,a2 as fe,a3 as ue,t as ge,b2 as ze,s as Ae,S as Fe,X as je,H as Le,bb as Be,aN as Te,af as He,bc as Se,bd as Ne,be as De,bf as Ie}from"./index-Cgi8LbrD.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ue("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=Ue("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ye={ko:"메세지를 작성해 주세요",en:"Input message"},qe={ko:"전송",en:"send"};function Ge({chattingUser:l,userObj:t,multiple:d,messages:C,handleMessages:w,messagesList:V,handleMessagesList:E}){const S=le(c=>c.profileColor.value),U=le(c=>c.piazzaForm.value),f=se(c=>c.profile.value),M=xe(),x=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",T=se(c=>c.languages.value),N=T==="ko"||T==="en"?T:"ko",R=async c=>{var s;c.preventDefault();const j=C,I=t.uid,m=t.displayName,y=Date.now(),k=new Date().toString(),P=f==null?void 0:f.profileImageUrl,a=f==null?void 0:f.defaultProfile,h=f==null?void 0:f.profileImage;let p,v,g;l&&(p=Y($,`members/${l.uid}`),v=await q(p),g=(s=v.data())==null?void 0:s.messagingToken);const o=f.profileImage?f.profileImageUrl:f.defaultProfile;console.log(f);const n={msg:j,userUid:I,id:m,messageClockNumber:y,messageClock:k,conversation:x,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:h,defaultProfile:a,profileImageUrl:P,profileUrl:o,sendingToken:g};d?n&&j&&(u.emit("piazzaMessage",n),F()):j&&(V.length!==0?(u.emit("message",n),console.log("message")):(u.emit("messageNew",n),console.log("messageNew")),D(),B()),w("")},O=c=>{w(c.target.value)},F=async()=>{try{const c=C,j=t.uid,I=t.displayName,m=new Date().toString(),y=Date.now(),k=f==null?void 0:f.profileImageUrl,P=f==null?void 0:f.defaultProfile,a=f==null?void 0:f.profileImage;c&&(await ye(oe($,"chats_group"),{userUid:j,userName:I,message:c,messageClock:m,messageClockNumber:y,profileImageUrl:k,defaultProfile:P,profileColor:S,piazzaChecked:[t.uid],profileImage:a}),E(h=>[...h,{msg:c,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileColor:S,messageClockNumber:y,defaultProfile:P,profileImageUrl:k,profileImage:a||!1}]))}catch(c){console.log(c)}},D=async()=>{var j,I,m;const c=C;try{const y=t.uid,k=t.displayName,P=Date.now(),a=new Date().toString(),h=f.profileImage,p=l.profileImage,v=f.profileImageUrl,g=l.profileImageUrl,o=f.defaultProfile,n=l.defaultProfile;let s,r,z,b,L,A,G,X,J,W;if(t.uid<l.uid?(s=t.uid,r=l.uid,z=t.displayName,b=l.displayName,L=v,A=g,G=o,X=n,J=f.profileImage,W=l.profileImage):(s=l.uid,r=t.uid,z=l.displayName,b=t.displayName,L=g,A=v,G=n,X=o,J=l.profileImage,W=f.profileImage),!L){const H=Y($,`members/${s}`);L=(j=(await q(H)).data())==null?void 0:j.profileImageUrl}if(!A){const H=Y($,`members/${r}`);A=(I=(await q(H)).data())==null?void 0:I.profileImageUrl}if(c){const H={userUid:y,userName:k,message:c,messageClock:a,messageClockNumber:P,userOne:s,userTwo:r,userOneDisplayName:z,userTwoDisplayName:b,userOneProfileUrl:L,userTwoProfileUrl:A,userOneDefaultProfile:G,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W};await ye(oe($,`chats_${x}`),H);const K=Y($,`members/${y}`),ne=(await q(K)).data().chattings||{},ie=Y($,`members/${l.uid}`),ee=(await q(ie)).data().chattings||{},ce=((m=ee[x])==null?void 0:m.messageCount)||0;ne[x]=H,ee[x]={...H,messageCount:ce+1},await te(K,{chattings:ne}),await te(ie,{chattings:ee}),E(Re=>[...Re,{msg:c,type:"me",userUid:t.uid,id:t.displayName,messageClock:a,conversation:x,userName:k,messageClockNumber:P,userOne:s,userTwo:r,userOneDisplayName:z,userTwoDisplayName:b,userOneProfileUrl:L,userTwoProfileUrl:A,userOneDefaultProfile:G,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W}])}}catch(y){console.log(y)}},B=async()=>{try{const c=t.uid,j=l.uid,I=Y($,`members/${c}`),y=(await q(I)).data().conversation||[],k=Y($,`members/${j}`),a=(await q(k)).data().conversation||[];y.indexOf(x)===-1&&(await te(I,{conversation:[...y,x]}),M(Ve())),a.indexOf(x)===-1&&await te(k,{conversation:[...a,x]})}catch(c){console.log(c)}};return e.jsxs("form",{className:`fixed w-screen ${U?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:R,children:[x&&x!=="piazza"&&e.jsx(me,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Oe,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var c;(c=document.getElementById("videoCall"))==null||c.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var c;(c=document.getElementById("audioCall"))==null||c.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_e,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ye[N],onChange:O,value:C,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:qe[N]})]})}const be=({initiateContinuing:l,user:t,userObj:d,handleMessagesList:C,displayedName:w,handleChatUid:V,handleChatDisplayName:E})=>{const{state:S}=Me(),U=(S==null?void 0:S.conversation)||"piazza",f=se(T=>T.languages.value),[M,x]=i.useState("");return i.useEffect(()=>{t&&((t==null?void 0:t.uid)<d.uid?x((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]):x(d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:d.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==w&&e.jsx("div",{children:f==="ko"?e.jsxs("div",{children:["(",w,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(Q,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),U==="piazza"&&d.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${M}`,state:{conversation:M,displayName:t==null?void 0:t.displayName,userUid:d.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(Q,{variant:"outlined",onClick:()=>{C([]),l()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Pe({userObj:l,messagesList:t,handleMessagesList:d,handleChatUid:C,handleChatDisplayName:w}){const V=i.useRef(null),E=i.useRef(null),[S,U]=i.useState(null),[f,M]=i.useState(""),[x,T]=i.useState(!1),[N,R]=i.useState(null),[O,F]=i.useState(0),[D,B]=i.useState("piazza"),c=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";i.useEffect(()=>{(D!==c||c==="piazza")&&(d([]),R(null),F(0),B(c))},[c]);const j=se(a=>a.languages.value),I=async({userUid:a,displayName:h})=>{const p=Y($,`members/${a}`),g=(await q(p)).data();U(g),M(h),console.log("practice")},m=({userUid:a,displayName:h})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),I({userUid:a,displayName:h})},y=20;i.useEffect(()=>{if(!u)return;function a(h){const{msg:p,userUid:v,id:g,target:o,messageClock:n,messageClockNumber:s,profileImageUrl:r,defaultProfile:z,profileImage:b,conversation:L}=h;d(A=>[...A,{msg:p,type:o?"private":"other",userUid:v,id:g,messageClock:n,messageClockNumber:s,conversation:null,profileImageUrl:r,defaultProfile:z,profileImage:b}])}return u.on("sMessagePiazza",a),()=>{u.off("sMessagePiazza",a)}},[]),i.useEffect(()=>{if(!u)return;function a(h){const{msg:p,userUid:v,id:g,target:o,messageClock:n,messageClockNumber:s,conversation:r,profileImageUrl:z,defaultProfile:b,profileImage:L,piazzaData:A}=h;d(G=>[...G,{msg:p,type:o?"private":"other",userUid:v,id:g,messageClock:n,messageClockNumber:s,conversation:null,profileImageUrl:z,defaultProfile:b,profileImage:L,...A}])}return u.on(`sMessage${c}`,a),()=>{u.off(`sMessage${c}`,a)}},[c]),i.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),i.useEffect(()=>{k(),(async()=>{if(c==="piazza"){const h=oe($,"chats_group"),p=de(h,ue("messageClockNumber","desc"),fe(1));(await ge(p)).forEach(async g=>{const o=Y($,`chats_group/${g.id}`),s=(await q(o)).data(),r=s.piazzaChecked||[];r.indexOf(l.uid)===-1&&(r.splice(-1,l.uid,0),r.push(l.uid),await te(o,{...s,piazzaChecked:r}))})}else{const h=Y($,`members/${l.uid}`),v=(await q(h)).data().chattings;v[c]&&(v[c].messageCount=0),await te(h,{chattings:v})}})()},[t]);const k=()=>{var a;(a=V.current)==null||a.scrollIntoView()};i.useEffect(()=>{const a=async()=>{const p=[],v=oe($,"chats_group"),g=de(v,ue("messageClockNumber","desc"),fe(y),ze(N||"")),o=await ge(g);o.docs.length||F(o.docs.length),o.forEach(n=>{var W,H,K;p.length===o.docs.length-1&&(R(n),F(o.docs.length-1));const s=n.data().message,r=n.data().userUid,z=n.data().userName,b=n.data().messageClock,L=n.data().messageClockNumber,A=(W=n.data())==null?void 0:W.profileImageUrl,G=(H=n.data())==null?void 0:H.defaultProfile,X=(K=n.data())==null?void 0:K.profileImage,J=n.data();p.push({msg:s,userUid:r,id:z,messageClockNumber:L,messageClock:b,conversation:null,profileImageUrl:A,defaultProfile:G,profileImage:X||!1,...J})}),p.reverse(),d([...p,...t]),T(!1)},h=async p=>{const v=oe($,`chats_${p}`),g=de(v,ue("messageClockNumber","desc"),fe(y),ze(N||"")),o=await ge(g),n=[];o.docs.length||F(o.docs.length),o.forEach((s,r)=>{var re,ee,ce;n.length===o.docs.length-1&&(R(s),F(o.docs.length-1));const z=s.data().message,b=s.data().userUid,L=s.data().userName,A=s.data().messageClock,G=s.data().messageClockNumber||0,X=(re=s.data())==null?void 0:re.profileImageUrl,J=(ee=s.data())==null?void 0:ee.defaultProfile,W=(ce=s.data())==null?void 0:ce.profileImage,H=s.data(),K=s.data().userOne,ae=s.data().userOneDisplayName,ne=s.data().userTwo,ie=s.data().userTwoDisplayName;K!==l.uid?(C(K),w(ae)):(C(ne),w(ie)),n.push({msg:z,userUid:b,id:L,messageClockNumber:G,messageClock:A,conversation:null,profileImageUrl:X,defaultProfile:J,profileImage:W||!1,...H})}),n.reverse(),d([...n,...t]),T(!1)};console.log(t.length),c==="piazza"?(x||!t.length)&&a():(x||!t.length)&&h(c)},[x,D]);const P=()=>{E.current.scrollTop!==0||x||(console.log("scroll"),T(!0))};return i.useEffect(()=>{var a;return(a=E.current)==null||a.addEventListener("scroll",P),()=>{var h;return(h=E.current)==null?void 0:h.removeEventListener("scroll",P)}},[x]),console.log(c),console.log(t),console.log(S),e.jsx(e.Fragment,{children:e.jsx("div",{ref:E,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[x&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,h)=>{let p;c==="piazza"?p=a:a.userUid===a.userOne?p={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:p={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let v;const g=new Date(a.messageClock);a.userUid===l.uid?v="text-right":v="text-left";let o,n;h>0&&(o=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===l.uid&&(n=new Date(t[h+1].messageClock),g.getFullYear()===n.getFullYear()&&g.getMonth()===n.getMonth()&&g.getDate()===n.getDate()&&g.getHours()===n.getHours()&&(g.getMinutes(),n.getMinutes()));let s,r=g.getHours(),z=(g.getMonth()+1).toString(),b=g.getDate().toString();return r>=13?(s="오후",r!==12&&(r=r-12)):(s="오전",r===0&&(r=r+12)),g.getMonth()+1<10&&(z="0"+z),b.length===1&&(b="0"+b),e.jsxs("li",{ref:h===O?V:null,className:v,children:[o!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==l.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(me,{trigger:e.jsx(he,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>R(null),user:S,userObj:l,handleMessagesList:d,displayedName:f})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:a.id}),e.jsx(me,{trigger:e.jsx(he,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>R(null),user:S,userObj:l,handleMessagesList:d,displayedName:f,handleChatUid:C,handleChatDisplayName:w})})]})})}),a.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[g.getFullYear(),"-",z,"-",b," ",j==="ko"&&s," ",r,":",g.getMinutes()<10&&"0",g.getMinutes(),j==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[g.getFullYear(),"-",z,"-",b," ",j==="ko"&&s," ",r,":",g.getMinutes()<10&&"0",g.getMinutes(),j==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},h)}),e.jsx("li",{ref:V})]})})})}function Ke({isKeyboardOpen:l,userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:V}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Pe,{userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:V})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Pe,{userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:V})})})}const We=Ae(Fe)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ze(){const l=se(w=>w.languages.value),t=le(w=>w.piazzaSwitch.value),d=xe(),C=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),d(je("false"))):(window.localStorage.setItem("piazza","true"),d(je("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(We,{onClick:()=>C(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Ee={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:l})=>{const t=se(w=>w.languages.value),d=t==="ko"||t==="en"?t:"ko",C=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Le,{icon:e.jsx(Be,{}),title:C==="piazza"?Ee[d][0]:`${Ee[d][1]} ${l}`}),C==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ze,{})})]})};function Je(){const[l,t]=i.useState([]),[d,C]=i.useState(!0),[w,V]=i.useState(!0),[E,S]=i.useState(""),[U,f]=i.useState(null),[M,x]=i.useState(null),T=Te(),N=i.useRef(null),R=i.useRef(null),O={audio:!0,video:!1},F=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:F.map(s=>s.urls)}]}),B=location.search.slice(4);console.log(location.search.slice(4)),i.useEffect(()=>{(async()=>{await m()})()},[]),i.useEffect(()=>{N.current&&(N.current.srcObject=U)},[U]);async function c(){const s=U;s&&s.getAudioTracks().forEach(r=>r.enabled=!r.enabled),C(!d)}async function j(){const s=U;s&&s.getVideoTracks().forEach(r=>r.enabled=!r.enabled),V(!w)}const I=()=>{N.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(N.current)};i.useEffect(()=>{M&&y(M)},[M]);async function m(){try{const r=(await navigator.mediaDevices.enumerateDevices()).filter(z=>z.kind==="videoinput");t(r)}catch(s){console.log(s)}}async function y(s){try{const z=s?{audio:!0,video:{deviceId:{exact:s}}}:O,b=await navigator.mediaDevices.getUserMedia(z);f(b),S("")}catch(r){const z=r==null?void 0:r.toString();z&&S(z),console.log(r)}}function k(s){console.log("icecandidate"),console.log(s),u.emit("ice",s.candidate,B)}function P(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",U),R.current=s.stream}function a(){D.addEventListener("icecandidate",k),D.addEventListener("addstream",P),U&&U.getTracks().forEach(s=>D.addTrack(s,U))}async function h(){await y(null),a()}async function p(){await h(),u.emit("joinRoom",B,h)}i.useEffect(()=>{p()},[]);const v=async()=>{console.log("sent the offer"),console.log(D);const s=await D.createOffer();D.setLocalDescription(s),console.log(s),u.emit("offer",s,B)};i.useEffect(()=>{if(u)return u.on("welcome",v),()=>{u.off("welcome",v)}});const g=async s=>{console.log("received the offer"),D.setRemoteDescription(s);const r=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(r),u.emit("answer",r,B)};i.useEffect(()=>{if(u)return u.on("offer",g),()=>{u.off("offer",g)}});const o=s=>{console.log("received the answer"),D.setRemoteDescription(s)};i.useEffect(()=>{if(u)return u.on("answer",o),()=>{u.off("answer",o)}});const n=s=>{console.log("received candidate"),D.addIceCandidate(s)};return i.useEffect(()=>{if(u)return u.on("ice",n),()=>{u.off("ice",n)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:N,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:c,children:d?"unmute":"mute"}),e.jsx(Q,{onClick:j,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:I,children:"stop"})]})}),E&&e.jsx("div",{children:E})]})}let Z,_;function Qe(){const[l,t]=i.useState([]),[d,C]=i.useState(!0),[w,V]=i.useState(!0),[E,S]=i.useState(""),[U,f]=i.useState(null),M=i.useRef(null),x=i.useRef(null),T=Te(),N=document.getElementById("devices"),R={audio:!0,video:!0},O=location.search.slice(4);async function F(){const o=Z;o&&o.getAudioTracks().forEach(n=>n.enabled=!n.enabled),C(!d)}async function D(){const o=Z;o&&o.getVideoTracks().forEach(n=>n.enabled=!n.enabled),V(!w)}const B=()=>{M.current.srcObject.getTracks().forEach(o=>o.stop()),console.log(M.current)};async function c(){console.log(N.value),Z.getTracks().forEach(n=>n.stop()),f(N.value),await I(N.value)}i.useEffect(()=>{I(U)},[N]);async function j(){try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput");t(n)}catch(o){console.log(o)}}async function I(o){try{const s=o?{audio:!0,video:{deviceId:{exact:o}}}:R;Z=await navigator.mediaDevices.getUserMedia(s);const r=await navigator.mediaDevices.enumerateDevices();M.current.srcObject=Z,await j(),S("")}catch(n){console.log(n),S(n)}}function m(o){console.log("icecandidate"),console.log(o),u.emit("ice",o.candidate,O)}function y(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",Z),x.current.srcObject=o.stream}function k(){const o=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];_=new RTCPeerConnection({iceServers:[{urls:o.map(n=>n.urls)}]}),_.addEventListener("icecandidate",m),_.addEventListener("addstream",y),Z&&Z.getTracks().forEach(n=>_.addTrack(n,Z))}async function P(){await I(null),k()}async function a(){await P(),u.emit("joinRoom",O,P)}i.useEffect(()=>{a()},[]);const h=async()=>{console.log("sent the offer"),console.log(_);const o=await _.createOffer();_.setLocalDescription(o),console.log(o),u.emit("offer",o,O)};i.useEffect(()=>{if(u)return u.on("welcome",h),()=>{u.off("welcome",h)}});const p=async o=>{console.log("received the offer"),_.setRemoteDescription(o);const n=await _.createAnswer();console.log("sent the answer"),_.setLocalDescription(n),u.emit("answer",n,O)};i.useEffect(()=>{if(u)return u.on("offer",p),()=>{u.off("offer",p)}});const v=o=>{console.log("received the answer"),_.setRemoteDescription(o)};i.useEffect(()=>{if(u)return u.on("answer",v),()=>{u.off("answer",v)}});const g=o=>{console.log("received candidate"),_.addIceCandidate(o)};return i.useEffect(()=>{if(u)return u.on("ice",g),()=>{u.off("ice",g)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"yourScreen",ref:x,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:M,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:F,children:d?"unmute":"mute"}),e.jsx(Q,{onClick:D,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:B,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:c,children:l.map((o,n)=>e.jsx("option",{value:o.deviceId,children:o.label},n))})]}),E&&e.jsx("div",{children:E.toString()})]})}function tt({userObj:l}){const[t,d]=i.useState(""),[C,w]=i.useState([]),V=xe(),{state:E}=Me(),[S,U]=i.useState(!1),[f,M]=i.useState(null),[x,T]=i.useState(""),[N,R]=i.useState(""),[O,F]=i.useState(""),D=m=>{T(m)},B=m=>{R(m)},c=location.search.slice(location.search.indexOf("=")+1);console.log(f),console.log(x),i.useEffect(()=>{E?(T(E.chattingUid),R(E.displayName)):(T(""),R(""))},[c]),i.useEffect(()=>{c&&(async()=>{if(x){const y=Y($,`members/${x}`),k=await q(y);M(k.data())}})()},[c,x]);const j=le(m=>m.piazzaForm.value);i.useEffect(()=>{var y;const m=()=>{var P;const k=window.screen.height-300>(((P=window.visualViewport)==null?void 0:P.height)||window.screen.height);S!==k&&U(k)};return window.addEventListener("resize",m),typeof visualViewport<"u"&&((y=window.visualViewport)==null||y.addEventListener("resize",m)),visualViewport==null||visualViewport.addEventListener("resize",m),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",m)),()=>{var k;typeof visualViewport<"u"&&((k=window.visualViewport)==null||k.removeEventListener("resize",m))}},[S]);const I=()=>{var m;F(""),(m=document.getElementById("myScreen"))==null||m.srcObject.getTracks().forEach(y=>y.stop())};return i.useEffect(()=>{V(He(5))}),e.jsxs(e.Fragment,{children:[!S&&e.jsx(Xe,{multiple:!c,displayName:N}),e.jsx(Ke,{isKeyboardOpen:j,userObj:l,messagesList:C,handleMessagesList:m=>w(m),handleChatUid:D,handleChatDisplayName:B}),e.jsx(Ge,{chattingUser:f,userObj:l,multiple:!c,messages:t,handleMessages:m=>d(m),messagesList:C,handleMessagesList:m=>w(m)}),e.jsxs(Se,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Qe,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:I,children:"전화 종료"})})]})})]}),e.jsxs(Se,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:I,children:"전화 종료"})})]})})]})]})}export{tt as default};
