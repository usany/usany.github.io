import{r as y,j as t,M as Z,N as q,Q as J,U as O,a0 as F,aZ as Q,W as D,X as N,Y as z,a2 as T,a3 as Y,a4 as oe,a5 as _,a6 as V,Z as $,S as W,aJ as ee,bh as ne,v as ce,bi as le,V as ae,ag as de}from"./index-Df_Wku-e.js";import{w as b}from"./webSocket-BpFYzTQr.js";import{f as re,g as me,i as ge,l as fe}from"./drawer-BYwVg8u0.js";import{B as te}from"./Button-CwoYlKT7.js";import{P as pe}from"./PageTitle-WBoG3sS4.js";const he=({multiple:s,handleMultiple:w,user:e,userObj:n,handleMessagesList:C,displayedName:k})=>{const[x,U]=y.useState(null);return y.useEffect(()=>{e&&((e==null?void 0:e.uid)<n.uid?U((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]):U(n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsx("div",{children:t.jsxs(re,{children:[t.jsx(me,{children:t.jsx("div",{id:"drawer"})}),t.jsxs(ge,{className:"bg-light-3 dark:bg-dark-3",children:[t.jsx("div",{className:"flex justify-center",children:t.jsx("div",{className:"bg-light-2 dark:bg-dark-2 h-2 w-[100px] rounded-full bg-muted",children:" "})}),t.jsxs("div",{className:"flex flex-col items-center pt-3",children:[t.jsxs(Z,{className:"bg-profile-blue",children:[t.jsx(q,{src:e==null?void 0:e.profileImageUrl}),t.jsx(J,{className:"text-xl border-none	",children:e==null?void 0:e.displayName[0]})]}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==k&&t.jsxs("div",{children:["(",k,"에서 개명)"]})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(O,{to:"/profile",state:{element:e},children:t.jsx(te,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),s&&n.uid!==(e==null?void 0:e.uid)&&t.jsx(O,{to:"/piazza",state:{conversation:x,displayName:e==null?void 0:e.displayName,userUid:n.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(fe,{children:t.jsx(te,{variant:"outlined",onClick:()=>{C([]),w(!1)},children:"개인 대화"})})})]})]})]})})};function xe({userObj:s,multiple:w,handleMultiple:e,messagesList:n,handleMessagesList:C}){const k=y.useRef(null),[x,U]=y.useState(null),[R,g]=y.useState(""),h=F(a=>a.profileColor.value),H=F(a=>a.profileUrl.value),{state:P}=Q(),E=P==null?void 0:P.conversation,B=async({userUid:a,displayName:c})=>{const l=D(N,`members/${a}`),d=(await z(l)).data();U(d),g(c)};y.useEffect(()=>{if(!b)return;function a(c){const{msg:l,userUid:i,id:d,target:m,messageClock:r,messageClockNumber:o,conversation:p}=c;C(f=>[...f,{msg:l,type:m?"private":"other",userUid:i,id:d,messageClock:r,messageClockNumber:o,conversation:null,profileImageUrl:H,profileColor:h}])}return b.on("sMessagePiazza",a),()=>{b.off("sMessagePiazza",a)}},[]),y.useEffect(()=>{if(!b)return;function a(c){const{msg:l,userUid:i,id:d,target:m,messageClock:r,messageClockNumber:o,conversation:p}=c;C(f=>[...f,{msg:l,type:m?"private":"other",userUid:i,id:d,messageClock:r,messageClockNumber:o,conversation:null}])}return b.on(`sMessage${E}`,a),()=>{b.off(`sMessage${E}`,a)}},[]),y.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),y.useEffect(()=>{L(),(async()=>{if(w){const c=T(N,"chats_group"),l=Y(c,_("messageClockNumber","desc"),oe(1));(await V(l)).forEach(async d=>{const m=D(N,`chats_group/${d.id}`),o=(await z(m)).data(),p=o.piazzaChecked||[];p.indexOf(s.uid)===-1&&(p.push(s.uid),await $(m,{...o,piazzaChecked:p}))})}else{const c=D(N,`members/${s.uid}`),i=(await z(c)).data().chattings;i[E].messageCount=0,await $(c,{chattings:i})}})()},[n]);const L=()=>{var a;(a=k.current)==null||a.scrollIntoView()};return y.useEffect(()=>{w?(async()=>{const l=[],i=T(N,"chats_group"),d=Y(i,_("messageClockNumber"));(await V(d)).forEach(r=>{var v,I;const o=r.data().message,p=r.data().userUid,f=r.data().userName,u=r.data().messageClock,j=r.data().messageClockNumber,S=(v=r.data())==null?void 0:v.profileColor,M=(I=r.data())==null?void 0:I.profileImageUrl;l.push({msg:o,type:"me",userUid:p,id:f,messageClockNumber:j,messageClock:u,conversation:null,profileColor:S,profileImageUrl:M}),C(l)})})():(async l=>{const i=T(N,`chats_${l}`),d=Y(i,_("messageClockNumber")),m=await V(d),r=[];m.forEach(o=>{const p=o.data().message,f=o.data().userUid,u=o.data().userName,j=o.data().messageClock,S=o.data().messageClockNumber||0;r.push({msg:p,type:"me",userUid:f,id:u,messageClock:j,messageClockNumber:S}),C(r)})})(E)},[w]),t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{className:"p-1 border-t rounded-xl h-[350px] overflow-auto",children:t.jsxs("ul",{children:[n.map((a,c)=>{let l;const i=new Date(a.messageClock);a.userUid===s.uid?l="text-right":l="text-left";let d,m;c>0&&(d=n[c-1].userUid),c<n.length-1&&n[c+1].userUid===s.uid&&(m=new Date(n[c+1].messageClock),i.getFullYear()===m.getFullYear()&&i.getMonth()===m.getMonth()&&i.getDate()===m.getDate()&&i.getHours()===m.getHours()&&(i.getMinutes(),m.getMinutes()));let r,o=i.getHours(),p=(i.getMonth()+1).toString(),f=i.getDate().toString();return o>=13?(r="오후",o!==12&&(o=o-12)):(r="오전",o===0&&(o=o+12)),i.getMonth()+1<10&&(p="0"+p),f.length===1&&(f="0"+f),t.jsxs("li",{className:l,children:[d!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:l==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsxs(Z,{onClick:()=>{var u;(u=document.getElementById("drawer"))==null||u.click(),B({userUid:a.userUid,displayName:a.id})},className:"bg-profile-blue",children:[t.jsx(q,{src:a==null?void 0:a.profileImageUrl}),t.jsx(J,{className:"text-xl border-none	",children:a==null?void 0:a.id[0]})]}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsxs(Z,{onClick:()=>{var u;(u=document.getElementById("drawer"))==null||u.click(),B({userUid:a.userUid,displayName:a.id})},className:"bg-profile-blue",children:[t.jsx(q,{src:a==null?void 0:a.profileImageUrl}),t.jsx(J,{className:"text-xl border-none	",children:a==null?void 0:a.id[0]})]})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[i.getFullYear(),"-",p,"-",f," ",r," ",o,":",i.getMinutes()<10&&"0",i.getMinutes()]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[i.getFullYear(),"-",p,"-",f," ",r," ",o,":",i.getMinutes()<10&&"0",i.getMinutes()]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]})}),t.jsx("li",{ref:k})]})})}),t.jsx(he,{multiple:w,handleMultiple:e,user:x,userObj:s,handleMessagesList:C,displayedName:R})]})}function ue({userObj:s,multiple:w,messages:e,handleMessages:n,messagesList:C,handleMessagesList:k}){const x=F(a=>a.profileColor.value),U=F(a=>a.profileUrl.value),R=W(),{state:g}=Q(),h=g==null?void 0:g.conversation,H=async a=>{var u;a.preventDefault();const c=e,l=s.uid,i=s.displayName,d=Date.now(),m=new Date().toString();let r,o,p;g.chattingUid&&(r=D(N,`members/${g.chattingUid}`),o=await z(r),p=(u=o.data())==null?void 0:u.messagingToken);const f={msg:c,userUid:l,id:i,messageClockNumber:d,messageClock:m,conversation:h,conversationUid:g.chattingUid,conversationName:g.displayName,profileUrl:U,sendingToken:p};w?f&&c&&(b.emit("piazzaMessage",f),E()):c&&(C.length!==0?(b.emit("message",f),console.log("message")):(b.emit("messageNew",f),console.log("messageNew")),B(),L()),n("")},P=a=>{n(a.target.value)},E=async()=>{try{const a=e,c=s.uid,l=s.displayName,i=new Date().toString(),d=Date.now();a&&(await ee(T(N,"chats_group"),{userUid:c,userName:l,message:a,messageClock:i,messageClockNumber:d,profileImageUrl:U,profileColor:x,piazzaChecked:[s.uid]}),k(m=>[...m,{msg:a,type:"me",userUid:s.uid,id:s.displayName,messageClock:i,conversation:null,profileImageUrl:U,profileColor:x}]))}catch(a){console.log(a)}},B=async()=>{var c,l,i;const a=e;try{const d=s.uid,m=s.displayName,r=Date.now(),o=new Date().toString();let p,f,u,j,S,M;if(g.userUid<g.chattingUid?(p=g.userUid,f=g.chattingUid,u=s.displayName,j=g.displayName,S=U,M=g.profileUrl):(p=g.chattingUid,f=g.userUid,u=g.displayName,j=s.displayName,S=g.profileUrl,M=U),!S){const v=D(N,`members/${p}`);S=(c=(await z(v)).data())==null?void 0:c.profileImageUrl}if(!M){const v=D(N,`members/${f}`);M=(l=(await z(v)).data())==null?void 0:l.profileImageUrl}if(a){const v={userUid:d,userName:m,message:a,messageClock:o,messageClockNumber:r,userOne:p,userTwo:f,userOneDisplayName:u,userTwoDisplayName:j,userOneProfileUrl:S,userTwoProfileUrl:M};await ee(T(N,`chats_${h}`),v);const I=D(N,`members/${d}`),G=(await z(I)).data().chattings||{},K=D(N,`members/${g.chattingUid}`),A=(await z(K)).data().chattings||{},se=((i=A[h])==null?void 0:i.messageCount)||0;G[h]=v,A[h]={...v,messageCount:se+1},await $(I,{chattings:G}),await $(K,{chattings:A}),k(ie=>[...ie,{msg:a,type:"me",userUid:s.uid,id:s.displayName,messageClock:o,conversation:h}])}}catch(d){console.log(d)}},L=async()=>{try{const a=s.uid,c=g.chattingUid,l=D(N,`members/${a}`),d=(await z(l)).data().conversation||[],m=D(N,`members/${c}`),o=(await z(m)).data().conversation||[];d.indexOf(h)===-1&&(await $(l,{conversation:[...d,h]}),R(ne())),o.indexOf(h)===-1&&await $(m,{conversation:[...o,h]})}catch(a){console.log(a)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:H,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:P,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})})}const we=ce(le)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ne(){const s=F(n=>n.piazzaSwitch.value),w=W(),e=()=>{s==="true"?(window.localStorage.setItem("piazza","false"),w(ae("false"))):(window.localStorage.setItem("piazza","true"),w(ae("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(we,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:s==="true"})})]})}const ye=({multiple:s,displayName:w})=>t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(pe,{title:s?"단체 대화":`개인 대화 ${w}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Ne,{})})]});function Se({userObj:s}){const[w,e]=y.useState(""),[n,C]=y.useState([]),k=W(),{state:x}=Q(),[U,R]=y.useState(!0);y.useEffect(()=>{(x==null?void 0:x.multiple)!==void 0&&R(x==null?void 0:x.multiple)},[]),y.useEffect(()=>{k(de(5))});const g=x==null?void 0:x.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(ye,{multiple:U,displayName:g}),t.jsx(xe,{userObj:s,multiple:U,handleMultiple:h=>R(h),messagesList:n,handleMessagesList:h=>C(h)}),t.jsx(ue,{userObj:s,multiple:U,messages:w,handleMessages:h=>e(h),messagesList:n,handleMessagesList:h=>C(h)})]})}export{Se as default};
