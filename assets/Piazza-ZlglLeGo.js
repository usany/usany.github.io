import{u as Q,c as ee,O as re,aG as de,j as t,k as $,g as z,I as F,W as K,aL as me,f as ae,v as O,aN as Se,r as x,M as ce,U as pe,B as ue,au as Ie,P as he,aO as xe,q as ie,X as oe,H as ne,h as le,aJ as we,ae as Pe,aP as be,V as ve,w as je,a6 as Me}from"./index-rlnB4WNY.js";const Ue={ko:"메세지를 작성해 주세요",en:"Input message"},ke={ko:"전송",en:"send"};function Ee({chattingUser:u,userObj:i,multiple:v,messages:e,handleMessages:s,messagesList:C,handleMessagesList:m}){const I=Q(c=>c.profileColor.value);Q(c=>c.profileUrl.value);const V=Q(c=>c.piazzaForm.value),g=ee(c=>c.profile.value),q=re(),{state:w}=de(),k=w==null?void 0:w.conversation,L=ee(c=>c.languages.value),T=L==="ko"||L==="en"?L:"ko",h=async c=>{var f;c.preventDefault();const j=e,M=i.uid,R=i.displayName,S=Date.now(),P=new Date().toString();let a,o,l;w.chattingUid&&(a=$(z,`members/${w.chattingUid}`),o=await F(a),l=(f=o.data())==null?void 0:f.messagingToken);const U=g.profileImage?g.profileUrl:g.defaultProfile,n={msg:j,userUid:M,id:R,messageClockNumber:S,messageClock:P,conversation:k,conversationUid:w.chattingUid,conversationName:w.displayName,profileUrl:U,sendingToken:l};v?n&&j&&(K.emit("piazzaMessage",n),D()):j&&(C.length!==0?(K.emit("message",n),console.log("message")):(K.emit("messageNew",n),console.log("messageNew")),Z(),J()),s("")},_=c=>{s(c.target.value)},D=async()=>{try{const c=e,j=i.uid,M=i.displayName,R=new Date().toString(),S=Date.now(),P=g==null?void 0:g.profileImageUrl,a=g==null?void 0:g.defaultProfile,o=g==null?void 0:g.profileImage;c&&(await me(ae(z,"chats_group"),{userUid:j,userName:M,message:c,messageClock:R,messageClockNumber:S,profileImageUrl:P,defaultProfile:a,profileColor:I,piazzaChecked:[i.uid],profileImage:o}),m(l=>[...l,{msg:c,type:"me",userUid:i.uid,id:i.displayName,messageClock:R,conversation:null,profileColor:I,messageClockNumber:S,defaultProfile:a,profileImageUrl:P,profileImage:o||!1}]))}catch(c){console.log(c)}},Z=async()=>{var j,M,R;const c=e;try{const S=i.uid,P=i.displayName,a=Date.now(),o=new Date().toString(),l=g.profileImage,U=u.profileImage,n=g.profileImageUrl,f=u.profileImageUrl,r=g.defaultProfile,d=u.defaultProfile;let p,y,N,A,E,H,W,X,Y,G;if(w.userUid<w.chattingUid?(p=w.userUid,y=w.chattingUid,N=i.displayName,A=w.displayName,E=n,H=f,W=r,X=d,Y=g.profileImage,G=u.profileImage):(p=w.chattingUid,y=w.userUid,N=w.displayName,A=i.displayName,E=f,H=n,W=d,X=r,Y=u.profileImage,G=g.profileImage),!E){const b=$(z,`members/${p}`);E=(j=(await F(b)).data())==null?void 0:j.profileImageUrl}if(!H){const b=$(z,`members/${y}`);H=(M=(await F(b)).data())==null?void 0:M.profileImageUrl}if(c){const b={userUid:S,userName:P,message:c,messageClock:o,messageClockNumber:a,userOne:p,userTwo:y,userOneDisplayName:N,userTwoDisplayName:A,userOneProfileUrl:E,userTwoProfileUrl:H,userOneDefaultProfile:W,userTwoDefaultProfile:X,userOneProfileImage:Y,userTwoProfileImage:G};await me(ae(z,`chats_${k}`),b);const B=$(z,`members/${S}`),ge=(await F(B)).data().chattings||{},fe=$(z,`members/${w.chattingUid}`),se=(await F(fe)).data().chattings||{},Ce=((R=se[k])==null?void 0:R.messageCount)||0;ge[k]=b,se[k]={...b,messageCount:Ce+1},await O(B,{chattings:ge}),await O(fe,{chattings:se}),m(De=>[...De,{msg:c,type:"me",userUid:i.uid,id:i.displayName,messageClock:o,conversation:k,userName:P,messageClockNumber:a,userOne:p,userTwo:y,userOneDisplayName:N,userTwoDisplayName:A,userOneProfileUrl:E,userTwoProfileUrl:H,userOneDefaultProfile:W,userTwoDefaultProfile:X,userOneProfileImage:Y,userTwoProfileImage:G}])}}catch(S){console.log(S)}},J=async()=>{try{const c=i.uid,j=w.chattingUid,M=$(z,`members/${c}`),S=(await F(M)).data().conversation||[],P=$(z,`members/${j}`),o=(await F(P)).data().conversation||[];S.indexOf(k)===-1&&(await O(M,{conversation:[...S,k]}),q(Se())),o.indexOf(k)===-1&&await O(P,{conversation:[...o,k]})}catch(c){console.log(c)}};return t.jsx(t.Fragment,{children:V?t.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:h,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ue[T],onChange:_,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ke[T]})]}):t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:h,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ue[T],onChange:_,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ke[T]})]})})}const ye=({initiateContinuing:u,multiple:i,handleMultiple:v,user:e,userObj:s,handleMessagesList:C,displayedName:m})=>{const[I,V]=x.useState(null),g=ee(q=>q.languages.value);return x.useEffect(()=>{e&&((e==null?void 0:e.uid)<s.uid?V((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]):V(s.uid[0]+s.uid[1]+s.uid[2]+s.uid[3]+s.uid[4]+s.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(ce,{element:e,uid:s.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==m&&t.jsx("div",{children:g==="ko"?t.jsxs("div",{children:["(",m,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",m,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(pe,{to:"/profile",state:{element:e},children:t.jsx(ue,{variant:"outlined",onClick:()=>{},children:g==="ko"?"프로필 확인":"Check Profile"})}),i&&s.uid!==(e==null?void 0:e.uid)&&t.jsx(pe,{to:"/piazza",state:{conversation:I,displayName:e==null?void 0:e.displayName,userUid:s.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(Ie,{children:t.jsx(ue,{variant:"outlined",onClick:()=>{C([]),v(!1),u()},children:g==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({chattingUser:u,userObj:i,multiple:v,handleMultiple:e,messagesList:s,handleMessagesList:C}){const m=x.useRef(null),I=x.useRef(null),[V,g]=x.useState(null),[q,w]=x.useState(""),[k,L]=x.useState(!1),[T,h]=x.useState(null),[_,D]=x.useState(0);Q(a=>a.profileColor.value),Q(a=>a.profileUrl.value);const{state:Z}=de(),J=Z==null?void 0:Z.conversation,c=ee(a=>a.languages.value),j=async({userUid:a,displayName:o})=>{const l=$(z,`members/${a}`),n=(await F(l)).data();g(n),w(o)},M=({userUid:a,displayName:o})=>{var l;(l=document.getElementById("drawer"))==null||l.click(),j({userUid:a,displayName:o})};console.log(u);const R=20;x.useEffect(()=>{if(!K)return;function a(o){const{msg:l,userUid:U,id:n,target:f,messageClock:r,messageClockNumber:d,profileImageUrl:p,defaultProfile:y,profileImage:N,conversation:A}=o;C(E=>[...E,{msg:l,type:f?"private":"other",userUid:U,id:n,messageClock:r,messageClockNumber:d,conversation:null,profileImageUrl:p,defaultProfile:y,profileImage:N}])}return K.on("sMessagePiazza",a),()=>{K.off("sMessagePiazza",a)}},[]),x.useEffect(()=>{if(!K)return;function a(o){const{msg:l,userUid:U,id:n,target:f,messageClock:r,messageClockNumber:d,conversation:p,piazzaData:y}=o;C(N=>[...N,{msg:l,type:f?"private":"other",userUid:U,id:n,messageClock:r,messageClockNumber:d,conversation:null,...y}])}return K.on(`sMessage${J}`,a),()=>{K.off(`sMessage${J}`,a)}},[]),x.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),x.useEffect(()=>{S(),(async()=>{if(v){const o=ae(z,"chats_group"),l=ie(o,ne("messageClockNumber","desc"),oe(1));(await le(l)).forEach(async n=>{const f=$(z,`chats_group/${n.id}`),d=(await F(f)).data(),p=d.piazzaChecked||[];p.indexOf(i.uid)===-1&&(p.splice(-1,i.uid,0),p.push(i.uid),await O(f,{...d,piazzaChecked:p}))})}else{const o=$(z,`members/${i.uid}`),U=(await F(o)).data().chattings;U[J].messageCount=0,await O(o,{chattings:U})}})()},[s]);const S=()=>{var a;(a=m.current)==null||a.scrollIntoView()};x.useEffect(()=>{const a=async()=>{const l=[],U=ae(z,"chats_group"),n=ie(U,ne("messageClockNumber","desc"),oe(R),we(T||"")),f=await le(n);f.docs.length||D(f.docs.length),f.forEach(r=>{var Y,G,b,B;l.length===f.docs.length-1&&(h(r),D(f.docs.length-1));const d=r.data().message,p=r.data().userUid,y=r.data().userName,N=r.data().messageClock,A=r.data().messageClockNumber;(Y=r.data())==null||Y.profileColor;const E=(G=r.data())==null?void 0:G.profileImageUrl,H=(b=r.data())==null?void 0:b.defaultProfile,W=(B=r.data())==null?void 0:B.profileImage,X=r.data();l.push({msg:d,userUid:p,id:y,messageClockNumber:A,messageClock:N,conversation:null,profileImageUrl:E,defaultProfile:H,profileImage:W||!1,...X})}),l.reverse(),C([...l,...s]),L(!1)},o=async l=>{const U=ae(z,`chats_${l}`),n=ie(U,ne("messageClockNumber","desc"),oe(R),we(T||"")),f=await le(n),r=[];f.docs.length||D(f.docs.length),f.forEach((d,p)=>{var b,B,te;r.length===f.docs.length-1&&(h(d),D(f.docs.length-1));const y=d.data().message,N=d.data().userUid,A=d.data().userName,E=d.data().messageClock,H=d.data().messageClockNumber||0,W=(b=d.data())==null?void 0:b.profileImageUrl,X=(B=d.data())==null?void 0:B.defaultProfile,Y=(te=d.data())==null?void 0:te.profileImage,G=d.data();r.push({msg:y,userUid:N,id:A,messageClockNumber:H,messageClock:E,conversation:null,profileImageUrl:W,defaultProfile:X,profileImage:Y||!1,...G})}),r.reverse(),C([...r,...s]),L(!1)};J?(k||!s.length)&&o(J):(k||!s.length)&&a()},[k,J]);const P=()=>{I.current.scrollTop!==0||k||(console.log("scroll"),L(!0))};return x.useEffect(()=>{var a;return(a=I.current)==null||a.addEventListener("scroll",P),()=>{var o;return(o=I.current)==null?void 0:o.removeEventListener("scroll",P)}},[k]),t.jsx(t.Fragment,{children:t.jsx(t.Fragment,{children:t.jsx("div",{ref:I,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[k&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),s.map((a,o)=>{let l;v?l=a:(console.log(a.userUid===i.uid),a.userUid===a.userOne?l={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage,defaultProfile:a.userOneDefaultProfile,profileImageUrl:a.userOneProfileUrl}:l={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage,defaultProfile:a.userTwoDefaultProfile,profileImageUrl:a.userTwoProfileUrl});let U;const n=new Date(a.messageClock);a.userUid===i.uid?U="text-right":U="text-left";let f,r;o>0&&(f=s[o-1].userUid),o<s.length-1&&s[o+1].userUid===i.uid&&(r=new Date(s[o+1].messageClock),n.getFullYear()===r.getFullYear()&&n.getMonth()===r.getMonth()&&n.getDate()===r.getDate()&&n.getHours()===r.getHours()&&(n.getMinutes(),r.getMinutes()));let d,p=n.getHours(),y=(n.getMonth()+1).toString(),N=n.getDate().toString();return p>=13?(d="오후",p!==12&&(p=p-12)):(d="오전",p===0&&(p=p+12)),n.getMonth()+1<10&&(y="0"+y),N.length===1&&(N="0"+N),console.log(a),t.jsxs("li",{ref:o===_?m:null,className:U,children:[f!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==i.uid?"start":"end"}`,children:U==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(he,{trigger:t.jsx(ce,{element:l,piazza:()=>M({userUid:l.userUid,displayName:l.id}),profile:!1}),title:t.jsx(xe,{}),content:t.jsx(ye,{initiateContinuing:()=>h(null),multiple:v,handleMultiple:e,user:V,userObj:i,handleMessagesList:C,displayedName:q})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(he,{trigger:t.jsx(ce,{element:l,piazza:()=>M({userUid:l.userUid,displayName:l.id}),profile:!1}),title:t.jsx(xe,{}),content:t.jsx(ye,{initiateContinuing:()=>h(null),multiple:v,handleMultiple:e,user:V,userObj:i,handleMessagesList:C,displayedName:q})})]})})}),a.userUid!==i.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",y,"-",N," ",c==="ko"&&d," ",p,":",n.getMinutes()<10&&"0",n.getMinutes(),c==="en"&&(d==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",y,"-",N," ",c==="ko"&&d," ",p,":",n.getMinutes()<10&&"0",n.getMinutes(),c==="en"&&(d==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},o)}),t.jsx("li",{ref:m})]})})})})}function Te({chattingUser:u,isKeyboardOpen:i,userObj:v,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m}){return t.jsx(t.Fragment,{children:i?t.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:t.jsx(Ne,{chattingUser:u,userObj:v,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m})}):t.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:t.jsx(Ne,{chattingUser:u,userObj:v,multiple:e,handleMultiple:s,messagesList:C,handleMessagesList:m})})})}const Re=Pe(be)(({theme:u})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(u.palette.getContrastText(u.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(u.palette.getContrastText(u.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function $e(){const u=ee(s=>s.languages.value),i=Q(s=>s.piazzaSwitch.value),v=re(),e=()=>{i==="true"?(window.localStorage.setItem("piazza","false"),v(ve("false"))):(window.localStorage.setItem("piazza","true"),v(ve("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:u==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Re,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:i==="true"})})]})}const ze={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Fe=({multiple:u,displayName:i})=>{const v=ee(s=>s.languages.value),e=v==="ko"||v==="en"?v:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(je,{title:u?ze[e][0]:`${ze[e][1]} ${i}`}),u&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx($e,{})})]})};function Be({userObj:u}){const[i,v]=x.useState(""),[e,s]=x.useState([]),C=re(),{state:m}=de(),[I,V]=x.useState(!0),[g,q]=x.useState(!1),[w,k]=x.useState(null);x.useEffect(()=>{const h=async()=>{if(m.chattingUid){const _=$(z,`members/${m.chattingUid}`),D=await F(_);k(D.data())}};m.multiple||h()},[]);const L=Q(h=>h.piazzaForm.value);x.useEffect(()=>{var _;const h=()=>{var Z;const D=window.screen.height-300>(((Z=window.visualViewport)==null?void 0:Z.height)||window.screen.height);g!==D&&q(D)};return window.addEventListener("resize",h),typeof visualViewport<"u"&&((_=window.visualViewport)==null||_.addEventListener("resize",h)),visualViewport==null||visualViewport.addEventListener("resize",h),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",h)),()=>{var D;typeof visualViewport<"u"&&((D=window.visualViewport)==null||D.removeEventListener("resize",h))}},[g]),x.useEffect(()=>{(m==null?void 0:m.multiple)!==void 0&&V(m==null?void 0:m.multiple)},[]),x.useEffect(()=>{C(Me(5))});const T=m==null?void 0:m.displayName;return t.jsxs(t.Fragment,{children:[!g&&t.jsx(Fe,{multiple:I,displayName:T}),t.jsx(Te,{chattingUser:w,isKeyboardOpen:L,userObj:u,multiple:I,handleMultiple:h=>V(h),messagesList:e,handleMessagesList:h=>s(h)}),t.jsx(Ee,{chattingUser:w,userObj:u,multiple:I,messages:i,handleMessages:h=>v(h),messagesList:e,handleMessagesList:h=>s(h)})]})}export{Be as default};
