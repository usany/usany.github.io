import{b2 as je,u as oe,c as te,O as pe,aV as se,r,j as e,P as fe,Y as ne,b1 as me,X as we,b3 as ye,aX as Ue,v as H,m as T,I as _,$ as y,a_ as ke,l as ae,C as ee,b4 as Ee,N as ue,B as ie,b5 as Ce,q as ce,Z as re,_ as de,n as ge,aY as ze,s as Me,S as Te,Q as Ne,D as $e,b6 as Re,aJ as Ve,aa as Fe,b7 as Be,b8 as Ae,b9 as Le,ba as He}from"./index-BORVGCJL.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=je("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=je("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),qe={ko:"메세지를 작성해 주세요",en:"Input message"},Ke={ko:"전송",en:"send"};function Ze({chattingUser:n,userObj:m,multiple:S,messages:t,handleMessages:l,messagesList:U,handleMessagesList:u}){const b=oe(f=>f.profileColor.value),N=oe(f=>f.piazzaForm.value),d=te(f=>f.profile.value),F=pe(),{state:D}=se(),k=D==null?void 0:D.conversation,R=te(f=>f.languages.value),V=R==="ko"||R==="en"?R:"ko",[z,x]=r.useState(!1),E=async f=>{var C;f.preventDefault();const I=t,M=m.uid,$=m.displayName,w=Date.now(),a=new Date().toString(),c=d==null?void 0:d.profileImageUrl,i=d==null?void 0:d.defaultProfile,v=d==null?void 0:d.profileImage;let p,s,o;n&&(p=H(T,`members/${n.uid}`),s=await _(p),o=(C=s.data())==null?void 0:C.messagingToken);const g=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const h={msg:I,userUid:M,id:$,messageClockNumber:w,messageClock:a,conversation:k,conversationUid:n==null?void 0:n.uid,conversationName:n==null?void 0:n.displayName,profileImage:v,defaultProfile:i,profileImageUrl:c,profileUrl:g,sendingToken:o};S?h&&I&&(y.emit("piazzaMessage",h),W()):I&&(U.length!==0?(y.emit("message",h),console.log("message")):(y.emit("messageNew",h),console.log("messageNew")),P(),J()),l("")},X=f=>{l(f.target.value)},W=async()=>{try{const f=t,I=m.uid,M=m.displayName,$=new Date().toString(),w=Date.now(),a=d==null?void 0:d.profileImageUrl,c=d==null?void 0:d.defaultProfile,i=d==null?void 0:d.profileImage;f&&(await ke(ae(T,"chats_group"),{userUid:I,userName:M,message:f,messageClock:$,messageClockNumber:w,profileImageUrl:a,defaultProfile:c,profileColor:b,piazzaChecked:[m.uid],profileImage:i}),u(v=>[...v,{msg:f,type:"me",userUid:m.uid,id:m.displayName,messageClock:$,conversation:null,profileColor:b,messageClockNumber:w,defaultProfile:c,profileImageUrl:a,profileImage:i||!1}]))}catch(f){console.log(f)}},P=async()=>{var I,M,$;const f=t;try{const w=m.uid,a=m.displayName,c=Date.now(),i=new Date().toString(),v=d.profileImage,p=n.profileImage,s=d.profileImageUrl,o=n.profileImageUrl,g=d.defaultProfile,h=n.defaultProfile;let C,j,L,B,A,Y,Q,Z,G,q;if(m.uid<n.uid?(C=m.uid,j=n.uid,L=m.displayName,B=n.displayName,A=s,Y=o,Q=g,Z=h,G=d.profileImage,q=n.profileImage):(C=n.uid,j=m.uid,L=n.displayName,B=m.displayName,A=o,Y=s,Q=h,Z=g,G=n.profileImage,q=d.profileImage),!A){const K=H(T,`members/${C}`);A=(I=(await _(K)).data())==null?void 0:I.profileImageUrl}if(!Y){const K=H(T,`members/${j}`);Y=(M=(await _(K)).data())==null?void 0:M.profileImageUrl}if(f){const K={userUid:w,userName:a,message:f,messageClock:i,messageClockNumber:c,userOne:C,userTwo:j,userOneDisplayName:L,userTwoDisplayName:B,userOneProfileUrl:A,userTwoProfileUrl:Y,userOneDefaultProfile:Q,userTwoDefaultProfile:Z,userOneProfileImage:G,userTwoProfileImage:q};await ke(ae(T,`chats_${k}`),K);const O=H(T,`members/${w}`),xe=(await _(O)).data().chattings||{},ve=H(T,`members/${n.uid}`),le=(await _(ve)).data().chattings||{},be=(($=le[k])==null?void 0:$.messageCount)||0;xe[k]=K,le[k]={...K,messageCount:be+1},await ee(O,{chattings:xe}),await ee(ve,{chattings:le}),u(Pe=>[...Pe,{msg:f,type:"me",userUid:m.uid,id:m.displayName,messageClock:i,conversation:k,userName:a,messageClockNumber:c,userOne:C,userTwo:j,userOneDisplayName:L,userTwoDisplayName:B,userOneProfileUrl:A,userTwoProfileUrl:Y,userOneDefaultProfile:Q,userTwoDefaultProfile:Z,userOneProfileImage:G,userTwoProfileImage:q}])}}catch(w){console.log(w)}},J=async()=>{try{const f=m.uid,I=n.uid,M=H(T,`members/${f}`),w=(await _(M)).data().conversation||[],a=H(T,`members/${I}`),i=(await _(a)).data().conversation||[];w.indexOf(k)===-1&&(await ee(M,{conversation:[...w,k]}),F(Ee())),i.indexOf(k)===-1&&await ee(a,{conversation:[...i,k]})}catch(f){console.log(f)}};return r.useEffect(()=>{if(z){document.getElementById("mute"),document.getElementById("stream");const f=document.getElementById("videoInput");document.getElementById("myFace");let I;async function M(){try{const w={video:!0,audio:!0};I=await navigator.mediaDevices.getUserMedia(w),I.getVideoTracks().forEach(a=>a.enabled=!a.enabled),I.getAudioTracks().forEach(a=>a.enabled=!a.enabled),$()}catch(w){console.log(w)}}M();async function $(){try{const a=(await navigator.mediaDevices.enumerateDevices()).filter(c=>c.kind==="videoinput");a.forEach(c=>{const i=document.createElement("option");i.value=c.deviceId,i.innerText=c.label,f==null||f.appendChild(i)}),console.log(a)}catch(w){console.log(w)}}}}),console.log(D),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${N?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:E,children:[k&&k!=="piazza"&&e.jsx(fe,{trigger:e.jsx("button",{className:"px-1 h-full rounded bg-light-2 dark:bg-dark-2",type:"submit",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ne,{to:`/piazza?id=${k}?calls=video`,state:D,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var f;(f=document.getElementById("calls"))==null||f.click()},children:[e.jsx(Ue,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(ne,{to:`/piazza?id=${k}?calls=audio`,state:D,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(_e,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:qe[V],onChange:X,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ke[V]})]})})}const Se=({initiateContinuing:n,multiple:m,handleMultiple:S,user:t,userObj:l,handleMessagesList:U,displayedName:u})=>{const{state:b}=se(),N=(b==null?void 0:b.conversation)||"piazza",d=te(k=>k.languages.value),[F,D]=r.useState("");return r.useEffect(()=>{t&&((t==null?void 0:t.uid)<l.uid?D((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]):D(l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(ue,{element:t,uid:l.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==u&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",u,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",u,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(ne,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ie,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),N==="piazza"&&l.uid!==(t==null?void 0:t.uid)&&e.jsx(ne,{to:`${location.pathname}?id=${F}`,state:{conversation:F,displayName:t==null?void 0:t.displayName,userUid:l.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(me,{children:e.jsx(ie,{variant:"outlined",onClick:()=>{U([]),S(!1),n()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function De({userObj:n,multiple:m,handleMultiple:S,messagesList:t,handleMessagesList:l}){const U=r.useRef(null),u=r.useRef(null),[b,N]=r.useState(null),[d,F]=r.useState(""),[D,k]=r.useState(!1),[R,V]=r.useState(null),[z,x]=r.useState(0),[E,X]=r.useState("piazza"),{state:W}=se(),P=(W==null?void 0:W.conversation)||"piazza";r.useEffect(()=>{E!==P&&(l([]),V(null),x(0),X(P))},[P]);const J=te(a=>a.languages.value),f=async({userUid:a,displayName:c})=>{const i=H(T,`members/${a}`),p=(await _(i)).data();N(p),F(c),console.log("practice")},I=({userUid:a,displayName:c})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),f({userUid:a,displayName:c})},M=20;r.useEffect(()=>{if(!y)return;function a(c){const{msg:i,userUid:v,id:p,target:s,messageClock:o,messageClockNumber:g,profileImageUrl:h,defaultProfile:C,profileImage:j,conversation:L}=c;l(B=>[...B,{msg:i,type:s?"private":"other",userUid:v,id:p,messageClock:o,messageClockNumber:g,conversation:null,profileImageUrl:h,defaultProfile:C,profileImage:j}])}return y.on("sMessagePiazza",a),()=>{y.off("sMessagePiazza",a)}},[]),r.useEffect(()=>{if(!y)return;function a(c){const{msg:i,userUid:v,id:p,target:s,messageClock:o,messageClockNumber:g,conversation:h,profileImageUrl:C,defaultProfile:j,profileImage:L,piazzaData:B}=c;l(A=>[...A,{msg:i,type:s?"private":"other",userUid:v,id:p,messageClock:o,messageClockNumber:g,conversation:null,profileImageUrl:C,defaultProfile:j,profileImage:L,...B}])}return y.on(`sMessage${P}`,a),()=>{y.off(`sMessage${P}`,a)}},[P]),r.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),r.useEffect(()=>{$(),(async()=>{if(m){const c=ae(T,"chats_group"),i=ce(c,de("messageClockNumber","desc"),re(1));(await ge(i)).forEach(async p=>{const s=H(T,`chats_group/${p.id}`),g=(await _(s)).data(),h=g.piazzaChecked||[];h.indexOf(n.uid)===-1&&(h.splice(-1,n.uid,0),h.push(n.uid),await ee(s,{...g,piazzaChecked:h}))})}else{const c=H(T,`members/${n.uid}`),v=(await _(c)).data().chattings;v[P]&&(v[P].messageCount=0),await ee(c,{chattings:v})}})()},[t]);const $=()=>{var a;(a=U.current)==null||a.scrollIntoView()};r.useEffect(()=>{const a=async()=>{const i=[],v=ae(T,"chats_group"),p=ce(v,de("messageClockNumber","desc"),re(M),ze(R||"")),s=await ge(p);s.docs.length||x(s.docs.length),s.forEach(o=>{var Z,G,q;i.length===s.docs.length-1&&(V(o),x(s.docs.length-1));const g=o.data().message,h=o.data().userUid,C=o.data().userName,j=o.data().messageClock,L=o.data().messageClockNumber,B=(Z=o.data())==null?void 0:Z.profileImageUrl,A=(G=o.data())==null?void 0:G.defaultProfile,Y=(q=o.data())==null?void 0:q.profileImage,Q=o.data();i.push({msg:g,userUid:h,id:C,messageClockNumber:L,messageClock:j,conversation:null,profileImageUrl:B,defaultProfile:A,profileImage:Y||!1,...Q})}),i.reverse(),l([...i,...t]),k(!1)},c=async i=>{const v=ae(T,`chats_${i}`),p=ce(v,de("messageClockNumber","desc"),re(M),ze(R||"")),s=await ge(p),o=[];s.docs.length||x(s.docs.length),s.forEach((g,h)=>{var q,K,O;o.length===s.docs.length-1&&(V(g),x(s.docs.length-1));const C=g.data().message,j=g.data().userUid,L=g.data().userName,B=g.data().messageClock,A=g.data().messageClockNumber||0,Y=(q=g.data())==null?void 0:q.profileImageUrl,Q=(K=g.data())==null?void 0:K.defaultProfile,Z=(O=g.data())==null?void 0:O.profileImage,G=g.data();o.push({msg:C,userUid:j,id:L,messageClockNumber:A,messageClock:B,conversation:null,profileImageUrl:Y,defaultProfile:Q,profileImage:Z||!1,...G})}),o.reverse(),l([...o,...t]),k(!1)};P==="piazza"?(D||!t.length)&&a():(D||!t.length)&&c(P)},[D,P]);const w=()=>{u.current.scrollTop!==0||D||(console.log("scroll"),k(!0))};return r.useEffect(()=>{var a;return(a=u.current)==null||a.addEventListener("scroll",w),()=>{var c;return(c=u.current)==null?void 0:c.removeEventListener("scroll",w)}},[D]),console.log(P),console.log(t),console.log(b),e.jsx(e.Fragment,{children:e.jsx("div",{ref:u,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[D&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,c)=>{let i;P==="piazza"?i=a:a.userUid===a.userOne?i={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:i={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let v;const p=new Date(a.messageClock);a.userUid===n.uid?v="text-right":v="text-left";let s,o;c>0&&(s=t[c-1].userUid),c<t.length-1&&t[c+1].userUid===n.uid&&(o=new Date(t[c+1].messageClock),p.getFullYear()===o.getFullYear()&&p.getMonth()===o.getMonth()&&p.getDate()===o.getDate()&&p.getHours()===o.getHours()&&(p.getMinutes(),o.getMinutes()));let g,h=p.getHours(),C=(p.getMonth()+1).toString(),j=p.getDate().toString();return h>=13?(g="오후",h!==12&&(h=h-12)):(g="오전",h===0&&(h=h+12)),p.getMonth()+1<10&&(C="0"+C),j.length===1&&(j="0"+j),e.jsxs("li",{ref:c===z?U:null,className:v,children:[s!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==n.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3",children:[e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(Se,{initiateContinuing:()=>V(null),multiple:m,handleMultiple:S,user:b,userObj:n,handleMessagesList:l,displayedName:d})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{children:a.id}),e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(Se,{initiateContinuing:()=>V(null),multiple:m,handleMultiple:S,user:b,userObj:n,handleMessagesList:l,displayedName:d})})]})})}),a.userUid!==n.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[p.getFullYear(),"-",C,"-",j," ",J==="ko"&&g," ",h,":",p.getMinutes()<10&&"0",p.getMinutes(),J==="en"&&(g==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[p.getFullYear(),"-",C,"-",j," ",J==="ko"&&g," ",h,":",p.getMinutes()<10&&"0",p.getMinutes(),J==="en"&&(g==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},c)}),e.jsx("li",{ref:U})]})})})}function Ge({isKeyboardOpen:n,userObj:m,multiple:S,handleMultiple:t,messagesList:l,handleMessagesList:U}){return e.jsx(e.Fragment,{children:n?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(De,{userObj:m,multiple:S,handleMultiple:t,messagesList:l,handleMessagesList:U})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(De,{userObj:m,multiple:S,handleMultiple:t,messagesList:l,handleMessagesList:U})})})}const Xe=Me(Te)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Je(){const n=te(l=>l.languages.value),m=oe(l=>l.piazzaSwitch.value),S=pe(),t=()=>{m==="true"?(window.localStorage.setItem("piazza","false"),S(Ne("false"))):(window.localStorage.setItem("piazza","true"),S(Ne("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Xe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:m==="true"})})]})}const Ie={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Qe=({multiple:n,displayName:m})=>{const S=te(u=>u.languages.value),t=S==="ko"||S==="en"?S:"ko",{state:l}=se(),U=(l==null?void 0:l.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx($e,{icon:e.jsx(Re,{}),title:U==="piazza"?Ie[t][0]:`${Ie[t][1]} ${m}`}),n&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Je,{})})]})};function We(){const[n,m]=r.useState([]),[S,t]=r.useState(!0),[l,U]=r.useState(!0),[u,b]=r.useState(""),[N,d]=r.useState(null),[F,D]=r.useState(null),k=Ve(),R=document.getElementById("myScreen"),V={audio:!0,video:!0},z=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],x=new RTCPeerConnection({iceServers:[{urls:z.map(s=>s.urls)}]}),E=location.search.slice(4);console.log(location.search.slice(4)),r.useEffect(()=>{(async()=>{await navigator.mediaDevices.getUserMedia(V),await J()})()},[]),r.useEffect(()=>{R&&(R.srcObject=N)},[N]);async function X(){const s=N;s&&s.getAudioTracks().forEach(o=>o.enabled=!o.enabled),t(!S)}async function W(){const s=N;s&&s.getVideoTracks().forEach(o=>o.enabled=!o.enabled),U(!l)}async function P(s){const o=N;if(await o.getTracks().forEach(g=>g.stop()),d(o),D(s.target.value),x){console.log(x.getSenders());const g=N.getVideoTracks()[0];x.getSenders().find(C=>C.track.kind==="video").replaceTrack(g)}}r.useEffect(()=>{F&&f(F)},[F]);async function J(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(g=>g.kind==="videoinput");m(o)}catch(s){console.log(s)}}async function f(s){try{const g=s?{audio:!0,video:{deviceId:{exact:s}}}:V,h=await navigator.mediaDevices.getUserMedia(g);d(h);const C=await navigator.mediaDevices.enumerateDevices();b("")}catch(o){b(o)}}function I(s){console.log("icecandidate"),console.log(s),y.emit("ice",s.candidate,E)}function M(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",N);const o=document.getElementById("yourScreen");o.srcObject=s.stream}function $(){x.addEventListener("icecandidate",I),x.addEventListener("addstream",M),N&&N.getTracks().forEach(s=>x.addTrack(s,N))}async function w(){await f(null),$()}async function a(){await w(),y.emit("joinRoom",E,w)}r.useEffect(()=>{a()},[]);const c=async()=>{console.log("sent the offer"),console.log(x);const s=await x.createOffer();x.setLocalDescription(s),console.log(s),y.emit("offer",s,E)};r.useEffect(()=>{if(y)return y.on("welcome",c),()=>{y.off("welcome",c)}});const i=async s=>{console.log("received the offer"),x.setRemoteDescription(s);const o=await x.createAnswer();console.log("sent the answer"),x.setLocalDescription(o),y.emit("answer",o,E)};r.useEffect(()=>{if(y)return y.on("offer",i),()=>{y.off("offer",i)}});const v=s=>{console.log("received the answer"),x.setRemoteDescription(s)};r.useEffect(()=>{if(y)return y.on("answer",v),()=>{y.off("answer",v)}});const p=s=>{console.log("received candidate"),x.addIceCandidate(s)};return r.useEffect(()=>{if(y)return y.on("ice",p),()=>{y.off("ice",p)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!k&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ie,{onClick:X,children:S?"unmute":"mute"}),e.jsx(ie,{onClick:W,children:l?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:P,children:n.map((s,o)=>e.jsx("option",{value:s.deviceId,selected:(N==null?void 0:N.getVideoTracks()[0].id)===s.deviceId,children:s.label},o))})]}),u&&e.jsx("div",{children:u.toString()})]})}function tt({userObj:n}){const[m,S]=r.useState(""),[t,l]=r.useState([]),U=pe(),{state:u}=se(),[b,N]=r.useState(!0),[d,F]=r.useState(!1),[D,k]=r.useState(null);r.useEffect(()=>{const z=async()=>{if(u!=null&&u.chattingUid){const x=H(T,`members/${u.chattingUid}`),E=await _(x);k(E.data())}};u!=null&&u.multiple||z()},[u]);const R=oe(z=>z.piazzaForm.value);r.useEffect(()=>{var x;const z=()=>{var X;const E=window.screen.height-300>(((X=window.visualViewport)==null?void 0:X.height)||window.screen.height);d!==E&&F(E)};return window.addEventListener("resize",z),typeof visualViewport<"u"&&((x=window.visualViewport)==null||x.addEventListener("resize",z)),visualViewport==null||visualViewport.addEventListener("resize",z),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",z)),()=>{var E;typeof visualViewport<"u"&&((E=window.visualViewport)==null||E.removeEventListener("resize",z))}},[d]),r.useEffect(()=>{(u==null?void 0:u.multiple)!==void 0&&N(u==null?void 0:u.multiple)},[]),r.useEffect(()=>{U(Fe(5))});const V=u==null?void 0:u.displayName;return e.jsxs(e.Fragment,{children:[!d&&e.jsx(Qe,{multiple:b,displayName:V}),e.jsx(Ge,{isKeyboardOpen:R,userObj:n,multiple:b,handleMultiple:z=>N(z),messagesList:t,handleMessagesList:z=>l(z)}),e.jsx(Ze,{chattingUser:D,userObj:n,multiple:b,messages:m,handleMessages:z=>S(z),messagesList:t,handleMessagesList:z=>l(z)}),e.jsxs(Be,{children:[e.jsx(Ae,{children:e.jsx("div",{id:"calls"})}),e.jsx(Le,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(We,{})}),e.jsx(He,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{tt as default};
