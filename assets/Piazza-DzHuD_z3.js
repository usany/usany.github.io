import{r as U,j as a,aQ as Q,a3 as J,a1 as B,b3 as Z,O as F,Q as y,M as Y,a8 as se,N as V,a9 as q,W as v,a5 as z,X as E,a2 as W,aT as K,bt as ie,v as oe,bu as ne,a4 as O,am as ce}from"./index-BqyS_e1n.js";import{D as le,w as b}from"./DrawersBar-vJ54V2ii.js";import{i as re,j as de,k as me,l as ge,B as ee,q as fe}from"./index-BYHlIf9n.js";import{P as pe}from"./PageTitle-DlSWDaqd.js";const he=({multiple:i,handleMultiple:w,user:e,userObj:n,handleMessagesList:C,displayedName:k})=>{const[x,N]=U.useState(null);return U.useEffect(()=>{e&&((e==null?void 0:e.uid)<n.uid?N((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]):N(n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsx("div",{children:a.jsxs(re,{children:[a.jsx(de,{children:a.jsx("div",{id:"drawer"})}),a.jsx(me,{className:"bg-light-3 dark:bg-dark-3",children:a.jsxs(ge,{className:"overflow-y-scroll",children:[a.jsx(le,{}),a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(Q,{profile:!1,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==k&&a.jsxs("div",{children:["(",k,"에서 개명)"]})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(J,{to:"/profile",state:{element:e},children:a.jsx(ee,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),i&&n.uid!==(e==null?void 0:e.uid)&&a.jsx(J,{to:"/piazza",state:{conversation:x,displayName:e==null?void 0:e.displayName,userUid:n.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(fe,{children:a.jsx(ee,{variant:"outlined",onClick:()=>{C([]),w(!1)},children:"개인 대화"})})})]})]})})]})})};function ue({userObj:i,multiple:w,handleMultiple:e,messagesList:n,handleMessagesList:C}){const k=U.useRef(null),[x,N]=U.useState(null),[R,m]=U.useState(""),h=B(t=>t.profileColor.value),L=B(t=>t.profileUrl.value),{state:P}=Z(),$=P==null?void 0:P.conversation,_=async({userUid:t,displayName:c})=>{const l=v(y,`members/${t}`),f=(await z(l)).data();N(f),m(c)},H=({userUid:t,displayName:c})=>{var l;(l=document.getElementById("drawer"))==null||l.click(),_({userUid:t,displayName:c})};U.useEffect(()=>{if(!b)return;function t(c){const{msg:l,userUid:s,id:f,target:p,messageClock:r,messageClockNumber:o,conversation:d}=c;C(u=>[...u,{msg:l,type:p?"private":"other",userUid:s,id:f,messageClock:r,messageClockNumber:o,conversation:null,profileImageUrl:L,profileColor:h}])}return b.on("sMessagePiazza",t),()=>{b.off("sMessagePiazza",t)}},[]),U.useEffect(()=>{if(!b)return;function t(c){const{msg:l,userUid:s,id:f,target:p,messageClock:r,messageClockNumber:o,conversation:d}=c;C(u=>[...u,{msg:l,type:p?"private":"other",userUid:s,id:f,messageClock:r,messageClockNumber:o,conversation:null}])}return b.on(`sMessage${$}`,t),()=>{b.off(`sMessage${$}`,t)}},[]),U.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),U.useEffect(()=>{g(),(async()=>{if(w){const c=F(y,"chats_group"),l=Y(c,V("messageClockNumber","desc"),se(1));(await q(l)).forEach(async f=>{const p=v(y,`chats_group/${f.id}`),o=(await z(p)).data(),d=o.piazzaChecked||[];d.indexOf(i.uid)===-1&&(d.push(i.uid),await E(p,{...o,piazzaChecked:d}))})}else{const c=v(y,`members/${i.uid}`),s=(await z(c)).data().chattings;s[$].messageCount=0,await E(c,{chattings:s})}})()},[n]);const g=()=>{var t;(t=k.current)==null||t.scrollIntoView()};return U.useEffect(()=>{w?(async()=>{const l=[],s=F(y,"chats_group"),f=Y(s,V("messageClockNumber"));(await q(f)).forEach(r=>{var I,T;const o=r.data().message,d=r.data().userUid,u=r.data().userName,j=r.data().messageClock,D=r.data().messageClockNumber,S=(I=r.data())==null?void 0:I.profileColor,M=(T=r.data())==null?void 0:T.profileImageUrl;l.push({msg:o,type:"me",userUid:d,id:u,messageClockNumber:D,messageClock:j,conversation:null,profileColor:S,profileImageUrl:M}),C(l)})})():(async l=>{const s=F(y,`chats_${l}`),f=Y(s,V("messageClockNumber")),p=await q(f),r=[];p.forEach(o=>{const d=o.data().message,u=o.data().userUid,j=o.data().userName,D=o.data().messageClock,S=o.data().messageClockNumber||0;r.push({msg:d,type:"me",userUid:u,id:j,messageClock:D,messageClockNumber:S}),C(r)})})($)},[w]),a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-col pt-5",children:a.jsx("div",{className:"p-1 border-t rounded-xl max-h-[60vh] overflow-auto",children:a.jsxs("ul",{children:[n.map((t,c)=>{let l;const s=new Date(t.messageClock);t.userUid===i.uid?l="text-right":l="text-left";let f,p;c>0&&(f=n[c-1].userUid),c<n.length-1&&n[c+1].userUid===i.uid&&(p=new Date(n[c+1].messageClock),s.getFullYear()===p.getFullYear()&&s.getMonth()===p.getMonth()&&s.getDate()===p.getDate()&&s.getHours()===p.getHours()&&(s.getMinutes(),p.getMinutes()));let r,o=s.getHours(),d=(s.getMonth()+1).toString(),u=s.getDate().toString();return o>=13?(r="오후",o!==12&&(o=o-12)):(r="오전",o===0&&(o=o+12)),s.getMonth()+1<10&&(d="0"+d),u.length===1&&(u="0"+u),a.jsxs("li",{className:l,children:[f!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==i.uid?"start":"end"}`,children:l==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(Q,{profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:()=>H({userUid:t.userUid,displayName:t.id})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(Q,{profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:()=>H({userUid:t.userUid,displayName:t.id})})]})})}),t.userUid!==i.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[s.getFullYear(),"-",d,"-",u," ",r," ",o,":",s.getMinutes()<10&&"0",s.getMinutes()]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[s.getFullYear(),"-",d,"-",u," ",r," ",o,":",s.getMinutes()<10&&"0",s.getMinutes()]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},c)}),a.jsx("li",{ref:k})]})})}),a.jsx(he,{multiple:w,handleMultiple:e,user:x,userObj:i,handleMessagesList:C,displayedName:R})]})}function xe({userObj:i,multiple:w,messages:e,handleMessages:n,messagesList:C,handleMessagesList:k}){const x=B(g=>g.profileColor.value),N=B(g=>g.profileUrl.value),R=W(),{state:m}=Z(),h=m==null?void 0:m.conversation,L=async g=>{var u;g.preventDefault();const t=e,c=i.uid,l=i.displayName,s=Date.now(),f=new Date().toString();let p,r,o;m.chattingUid&&(p=v(y,`members/${m.chattingUid}`),r=await z(p),o=(u=r.data())==null?void 0:u.messagingToken);const d={msg:t,userUid:c,id:l,messageClockNumber:s,messageClock:f,conversation:h,conversationUid:m.chattingUid,conversationName:m.displayName,profileUrl:N,sendingToken:o};w?d&&t&&(b.emit("piazzaMessage",d),$()):t&&(C.length!==0?(b.emit("message",d),console.log("message")):(b.emit("messageNew",d),console.log("messageNew")),_(),H()),n("")},P=g=>{n(g.target.value)},$=async()=>{try{const g=e,t=i.uid,c=i.displayName,l=new Date().toString(),s=Date.now();g&&(await K(F(y,"chats_group"),{userUid:t,userName:c,message:g,messageClock:l,messageClockNumber:s,profileImageUrl:N,profileColor:x,piazzaChecked:[i.uid]}),k(f=>[...f,{msg:g,type:"me",userUid:i.uid,id:i.displayName,messageClock:l,conversation:null,profileImageUrl:N,profileColor:x}]))}catch(g){console.log(g)}},_=async()=>{var t,c,l;const g=e;try{const s=i.uid,f=i.displayName,p=Date.now(),r=new Date().toString();let o,d,u,j,D,S;if(m.userUid<m.chattingUid?(o=m.userUid,d=m.chattingUid,u=i.displayName,j=m.displayName,D=N,S=m.profileUrl):(o=m.chattingUid,d=m.userUid,u=m.displayName,j=i.displayName,D=m.profileUrl,S=N),!D){const M=v(y,`members/${o}`);D=(t=(await z(M)).data())==null?void 0:t.profileImageUrl}if(!S){const M=v(y,`members/${d}`);S=(c=(await z(M)).data())==null?void 0:c.profileImageUrl}if(g){const M={userUid:s,userName:f,message:g,messageClock:r,messageClockNumber:p,userOne:o,userTwo:d,userOneDisplayName:u,userTwoDisplayName:j,userOneProfileUrl:D,userTwoProfileUrl:S};await K(F(y,`chats_${h}`),M);const I=v(y,`members/${s}`),X=(await z(I)).data().chattings||{},G=v(y,`members/${m.chattingUid}`),A=(await z(G)).data().chattings||{},ae=((l=A[h])==null?void 0:l.messageCount)||0;X[h]=M,A[h]={...M,messageCount:ae+1},await E(I,{chattings:X}),await E(G,{chattings:A}),k(te=>[...te,{msg:g,type:"me",userUid:i.uid,id:i.displayName,messageClock:r,conversation:h}])}}catch(s){console.log(s)}},H=async()=>{try{const g=i.uid,t=m.chattingUid,c=v(y,`members/${g}`),s=(await z(c)).data().conversation||[],f=v(y,`members/${t}`),r=(await z(f)).data().conversation||[];s.indexOf(h)===-1&&(await E(c,{conversation:[...s,h]}),R(ie())),r.indexOf(h)===-1&&await E(f,{conversation:[...r,h]})}catch(g){console.log(g)}};return a.jsx(a.Fragment,{children:a.jsxs("form",{className:"flex gap-px",onSubmit:L,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:P,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})})}const we=oe(ne)(({theme:i})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(i.palette.getContrastText(i.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(i.palette.getContrastText(i.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function ye(){const i=B(n=>n.piazzaSwitch.value),w=W(),e=()=>{i==="true"?(window.localStorage.setItem("piazza","false"),w(O("false"))):(window.localStorage.setItem("piazza","true"),w(O("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(we,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:i==="true"})})]})}const Ue=({multiple:i,displayName:w})=>a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(pe,{title:i?"단체 대화":`개인 대화 ${w}`}),i&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx(ye,{})})]});function De({userObj:i}){const[w,e]=U.useState(""),[n,C]=U.useState([]),k=W(),{state:x}=Z(),[N,R]=U.useState(!0);U.useEffect(()=>{(x==null?void 0:x.multiple)!==void 0&&R(x==null?void 0:x.multiple)},[]),U.useEffect(()=>{k(ce(5))});const m=x==null?void 0:x.displayName;return a.jsxs(a.Fragment,{children:[a.jsx(Ue,{multiple:N,displayName:m}),a.jsx(ue,{userObj:i,multiple:N,handleMultiple:h=>R(h),messagesList:n,handleMessagesList:h=>C(h)}),a.jsx(xe,{userObj:i,multiple:N,messages:w,handleMessages:h=>e(h),messagesList:n,handleMessagesList:h=>C(h)})]})}export{De as default};
