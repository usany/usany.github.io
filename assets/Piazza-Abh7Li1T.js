import{u as G,K as se,aE as ae,c as Z,j as t,k as $,g as k,V as P,S as V,aJ as oe,f as q,v as A,aL as he,r as f,I as te,O as le,B as ce,as as ue,P as re,aM as de,q as W,U as X,E as O,h as ee,aH as ge,ad as we,aN as xe,Q as me,w as ve,a5 as ye}from"./index-TDafGZvJ.js";const Ce={ko:"메세지를 작성해 주세요",en:"Input message"},ke={ko:"전송",en:"send"};function Ue({userObj:a,multiple:U,messages:u,handleMessages:e,messagesList:i,handleMessagesList:E}){const p=G(m=>m.profileColor.value),N=G(m=>m.profileUrl.value),T=se(),{state:c}=ae(),v=c==null?void 0:c.conversation,M=Z(m=>m.languages.value),w=M==="ko"||M==="en"?M:"ko",F=async m=>{var l;m.preventDefault();const z=u,y=a.uid,S=a.displayName,D=Date.now(),b=new Date().toString();let H,I,R;c.chattingUid&&(H=$(k,`members/${c.chattingUid}`),I=await P(H),R=(l=I.data())==null?void 0:l.messagingToken);const s={msg:z,userUid:y,id:S,messageClockNumber:D,messageClock:b,conversation:v,conversationUid:c.chattingUid,conversationName:c.displayName,profileUrl:N,sendingToken:R};U?s&&z&&(V.emit("piazzaMessage",s),B()):z&&(i.length!==0?(V.emit("message",s),console.log("message")):(V.emit("messageNew",s),console.log("messageNew")),_(),Q()),e("")},j=m=>{e(m.target.value)},B=async()=>{try{const m=u,z=a.uid,y=a.displayName,S=new Date().toString(),D=Date.now();m&&(await oe(q(k,"chats_group"),{userUid:z,userName:y,message:m,messageClock:S,messageClockNumber:D,profileImageUrl:N,profileColor:p,piazzaChecked:[a.uid]}),E(b=>[...b,{msg:m,type:"me",userUid:a.uid,id:a.displayName,messageClock:S,conversation:null,profileImageUrl:N,profileColor:p}]))}catch(m){console.log(m)}},_=async()=>{var z,y,S;const m=u;try{const D=a.uid,b=a.displayName,H=Date.now(),I=new Date().toString();let R,s,l,g,n,h;if(c.userUid<c.chattingUid?(R=c.userUid,s=c.chattingUid,l=a.displayName,g=c.displayName,n=N,h=c.profileUrl):(R=c.chattingUid,s=c.userUid,l=c.displayName,g=a.displayName,n=c.profileUrl,h=N),!n){const o=$(k,`members/${R}`);n=(z=(await P(o)).data())==null?void 0:z.profileImageUrl}if(!h){const o=$(k,`members/${s}`);h=(y=(await P(o)).data())==null?void 0:y.profileImageUrl}if(m){const o={userUid:D,userName:b,message:m,messageClock:I,messageClockNumber:H,userOne:R,userTwo:s,userOneDisplayName:l,userTwoDisplayName:g,userOneProfileUrl:n,userTwoProfileUrl:h};await oe(q(k,`chats_${v}`),o);const r=$(k,`members/${D}`),x=(await P(r)).data().chattings||{},C=$(k,`members/${c.chattingUid}`),L=(await P(C)).data().chattings||{},Y=((S=L[v])==null?void 0:S.messageCount)||0;x[v]=o,L[v]={...o,messageCount:Y+1},await A(r,{chattings:x}),await A(C,{chattings:L}),E(K=>[...K,{msg:m,type:"me",userUid:a.uid,id:a.displayName,messageClock:I,conversation:v}])}}catch(D){console.log(D)}},Q=async()=>{try{const m=a.uid,z=c.chattingUid,y=$(k,`members/${m}`),D=(await P(y)).data().conversation||[],b=$(k,`members/${z}`),I=(await P(b)).data().conversation||[];D.indexOf(v)===-1&&(await A(y,{conversation:[...D,v]}),T(he())),I.indexOf(v)===-1&&await A(b,{conversation:[...I,v]})}catch(m){console.log(m)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:F,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ce[w],onChange:j,value:u,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ke[w]})]})})}const fe=({initiateContinuing:a,multiple:U,handleMultiple:u,user:e,userObj:i,handleMessagesList:E,displayedName:p})=>{const[N,T]=f.useState(null),c=Z(v=>v.languages.value);return f.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?T((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):T(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(te,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&t.jsx("div",{children:c==="ko"?t.jsxs("div",{children:["(",p,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:"/profile",state:{element:e},children:t.jsx(ce,{variant:"outlined",onClick:()=>{},children:c==="ko"?"프로필 확인":"Check Profile"})}),U&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:"/piazza",state:{conversation:N,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ue,{children:t.jsx(ce,{variant:"outlined",onClick:()=>{E([]),u(!1),a()},children:c==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:a,multiple:U,handleMultiple:u,messagesList:e,handleMessagesList:i}){const E=f.useRef(null),p=f.useRef(null),[N,T]=f.useState(null),[c,v]=f.useState(""),[M,w]=f.useState(!1),[F,j]=f.useState(null),[B,_]=f.useState(0),Q=G(s=>s.profileColor.value),m=G(s=>s.profileUrl.value),{state:z}=ae(),y=z==null?void 0:z.conversation,S=Z(s=>s.languages.value),D=async({userUid:s,displayName:l})=>{const g=$(k,`members/${s}`),h=(await P(g)).data();T(h),v(l)},b=({userUid:s,displayName:l})=>{var g;(g=document.getElementById("drawer"))==null||g.click(),D({userUid:s,displayName:l})},H=20;f.useEffect(()=>{if(!V)return;function s(l){const{msg:g,userUid:n,id:h,target:o,messageClock:r,messageClockNumber:d,conversation:x}=l;i(C=>[...C,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:r,messageClockNumber:d,conversation:null,profileImageUrl:m,profileColor:Q}])}return V.on("sMessagePiazza",s),()=>{V.off("sMessagePiazza",s)}},[]),f.useEffect(()=>{if(!V)return;function s(l){const{msg:g,userUid:n,id:h,target:o,messageClock:r,messageClockNumber:d,conversation:x}=l;i(C=>[...C,{msg:g,type:o?"private":"other",userUid:n,id:h,messageClock:r,messageClockNumber:d,conversation:null}])}return V.on(`sMessage${y}`,s),()=>{V.off(`sMessage${y}`,s)}},[]),f.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),f.useEffect(()=>{I(),(async()=>{if(U){const l=q(k,"chats_group"),g=W(l,O("messageClockNumber","desc"),X(1));(await ee(g)).forEach(async h=>{const o=$(k,`chats_group/${h.id}`),d=(await P(o)).data(),x=d.piazzaChecked||[];x.indexOf(a.uid)===-1&&(x.splice(-1,a.uid,0),x.push(a.uid),await A(o,{...d,piazzaChecked:x}))})}else{const l=$(k,`members/${a.uid}`),n=(await P(l)).data().chattings;n[y].messageCount=0,await A(l,{chattings:n})}})()},[e]);const I=()=>{var s;(s=E.current)==null||s.scrollIntoView()};f.useEffect(()=>{const s=async()=>{const g=[],n=q(k,"chats_group"),h=W(n,O("messageClockNumber","desc"),X(H),ge(F||"")),o=await ee(h);o.docs.length||_(o.docs.length),o.forEach(r=>{var ie,ne;g.length===o.docs.length-1&&(j(r),_(o.docs.length-1));const d=r.data().message,x=r.data().userUid,C=r.data().userName,J=r.data().messageClock,L=r.data().messageClockNumber,Y=(ie=r.data())==null?void 0:ie.profileColor,K=(ne=r.data())==null?void 0:ne.profileImageUrl;g.push({msg:d,type:"me",userUid:x,id:C,messageClockNumber:L,messageClock:J,conversation:null,profileColor:Y,profileImageUrl:K})}),g.reverse(),i([...g,...e]),w(!1)},l=async g=>{const n=q(k,`chats_${g}`),h=W(n,O("messageClockNumber","desc"),X(H),ge(F||"")),o=await ee(h),r=[];o.docs.length||_(o.docs.length),o.forEach((d,x)=>{r.length===o.docs.length-1&&(j(d),_(o.docs.length-1));const C=d.data().message,J=d.data().userUid,L=d.data().userName,Y=d.data().messageClock,K=d.data().messageClockNumber||0;r.push({msg:C,type:"me",userUid:J,id:L,messageClock:Y,messageClockNumber:K})}),r.reverse(),i([...r,...e]),w(!1)};y?(M||!e.length)&&l(y):(M||!e.length)&&s()},[M,y]);const R=()=>{p.current.scrollTop!==0||M||(console.log("scroll"),w(!0))};return f.useEffect(()=>{var s;return(s=p.current)==null||s.addEventListener("scroll",R),()=>{var l;return(l=p.current)==null?void 0:l.removeEventListener("scroll",R)}},[M]),t.jsx(t.Fragment,{children:t.jsx("div",{className:"fixed bottom-[110px] w-screen flex flex-col pt-5",children:t.jsx("div",{ref:p,className:"p-1 border-t rounded-xl h-[50vh] overflow-auto",children:t.jsxs("ul",{children:[M&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((s,l)=>{let g;const n=new Date(s.messageClock);s.userUid===a.uid?g="text-right":g="text-left";let h,o;l>0&&(h=e[l-1].userUid),l<e.length-1&&e[l+1].userUid===a.uid&&(o=new Date(e[l+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let r,d=n.getHours(),x=(n.getMonth()+1).toString(),C=n.getDate().toString();return d>=13?(r="오후",d!==12&&(d=d-12)):(r="오전",d===0&&(d=d+12)),n.getMonth()+1<10&&(x="0"+x),C.length===1&&(C="0"+C),t.jsxs("li",{ref:l===B?E:null,className:g,children:[h!==s.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${s.userUid!==a.uid?"start":"end"}`,children:g==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(re,{trigger:t.jsx(te,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>b({userUid:s.userUid,displayName:s.id})}),title:t.jsx(de,{}),content:t.jsx(fe,{initiateContinuing:()=>j(null),multiple:U,handleMultiple:u,user:N,userObj:a,handleMessagesList:i,displayedName:c})}),t.jsx("div",{children:s.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:s.id}),t.jsx(re,{trigger:t.jsx(te,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>b({userUid:s.userUid,displayName:s.id})}),title:t.jsx(de,{}),content:t.jsx(fe,{initiateContinuing:()=>j(null),multiple:U,handleMultiple:u,user:N,userObj:a,handleMessagesList:i,displayedName:c})})]})})}),s.userUid!==a.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",x,"-",C," ",S==="ko"&&r," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),S==="en"&&(r==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",x,"-",C," ",S==="ko"&&r," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),S==="en"&&(r==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},l)}),t.jsx("li",{ref:E})]})})})})}const ze=we(xe)(({theme:a})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Se(){const a=Z(i=>i.languages.value),U=G(i=>i.piazzaSwitch.value),u=se(),e=()=>{U==="true"?(window.localStorage.setItem("piazza","false"),u(me("false"))):(window.localStorage.setItem("piazza","true"),u(me("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:a==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ze,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:U==="true"})})]})}const pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},De=({multiple:a,displayName:U})=>{const u=Z(i=>i.languages.value),e=u==="ko"||u==="en"?u:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(ve,{title:a?pe[e][0]:`${pe[e][1]} ${U}`}),a&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(Se,{})})]})};function je({userObj:a}){const[U,u]=f.useState(""),[e,i]=f.useState([]),E=se(),{state:p}=ae(),[N,T]=f.useState(!0),[c,v]=f.useState(!1);f.useEffect(()=>{var F;const w=()=>{var B;const j=window.screen.height-300>(((B=window.visualViewport)==null?void 0:B.height)||window.screen.height);c!==j&&v(j)};return window.addEventListener("resize",w),typeof visualViewport<"u"&&((F=window.visualViewport)==null||F.addEventListener("resize",w)),()=>{var j;typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.removeEventListener("resize",w))}},[]),console.log(c),f.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&T(p==null?void 0:p.multiple)},[]),window.addEventListener("resize",()=>{window.visualViewport&&console.log(window.visualViewport.height)}),f.useEffect(()=>{E(ye(5))});const M=p==null?void 0:p.displayName;return t.jsxs(t.Fragment,{children:[!c&&t.jsx(De,{multiple:N,displayName:M}),c?t.jsx("div",{children:"open"}):t.jsx("div",{children:"closing"}),t.jsx(Ne,{userObj:a,multiple:N,handleMultiple:w=>T(w),messagesList:e,handleMessagesList:w=>i(w)}),t.jsx(Ue,{userObj:a,multiple:N,messages:U,handleMessages:w=>u(w),messagesList:e,handleMessagesList:w=>i(w)})]})}export{je as default};
