import{r as h,j as t,aT as O,a3 as ie,a1 as W,b6 as ee,W as V,O as y,U as Q,a8 as X,V as J,X as K,N as R,a5 as E,Q as A,bj as oe,a2 as te,aW as ne,bw as re,v as de,bx as ge,a4 as le,ap as me}from"./index-B_d1dMZj.js";import{r as fe,t as pe,v as he,w as ue,B as ce,G as xe}from"./index-CXRr2hgY.js";import{D as we,w as $}from"./DrawersBar-D-a4toq6.js";import{P as ye}from"./PageTitle-CbwRuwRC.js";const Ne=({multiple:s,handleMultiple:N,user:e,userObj:i,handleMessagesList:v,displayedName:S})=>{const[u,U]=h.useState(null);return h.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?U((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):U(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsx("div",{children:t.jsxs(fe,{children:[t.jsx(pe,{children:t.jsx("div",{id:"drawer"})}),t.jsx(he,{className:"bg-light-3 dark:bg-dark-3",children:t.jsxs(ue,{className:"overflow-y-scroll",children:[t.jsx(we,{}),t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(O,{profile:!1,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==S&&t.jsxs("div",{children:["(",S,"에서 개명)"]})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(ie,{to:"/profile",state:{element:e},children:t.jsx(ce,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),s&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(ie,{to:"/piazza",state:{conversation:u,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(xe,{children:t.jsx(ce,{variant:"outlined",onClick:()=>{v([]),N(!1)},children:"개인 대화"})})})]})]})})]})})};function Ue({userObj:s,multiple:N,handleMultiple:e,messagesList:i,handleMessagesList:v}){const S=h.useRef(null),u=h.useRef(null),[U,B]=h.useState(null),[m,p]=h.useState(""),[T,_]=h.useState(!1),[H,Z]=h.useState(null),[q,d]=h.useState(0),k=W(a=>a.profileColor.value),b=W(a=>a.profileUrl.value),{state:z}=ee(),w=z==null?void 0:z.conversation,j=async({userUid:a,displayName:l})=>{const c=R(y,`members/${a}`),f=(await E(c)).data();B(f),p(l)},P=({userUid:a,displayName:l})=>{var c;(c=document.getElementById("drawer"))==null||c.click(),j({userUid:a,displayName:l})},M=10;h.useEffect(()=>{if(!$)return;function a(l){const{msg:c,userUid:o,id:f,target:n,messageClock:g,messageClockNumber:r,conversation:x}=l;v(C=>[...C,{msg:c,type:n?"private":"other",userUid:o,id:f,messageClock:g,messageClockNumber:r,conversation:null,profileImageUrl:b,profileColor:k}])}return $.on("sMessagePiazza",a),()=>{$.off("sMessagePiazza",a)}},[]),h.useEffect(()=>{if(!$)return;function a(l){const{msg:c,userUid:o,id:f,target:n,messageClock:g,messageClockNumber:r,conversation:x}=l;v(C=>[...C,{msg:c,type:n?"private":"other",userUid:o,id:f,messageClock:g,messageClockNumber:r,conversation:null}])}return $.on(`sMessage${w}`,a),()=>{$.off(`sMessage${w}`,a)}},[]),h.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),h.useEffect(()=>{I(),(async()=>{if(N){const l=V(y,"chats_group"),c=Q(l,J("messageClockNumber","desc"),X(1));(await K(c)).forEach(async f=>{const n=R(y,`chats_group/${f.id}`),r=(await E(n)).data(),x=r.piazzaChecked||[];x.indexOf(s.uid)===-1&&(x.splice(-1,s.uid,0),x.push(s.uid),await A(n,{...r,piazzaChecked:x}))})}else{const l=R(y,`members/${s.uid}`),o=(await E(l)).data().chattings;o[w].messageCount=0,await A(l,{chattings:o})}})()},[i]);const I=()=>{var a;(a=S.current)==null||a.scrollIntoView()};h.useEffect(()=>{const a=async()=>{const c=[],o=V(y,"chats_group"),f=Q(o,J("messageClockNumber","desc"),X(M),oe(H||"")),n=await K(f);n.docs.length||d(n.docs.length),n.forEach(g=>{var ae,se;c.length===n.docs.length-1&&(Z(g),d(n.docs.length-1));const r=g.data().message,x=g.data().userUid,C=g.data().userName,F=g.data().messageClock,L=g.data().messageClockNumber,Y=(ae=g.data())==null?void 0:ae.profileColor,G=(se=g.data())==null?void 0:se.profileImageUrl;c.push({msg:r,type:"me",userUid:x,id:C,messageClockNumber:L,messageClock:F,conversation:null,profileColor:Y,profileImageUrl:G})}),c.reverse(),v([...c,...i]),_(!1)},l=async c=>{const o=V(y,`chats_${c}`),f=Q(o,J("messageClockNumber","desc"),X(M),oe(H||"")),n=await K(f),g=[];n.docs.length||d(n.docs.length),n.forEach((r,x)=>{g.length===n.docs.length-1&&(Z(r),d(n.docs.length-1));const C=r.data().message,F=r.data().userUid,L=r.data().userName,Y=r.data().messageClock,G=r.data().messageClockNumber||0;g.push({msg:C,type:"me",userUid:F,id:L,messageClock:Y,messageClockNumber:G})}),g.reverse(),v([...g,...i]),_(!1)};N?(T||!i.length)&&a():(T||!i.length)&&l(w)},[T]);const D=()=>{u.current.scrollTop!==0||T||(console.log("scroll"),_(!0))};return h.useEffect(()=>{var a;return(a=u.current)==null||a.addEventListener("scroll",D),()=>{var l;return(l=u.current)==null?void 0:l.removeEventListener("scroll",D)}},[T]),t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{ref:u,className:"p-1 border-t rounded-xl max-h-[60vh] overflow-auto",children:t.jsxs("ul",{children:[T&&t.jsx("div",{children:"loading"}),i.map((a,l)=>{let c;const o=new Date(a.messageClock);a.userUid===s.uid?c="text-right":c="text-left";let f,n;l>0&&(f=i[l-1].userUid),l<i.length-1&&i[l+1].userUid===s.uid&&(n=new Date(i[l+1].messageClock),o.getFullYear()===n.getFullYear()&&o.getMonth()===n.getMonth()&&o.getDate()===n.getDate()&&o.getHours()===n.getHours()&&(o.getMinutes(),n.getMinutes()));let g,r=o.getHours(),x=(o.getMonth()+1).toString(),C=o.getDate().toString();return r>=13?(g="오후",r!==12&&(r=r-12)):(g="오전",r===0&&(r=r+12)),o.getMonth()+1<10&&(x="0"+x),C.length===1&&(C="0"+C),t.jsxs("li",{ref:l===q?S:null,className:c,children:[f!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:c==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(O,{profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,fallback:"",piazza:()=>P({userUid:a.userUid,displayName:a.id})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(O,{profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,fallback:"",piazza:()=>P({userUid:a.userUid,displayName:a.id})})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[o.getFullYear(),"-",x,"-",C," ",g," ",r,":",o.getMinutes()<10&&"0",o.getMinutes()]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[o.getFullYear(),"-",x,"-",C," ",g," ",r,":",o.getMinutes()<10&&"0",o.getMinutes()]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},l)}),t.jsx("li",{ref:S})]})})}),t.jsx(Ne,{multiple:N,handleMultiple:e,user:U,userObj:s,handleMessagesList:v,displayedName:m})]})}function Ce({userObj:s,multiple:N,messages:e,handleMessages:i,messagesList:v,handleMessagesList:S}){const u=W(d=>d.profileColor.value),U=W(d=>d.profileUrl.value),B=te(),{state:m}=ee(),p=m==null?void 0:m.conversation,T=async d=>{var a;d.preventDefault();const k=e,b=s.uid,z=s.displayName,w=Date.now(),j=new Date().toString();let P,M,I;m.chattingUid&&(P=R(y,`members/${m.chattingUid}`),M=await E(P),I=(a=M.data())==null?void 0:a.messagingToken);const D={msg:k,userUid:b,id:z,messageClockNumber:w,messageClock:j,conversation:p,conversationUid:m.chattingUid,conversationName:m.displayName,profileUrl:U,sendingToken:I};N?D&&k&&($.emit("piazzaMessage",D),H()):k&&(v.length!==0?($.emit("message",D),console.log("message")):($.emit("messageNew",D),console.log("messageNew")),Z(),q()),i("")},_=d=>{i(d.target.value)},H=async()=>{try{const d=e,k=s.uid,b=s.displayName,z=new Date().toString(),w=Date.now();d&&(await ne(V(y,"chats_group"),{userUid:k,userName:b,message:d,messageClock:z,messageClockNumber:w,profileImageUrl:U,profileColor:u,piazzaChecked:[s.uid]}),S(j=>[...j,{msg:d,type:"me",userUid:s.uid,id:s.displayName,messageClock:z,conversation:null,profileImageUrl:U,profileColor:u}]))}catch(d){console.log(d)}},Z=async()=>{var k,b,z;const d=e;try{const w=s.uid,j=s.displayName,P=Date.now(),M=new Date().toString();let I,D,a,l,c,o;if(m.userUid<m.chattingUid?(I=m.userUid,D=m.chattingUid,a=s.displayName,l=m.displayName,c=U,o=m.profileUrl):(I=m.chattingUid,D=m.userUid,a=m.displayName,l=s.displayName,c=m.profileUrl,o=U),!c){const f=R(y,`members/${I}`);c=(k=(await E(f)).data())==null?void 0:k.profileImageUrl}if(!o){const f=R(y,`members/${D}`);o=(b=(await E(f)).data())==null?void 0:b.profileImageUrl}if(d){const f={userUid:w,userName:j,message:d,messageClock:M,messageClockNumber:P,userOne:I,userTwo:D,userOneDisplayName:a,userTwoDisplayName:l,userOneProfileUrl:c,userTwoProfileUrl:o};await ne(V(y,`chats_${p}`),f);const n=R(y,`members/${w}`),r=(await E(n)).data().chattings||{},x=R(y,`members/${m.chattingUid}`),F=(await E(x)).data().chattings||{},L=((z=F[p])==null?void 0:z.messageCount)||0;r[p]=f,F[p]={...f,messageCount:L+1},await A(n,{chattings:r}),await A(x,{chattings:F}),S(Y=>[...Y,{msg:d,type:"me",userUid:s.uid,id:s.displayName,messageClock:M,conversation:p}])}}catch(w){console.log(w)}},q=async()=>{try{const d=s.uid,k=m.chattingUid,b=R(y,`members/${d}`),w=(await E(b)).data().conversation||[],j=R(y,`members/${k}`),M=(await E(j)).data().conversation||[];w.indexOf(p)===-1&&(await A(b,{conversation:[...w,p]}),B(re())),M.indexOf(p)===-1&&await A(j,{conversation:[...M,p]})}catch(d){console.log(d)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:T,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:_,value:e,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})})}const ve=de(ge)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function ke(){const s=W(i=>i.piazzaSwitch.value),N=te(),e=()=>{s==="true"?(window.localStorage.setItem("piazza","false"),N(le("false"))):(window.localStorage.setItem("piazza","true"),N(le("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ve,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:s==="true"})})]})}const ze=({multiple:s,displayName:N})=>t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(ye,{title:s?"단체 대화":`개인 대화 ${N}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(ke,{})})]});function je({userObj:s}){const[N,e]=h.useState(""),[i,v]=h.useState([]),S=te(),{state:u}=ee(),[U,B]=h.useState(!0);h.useEffect(()=>{(u==null?void 0:u.multiple)!==void 0&&B(u==null?void 0:u.multiple)},[]),h.useEffect(()=>{S(me(5))});const m=u==null?void 0:u.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(ze,{multiple:U,displayName:m}),t.jsx(Ue,{userObj:s,multiple:U,handleMultiple:p=>B(p),messagesList:i,handleMessagesList:p=>v(p)}),t.jsx(Ce,{userObj:s,multiple:U,messages:N,handleMessages:p=>e(p),messagesList:i,handleMessagesList:p=>v(p)})]})}export{je as default};
