import{r as u,j as s,M as K,v as Ne,bj as we,S as V,a5 as te,bk as X,aY as ye,aP as Ce,N as O,O as ee,Q as ae,a0 as L,V as x,a1 as H,a2 as Ue,a3 as B,a4 as Y,U as y,W as C,ae as $,aO as se,bl as ve}from"./index-DFLENtAm.js";import{a as ke,b as De,D as Se}from"./DialogContent-BnRHI7Wb.js";import{A as ze}from"./Avatar-Due4Yuf4.js";import{B as _}from"./Button-CmaEIKBj.js";import{w as S}from"./webSocket-BpFYzTQr.js";const Me=({multiple:i,selectUser:U,user:e,handleClose:v,userObj:f,handleMsgList:k,handleChangeMessage:E,displayedName:j})=>{const[T,P]=u.useState(null);return u.useEffect(()=>{U&&((e==null?void 0:e.uid)<f.uid?P((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]):P(f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[U]),s.jsxs(ke,{open:U,onClose:v,children:[s.jsxs(De,{children:[s.jsx("div",{children:s.jsx(ze,{alt:e==null?void 0:e.displayName,sx:{bgcolor:(e==null?void 0:e.profileColor)||"#2196f3"},src:(e==null?void 0:e.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==j&&s.jsxs("div",{children:["(",j,"에서 개명)"]})]}),s.jsxs(Se,{children:[s.jsx(K,{to:"/profile",state:{element:e},children:s.jsx(_,{variant:"outlined",onClick:()=>{v()},children:"프로필 확인"})}),i&&f.uid!==(e==null?void 0:e.uid)&&s.jsx(K,{to:"/piazza",state:{conversation:T,displayName:e==null?void 0:e.displayName,userUid:f.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:s.jsx(_,{variant:"outlined",onClick:()=>{k([]),E(!0),v()},children:"개인 대화"})}),s.jsx(_,{variant:"outlined",onClick:()=>{v()},children:"닫기"})]})]})},be=Ne(we)(({theme:i})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(i.palette.getContrastText(i.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(i.palette.getContrastText(i.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function je(){const i=V(v=>v.piazzaSwitch.value),U=te(),e=()=>{i==="true"?(window.localStorage.setItem("piazza","false"),U(X("false"))):(window.localStorage.setItem("piazza","true"),U(X("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(be,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:i==="true"})})]})}function Pe({userObj:i}){const U=u.useRef(null),[e,v]=u.useState(""),[f,k]=u.useState([]),[E,j]=u.useState(!0),[T,P]=u.useState(""),[ie,oe]=u.useState(null),[ne,Z]=u.useState(!1),A=V(a=>a.profileColor.value),I=V(a=>a.profileUrl.value),[ce,le]=u.useState(null),q=te(),{state:r}=ye(),R=r==null?void 0:r.multiple,N=r==null?void 0:r.conversation;u.useEffect(()=>{if(!S)return;function a(o){const{msg:n,userUid:t,id:d,target:g,messageClock:m,messageClockNumber:c,conversation:l}=o;k(p=>[...p,{msg:n,type:g?"private":"other",userUid:t,id:d,messageClock:m,messageClockNumber:c,conversation:null,profileImageUrl:I,profileColor:A}])}return S.on("sMessagePiazza",a),()=>{S.off("sMessagePiazza",a)}},[]),u.useEffect(()=>{if(!S)return;function a(o){const{msg:n,userUid:t,id:d,target:g,messageClock:m,messageClockNumber:c,conversation:l}=o;k(p=>[...p,{msg:n,type:g?"private":"other",userUid:t,id:d,messageClock:m,messageClockNumber:c,conversation:null}])}return S.on(`sMessage${N}`,a),()=>{S.off(`sMessage${N}`,a)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{de(),(async()=>{if(R){const o=L(x,"chats_group"),n=H(o,B("messageClockNumber","desc"),Ue(1));(await Y(n)).forEach(async d=>{const g=y(x,`chats_group/${d.id}`),c=(await C(g)).data(),l=c.piazzaChecked||[];l.indexOf(i.uid)===-1&&(l.push(i.uid),await $(g,{...c,piazzaChecked:l}))})}else{const o=y(x,`members/${i.uid}`),t=(await C(o)).data().chattings;t[N].messageCount=0,await $(o,{chattings:t})}})()},[f]),u.useEffect(()=>{q(Ce(5))});const de=()=>{var a;(a=U.current)==null||a.scrollIntoView()},re=async a=>{var h;a.preventDefault();const o=e,n=i.uid,t=i.displayName,d=Date.now(),g=new Date().toString();let m,c,l;r.chattingUid&&(m=y(x,`members/${r.chattingUid}`),c=await C(m),l=(h=c.data())==null?void 0:h.messagingToken);const p={msg:o,userUid:n,id:t,messageClockNumber:d,messageClock:g,target:T,conversation:N,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:I,sendingToken:l};R?p&&o&&(S.emit("piazzaMessage",p),fe()):o&&(f.length!==0?(S.emit("message",p),console.log("message")):(S.emit("messageNew",p),console.log("messageNew")),pe(),he()),v("")},ge=a=>{v(a.target.value)},Q=async({userUid:a,displayName:o})=>{const n=y(x,`members/${a}`),d=(await C(n)).data();oe(d),Z(!0),le(o)},me=()=>{Z(!1)},fe=async()=>{try{const a=e,o=i.uid,n=i.displayName,t=new Date().toString(),d=Date.now();a&&(await se(L(x,"chats_group"),{userUid:o,userName:n,message:a,messageClock:t,messageClockNumber:d,profileImageUrl:I,profileColor:A,piazzaChecked:[i.uid]}),k(g=>[...g,{msg:a,type:"me",userUid:i.uid,id:i.displayName,messageClock:t,conversation:null,profileImageUrl:I,profileColor:A}]))}catch(a){console.log(a)}};u.useEffect(()=>{E&&(R?((async()=>{const n=[],t=L(x,"chats_group"),d=H(t,B("messageClockNumber"));(await Y(d)).forEach(m=>{var w,b;const c=m.data().message,l=m.data().userUid,p=m.data().userName,h=m.data().messageClock,z=m.data().messageClockNumber,D=(w=m.data())==null?void 0:w.profileColor,M=(b=m.data())==null?void 0:b.profileImageUrl;n.push({msg:c,type:"me",userUid:l,id:p,messageClockNumber:z,messageClock:h,conversation:null,profileColor:D,profileImageUrl:M}),k(n)})})(),j(!1)):((async n=>{const t=L(x,`chats_${n}`),d=H(t,B("messageClockNumber")),g=await Y(d),m=[];g.forEach(c=>{const l=c.data().message,p=c.data().userUid,h=c.data().userName,z=c.data().messageClock,D=c.data().messageClockNumber||0;m.push({msg:l,type:"me",userUid:p,id:h,messageClock:z,messageClockNumber:D}),k(m)})})(N),j(!1)))},[E]);const pe=async()=>{var o,n,t;const a=e;try{const d=i.uid,g=i.displayName,m=Date.now(),c=new Date().toString();let l,p,h,z,D,M;if(r.userUid<r.chattingUid?(l=r.userUid,p=r.chattingUid,h=i.displayName,z=r.displayName,D=I,M=r.profileUrl):(l=r.chattingUid,p=r.userUid,h=r.displayName,z=i.displayName,D=r.profileUrl,M=I),!D){const w=y(x,`members/${l}`);D=(o=(await C(w)).data())==null?void 0:o.profileImageUrl}if(!M){const w=y(x,`members/${p}`);M=(n=(await C(w)).data())==null?void 0:n.profileImageUrl}if(a){const w={userUid:d,userName:g,message:a,messageClock:c,messageClockNumber:m,userOne:l,userTwo:p,userOneDisplayName:h,userTwoDisplayName:z,userOneProfileUrl:D,userTwoProfileUrl:M};console.log(w),await se(L(x,`chats_${N}`),w);const b=y(x,`members/${d}`),G=(await C(b)).data().chattings||{},J=y(x,`members/${r.chattingUid}`),F=(await C(J)).data().chattings||{},ue=((t=F[N])==null?void 0:t.messageCount)||0;G[N]=w,F[N]={...w,messageCount:ue+1},await $(b,{chattings:G}),await $(J,{chattings:F}),k(xe=>[...xe,{msg:a,type:"me",userUid:i.uid,id:i.displayName,messageClock:c,conversation:N}])}}catch(d){console.log(d)}},he=async()=>{try{const a=i.uid,o=r.chattingUid,n=y(x,`members/${a}`),d=(await C(n)).data().conversation||[],g=y(x,`members/${o}`),c=(await C(g)).data().conversation||[];d.indexOf(N)===-1&&(await $(n,{conversation:[...d,N]}),q(ve())),c.indexOf(N)===-1&&await $(g,{conversation:[...c,N]})}catch(a){console.log(a)}};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex text-2xl p-5 w-screen",children:[s.jsx("div",{className:"w-screen",children:R?"단체 대화":`개인 대화 ${r==null?void 0:r.displayName}`}),R&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(je,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[f.map((a,o)=>{let n;const t=new Date(a.messageClock);a.userUid===i.uid?n="text-right":n="text-left";let d,g,m="true";o>0&&(d=f[o-1].userUid),o<f.length-1&&f[o+1].userUid===i.uid&&(g=new Date(f[o+1].messageClock),t.getFullYear()===g.getFullYear()&&t.getMonth()===g.getMonth()&&t.getDate()===g.getDate()&&t.getHours()===g.getHours()&&t.getMinutes()===g.getMinutes()&&(m="false"));let c,l=t.getHours(),p=(t.getMonth()+1).toString(),h=t.getDate().toString();return l>=13?(c="오후",l!==12&&(l=l-12)):(c="오전",l===0&&(l=l+12)),t.getMonth()+1<10&&(p="0"+p),h.length===1&&(h="0"+h),s.jsxs("li",{className:n,children:[d!==a.userUid&&s.jsx("div",{children:s.jsx("div",{className:`flex justify-${a.userUid!==i.uid?"start":"end"}`,children:n==="text-left"?s.jsxs("div",{className:"flex gap-3",children:[s.jsxs(O,{onClick:()=>Q({userUid:a.userUid,displayName:a.id}),className:"bg-profile-blue",children:[s.jsx(ee,{src:a.profileImageUrl}),s.jsx(ae,{className:"text-xl border-none	",children:a.id[0]})]}),s.jsx("div",{children:a.id})]}):s.jsxs("div",{className:"flex gap-3",children:[s.jsx("div",{children:a.id}),s.jsxs(O,{onClick:()=>Q({userUid:a.userUid,displayName:a.id}),className:"bg-profile-blue",children:[s.jsx(ee,{src:a.profileImageUrl}),s.jsx(ae,{className:"text-xl border-none	",children:a.id[0]})]})]})})}),a.userUid!==i.uid?s.jsxs("div",{className:"flex gap-3 justify-start",children:[s.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),m==="true"&&s.jsxs("div",{children:[t.getFullYear(),"-",p,"-",h," ",c," ",l,":",t.getMinutes()]})]}):s.jsxs("div",{className:"flex gap-3 justify-end",children:[m==="true"&&s.jsxs("div",{children:[t.getFullYear(),"-",p,"-",h," ",c," ",l,":",t.getMinutes()]}),s.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]})}),s.jsx("li",{ref:U})]}),s.jsxs("form",{className:"flex gap-px",onSubmit:re,children:[s.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:ge,value:e,autoFocus:!0}),s.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})]}),s.jsx(Me,{multiple:R,selectUser:ne,user:ie,handleClose:me,userObj:i,handleMsgList:a=>k(a),handleChangeMessage:a=>j(a),displayedName:ce})]})})]})}export{Pe as default};
