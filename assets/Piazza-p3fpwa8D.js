import{c as Te,u as re,d as ae,G as ve,b1 as Ue,j as e,P as pe,a0 as we,b8 as ye,b7 as he,b0 as Ae,x as F,p as M,O as B,a4 as m,b4 as ke,n as ce,E as oe,b9 as Fe,a_ as Re,r as c,W as xe,a1 as Ce,B as ee,ba as ze,q as fe,a2 as ge,a3 as ue,t as me,b2 as Se,s as Be,S as He,X as je,H as _e,bb as Oe,aN as $e,af as Ye,bc as Ne,bd as De,be as Ie,bf as be}from"./index-BDodpFV_.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Te("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Te("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ke={ko:"메세지를 작성해 주세요",en:"Input message"},We={ko:"전송",en:"send"};function Ze({chattingUser:l,userObj:t,multiple:g,messages:S,handleMessages:C,messagesList:U,handleMessagesList:P}){const I=re(n=>n.profileColor.value),N=re(n=>n.piazzaForm.value),d=ae(n=>n.profile.value),$=ve(),x=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",b=ae(n=>n.languages.value),E=b==="ko"||b==="en"?b:"ko",[R,O]=Ue(),L=async n=>{var k;n.preventDefault();const v=S,w=t.uid,j=t.displayName,o=Date.now(),f=new Date().toString(),s=d==null?void 0:d.profileImageUrl,i=d==null?void 0:d.defaultProfile,r=d==null?void 0:d.profileImage;let y,h,p;l&&(y=F(M,`members/${l.uid}`),h=await B(y),p=(k=h.data())==null?void 0:k.messagingToken);const a=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const u={msg:v,userUid:w,id:j,messageClockNumber:o,messageClock:f,conversation:x,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:r,defaultProfile:i,profileImageUrl:s,profileUrl:a,sendingToken:p};g?u&&v&&(m.emit("piazzaMessage",u),A()):v&&(U.length!==0?(m.emit("message",u),console.log("message")):(m.emit("messageNew",u),console.log("messageNew")),z(),H()),C("")},D=n=>{C(n.target.value)},A=async()=>{try{const n=S,v=t.uid,w=t.displayName,j=new Date().toString(),o=Date.now(),f=d==null?void 0:d.profileImageUrl,s=d==null?void 0:d.defaultProfile,i=d==null?void 0:d.profileImage;n&&(await ke(ce(M,"chats_group"),{userUid:v,userName:w,message:n,messageClock:j,messageClockNumber:o,profileImageUrl:f,defaultProfile:s,profileColor:I,piazzaChecked:[t.uid],profileImage:i}),P(r=>[...r,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:j,conversation:null,profileColor:I,messageClockNumber:o,defaultProfile:s,profileImageUrl:f,profileImage:i||!1}]))}catch(n){console.log(n)}},z=async()=>{var v,w,j;const n=S;try{const o=t.uid,f=t.displayName,s=Date.now(),i=new Date().toString(),r=d.profileImage,y=l.profileImage,h=d.profileImageUrl,p=l.profileImageUrl,a=d.defaultProfile,u=l.defaultProfile;let k,T,_,q,G,K,Z,X,W,te;if(t.uid<l.uid?(k=t.uid,T=l.uid,_=t.displayName,q=l.displayName,G=h,K=p,Z=a,X=u,W=d.profileImage,te=l.profileImage):(k=l.uid,T=t.uid,_=l.displayName,q=t.displayName,G=p,K=h,Z=u,X=a,W=l.profileImage,te=d.profileImage),!G){const J=F(M,`members/${k}`);G=(v=(await B(J)).data())==null?void 0:v.profileImageUrl}if(!K){const J=F(M,`members/${T}`);K=(w=(await B(J)).data())==null?void 0:w.profileImageUrl}if(n){const J={userUid:o,userName:f,message:n,messageClock:i,messageClockNumber:s,userOne:k,userTwo:T,userOneDisplayName:_,userTwoDisplayName:q,userOneProfileUrl:G,userTwoProfileUrl:K,userOneDefaultProfile:Z,userTwoDefaultProfile:X,userOneProfileImage:W,userTwoProfileImage:te};await ke(ce(M,`chats_${x}`),J);const se=F(M,`members/${o}`),ie=(await B(se)).data().chattings||{},le=F(M,`members/${l.uid}`),de=(await B(le)).data().chattings||{},Ve=((j=de[x])==null?void 0:j.messageCount)||0;ie[x]=J,de[x]={...J,messageCount:Ve+1},await oe(se,{chattings:ie}),await oe(le,{chattings:de}),P(Le=>[...Le,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:i,conversation:x,userName:f,messageClockNumber:s,userOne:k,userTwo:T,userOneDisplayName:_,userTwoDisplayName:q,userOneProfileUrl:G,userTwoProfileUrl:K,userOneDefaultProfile:Z,userTwoDefaultProfile:X,userOneProfileImage:W,userTwoProfileImage:te}])}}catch(o){console.log(o)}},H=async()=>{try{const n=t.uid,v=l.uid,w=F(M,`members/${n}`),o=(await B(w)).data().conversation||[],f=F(M,`members/${v}`),i=(await B(f)).data().conversation||[];o.indexOf(x)===-1&&(await oe(w,{conversation:[...o,x]}),$(Fe())),i.indexOf(x)===-1&&await oe(f,{conversation:[...i,x]})}catch(n){console.log(n)}},Y=async()=>{var f,s,i;(f=document.getElementById("videoCall"))==null||f.click();let n,v,w,j;l&&(n=F(M,`members/${l.uid}`),v=await B(n),w=(s=v.data())==null?void 0:s.messagingToken,j=(i=v.data())==null?void 0:i.preferLanguage);const o={conversation:x,isVideo:!0,sendingToken:w,connectedUrl:`/piazza?id=${x}&call=video`,preferLanguage:j,userUid:t.uid,id:t.displayName,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName};console.log(o),m.emit("call",o),O(r=>(r.set("call","video"),r))};return e.jsxs("form",{className:`fixed w-screen ${N?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:L,children:[x&&x!=="piazza"&&e.jsx(pe,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ge,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{Y()},children:e.jsxs(he,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Ae,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var n;(n=document.getElementById("audioCall"))==null||n.click()},children:e.jsxs(he,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(qe,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ke[E],onChange:D,value:S,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:We[E]})]})}const Pe=({initiateContinuing:l,user:t,userObj:g,handleMessagesList:S,displayedName:C,handleChatUid:U,handleChatDisplayName:P})=>{const{state:I}=Re(),N=(I==null?void 0:I.conversation)||"piazza",d=ae(b=>b.languages.value),[$,x]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<g.uid?x((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+g.uid[0]+g.uid[1]+g.uid[2]+g.uid[3]+g.uid[4]+g.uid[5]):x(g.uid[0]+g.uid[1]+g.uid[2]+g.uid[3]+g.uid[4]+g.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(xe,{element:t,uid:g.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==C&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",C,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",C,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ee,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),N==="piazza"&&g.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:g.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(he,{children:e.jsx(ee,{variant:"outlined",onClick:()=>{S([]),l()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ee({userObj:l,messagesList:t,handleMessagesList:g,handleChatUid:S,handleChatDisplayName:C}){const U=c.useRef(null),P=c.useRef(null),[I,N]=c.useState(null),[d,$]=c.useState(""),[x,b]=c.useState(!1),[E,R]=c.useState(null),[O,L]=c.useState(0),[D,A]=c.useState("piazza"),z=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";c.useEffect(()=>{(D!==z||z==="piazza")&&(g([]),R(null),L(0),A(z))},[z]);const H=ae(o=>o.languages.value),Y=async({userUid:o,displayName:f})=>{const s=F(M,`members/${o}`),r=(await B(s)).data();N(r),$(f),console.log("practice")},n=({userUid:o,displayName:f})=>{var s;(s=document.getElementById("drawer"))==null||s.click(),Y({userUid:o,displayName:f})},v=20;c.useEffect(()=>{if(!m)return;function o(f){const{msg:s,userUid:i,id:r,target:y,messageClock:h,messageClockNumber:p,profileImageUrl:a,defaultProfile:u,profileImage:k,conversation:T}=f;g(_=>[..._,{msg:s,type:y?"private":"other",userUid:i,id:r,messageClock:h,messageClockNumber:p,conversation:null,profileImageUrl:a,defaultProfile:u,profileImage:k}])}return m.on("sMessagePiazza",o),()=>{m.off("sMessagePiazza",o)}},[]),c.useEffect(()=>{if(!m)return;function o(f){const{msg:s,userUid:i,id:r,target:y,messageClock:h,messageClockNumber:p,conversation:a,profileImageUrl:u,defaultProfile:k,profileImage:T,piazzaData:_}=f;g(q=>[...q,{msg:s,type:y?"private":"other",userUid:i,id:r,messageClock:h,messageClockNumber:p,conversation:null,profileImageUrl:u,defaultProfile:k,profileImage:T,..._}])}return m.on(`sMessage${z}`,o),()=>{m.off(`sMessage${z}`,o)}},[z]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{w(),(async()=>{if(z==="piazza"){const f=ce(M,"chats_group"),s=fe(f,ue("messageClockNumber","desc"),ge(1));(await me(s)).forEach(async r=>{const y=F(M,`chats_group/${r.id}`),p=(await B(y)).data(),a=p.piazzaChecked||[];a.indexOf(l.uid)===-1&&(a.splice(-1,l.uid,0),a.push(l.uid),await oe(y,{...p,piazzaChecked:a}))})}else{const f=F(M,`members/${l.uid}`),i=(await B(f)).data().chattings;i[z]&&(i[z].messageCount=0),await oe(f,{chattings:i})}})()},[t]);const w=()=>{var o;(o=U.current)==null||o.scrollIntoView()};c.useEffect(()=>{const o=async()=>{const s=[],i=ce(M,"chats_group"),r=fe(i,ue("messageClockNumber","desc"),ge(v),Se(E||"")),y=await me(r);y.docs.length||L(y.docs.length),y.forEach(h=>{var Z,X,W;s.length===y.docs.length-1&&(R(h),L(y.docs.length-1));const p=h.data().message,a=h.data().userUid,u=h.data().userName,k=h.data().messageClock,T=h.data().messageClockNumber,_=(Z=h.data())==null?void 0:Z.profileImageUrl,q=(X=h.data())==null?void 0:X.defaultProfile,G=(W=h.data())==null?void 0:W.profileImage,K=h.data();s.push({msg:p,userUid:a,id:u,messageClockNumber:T,messageClock:k,conversation:null,profileImageUrl:_,defaultProfile:q,profileImage:G||!1,...K})}),s.reverse(),g([...s,...t]),b(!1)},f=async s=>{const i=ce(M,`chats_${s}`),r=fe(i,ue("messageClockNumber","desc"),ge(v),Se(E||"")),y=await me(r),h=[];y.docs.length||L(y.docs.length),y.forEach((p,a)=>{var ne,ie,le;h.length===y.docs.length-1&&(R(p),L(y.docs.length-1));const u=p.data().message,k=p.data().userUid,T=p.data().userName,_=p.data().messageClock,q=p.data().messageClockNumber||0,G=(ne=p.data())==null?void 0:ne.profileImageUrl,K=(ie=p.data())==null?void 0:ie.defaultProfile,Z=(le=p.data())==null?void 0:le.profileImage,X=p.data(),W=p.data().userOne,te=p.data().userOneDisplayName,J=p.data().userTwo,se=p.data().userTwoDisplayName;W!==l.uid?(S(W),C(te)):(S(J),C(se)),h.push({msg:u,userUid:k,id:T,messageClockNumber:q,messageClock:_,conversation:null,profileImageUrl:G,defaultProfile:K,profileImage:Z||!1,...X})}),h.reverse(),g([...h,...t]),b(!1)};console.log(t.length),z==="piazza"?(x||!t.length)&&o():(x||!t.length)&&f(z)},[x,D]);const j=()=>{P.current.scrollTop!==0||x||(console.log("scroll"),b(!0))};return c.useEffect(()=>{var o;return(o=P.current)==null||o.addEventListener("scroll",j),()=>{var f;return(f=P.current)==null?void 0:f.removeEventListener("scroll",j)}},[x]),console.log(z),console.log(t),console.log(I),e.jsx(e.Fragment,{children:e.jsx("div",{ref:P,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[x&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((o,f)=>{let s;z==="piazza"?s=o:o.userUid===o.userOne?s={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:s={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let i;const r=new Date(o.messageClock);o.userUid===l.uid?i="text-right":i="text-left";let y,h;f>0&&(y=t[f-1].userUid),f<t.length-1&&t[f+1].userUid===l.uid&&(h=new Date(t[f+1].messageClock),r.getFullYear()===h.getFullYear()&&r.getMonth()===h.getMonth()&&r.getDate()===h.getDate()&&r.getHours()===h.getHours()&&(r.getMinutes(),h.getMinutes()));let p,a=r.getHours(),u=(r.getMonth()+1).toString(),k=r.getDate().toString();return a>=13?(p="오후",a!==12&&(a=a-12)):(p="오전",a===0&&(a=a+12)),r.getMonth()+1<10&&(u="0"+u),k.length===1&&(k="0"+k),e.jsxs("li",{ref:f===O?U:null,className:i,children:[y!==o.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${o.userUid!==l.uid?"start":"end"}`,children:i==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(pe,{trigger:e.jsx(xe,{element:s,piazza:()=>n({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(ze,{}),content:e.jsx(Pe,{initiateContinuing:()=>R(null),user:I,userObj:l,handleMessagesList:g,displayedName:d})}),e.jsx("div",{children:o.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:o.id}),e.jsx(pe,{trigger:e.jsx(xe,{element:s,piazza:()=>n({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(ze,{}),content:e.jsx(Pe,{initiateContinuing:()=>R(null),user:I,userObj:l,handleMessagesList:g,displayedName:d,handleChatUid:S,handleChatDisplayName:C})})]})})}),o.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),e.jsxs("div",{children:[r.getFullYear(),"-",u,"-",k," ",H==="ko"&&p," ",a,":",r.getMinutes()<10&&"0",r.getMinutes(),H==="en"&&(p==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[r.getFullYear(),"-",u,"-",k," ",H==="ko"&&p," ",a,":",r.getMinutes()<10&&"0",r.getMinutes(),H==="en"&&(p==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},f)}),e.jsx("li",{ref:U})]})})})}function Xe({isKeyboardOpen:l,userObj:t,messagesList:g,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:U}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ee,{userObj:t,messagesList:g,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:U})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ee,{userObj:t,messagesList:g,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:U})})})}const Je=Be(He)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Qe(){const l=ae(C=>C.languages.value),t=re(C=>C.piazzaSwitch.value),g=ve(),S=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),g(je("false"))):(window.localStorage.setItem("piazza","true"),g(je("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Je,{onClick:()=>S(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Me={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},et=({displayName:l})=>{const t=ae(C=>C.languages.value),g=t==="ko"||t==="en"?t:"ko",S=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(_e,{icon:e.jsx(Oe,{}),title:S==="piazza"?Me[g][0]:`${Me[g][1]} ${l}`}),S==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Qe,{})})]})};function tt(){const[l,t]=c.useState([]),[g,S]=c.useState(!0),[C,U]=c.useState(!0),[P,I]=c.useState(""),[N,d]=c.useState(null),[$,x]=c.useState(null),b=$e(),E=c.useRef(null),R=c.useRef(null),O={audio:!0,video:!1},L=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:L.map(a=>a.urls)}]}),A=location.search.slice(4);console.log(location.search.slice(4)),c.useEffect(()=>{(async()=>{await v()})()},[]),c.useEffect(()=>{E.current&&(E.current.srcObject=N)},[N]);async function z(){const a=N;a&&a.getAudioTracks().forEach(u=>u.enabled=!u.enabled),S(!g)}async function H(){const a=N;a&&a.getVideoTracks().forEach(u=>u.enabled=!u.enabled),U(!C)}const Y=()=>{E.current.srcObject.getTracks().forEach(a=>a.stop()),console.log(E.current)};async function n(a){if(E.current.srcObject.getTracks().forEach(u=>u.stop()),x(a.target.value),D){console.log(D.getSenders());const u=N.getVideoTracks()[0];D.getSenders().find(T=>T.track.kind==="video").replaceTrack(u)}}c.useEffect(()=>{$&&w($)},[$]);async function v(){try{const u=(await navigator.mediaDevices.enumerateDevices()).filter(k=>k.kind==="videoinput");t(u)}catch(a){console.log(a)}}async function w(a){try{const k=a?{audio:!0,video:{deviceId:{exact:a}}}:O,T=await navigator.mediaDevices.getUserMedia(k);d(T),I("")}catch(u){const k=u==null?void 0:u.toString();k&&I(k),console.log(u)}}function j(a){console.log("icecandidate"),console.log(a),m.emit("ice",a.candidate,A)}function o(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",N),R.current=a.stream}function f(){D.addEventListener("icecandidate",j),D.addEventListener("addstream",o),N&&N.getTracks().forEach(a=>D.addTrack(a,N))}async function s(){await w(null),f()}async function i(){await s(),m.emit("joinRoom",A,s)}c.useEffect(()=>{i()},[]);const r=async()=>{console.log("sent the offer"),console.log(D);const a=await D.createOffer();D.setLocalDescription(a),console.log(a),m.emit("offer",a,A)};c.useEffect(()=>{if(m)return m.on("welcome",r),()=>{m.off("welcome",r)}});const y=async a=>{console.log("received the offer"),D.setRemoteDescription(a);const u=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(u),m.emit("answer",u,A)};c.useEffect(()=>{if(m)return m.on("offer",y),()=>{m.off("offer",y)}});const h=a=>{console.log("received the answer"),D.setRemoteDescription(a)};c.useEffect(()=>{if(m)return m.on("answer",h),()=>{m.off("answer",h)}});const p=a=>{console.log("received candidate"),D.addIceCandidate(a)};return c.useEffect(()=>{if(m)return m.on("ice",p),()=>{m.off("ice",p)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!b&&"flex-col"} gap-1 items-center`,children:[e.jsx("audio",{ref:R,width:"160",height:"120",controls:!0,autoPlay:!0}),e.jsx("audio",{id:"myScreen",ref:E,width:"160",height:"120",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ee,{onClick:z,children:g?"unmute":"mute"}),e.jsx(ee,{onClick:H,children:C?"turn stream on":"turn stream off"}),e.jsx(ee,{onClick:Y,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:n,children:l.map((a,u)=>e.jsx("option",{value:a.deviceId,children:a.label},u))})]}),P&&e.jsx("div",{children:P})]})}let Q,V;function st(){const[l,t]=c.useState([]),[g,S]=c.useState(!0),[C,U]=c.useState(!0),[P,I]=c.useState(""),N=c.useRef(null),d=c.useRef(null),$=$e(),x={audio:!0,video:!0},b=location.search.slice(4);async function E(){const s=Q;s&&s.getAudioTracks().forEach(i=>i.enabled=!i.enabled),S(!g)}async function R(){const s=Q;s&&s.getVideoTracks().forEach(i=>i.enabled=!i.enabled),U(!C)}const O=()=>{N.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(N.current)};async function L(s){if(console.log(s.target.value),N.current.srcObject.getTracks().forEach(i=>i.stop()),await A(s.target.value),V){console.log(V.getSenders());const i=Q.getVideoTracks()[0];V.getSenders().find(y=>y.track.kind==="video").replaceTrack(i)}}async function D(){try{const i=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");t(i)}catch(s){console.log(s)}}async function A(s){try{const r=s?{audio:!0,video:{deviceId:{exact:s}}}:x;Q=await navigator.mediaDevices.getUserMedia(r),N.current.srcObject=Q,await D(),I("")}catch(i){console.log(i);const r=i==null?void 0:i.toString();r&&I(r)}}function z(s){console.log("icecandidate"),console.log(s),m.emit("ice",s.candidate,b)}function H(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",Q),d.current.srcObject=s.stream}function Y(){const s=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];V=new RTCPeerConnection({iceServers:[{urls:s.map(i=>i.urls)}]}),V.addEventListener("icecandidate",z),V.addEventListener("addstream",H),Q&&Q.getTracks().forEach(i=>V.addTrack(i,Q))}async function n(){await A(null),Y()}async function v(){await n(),m.emit("joinRoom",b,n)}c.useEffect(()=>{v()},[]);const w=async()=>{const s=await V.createOffer();V.setLocalDescription(s),m.emit("offer",s,b),console.log(s),console.log("sent the offer")};c.useEffect(()=>{if(m)return m.on("welcome",w),()=>{m.off("welcome",w)}});const j=async s=>{V.setRemoteDescription(s),console.log("received the offer");const i=await V.createAnswer();V.setLocalDescription(i),m.emit("answer",i,b),console.log("sent the answer")};c.useEffect(()=>{if(m)return m.on("offer",j),()=>{m.off("offer",j)}});const o=s=>{V.setRemoteDescription(s),console.log("received the answer")};c.useEffect(()=>{if(m)return m.on("answer",o),()=>{m.off("answer",o)}});const f=s=>{V.addIceCandidate(s),console.log("received candidate")};return c.useEffect(()=>{if(m)return m.on("ice",f),()=>{m.off("ice",f)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!$&&"flex-col"} gap-1 items-center`,children:[e.jsx("video",{ref:d,width:"160",height:"120",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:N,width:"160",height:"120",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ee,{onClick:E,children:g?"unmute":"mute"}),e.jsx(ee,{onClick:R,children:C?"turn stream on":"turn stream off"}),e.jsx(ee,{onClick:O,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:L,children:l.map((s,i)=>e.jsx("option",{value:s.deviceId,children:s.label},i))})]}),P&&e.jsx("div",{children:P})]})}function nt({userObj:l}){const[t,g]=c.useState(""),[S,C]=c.useState([]),U=ve(),{state:P}=Re(),[I,N]=c.useState(!1),[d,$]=c.useState(null),[x,b]=c.useState(""),[E,R]=c.useState(""),[O,L]=Ue(),D=n=>{b(n)},A=n=>{R(n)},z=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(x),c.useEffect(()=>{P?(b(P.chattingUid),R(P.displayName)):(b(""),R(""))},[z]),c.useEffect(()=>{z&&(async()=>{if(x){const v=F(M,`members/${x}`),w=await B(v);$(w.data())}})()},[z,x]);const H=re(n=>n.piazzaForm.value);c.useEffect(()=>{var v;const n=()=>{var j;const w=window.screen.height-300>(((j=window.visualViewport)==null?void 0:j.height)||window.screen.height);I!==w&&N(w)};return window.addEventListener("resize",n),typeof visualViewport<"u"&&((v=window.visualViewport)==null||v.addEventListener("resize",n)),visualViewport==null||visualViewport.addEventListener("resize",n),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",n)),()=>{var w;typeof visualViewport<"u"&&((w=window.visualViewport)==null||w.removeEventListener("resize",n))}},[I]);const Y=async()=>{var f,s,i;L(r=>(r.delete("call"),r)),(f=document.getElementById("myScreen"))==null||f.srcObject.getTracks().forEach(r=>r.stop());let n,v,w,j;d&&(n=F(M,`members/${d.uid}`),v=await B(n),w=(s=v.data())==null?void 0:s.messagingToken,j=(i=v.data())==null?void 0:i.preferLanguage);const o={conversation:z,isVideo:!0,sendingToken:w,connectedUrl:`/piazza?id=${z}&call=video`,preferLanguage:j,userUid:l.uid,id:l.displayName,conversationUid:d==null?void 0:d.uid,conversationName:d==null?void 0:d.displayName};console.log(o),m.emit("quitCall",o)};return c.useEffect(()=>{U(Ye(5))}),c.useEffect(()=>{var n,v;O.get("call")==="video"&&((n=document.getElementById("videoCall"))==null||n.click()),O.get("call")==="audio"&&((v=document.getElementById("audioCall"))==null||v.click())},[]),e.jsxs(e.Fragment,{children:[!I&&e.jsx(et,{multiple:!z,displayName:E}),e.jsx(Xe,{isKeyboardOpen:H,userObj:l,messagesList:S,handleMessagesList:n=>C(n),handleChatUid:D,handleChatDisplayName:A}),e.jsx(Ze,{chattingUser:d,userObj:l,multiple:!z,messages:t,handleMessages:n=>g(n),messagesList:S,handleMessagesList:n=>C(n)}),e.jsxs(Ne,{children:[e.jsx(De,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(Ie,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(st,{})}),e.jsx(be,{children:e.jsx("div",{onClick:Y,children:"전화 종료"})})]})})]}),e.jsxs(Ne,{children:[e.jsx(De,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(Ie,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(tt,{})}),e.jsx(be,{children:e.jsx("div",{onClick:Y,children:"전화 종료"})})]})})]})]})}export{nt as default};
