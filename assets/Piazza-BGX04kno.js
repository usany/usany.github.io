import{r as u,j as a,aP as K,a3 as te,a1 as Y,b2 as O,W as _,O as y,U as W,a8 as X,V as G,X as J,N as j,a5 as R,Q as H,bf as se,a2 as ee,aS as ie,bs as le,v as ce,bt as re,a4 as oe,al as de}from"./index-COLYf---.js";import{i as ge,j as me,k as fe,l as pe,B as ne,q as he}from"./index-C3yF1GEO.js";import{D as ue,w as I}from"./DrawersBar-CaBr7B-h.js";import{P as xe}from"./PageTitle-BVKjFaVA.js";const we=({multiple:s,handleMultiple:U,user:e,userObj:o,handleMessagesList:D,displayedName:S})=>{const[h,N]=u.useState(null);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<o.uid?N((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+o.uid[0]+o.uid[1]+o.uid[2]+o.uid[3]+o.uid[4]+o.uid[5]):N(o.uid[0]+o.uid[1]+o.uid[2]+o.uid[3]+o.uid[4]+o.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsx("div",{children:a.jsxs(ge,{children:[a.jsx(me,{children:a.jsx("div",{id:"drawer"})}),a.jsx(fe,{className:"bg-light-3 dark:bg-dark-3",children:a.jsxs(pe,{className:"overflow-y-scroll",children:[a.jsx(ue,{}),a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(K,{profile:!1,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==S&&a.jsxs("div",{children:["(",S,"에서 개명)"]})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(te,{to:"/profile",state:{element:e},children:a.jsx(ne,{variant:"outlined",onClick:()=>{},children:"프로필 확인"})}),s&&o.uid!==(e==null?void 0:e.uid)&&a.jsx(te,{to:"/piazza",state:{conversation:h,displayName:e==null?void 0:e.displayName,userUid:o.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(he,{children:a.jsx(ne,{variant:"outlined",onClick:()=>{D([]),U(!1)},children:"개인 대화"})})})]})]})})]})})};function ye({userObj:s,multiple:U,handleMultiple:e,messagesList:o,handleMessagesList:D}){const S=u.useRef(null),h=u.useRef(null),[N,F]=u.useState(null),[d,f]=u.useState(""),[$,A]=u.useState(!1),[E,Z]=u.useState(null),Q=Y(t=>t.profileColor.value),g=Y(t=>t.profileUrl.value),{state:C}=O(),v=C==null?void 0:C.conversation,M=async({userUid:t,displayName:i})=>{const l=j(y,`members/${t}`),p=(await R(l)).data();F(p),f(i)},k=({userUid:t,displayName:i})=>{var l;(l=document.getElementById("drawer"))==null||l.click(),M({userUid:t,displayName:i})},z=10;u.useEffect(()=>{if(!I)return;function t(i){const{msg:l,userUid:n,id:p,target:m,messageClock:c,messageClockNumber:r,conversation:x}=i;D(w=>[...w,{msg:l,type:m?"private":"other",userUid:n,id:p,messageClock:c,messageClockNumber:r,conversation:null,profileImageUrl:g,profileColor:Q}])}return I.on("sMessagePiazza",t),()=>{I.off("sMessagePiazza",t)}},[]),u.useEffect(()=>{if(!I)return;function t(i){const{msg:l,userUid:n,id:p,target:m,messageClock:c,messageClockNumber:r,conversation:x}=i;D(w=>[...w,{msg:l,type:m?"private":"other",userUid:n,id:p,messageClock:c,messageClockNumber:r,conversation:null}])}return I.on(`sMessage${v}`,t),()=>{I.off(`sMessage${v}`,t)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{P(),(async()=>{if(U){const i=_(y,"chats_group"),l=W(i,G("messageClockNumber","desc"),X(1));(await J(l)).forEach(async p=>{const m=j(y,`chats_group/${p.id}`),r=(await R(m)).data(),x=r.piazzaChecked||[];x.indexOf(s.uid)===-1&&(x.splice(-1,s.uid,0),x.push(s.uid),await H(m,{...r,piazzaChecked:x}))})}else{const i=j(y,`members/${s.uid}`),n=(await R(i)).data().chattings;n[v].messageCount=0,await H(i,{chattings:n})}})()},[o]);const P=()=>{var t;(t=S.current)==null||t.scrollIntoView()};console.log(E==null?void 0:E.data()),u.useEffect(()=>{const t=async()=>{const l=[],n=_(y,"chats_group"),p=W(n,G("messageClockNumber","desc"),X(z),se(E||""));(await J(p)).forEach(c=>{var q,ae;l.length===z-1&&Z(c);const r=c.data().message,x=c.data().userUid,w=c.data().userName,B=c.data().messageClock,V=c.data().messageClockNumber,T=(q=c.data())==null?void 0:q.profileColor,L=(ae=c.data())==null?void 0:ae.profileImageUrl;l.push({msg:r,type:"me",userUid:x,id:w,messageClockNumber:V,messageClock:B,conversation:null,profileColor:T,profileImageUrl:L})}),l.reverse(),D([...l,...o]),A(!1)},i=async l=>{const n=_(y,`chats_${l}`),p=W(n,G("messageClockNumber","desc"),X(z),se(E||"")),m=await J(p),c=[];m.forEach((r,x)=>{const w=r.data().message,B=r.data().userUid,V=r.data().userName,T=r.data().messageClock,L=r.data().messageClockNumber||0;c.push({msg:w,type:"me",userUid:B,id:V,messageClock:T,messageClockNumber:L})}),c.reverse(),D(c),A(!1)};U?($||!o.length)&&t():($||!o.length)&&i(v)},[$]);const b=()=>{h.current.scrollTop!==0||$||(console.log("scroll"),A(!0))};return u.useEffect(()=>{var t;return(t=h.current)==null||t.addEventListener("scroll",b),()=>{var i;return(i=h.current)==null?void 0:i.removeEventListener("scroll",b)}},[$]),a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-col pt-5",children:a.jsx("div",{ref:h,className:"p-1 border-t rounded-xl max-h-[60vh] overflow-auto",children:a.jsxs("ul",{children:[$&&a.jsx("div",{children:"loading"}),o.map((t,i)=>{let l;const n=new Date(t.messageClock);t.userUid===s.uid?l="text-right":l="text-left";let p,m;i>0&&(p=o[i-1].userUid),i<o.length-1&&o[i+1].userUid===s.uid&&(m=new Date(o[i+1].messageClock),n.getFullYear()===m.getFullYear()&&n.getMonth()===m.getMonth()&&n.getDate()===m.getDate()&&n.getHours()===m.getHours()&&(n.getMinutes(),m.getMinutes()));let c,r=n.getHours(),x=(n.getMonth()+1).toString(),w=n.getDate().toString();return r>=13?(c="오후",r!==12&&(r=r-12)):(c="오전",r===0&&(r=r+12)),n.getMonth()+1<10&&(x="0"+x),w.length===1&&(w="0"+w),a.jsxs("li",{ref:i===z-1?S:null,className:l,children:[p!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==s.uid?"start":"end"}`,children:l==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(K,{profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:()=>k({userUid:t.userUid,displayName:t.id})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(K,{profile:!1,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:()=>k({userUid:t.userUid,displayName:t.id})})]})})}),t.userUid!==s.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[n.getFullYear(),"-",x,"-",w," ",c," ",r,":",n.getMinutes()<10&&"0",n.getMinutes()]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[n.getFullYear(),"-",x,"-",w," ",c," ",r,":",n.getMinutes()<10&&"0",n.getMinutes()]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},i)}),a.jsx("li",{ref:S})]})})}),a.jsx(we,{multiple:U,handleMultiple:e,user:N,userObj:s,handleMessagesList:D,displayedName:d})]})}function Ue({userObj:s,multiple:U,messages:e,handleMessages:o,messagesList:D,handleMessagesList:S}){const h=Y(g=>g.profileColor.value),N=Y(g=>g.profileUrl.value),F=ee(),{state:d}=O(),f=d==null?void 0:d.conversation,$=async g=>{var l;g.preventDefault();const C=e,v=s.uid,M=s.displayName,k=Date.now(),z=new Date().toString();let P,b,t;d.chattingUid&&(P=j(y,`members/${d.chattingUid}`),b=await R(P),t=(l=b.data())==null?void 0:l.messagingToken);const i={msg:C,userUid:v,id:M,messageClockNumber:k,messageClock:z,conversation:f,conversationUid:d.chattingUid,conversationName:d.displayName,profileUrl:N,sendingToken:t};U?i&&C&&(I.emit("piazzaMessage",i),E()):C&&(D.length!==0?(I.emit("message",i),console.log("message")):(I.emit("messageNew",i),console.log("messageNew")),Z(),Q()),o("")},A=g=>{o(g.target.value)},E=async()=>{try{const g=e,C=s.uid,v=s.displayName,M=new Date().toString(),k=Date.now();g&&(await ie(_(y,"chats_group"),{userUid:C,userName:v,message:g,messageClock:M,messageClockNumber:k,profileImageUrl:N,profileColor:h,piazzaChecked:[s.uid]}),S(z=>[...z,{msg:g,type:"me",userUid:s.uid,id:s.displayName,messageClock:M,conversation:null,profileImageUrl:N,profileColor:h}]))}catch(g){console.log(g)}},Z=async()=>{var C,v,M;const g=e;try{const k=s.uid,z=s.displayName,P=Date.now(),b=new Date().toString();let t,i,l,n,p,m;if(d.userUid<d.chattingUid?(t=d.userUid,i=d.chattingUid,l=s.displayName,n=d.displayName,p=N,m=d.profileUrl):(t=d.chattingUid,i=d.userUid,l=d.displayName,n=s.displayName,p=d.profileUrl,m=N),!p){const c=j(y,`members/${t}`);p=(C=(await R(c)).data())==null?void 0:C.profileImageUrl}if(!m){const c=j(y,`members/${i}`);m=(v=(await R(c)).data())==null?void 0:v.profileImageUrl}if(g){const c={userUid:k,userName:z,message:g,messageClock:b,messageClockNumber:P,userOne:t,userTwo:i,userOneDisplayName:l,userTwoDisplayName:n,userOneProfileUrl:p,userTwoProfileUrl:m};await ie(_(y,`chats_${f}`),c);const r=j(y,`members/${k}`),w=(await R(r)).data().chattings||{},B=j(y,`members/${d.chattingUid}`),T=(await R(B)).data().chattings||{},L=((M=T[f])==null?void 0:M.messageCount)||0;w[f]=c,T[f]={...c,messageCount:L+1},await H(r,{chattings:w}),await H(B,{chattings:T}),S(q=>[...q,{msg:g,type:"me",userUid:s.uid,id:s.displayName,messageClock:b,conversation:f}])}}catch(k){console.log(k)}},Q=async()=>{try{const g=s.uid,C=d.chattingUid,v=j(y,`members/${g}`),k=(await R(v)).data().conversation||[],z=j(y,`members/${C}`),b=(await R(z)).data().conversation||[];k.indexOf(f)===-1&&(await H(v,{conversation:[...k,f]}),F(le())),b.indexOf(f)===-1&&await H(z,{conversation:[...b,f]})}catch(g){console.log(g)}};return a.jsx(a.Fragment,{children:a.jsxs("form",{className:"flex gap-px",onSubmit:$,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:A,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})})}const Ne=ce(re)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ce(){const s=Y(o=>o.piazzaSwitch.value),U=ee(),e=()=>{s==="true"?(window.localStorage.setItem("piazza","false"),U(oe("false"))):(window.localStorage.setItem("piazza","true"),U(oe("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Ne,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:s==="true"})})]})}const ve=({multiple:s,displayName:U})=>a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(xe,{title:s?"단체 대화":`개인 대화 ${U}`}),s&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx(Ce,{})})]});function be({userObj:s}){const[U,e]=u.useState(""),[o,D]=u.useState([]),S=ee(),{state:h}=O(),[N,F]=u.useState(!0);u.useEffect(()=>{(h==null?void 0:h.multiple)!==void 0&&F(h==null?void 0:h.multiple)},[]),u.useEffect(()=>{S(de(5))});const d=h==null?void 0:h.displayName;return a.jsxs(a.Fragment,{children:[a.jsx(ve,{multiple:N,displayName:d}),a.jsx(ye,{userObj:s,multiple:N,handleMultiple:f=>F(f),messagesList:o,handleMessagesList:f=>D(f)}),a.jsx(Ue,{userObj:s,multiple:N,messages:U,handleMessages:f=>e(f),messagesList:o,handleMessagesList:f=>D(f)})]})}export{be as default};
