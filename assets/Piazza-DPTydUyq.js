import{b2 as je,u as ie,c as O,O as he,j as t,P as me,Y as le,b1 as ue,X as xe,b3 as ve,aX as Ie,v as H,m as M,I as _,$ as w,a_ as we,l as ee,C as W,b4 as Pe,aV as be,r as l,N as pe,B as te,b5 as ye,q as re,Z as de,_ as ge,n as fe,aY as ke,s as Ue,S as Me,Q as Ce,D as Ee,b6 as Te,aJ as Re,aa as $e,b7 as Ve,b8 as Fe,b9 as Ae,ba as Le}from"./index-2iPKFHFy.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=je("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=je("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),_e={ko:"메세지를 작성해 주세요",en:"Input message"},Ye={ko:"전송",en:"send"};function qe({chattingUser:n,userObj:e,multiple:c,messages:C,handleMessages:y,messagesList:I,handleMessagesList:P}){const E=ie(s=>s.profileColor.value),z=ie(s=>s.piazzaForm.value),g=O(s=>s.profile.value),V=he(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",B=O(s=>s.languages.value),b=B==="ko"||B==="en"?B:"ko",A=async s=>{var i;s.preventDefault();const k=C,N=e.uid,U=e.displayName,j=Date.now(),T=new Date().toString(),F=g==null?void 0:g.profileImageUrl,o=g==null?void 0:g.defaultProfile,u=g==null?void 0:g.profileImage;let m,h,f;n&&(m=H(M,`members/${n.uid}`),h=await _(m),f=(i=h.data())==null?void 0:i.messagingToken);const p=g.profileImage?g.profileImageUrl:g.defaultProfile;console.log(g);const d={msg:k,userUid:N,id:U,messageClockNumber:j,messageClock:T,conversation:v,conversationUid:n==null?void 0:n.uid,conversationName:n==null?void 0:n.displayName,profileImage:u,defaultProfile:o,profileImageUrl:F,profileUrl:p,sendingToken:f};c?d&&k&&(w.emit("piazzaMessage",d),R()):k&&(I.length!==0?(w.emit("message",d),console.log("message")):(w.emit("messageNew",d),console.log("messageNew")),S(),Y()),y("")},J=s=>{y(s.target.value)},R=async()=>{try{const s=C,k=e.uid,N=e.displayName,U=new Date().toString(),j=Date.now(),T=g==null?void 0:g.profileImageUrl,F=g==null?void 0:g.defaultProfile,o=g==null?void 0:g.profileImage;s&&(await we(ee(M,"chats_group"),{userUid:k,userName:N,message:s,messageClock:U,messageClockNumber:j,profileImageUrl:T,defaultProfile:F,profileColor:E,piazzaChecked:[e.uid],profileImage:o}),P(u=>[...u,{msg:s,type:"me",userUid:e.uid,id:e.displayName,messageClock:U,conversation:null,profileColor:E,messageClockNumber:j,defaultProfile:F,profileImageUrl:T,profileImage:o||!1}]))}catch(s){console.log(s)}},S=async()=>{var k,N,U;const s=C;try{const j=e.uid,T=e.displayName,F=Date.now(),o=new Date().toString(),u=g.profileImage,m=n.profileImage,h=g.profileImageUrl,f=n.profileImageUrl,p=g.defaultProfile,d=n.defaultProfile;let i,a,r,x,D,$,q,G,X,Z;if(e.uid<n.uid?(i=e.uid,a=n.uid,r=e.displayName,x=n.displayName,D=h,$=f,q=p,G=d,X=g.profileImage,Z=n.profileImage):(i=n.uid,a=e.uid,r=n.displayName,x=e.displayName,D=f,$=h,q=d,G=p,X=n.profileImage,Z=g.profileImage),!D){const L=H(M,`members/${i}`);D=(k=(await _(L)).data())==null?void 0:k.profileImageUrl}if(!$){const L=H(M,`members/${a}`);$=(N=(await _(L)).data())==null?void 0:N.profileImageUrl}if(s){const L={userUid:j,userName:T,message:s,messageClock:o,messageClockNumber:F,userOne:i,userTwo:a,userOneDisplayName:r,userTwoDisplayName:x,userOneProfileUrl:D,userTwoProfileUrl:$,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:Z};await we(ee(M,`chats_${v}`),L);const K=H(M,`members/${j}`),ae=(await _(K)).data().chattings||{},oe=H(M,`members/${n.uid}`),Q=(await _(oe)).data().chattings||{},ne=((U=Q[v])==null?void 0:U.messageCount)||0;ae[v]=L,Q[v]={...L,messageCount:ne+1},await W(K,{chattings:ae}),await W(oe,{chattings:Q}),P(De=>[...De,{msg:s,type:"me",userUid:e.uid,id:e.displayName,messageClock:o,conversation:v,userName:T,messageClockNumber:F,userOne:i,userTwo:a,userOneDisplayName:r,userTwoDisplayName:x,userOneProfileUrl:D,userTwoProfileUrl:$,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:Z}])}}catch(j){console.log(j)}},Y=async()=>{try{const s=e.uid,k=n.uid,N=H(M,`members/${s}`),j=(await _(N)).data().conversation||[],T=H(M,`members/${k}`),o=(await _(T)).data().conversation||[];j.indexOf(v)===-1&&(await W(N,{conversation:[...j,v]}),V(Pe())),o.indexOf(v)===-1&&await W(T,{conversation:[...o,v]})}catch(s){console.log(s)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:`fixed w-screen ${z?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:A,children:[v&&v!=="piazza"&&t.jsx(me,{trigger:t.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:t.jsx(He,{})}),title:t.jsx("div",{children:"전화 선택"}),content:t.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[t.jsx(le,{to:`/piazza?id=${v}?calls=video`,children:t.jsx(ue,{children:t.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:t.jsx(ve,{children:t.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var s;(s=document.getElementById("calls"))==null||s.click()},children:[t.jsx(Ie,{}),t.jsx("div",{children:"화상 전화"})]})})})})}),t.jsx(le,{to:`/piazza?id=${v}?calls=audio`,children:t.jsx(ue,{children:t.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:t.jsx(ve,{children:t.jsxs("div",{className:"flex flex-col items-center gap-5",children:[t.jsx(Be,{}),t.jsx("div",{children:"음성 전화"})]})})})})})]})}),t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:_e[b],onChange:J,value:C,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ye[b]})]})})}const ze=({initiateContinuing:n,user:e,userObj:c,handleMessagesList:C,displayedName:y})=>{const{state:I}=be(),P=(I==null?void 0:I.conversation)||"piazza",E=O(V=>V.languages.value),[z,g]=l.useState("");return l.useEffect(()=>{e&&((e==null?void 0:e.uid)<c.uid?g((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+c.uid[0]+c.uid[1]+c.uid[2]+c.uid[3]+c.uid[4]+c.uid[5]):g(c.uid[0]+c.uid[1]+c.uid[2]+c.uid[3]+c.uid[4]+c.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(pe,{element:e,uid:c.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==y&&t.jsx("div",{children:E==="ko"?t.jsxs("div",{children:["(",y,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:`/profile?id=${e==null?void 0:e.uid}`,state:{element:e},children:t.jsx(te,{variant:"outlined",onClick:()=>{},children:E==="ko"?"프로필 확인":"Check Profile"})}),P==="piazza"&&c.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:`${location.pathname}?id=${z}`,state:{conversation:z,displayName:e==null?void 0:e.displayName,userUid:c.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ue,{children:t.jsx(te,{variant:"outlined",onClick:()=>{C([]),n()},children:E==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:n,messagesList:e,handleMessagesList:c,handleChatUid:C,handleChatDisplayName:y}){const I=l.useRef(null),P=l.useRef(null),[E,z]=l.useState(null),[g,V]=l.useState(""),[v,B]=l.useState(!1),[b,A]=l.useState(null),[J,R]=l.useState(0),[S,Y]=l.useState("piazza"),s=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";l.useEffect(()=>{S!==s&&(c([]),A(null),R(0),Y(s))},[s]);const k=O(o=>o.languages.value),N=async({userUid:o,displayName:u})=>{const m=H(M,`members/${o}`),f=(await _(m)).data();z(f),V(u),console.log("practice")},U=({userUid:o,displayName:u})=>{var m;(m=document.getElementById("drawer"))==null||m.click(),N({userUid:o,displayName:u})},j=20;l.useEffect(()=>{if(!w)return;function o(u){const{msg:m,userUid:h,id:f,target:p,messageClock:d,messageClockNumber:i,profileImageUrl:a,defaultProfile:r,profileImage:x,conversation:D}=u;c($=>[...$,{msg:m,type:p?"private":"other",userUid:h,id:f,messageClock:d,messageClockNumber:i,conversation:null,profileImageUrl:a,defaultProfile:r,profileImage:x}])}return w.on("sMessagePiazza",o),()=>{w.off("sMessagePiazza",o)}},[]),l.useEffect(()=>{if(!w)return;function o(u){const{msg:m,userUid:h,id:f,target:p,messageClock:d,messageClockNumber:i,conversation:a,profileImageUrl:r,defaultProfile:x,profileImage:D,piazzaData:$}=u;c(q=>[...q,{msg:m,type:p?"private":"other",userUid:h,id:f,messageClock:d,messageClockNumber:i,conversation:null,profileImageUrl:r,defaultProfile:x,profileImage:D,...$}])}return w.on(`sMessage${s}`,o),()=>{w.off(`sMessage${s}`,o)}},[s]),l.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),l.useEffect(()=>{T(),(async()=>{if(s==="piazza"){const u=ee(M,"chats_group"),m=re(u,ge("messageClockNumber","desc"),de(1));(await fe(m)).forEach(async f=>{const p=H(M,`chats_group/${f.id}`),i=(await _(p)).data(),a=i.piazzaChecked||[];a.indexOf(n.uid)===-1&&(a.splice(-1,n.uid,0),a.push(n.uid),await W(p,{...i,piazzaChecked:a}))})}else{const u=H(M,`members/${n.uid}`),h=(await _(u)).data().chattings;h[s]&&(h[s].messageCount=0),await W(u,{chattings:h})}})()},[e]);const T=()=>{var o;(o=I.current)==null||o.scrollIntoView()};l.useEffect(()=>{const o=async()=>{const m=[],h=ee(M,"chats_group"),f=re(h,ge("messageClockNumber","desc"),de(j),ke(b||"")),p=await fe(f);p.docs.length||R(p.docs.length),p.forEach(d=>{var Z,L,K;m.length===p.docs.length-1&&(A(d),R(p.docs.length-1));const i=d.data().message,a=d.data().userUid,r=d.data().userName,x=d.data().messageClock,D=d.data().messageClockNumber,$=(Z=d.data())==null?void 0:Z.profileImageUrl,q=(L=d.data())==null?void 0:L.defaultProfile,G=(K=d.data())==null?void 0:K.profileImage,X=d.data();m.push({msg:i,userUid:a,id:r,messageClockNumber:D,messageClock:x,conversation:null,profileImageUrl:$,defaultProfile:q,profileImage:G||!1,...X})}),c([...m,...e]),B(!1)},u=async m=>{const h=ee(M,`chats_${m}`),f=re(h,ge("messageClockNumber","desc"),de(j),ke(b||"")),p=await fe(f),d=[];p.docs.length||R(p.docs.length),p.forEach((i,a)=>{var ce,Q,ne;d.length===p.docs.length-1&&(A(i),R(p.docs.length-1));const r=i.data().message,x=i.data().userUid,D=i.data().userName,$=i.data().messageClock,q=i.data().messageClockNumber||0,G=(ce=i.data())==null?void 0:ce.profileImageUrl,X=(Q=i.data())==null?void 0:Q.defaultProfile,Z=(ne=i.data())==null?void 0:ne.profileImage,L=i.data(),K=i.data().userOne,se=i.data().userOneDisplayName,ae=i.data().userTwo,oe=i.data().userTwoDisplayName;K!==n.uid?(C(K),y(se)):(C(ae),y(oe)),d.push({msg:r,userUid:x,id:D,messageClockNumber:q,messageClock:$,conversation:null,profileImageUrl:G,defaultProfile:X,profileImage:Z||!1,...L})}),d.reverse(),c([...d,...e]),B(!1)};s==="piazza"?(v||!e.length)&&o():(v||!e.length)&&u(s)},[v,s]);const F=()=>{P.current.scrollTop!==0||v||(console.log("scroll"),B(!0))};return l.useEffect(()=>{var o;return(o=P.current)==null||o.addEventListener("scroll",F),()=>{var u;return(u=P.current)==null?void 0:u.removeEventListener("scroll",F)}},[v]),console.log(s),console.log(e),console.log(E),t.jsx(t.Fragment,{children:t.jsx("div",{ref:P,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[v&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((o,u)=>{let m;s==="piazza"?m=o:o.userUid===o.userOne?m={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:m={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let h;const f=new Date(o.messageClock);o.userUid===n.uid?h="text-right":h="text-left";let p,d;u>0&&(p=e[u-1].userUid),u<e.length-1&&e[u+1].userUid===n.uid&&(d=new Date(e[u+1].messageClock),f.getFullYear()===d.getFullYear()&&f.getMonth()===d.getMonth()&&f.getDate()===d.getDate()&&f.getHours()===d.getHours()&&(f.getMinutes(),d.getMinutes()));let i,a=f.getHours(),r=(f.getMonth()+1).toString(),x=f.getDate().toString();return a>=13?(i="오후",a!==12&&(a=a-12)):(i="오전",a===0&&(a=a+12)),f.getMonth()+1<10&&(r="0"+r),x.length===1&&(x="0"+x),t.jsxs("li",{ref:u===J?I:null,className:h,children:[p!==o.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${o.userUid!==n.uid?"start":"end"}`,children:h==="text-left"?t.jsxs("div",{className:"flex gap-3 pt-3",children:[t.jsx(me,{trigger:t.jsx(pe,{element:m,piazza:()=>U({userUid:m.userUid,displayName:m.id}),profile:!1}),title:t.jsx(ye,{}),content:t.jsx(ze,{initiateContinuing:()=>A(null),user:E,userObj:n,handleMessagesList:c,displayedName:g})}),t.jsx("div",{children:o.id})]}):t.jsxs("div",{className:"flex gap-3 pt-3",children:[t.jsx("div",{children:o.id}),t.jsx(me,{trigger:t.jsx(pe,{element:m,piazza:()=>U({userUid:m.userUid,displayName:m.id}),profile:!1}),title:t.jsx(ye,{}),content:t.jsx(ze,{initiateContinuing:()=>A(null),user:E,userObj:n,handleMessagesList:c,displayedName:g})})]})})}),o.userUid!==n.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),t.jsxs("div",{children:[f.getFullYear(),"-",r,"-",x," ",k==="ko"&&i," ",a,":",f.getMinutes()<10&&"0",f.getMinutes(),k==="en"&&(i==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[f.getFullYear(),"-",r,"-",x," ",k==="ko"&&i," ",a,":",f.getMinutes()<10&&"0",f.getMinutes(),k==="en"&&(i==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},u)}),t.jsx("li",{ref:I})]})})})}function Ke({isKeyboardOpen:n,userObj:e,messagesList:c,handleMessagesList:C,handleChatUid:y,handleChatDisplayName:I}){return t.jsx(t.Fragment,{children:n?t.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:t.jsx(Ne,{userObj:e,messagesList:c,handleMessagesList:C,handleChatUid:y,handleChatDisplayName:I})}):t.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:t.jsx(Ne,{userObj:e,messagesList:c,handleMessagesList:C,handleChatUid:y,handleChatDisplayName:I})})})}const Ze=Ue(Me)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ge(){const n=O(y=>y.languages.value),e=ie(y=>y.piazzaSwitch.value),c=he(),C=()=>{e==="true"?(window.localStorage.setItem("piazza","false"),c(Ce("false"))):(window.localStorage.setItem("piazza","true"),c(Ce("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Ze,{onClick:()=>C(),inputProps:{"aria-label":"ant design"},checked:e==="true"})})]})}const Se={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:n})=>{const e=O(y=>y.languages.value),c=e==="ko"||e==="en"?e:"ko",C=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(Ee,{icon:t.jsx(Te,{}),title:C==="piazza"?Se[c][0]:`${Se[c][1]} ${n}`}),C==="piazza"&&t.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:t.jsx(Ge,{})})]})};function Je(){const[n,e]=l.useState([]),[c,C]=l.useState(!0),[y,I]=l.useState(!0),[P,E]=l.useState(""),[z,g]=l.useState(null),[V,v]=l.useState(null),B=Re(),b=l.useRef(null),A=l.useRef(null),J={audio:!0,video:!0},R=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],S=new RTCPeerConnection({iceServers:[{urls:R.map(a=>a.urls)}]}),Y=location.search.slice(4);console.log(location.search.slice(4)),l.useEffect(()=>{(async()=>{await j()})()},[]),l.useEffect(()=>{b.current&&(b.current.srcObject=z)},[z]);async function s(){const a=z;a&&a.getAudioTracks().forEach(r=>r.enabled=!r.enabled),C(!c)}async function k(){const a=z;a&&a.getVideoTracks().forEach(r=>r.enabled=!r.enabled),I(!y)}const N=()=>{b.current.srcObject.getTracks().forEach(a=>a.stop()),console.log(b.current)};async function U(a){if(b.current.srcObject.getTracks().forEach(r=>r.stop()),v(a.target.value),S){console.log(S.getSenders());const r=z.getVideoTracks()[0];S.getSenders().find(D=>D.track.kind==="video").replaceTrack(r)}}l.useEffect(()=>{V&&T(V)},[V]);async function j(){try{const r=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput");e(r)}catch(a){console.log(a)}}async function T(a){try{const x=a?{audio:!0,video:{deviceId:{exact:a}}}:J,D=await navigator.mediaDevices.getUserMedia(x);g(D),E("")}catch(r){const x=r==null?void 0:r.toString();x&&E(x),console.log(r)}}function F(a){console.log("icecandidate"),console.log(a),w.emit("ice",a.candidate,Y)}function o(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",z),A.current=a.stream}function u(){S.addEventListener("icecandidate",F),S.addEventListener("addstream",o),z&&z.getTracks().forEach(a=>S.addTrack(a,z))}async function m(){await T(null),u()}async function h(){await m(),w.emit("joinRoom",Y,m)}l.useEffect(()=>{h()},[]);const f=async()=>{console.log("sent the offer"),console.log(S);const a=await S.createOffer();S.setLocalDescription(a),console.log(a),w.emit("offer",a,Y)};l.useEffect(()=>{if(w)return w.on("welcome",f),()=>{w.off("welcome",f)}});const p=async a=>{console.log("received the offer"),S.setRemoteDescription(a);const r=await S.createAnswer();console.log("sent the answer"),S.setLocalDescription(r),w.emit("answer",r,Y)};l.useEffect(()=>{if(w)return w.on("offer",p),()=>{w.off("offer",p)}});const d=a=>{console.log("received the answer"),S.setRemoteDescription(a)};l.useEffect(()=>{if(w)return w.on("answer",d),()=>{w.off("answer",d)}});const i=a=>{console.log("received candidate"),S.addIceCandidate(a)};return l.useEffect(()=>{if(w)return w.on("ice",i),()=>{w.off("ice",i)}}),t.jsxs("div",{children:[t.jsxs("div",{className:`flex ${!B&&"flex-col"} gap-1`,children:[t.jsx("video",{ref:A,width:"320",height:"240",controls:!0,autoPlay:!0}),t.jsx("video",{id:"myScreen",ref:b,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex gap-5",children:[t.jsx(te,{onClick:s,children:c?"unmute":"mute"}),t.jsx(te,{onClick:k,children:y?"turn stream on":"turn stream off"}),t.jsx(te,{onClick:N,children:"stop"})]}),t.jsx("select",{id:"devices",onChange:U,children:n.map((a,r)=>t.jsx("option",{value:a.deviceId,selected:(z==null?void 0:z.getVideoTracks()[0].id)===a.deviceId,children:a.label},r))})]}),P&&t.jsx("div",{children:P})]})}function We({userObj:n}){const[e,c]=l.useState(""),[C,y]=l.useState([]),I=he(),[P,E]=l.useState(!1),[z,g]=l.useState(null),[V,v]=l.useState(""),[B,b]=l.useState(""),A=s=>{v(s)},J=s=>{b(s)},R=location.search.slice(location.search.indexOf("=")+1);l.useEffect(()=>{R&&(async()=>{if(V){const k=H(M,`members/${V}`),N=await _(k);g(N.data())}})()},[R,V]);const S=ie(s=>s.piazzaForm.value);l.useEffect(()=>{var k;const s=()=>{var U;const N=window.screen.height-300>(((U=window.visualViewport)==null?void 0:U.height)||window.screen.height);P!==N&&E(N)};return window.addEventListener("resize",s),typeof visualViewport<"u"&&((k=window.visualViewport)==null||k.addEventListener("resize",s)),visualViewport==null||visualViewport.addEventListener("resize",s),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",s)),()=>{var N;typeof visualViewport<"u"&&((N=window.visualViewport)==null||N.removeEventListener("resize",s))}},[P]);const Y=()=>{var s;(s=document.getElementById("myScreen"))==null||s.srcObject.getTracks().forEach(k=>k.stop())};return l.useEffect(()=>{I($e(5))}),t.jsxs(t.Fragment,{children:[!P&&t.jsx(Xe,{multiple:!R,displayName:B}),t.jsx(Ke,{isKeyboardOpen:S,userObj:n,messagesList:C,handleMessagesList:s=>y(s),handleChatUid:A,handleChatDisplayName:J}),t.jsx(qe,{chattingUser:z,userObj:n,multiple:!R,messages:e,handleMessages:s=>c(s),messagesList:C,handleMessagesList:s=>y(s)}),t.jsxs(Ve,{children:[t.jsx(Fe,{children:t.jsx("div",{id:"calls"})}),t.jsx(Ae,{children:t.jsxs("div",{children:[t.jsx("div",{className:"flex gap-5",children:t.jsx(Je,{})}),t.jsx(Le,{children:t.jsx("div",{onClick:Y,children:"전화 종료"})})]})})]})]})}export{We as default};
