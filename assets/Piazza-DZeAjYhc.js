import{r as p,j as s,aN as ga,N as Q,v as pa,bl as fa,M as H,a8 as G,bm as W,aV as ha,aL as xa,O as Na,Q as ya,S as wa,a1 as b,V as x,a2 as B,a3 as Ca,a4 as _,a5 as V,U as k,W as D,$,aK as Y,bn as ua}from"./index-CRk_zr9W.js";import{D as va,a as Ua,B as F}from"./DialogContent-L7HnCdFW.js";import{D as ka,w as u}from"./webSocket-DYzqgk_T.js";const Da=({multiple:t,selectUser:y,user:a,handleClose:w,userObj:g,handleMsgList:C,handleChangeMessage:R,displayedName:S})=>{const[E,P]=p.useState(null);return p.useEffect(()=>{y&&((a==null?void 0:a.uid)<g.uid?P((a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])+g.uid[0]+g.uid[1]+g.uid[2]+g.uid[3]+g.uid[4]+g.uid[5]):P(g.uid[0]+g.uid[1]+g.uid[2]+g.uid[3]+g.uid[4]+g.uid[5]+(a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])))},[y]),s.jsxs(va,{open:y,onClose:w,children:[s.jsxs(Ua,{children:[s.jsx("div",{children:s.jsx(ga,{alt:a==null?void 0:a.displayName,sx:{bgcolor:(a==null?void 0:a.profileColor)||"#2196f3"},src:(a==null?void 0:a.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:a==null?void 0:a.displayName}),(a==null?void 0:a.displayName)!==S&&s.jsxs("div",{children:["(",S,"에서 개명)"]})]}),s.jsxs(ka,{children:[s.jsx(Q,{to:"/profile",state:{element:a},children:s.jsx(F,{variant:"outlined",onClick:()=>{w()},children:"프로필 확인"})}),t&&g.uid!==(a==null?void 0:a.uid)&&s.jsx(Q,{to:"/piazza",state:{conversation:E,displayName:a==null?void 0:a.displayName,userUid:g.uid,chattingUid:a==null?void 0:a.uid,multiple:!1,profileUrl:a==null?void 0:a.profileImageUrl},children:s.jsx(F,{variant:"outlined",onClick:()=>{C([]),R(!0),w()},children:"개인 대화"})}),s.jsx(F,{variant:"outlined",onClick:()=>{w()},children:"닫기"})]})]})},Sa=pa(fa)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function za(){const t=H(w=>w.piazzaSwitch.value),y=G(),a=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),y(W("false"))):(window.localStorage.setItem("piazza","true"),y(W("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(Sa,{onClick:()=>a(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}function La({userObj:t}){const y=p.useRef(null),[a,w]=p.useState(""),[g,C]=p.useState([]),[R,S]=p.useState(!0),[E,P]=p.useState(""),[J,X]=p.useState(null),[O,Z]=p.useState(!1),T=H(e=>e.profileColor.value),z=H(e=>e.profileUrl.value),[aa,ea]=p.useState(null),q=G(),{state:c}=ha(),M=c==null?void 0:c.multiple,f=c==null?void 0:c.conversation;p.useEffect(()=>{if(!u)return;function e(i){const{msg:o,userUid:m,id:l,target:r,messageClock:n,messageClockNumber:d,conversation:h}=i;C(N=>[...N,{msg:o,type:r?"private":"other",userUid:m,id:l,messageClock:n,messageClockNumber:d,conversation:null,profileImageUrl:z,profileColor:T}])}return u.on("sMessagePiazza",e),()=>{u.off("sMessagePiazza",e)}},[]),p.useEffect(()=>{if(!u)return;function e(i){const{msg:o,userUid:m,id:l,target:r,messageClock:n,messageClockNumber:d,conversation:h}=i;C(N=>[...N,{msg:o,type:r?"private":"other",userUid:m,id:l,messageClock:n,messageClockNumber:d,conversation:null}])}return u.on(`sMessage${f}`,e),()=>{u.off(`sMessage${f}`,e)}},[]),p.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),p.useEffect(()=>{sa(),(async()=>{if(M){const i=b(x,"chats_group"),o=B(i,_("messageClockNumber","desc"),Ca(1));(await V(o)).forEach(async l=>{const r=k(x,`chats_group/${l.id}`),d=(await D(r)).data(),h=d.piazzaChecked||[];h.indexOf(t.uid)===-1&&(h.push(t.uid),await $(r,{...d,piazzaChecked:h}))})}else{const i=k(x,`members/${t.uid}`),m=(await D(i)).data().chattings;m[f].messageCount=0,await $(i,{chattings:m})}})()},[g]),p.useEffect(()=>{q(xa(5))});const sa=()=>{var e;(e=y.current)==null||e.scrollIntoView()},ta=e=>{e.preventDefault();const i=a,o=t.uid,m=t.displayName,l=Date.now(),r=new Date().toString(),n={msg:i,userUid:o,id:m,messageClockNumber:l,messageClock:r,target:E,conversation:f,conversationUid:c.chattingUid,conversationName:c.displayName,profileUrl:z};M?n&&i&&(u.emit("message",n),ca()):i&&(g.length!==0?(u.emit("message",n),console.log("message")):(u.emit("messageNew",n),console.log("messageNew")),la(),da()),w("")},ia=e=>{w(e.target.value)},oa=async({userUid:e,displayName:i})=>{const o=k(x,`members/${e}`),l=(await D(o)).data();X(l),Z(!0),ea(i)},na=()=>{Z(!1)},ca=async()=>{try{const e=a,i=t.uid,o=t.displayName,m=new Date().toString(),l=Date.now();e&&(await Y(b(x,"chats_group"),{userUid:i,userName:o,message:e,messageClock:m,messageClockNumber:l,profileImageUrl:z,profileColor:T,piazzaChecked:[t.uid]}),C(r=>[...r,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileImageUrl:z,profileColor:T}]))}catch(e){console.log(e)}};p.useEffect(()=>{R&&(M?((async()=>{const o=[],m=b(x,"chats_group"),l=B(m,_("messageClockNumber"));(await V(l)).forEach(n=>{var I,L;const d=n.data().message,h=n.data().userUid,N=n.data().userName,v=n.data().messageClock,U=n.data().messageClockNumber,j=(I=n.data())==null?void 0:I.profileColor,K=(L=n.data())==null?void 0:L.profileImageUrl;o.push({msg:d,type:"me",userUid:h,id:N,messageClockNumber:U,messageClock:v,conversation:null,profileColor:j,profileImageUrl:K}),C(o)})})(),S(!1)):((async o=>{const m=b(x,`chats_${o}`),l=B(m,_("messageClockNumber")),r=await V(l),n=[];r.forEach(d=>{const h=d.data().message,N=d.data().userUid,v=d.data().userName,U=d.data().messageClock,j=d.data().messageClockNumber||0;n.push({msg:h,type:"me",userUid:N,id:v,messageClock:U,messageClockNumber:j}),C(n)})})(f),S(!1)))},[R]);const la=async()=>{const e=a;try{const i=t.uid,o=t.displayName,m=Date.now(),l=new Date().toString();let r,n,d,h,N,v;if(c.userUid<c.chattingUid?(r=c.userUid,n=c.chattingUid,d=t.displayName,h=c.displayName,N=z,v=c.profileUrl):(r=c.chattingUid,n=c.userUid,d=c.displayName,h=t.displayName,N=c.profileUrl,v=z),e){const U={userUid:i,userName:o,message:e,messageClock:l,messageClockNumber:m,userOne:r,userTwo:n,userOneDisplayName:d,userTwoDisplayName:h,userOneProfileUrl:N,userTwoProfileUrl:v};await Y(b(x,`chats_${f}`),U);const j=k(x,`members/${i}`),I=(await D(j)).data().chattings||{},L=k(x,`members/${c.chattingUid}`),A=(await D(L)).data().chattings||{},ma=A[f].messageCount||0;I[f]=U,A[f]={...U,messageCount:ma+1},await $(j,{chattings:I}),await $(L,{chattings:A}),C(ra=>[...ra,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:l,conversation:f}])}}catch(i){console.log(i)}},da=async()=>{try{const e=t.uid,i=c.chattingUid,o=k(x,`members/${e}`),l=(await D(o)).data().conversation||[],r=k(x,`members/${i}`),d=(await D(r)).data().conversation||[];l.indexOf(f)===-1&&(await $(o,{conversation:[...l,f]}),q(ua())),d.indexOf(f)===-1&&await $(r,{conversation:[...d,f]})}catch(e){console.log(e)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"flex text-2xl p-5",children:[s.jsx("div",{className:"w-screen",children:M?"단체 대화":`개인 대화 ${c==null?void 0:c.displayName}`}),M&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(za,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[g.map((e,i)=>{if(e.type==="welcome")return s.jsxs("li",{className:"welcome",children:[s.jsx("div",{className:"line"}),s.jsx("div",{children:e.msg}),s.jsx("div",{className:"line"})]});{let o;return e.userUid===t.uid?o="me":o="other",s.jsxs("li",{className:o,name:e.id,"data-id":e.id,children:[s.jsx("div",{className:`flex justify-${e.userUid!==t.uid?"start":"end"}`,children:s.jsxs(Na,{onClick:()=>oa({userUid:e.userUid,displayName:e.id}),className:"bg-profile-blue",children:[s.jsx(ya,{src:e.profileImageUrl}),s.jsx(wa,{className:"text-xl border-none	",children:e.id[0]})]})}),s.jsx("div",{className:e.id===E?"private-user":"userId","data-id":e.id,name:e.id,children:e.id}),e.userUid!==t.uid?s.jsxs("div",{className:"flex justify-start",children:[s.jsx("div",{className:"other","data-id":e.id,name:e.id,children:e.msg}),s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock})]}):s.jsxs("div",{className:"flex justify-end",children:[s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock}),s.jsx("div",{className:"me","data-id":e.id,name:e.id,children:e.msg})]})]},`${i}_li`)}}),s.jsx("li",{ref:y})]}),s.jsxs("form",{className:"send-form",onSubmit:ta,children:[s.jsx("input",{placeholder:"메세지를 작성해 주세요",onChange:ia,value:a,autoFocus:!0}),s.jsx("button",{type:"submit",children:"전송"})]})]}),s.jsx(Da,{multiple:M,selectUser:O,user:J,handleClose:na,userObj:t,handleMsgList:e=>C(e),handleChangeMessage:e=>S(e),displayedName:aa})]})})]})}export{La as default};
