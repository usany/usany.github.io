import{b1 as je,u as X,c as W,I as ge,aU as fe,r as x,j as a,m as F,h as I,z as V,U as _,aZ as he,g as ee,w as Q,b2 as Ee,H as de,Q as xe,B as we,b0 as Me,P as ve,b3 as ye,q as ne,R as le,S as ce,i as re,aX as ke,af as Te,b4 as Re,J as Ce,x as $e,b5 as Fe,a7 as Ve}from"./index-d4NAFSAb.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=je("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ne={ko:"메세지를 작성해 주세요",en:"Input message"},Ie={ko:"전송",en:"send"};function Be({chattingUser:s,userObj:g,multiple:v,messages:e,handleMessages:n,messagesList:j,handleMessagesList:p}){const U=X(m=>m.profileColor.value),A=X(m=>m.piazzaForm.value),l=W(m=>m.profile.value),K=ge(),{state:S}=fe(),z=S==null?void 0:S.conversation,B=W(m=>m.languages.value),E=B==="ko"||B==="en"?B:"ko",[w,M]=x.useState(!1),D=async m=>{var N;m.preventDefault();const C=e,t=g.uid,r=g.displayName,o=Date.now(),c=new Date().toString(),i=l==null?void 0:l.profileImageUrl,d=l==null?void 0:l.defaultProfile,f=l==null?void 0:l.profileImage;let u,h,y;s&&(u=F(I,`members/${s.uid}`),h=await V(u),y=(N=h.data())==null?void 0:N.messagingToken);const k=l.profileImage?l.profileImageUrl:l.defaultProfile;console.log(l);const b={msg:C,userUid:t,id:r,messageClockNumber:o,messageClock:c,conversation:z,conversationUid:s==null?void 0:s.uid,conversationName:s==null?void 0:s.displayName,profileImage:f,defaultProfile:d,profileImageUrl:i,profileUrl:k,sendingToken:y};v?b&&C&&(_.emit("piazzaMessage",b),J()):C&&(j.length!==0?(_.emit("message",b),console.log("message")):(_.emit("messageNew",b),console.log("messageNew")),oe(),ae()),n("")},P=m=>{n(m.target.value)},J=async()=>{try{const m=e,C=g.uid,t=g.displayName,r=new Date().toString(),o=Date.now(),c=l==null?void 0:l.profileImageUrl,i=l==null?void 0:l.defaultProfile,d=l==null?void 0:l.profileImage;m&&(await he(ee(I,"chats_group"),{userUid:C,userName:t,message:m,messageClock:r,messageClockNumber:o,profileImageUrl:c,defaultProfile:i,profileColor:U,piazzaChecked:[g.uid],profileImage:d}),p(f=>[...f,{msg:m,type:"me",userUid:g.uid,id:g.displayName,messageClock:r,conversation:null,profileColor:U,messageClockNumber:o,defaultProfile:i,profileImageUrl:c,profileImage:d||!1}]))}catch(m){console.log(m)}},oe=async()=>{var C,t,r;const m=e;try{const o=g.uid,c=g.displayName,i=Date.now(),d=new Date().toString(),f=l.profileImage,u=s.profileImage,h=l.profileImageUrl,y=s.profileImageUrl,k=l.defaultProfile,b=s.defaultProfile;let N,T,Y,q,R,$,H,L,Z,te;if(g.uid<s.uid?(N=g.uid,T=s.uid,Y=g.displayName,q=s.displayName,R=h,$=y,H=k,L=b,Z=l.profileImage,te=s.profileImage):(N=s.uid,T=g.uid,Y=s.displayName,q=g.displayName,R=y,$=h,H=b,L=k,Z=s.profileImage,te=l.profileImage),!R){const G=F(I,`members/${N}`);R=(C=(await V(G)).data())==null?void 0:C.profileImageUrl}if(!$){const G=F(I,`members/${T}`);$=(t=(await V(G)).data())==null?void 0:t.profileImageUrl}if(m){const G={userUid:o,userName:c,message:m,messageClock:d,messageClockNumber:i,userOne:N,userTwo:T,userOneDisplayName:Y,userTwoDisplayName:q,userOneProfileUrl:R,userTwoProfileUrl:$,userOneDefaultProfile:H,userTwoDefaultProfile:L,userOneProfileImage:Z,userTwoProfileImage:te};await he(ee(I,`chats_${z}`),G);const se=F(I,`members/${o}`),ue=(await V(se)).data().chattings||{},pe=F(I,`members/${s.uid}`),ie=(await V(pe)).data().chattings||{},Se=((r=ie[z])==null?void 0:r.messageCount)||0;ue[z]=G,ie[z]={...G,messageCount:Se+1},await Q(se,{chattings:ue}),await Q(pe,{chattings:ie}),p(Pe=>[...Pe,{msg:m,type:"me",userUid:g.uid,id:g.displayName,messageClock:d,conversation:z,userName:c,messageClockNumber:i,userOne:N,userTwo:T,userOneDisplayName:Y,userTwoDisplayName:q,userOneProfileUrl:R,userTwoProfileUrl:$,userOneDefaultProfile:H,userTwoDefaultProfile:L,userOneProfileImage:Z,userTwoProfileImage:te}])}}catch(o){console.log(o)}},ae=async()=>{try{const m=g.uid,C=s.uid,t=F(I,`members/${m}`),o=(await V(t)).data().conversation||[],c=F(I,`members/${C}`),d=(await V(c)).data().conversation||[];o.indexOf(z)===-1&&(await Q(t,{conversation:[...o,z]}),K(Ee())),d.indexOf(z)===-1&&await Q(c,{conversation:[...d,z]})}catch(m){console.log(m)}};x.useEffect(()=>{if(w){document.getElementById("mute"),document.getElementById("stream");const m=document.getElementById("videoInput");document.getElementById("myFace");let C;async function t(){try{const o={video:!0,audio:!0};C=await navigator.mediaDevices.getUserMedia(o),C.getVideoTracks().forEach(c=>c.enabled=!c.enabled),C.getAudioTracks().forEach(c=>c.enabled=!c.enabled),r()}catch(o){console.log(o)}}t();async function r(){try{const c=(await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="videoinput");c.forEach(i=>{const d=document.createElement("option");d.value=i.deviceId,d.innerText=i.label,m==null||m.appendChild(d)}),console.log(c)}catch(o){console.log(o)}}}});const O=()=>{M(!0)};return a.jsx(a.Fragment,{children:A?a.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:D,children:[a.jsx("button",{onClick:()=>O(),className:"px-1 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:a.jsx(ze,{})}),a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ne[E],onChange:P,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ie[E]})]}):a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:D,children:[a.jsx("button",{onClick:()=>O(),className:"px-1 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:a.jsx(ze,{})}),a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ne[E],onChange:P,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ie[E]})]})})}const De=({initiateContinuing:s,multiple:g,handleMultiple:v,user:e,userObj:n,handleMessagesList:j,displayedName:p})=>{const[U,A]=x.useState(null),l=W(K=>K.languages.value);return x.useEffect(()=>{e&&((e==null?void 0:e.uid)<n.uid?A((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]):A(n.uid[0]+n.uid[1]+n.uid[2]+n.uid[3]+n.uid[4]+n.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(de,{element:e,uid:n.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&a.jsx("div",{children:l==="ko"?a.jsxs("div",{children:["(",p,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(xe,{to:`${location.pathname}?id=${U}`,state:{element:e},children:a.jsx(we,{variant:"outlined",onClick:()=>{},children:l==="ko"?"프로필 확인":"Check Profile"})}),g&&n.uid!==(e==null?void 0:e.uid)&&a.jsx(xe,{to:`${location.pathname}?id=${U}`,state:{conversation:U,displayName:e==null?void 0:e.displayName,userUid:n.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(Me,{children:a.jsx(we,{variant:"outlined",onClick:()=>{j([]),v(!1),s()},children:l==="ko"?"개인 대화":"Private messaging"})})})]})]})};function be({userObj:s,multiple:g,handleMultiple:v,messagesList:e,handleMessagesList:n}){const j=x.useRef(null),p=x.useRef(null),[U,A]=x.useState(null),[l,K]=x.useState(""),[S,z]=x.useState(!1),[B,E]=x.useState(null),[w,M]=x.useState(0);X(t=>t.profileColor.value),X(t=>t.profileUrl.value);const{state:D}=fe(),P=(D==null?void 0:D.conversation)||"piazza",J=W(t=>t.languages.value),oe=async({userUid:t,displayName:r})=>{const o=F(I,`members/${t}`),i=(await V(o)).data();A(i),K(r)},ae=({userUid:t,displayName:r})=>{var o;(o=document.getElementById("drawer"))==null||o.click(),oe({userUid:t,displayName:r})},O=20;x.useEffect(()=>{if(!_)return;function t(r){const{msg:o,userUid:c,id:i,target:d,messageClock:f,messageClockNumber:u,profileImageUrl:h,defaultProfile:y,profileImage:k,conversation:b}=r;n(N=>[...N,{msg:o,type:d?"private":"other",userUid:c,id:i,messageClock:f,messageClockNumber:u,conversation:null,profileImageUrl:h,defaultProfile:y,profileImage:k}])}return _.on("sMessagePiazza",t),()=>{_.off("sMessagePiazza",t)}},[]),x.useEffect(()=>{if(!_)return;function t(r){const{msg:o,userUid:c,id:i,target:d,messageClock:f,messageClockNumber:u,conversation:h,profileImageUrl:y,defaultProfile:k,profileImage:b,piazzaData:N}=r;n(T=>[...T,{msg:o,type:d?"private":"other",userUid:c,id:i,messageClock:f,messageClockNumber:u,conversation:null,profileImageUrl:y,defaultProfile:k,profileImage:b,...N}])}return _.on(`sMessage${P}`,t),()=>{_.off(`sMessage${P}`,t)}},[]),x.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),x.useEffect(()=>{m(),(async()=>{if(g){const r=ee(I,"chats_group"),o=ne(r,ce("messageClockNumber","desc"),le(1));(await re(o)).forEach(async i=>{const d=F(I,`chats_group/${i.id}`),u=(await V(d)).data(),h=u.piazzaChecked||[];h.indexOf(s.uid)===-1&&(h.splice(-1,s.uid,0),h.push(s.uid),await Q(d,{...u,piazzaChecked:h}))})}else{const r=F(I,`members/${s.uid}`),c=(await V(r)).data().chattings;c[P]&&(c[P].messageCount=0),await Q(r,{chattings:c})}})()},[e]);const m=()=>{var t;(t=j.current)==null||t.scrollIntoView()};x.useEffect(()=>{const t=async()=>{const o=[],c=ee(I,"chats_group"),i=ne(c,ce("messageClockNumber","desc"),le(O),ke(B||"")),d=await re(i);d.docs.length||M(d.docs.length),d.forEach(f=>{var R,$,H,L;o.length===d.docs.length-1&&(E(f),M(d.docs.length-1));const u=f.data().message,h=f.data().userUid,y=f.data().userName,k=f.data().messageClock,b=f.data().messageClockNumber;(R=f.data())==null||R.profileColor;const N=($=f.data())==null?void 0:$.profileImageUrl,T=(H=f.data())==null?void 0:H.defaultProfile,Y=(L=f.data())==null?void 0:L.profileImage,q=f.data();o.push({msg:u,userUid:h,id:y,messageClockNumber:b,messageClock:k,conversation:null,profileImageUrl:N,defaultProfile:T,profileImage:Y||!1,...q})}),o.reverse(),n([...o,...e]),z(!1)},r=async o=>{const c=ee(I,`chats_${o}`),i=ne(c,ce("messageClockNumber","desc"),le(O),ke(B||"")),d=await re(i),f=[];d.docs.length||M(d.docs.length),d.forEach((u,h)=>{var H,L,Z;f.length===d.docs.length-1&&(E(u),M(d.docs.length-1));const y=u.data().message,k=u.data().userUid,b=u.data().userName,N=u.data().messageClock,T=u.data().messageClockNumber||0,Y=(H=u.data())==null?void 0:H.profileImageUrl,q=(L=u.data())==null?void 0:L.defaultProfile,R=(Z=u.data())==null?void 0:Z.profileImage,$=u.data();f.push({msg:y,userUid:k,id:b,messageClockNumber:T,messageClock:N,conversation:null,profileImageUrl:Y,defaultProfile:q,profileImage:R||!1,...$})}),f.reverse(),n([...f,...e]),z(!1)};P==="piazza"?(S||!e.length)&&t():(S||!e.length)&&r(P)},[S,P]);const C=()=>{p.current.scrollTop!==0||S||(console.log("scroll"),z(!0))};return x.useEffect(()=>{var t;return(t=p.current)==null||t.addEventListener("scroll",C),()=>{var r;return(r=p.current)==null?void 0:r.removeEventListener("scroll",C)}},[S]),console.log(e),a.jsx(a.Fragment,{children:a.jsx(a.Fragment,{children:a.jsx("div",{ref:p,className:"p-1 border-t rounded-xl overflow-auto",children:a.jsxs("ul",{children:[S&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((t,r)=>{let o;g?o=t:(console.log(t.userUid===s.uid),t.userUid===t.userOne?o={userUid:t.userOne,id:t.userOneDisplayName,profileImage:t.userOneProfileImage||t.profileImage,defaultProfile:t.userOneDefaultProfile||t.defaultProfile,profileImageUrl:t.userOneProfileUrl||t.profileImageUrl}:o={userUid:t.userTwo,id:t.userTwoDisplayName,profileImage:t.userTwoProfileImage||t.profileImage,defaultProfile:t.userTwoDefaultProfile||t.defaultProfile,profileImageUrl:t.userTwoProfileUrl||t.profileImageUrl});let c;const i=new Date(t.messageClock);t.userUid===s.uid?c="text-right":c="text-left";let d,f;r>0&&(d=e[r-1].userUid),r<e.length-1&&e[r+1].userUid===s.uid&&(f=new Date(e[r+1].messageClock),i.getFullYear()===f.getFullYear()&&i.getMonth()===f.getMonth()&&i.getDate()===f.getDate()&&i.getHours()===f.getHours()&&(i.getMinutes(),f.getMinutes()));let u,h=i.getHours(),y=(i.getMonth()+1).toString(),k=i.getDate().toString();return h>=13?(u="오후",h!==12&&(h=h-12)):(u="오전",h===0&&(h=h+12)),i.getMonth()+1<10&&(y="0"+y),k.length===1&&(k="0"+k),a.jsxs("li",{ref:r===w?j:null,className:c,children:[d!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==s.uid?"start":"end"}`,children:c==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(ve,{trigger:a.jsx(de,{element:o,piazza:()=>ae({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(ye,{}),content:a.jsx(De,{initiateContinuing:()=>E(null),multiple:g,handleMultiple:v,user:U,userObj:s,handleMessagesList:n,displayedName:l})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(ve,{trigger:a.jsx(de,{element:o,piazza:()=>ae({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(ye,{}),content:a.jsx(De,{initiateContinuing:()=>E(null),multiple:g,handleMultiple:v,user:U,userObj:s,handleMessagesList:n,displayedName:l})})]})})}),t.userUid!==s.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[i.getFullYear(),"-",y,"-",k," ",J==="ko"&&u," ",h,":",i.getMinutes()<10&&"0",i.getMinutes(),J==="en"&&(u==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[i.getFullYear(),"-",y,"-",k," ",J==="ko"&&u," ",h,":",i.getMinutes()<10&&"0",i.getMinutes(),J==="en"&&(u==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},r)}),a.jsx("li",{ref:j})]})})})})}function He({isKeyboardOpen:s,userObj:g,multiple:v,handleMultiple:e,messagesList:n,handleMessagesList:j}){return a.jsx(a.Fragment,{children:s?a.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:a.jsx(be,{userObj:g,multiple:v,handleMultiple:e,messagesList:n,handleMessagesList:j})}):a.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:a.jsx(be,{userObj:g,multiple:v,handleMultiple:e,messagesList:n,handleMessagesList:j})})})}const Le=Te(Re)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ae(){const s=W(n=>n.languages.value),g=X(n=>n.piazzaSwitch.value),v=ge(),e=()=>{g==="true"?(window.localStorage.setItem("piazza","false"),v(Ce("false"))):(window.localStorage.setItem("piazza","true"),v(Ce("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Le,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:g==="true"})})]})}const Ue={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},_e=({multiple:s,displayName:g})=>{const v=W(n=>n.languages.value),e=v==="ko"||v==="en"?v:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx($e,{icon:a.jsx(Fe,{}),title:s?Ue[e][0]:`${Ue[e][1]} ${g}`}),s&&a.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:a.jsx(Ae,{})})]})};function Ke({userObj:s}){const[g,v]=x.useState(""),[e,n]=x.useState([]),j=ge(),{state:p}=fe(),[U,A]=x.useState(!0),[l,K]=x.useState(!1),[S,z]=x.useState(null);x.useEffect(()=>{const w=async()=>{if(p.chattingUid){const M=F(I,`members/${p.chattingUid}`),D=await V(M);z(D.data())}};p.multiple||w()},[p]);const B=X(w=>w.piazzaForm.value);x.useEffect(()=>{var M;const w=()=>{var P;const D=window.screen.height-300>(((P=window.visualViewport)==null?void 0:P.height)||window.screen.height);l!==D&&K(D)};return window.addEventListener("resize",w),typeof visualViewport<"u"&&((M=window.visualViewport)==null||M.addEventListener("resize",w)),visualViewport==null||visualViewport.addEventListener("resize",w),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",w)),()=>{var D;typeof visualViewport<"u"&&((D=window.visualViewport)==null||D.removeEventListener("resize",w))}},[l]),x.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&A(p==null?void 0:p.multiple)},[]),x.useEffect(()=>{j(Ve(5))});const E=p==null?void 0:p.displayName;return console.log(p),console.log(S),a.jsxs(a.Fragment,{children:[!l&&a.jsx(_e,{multiple:U,displayName:E}),a.jsx(He,{isKeyboardOpen:B,userObj:s,multiple:U,handleMultiple:w=>A(w),messagesList:e,handleMessagesList:w=>n(w)}),a.jsx(Be,{chattingUser:S,userObj:s,multiple:U,messages:g,handleMessages:w=>v(w),messagesList:e,handleMessagesList:w=>n(w)})]})}export{Ke as default};
