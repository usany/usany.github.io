import{b2 as je,u as ne,c as te,O as pe,aV as oe,r as c,j as e,P as fe,Y as ie,b1 as me,X as we,b3 as ye,aX as Ue,v as H,m as $,I as _,$ as y,a_ as ke,l as ae,C as ee,b4 as Ee,N as ue,B as se,b5 as Ce,q as ce,Z as re,_ as de,n as ge,aY as ze,s as Me,S as Te,Q as Se,D as $e,b6 as Re,aJ as Ve,aa as Fe,b7 as Be,b8 as Ae,b9 as Le,ba as He}from"./index-BM586ujx.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=je("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=je("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),qe={ko:"메세지를 작성해 주세요",en:"Input message"},Ke={ko:"전송",en:"send"};function Ze({chattingUser:n,userObj:f,multiple:N,messages:t,handleMessages:l,messagesList:U,handleMessagesList:m}){const b=ne(g=>g.profileColor.value),D=ne(g=>g.piazzaForm.value),r=te(g=>g.profile.value),L=pe(),{state:j}=oe(),k=j==null?void 0:j.conversation,E=te(g=>g.languages.value),R=E==="ko"||E==="en"?E:"ko",[z,x]=c.useState(!1),M=async g=>{var w;g.preventDefault();const I=t,T=f.uid,V=f.displayName,C=Date.now(),s=new Date().toString(),d=r==null?void 0:r.profileImageUrl,i=r==null?void 0:r.defaultProfile,v=r==null?void 0:r.profileImage;let u,h,a;n&&(u=H($,`members/${n.uid}`),h=await _(u),a=(w=h.data())==null?void 0:w.messagingToken);const o=r.profileImage?r.profileImageUrl:r.defaultProfile;console.log(r);const p={msg:I,userUid:T,id:V,messageClockNumber:C,messageClock:s,conversation:k,conversationUid:n==null?void 0:n.uid,conversationName:n==null?void 0:n.displayName,profileImage:v,defaultProfile:i,profileImageUrl:d,profileUrl:o,sendingToken:a};N?p&&I&&(y.emit("piazzaMessage",p),W()):I&&(U.length!==0?(y.emit("message",p),console.log("message")):(y.emit("messageNew",p),console.log("messageNew")),P(),J()),l("")},X=g=>{l(g.target.value)},W=async()=>{try{const g=t,I=f.uid,T=f.displayName,V=new Date().toString(),C=Date.now(),s=r==null?void 0:r.profileImageUrl,d=r==null?void 0:r.defaultProfile,i=r==null?void 0:r.profileImage;g&&(await ke(ae($,"chats_group"),{userUid:I,userName:T,message:g,messageClock:V,messageClockNumber:C,profileImageUrl:s,defaultProfile:d,profileColor:b,piazzaChecked:[f.uid],profileImage:i}),m(v=>[...v,{msg:g,type:"me",userUid:f.uid,id:f.displayName,messageClock:V,conversation:null,profileColor:b,messageClockNumber:C,defaultProfile:d,profileImageUrl:s,profileImage:i||!1}]))}catch(g){console.log(g)}},P=async()=>{var I,T,V;const g=t;try{const C=f.uid,s=f.displayName,d=Date.now(),i=new Date().toString(),v=r.profileImage,u=n.profileImage,h=r.profileImageUrl,a=n.profileImageUrl,o=r.defaultProfile,p=n.defaultProfile;let w,S,B,F,A,Y,Q,Z,G,q;if(f.uid<n.uid?(w=f.uid,S=n.uid,B=f.displayName,F=n.displayName,A=h,Y=a,Q=o,Z=p,G=r.profileImage,q=n.profileImage):(w=n.uid,S=f.uid,B=n.displayName,F=f.displayName,A=a,Y=h,Q=p,Z=o,G=n.profileImage,q=r.profileImage),!A){const K=H($,`members/${w}`);A=(I=(await _(K)).data())==null?void 0:I.profileImageUrl}if(!Y){const K=H($,`members/${S}`);Y=(T=(await _(K)).data())==null?void 0:T.profileImageUrl}if(g){const K={userUid:C,userName:s,message:g,messageClock:i,messageClockNumber:d,userOne:w,userTwo:S,userOneDisplayName:B,userTwoDisplayName:F,userOneProfileUrl:A,userTwoProfileUrl:Y,userOneDefaultProfile:Q,userTwoDefaultProfile:Z,userOneProfileImage:G,userTwoProfileImage:q};await ke(ae($,`chats_${k}`),K);const O=H($,`members/${C}`),xe=(await _(O)).data().chattings||{},ve=H($,`members/${n.uid}`),le=(await _(ve)).data().chattings||{},be=((V=le[k])==null?void 0:V.messageCount)||0;xe[k]=K,le[k]={...K,messageCount:be+1},await ee(O,{chattings:xe}),await ee(ve,{chattings:le}),m(Pe=>[...Pe,{msg:g,type:"me",userUid:f.uid,id:f.displayName,messageClock:i,conversation:k,userName:s,messageClockNumber:d,userOne:w,userTwo:S,userOneDisplayName:B,userTwoDisplayName:F,userOneProfileUrl:A,userTwoProfileUrl:Y,userOneDefaultProfile:Q,userTwoDefaultProfile:Z,userOneProfileImage:G,userTwoProfileImage:q}])}}catch(C){console.log(C)}},J=async()=>{try{const g=f.uid,I=n.uid,T=H($,`members/${g}`),C=(await _(T)).data().conversation||[],s=H($,`members/${I}`),i=(await _(s)).data().conversation||[];C.indexOf(k)===-1&&(await ee(T,{conversation:[...C,k]}),L(Ee())),i.indexOf(k)===-1&&await ee(s,{conversation:[...i,k]})}catch(g){console.log(g)}};return c.useEffect(()=>{if(z){document.getElementById("mute"),document.getElementById("stream");const g=document.getElementById("videoInput");document.getElementById("myFace");let I;async function T(){try{const C={video:!0,audio:!0};I=await navigator.mediaDevices.getUserMedia(C),I.getVideoTracks().forEach(s=>s.enabled=!s.enabled),I.getAudioTracks().forEach(s=>s.enabled=!s.enabled),V()}catch(C){console.log(C)}}T();async function V(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==="videoinput");s.forEach(d=>{const i=document.createElement("option");i.value=d.deviceId,i.innerText=d.label,g==null||g.appendChild(i)}),console.log(s)}catch(C){console.log(C)}}}}),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${D?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:M,children:[k&&k!=="piazza"&&e.jsx(fe,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ie,{to:`/piazza?id=${k}?calls=video`,state:j,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var g;(g=document.getElementById("calls"))==null||g.click()},children:[e.jsx(Ue,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(ie,{to:`/piazza?id=${k}?calls=audio`,state:j,children:e.jsx(me,{children:e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(_e,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:qe[R],onChange:X,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ke[R]})]})})}const Ne=({initiateContinuing:n,multiple:f,handleMultiple:N,user:t,userObj:l,handleMessagesList:U,displayedName:m})=>{const{state:b}=oe(),D=(b==null?void 0:b.conversation)||"piazza",r=te(k=>k.languages.value),[L,j]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<l.uid?j((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]):j(l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(ue,{element:t,uid:l.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==m&&e.jsx("div",{children:r==="ko"?e.jsxs("div",{children:["(",m,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",m,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(ie,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(se,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),D==="piazza"&&l.uid!==(t==null?void 0:t.uid)&&e.jsx(ie,{to:`${location.pathname}?id=${L}`,state:{conversation:L,displayName:t==null?void 0:t.displayName,userUid:l.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(me,{children:e.jsx(se,{variant:"outlined",onClick:()=>{U([]),N(!1),n()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function De({userObj:n,multiple:f,handleMultiple:N,messagesList:t,handleMessagesList:l}){const U=c.useRef(null),m=c.useRef(null),[b,D]=c.useState(null),[r,L]=c.useState(""),[j,k]=c.useState(!1),[E,R]=c.useState(null),[z,x]=c.useState(0),[M,X]=c.useState("piazza"),{state:W}=oe(),P=(W==null?void 0:W.conversation)||"piazza";c.useEffect(()=>{M!==P&&(l([]),R(null),x(0),X(P))},[P]);const J=te(s=>s.languages.value),g=async({userUid:s,displayName:d})=>{const i=H($,`members/${s}`),u=(await _(i)).data();D(u),L(d),console.log("practice")},I=({userUid:s,displayName:d})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),g({userUid:s,displayName:d})},T=20;c.useEffect(()=>{if(!y)return;function s(d){const{msg:i,userUid:v,id:u,target:h,messageClock:a,messageClockNumber:o,profileImageUrl:p,defaultProfile:w,profileImage:S,conversation:B}=d;l(F=>[...F,{msg:i,type:h?"private":"other",userUid:v,id:u,messageClock:a,messageClockNumber:o,conversation:null,profileImageUrl:p,defaultProfile:w,profileImage:S}])}return y.on("sMessagePiazza",s),()=>{y.off("sMessagePiazza",s)}},[]),c.useEffect(()=>{if(!y)return;function s(d){const{msg:i,userUid:v,id:u,target:h,messageClock:a,messageClockNumber:o,conversation:p,profileImageUrl:w,defaultProfile:S,profileImage:B,piazzaData:F}=d;l(A=>[...A,{msg:i,type:h?"private":"other",userUid:v,id:u,messageClock:a,messageClockNumber:o,conversation:null,profileImageUrl:w,defaultProfile:S,profileImage:B,...F}])}return y.on(`sMessage${P}`,s),()=>{y.off(`sMessage${P}`,s)}},[P]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{V(),(async()=>{if(f){const d=ae($,"chats_group"),i=ce(d,de("messageClockNumber","desc"),re(1));(await ge(i)).forEach(async u=>{const h=H($,`chats_group/${u.id}`),o=(await _(h)).data(),p=o.piazzaChecked||[];p.indexOf(n.uid)===-1&&(p.splice(-1,n.uid,0),p.push(n.uid),await ee(h,{...o,piazzaChecked:p}))})}else{const d=H($,`members/${n.uid}`),v=(await _(d)).data().chattings;v[P]&&(v[P].messageCount=0),await ee(d,{chattings:v})}})()},[t]);const V=()=>{var s;(s=U.current)==null||s.scrollIntoView()};c.useEffect(()=>{const s=async()=>{const i=[],v=ae($,"chats_group"),u=ce(v,de("messageClockNumber","desc"),re(T),ze(E||"")),h=await ge(u);h.docs.length||x(h.docs.length),h.forEach(a=>{var Z,G,q;i.length===h.docs.length-1&&(R(a),x(h.docs.length-1));const o=a.data().message,p=a.data().userUid,w=a.data().userName,S=a.data().messageClock,B=a.data().messageClockNumber,F=(Z=a.data())==null?void 0:Z.profileImageUrl,A=(G=a.data())==null?void 0:G.defaultProfile,Y=(q=a.data())==null?void 0:q.profileImage,Q=a.data();i.push({msg:o,userUid:p,id:w,messageClockNumber:B,messageClock:S,conversation:null,profileImageUrl:F,defaultProfile:A,profileImage:Y||!1,...Q})}),i.reverse(),l([...i,...t]),k(!1)},d=async i=>{const v=ae($,`chats_${i}`),u=ce(v,de("messageClockNumber","desc"),re(T),ze(E||"")),h=await ge(u),a=[];h.docs.length||x(h.docs.length),h.forEach((o,p)=>{var q,K,O;a.length===h.docs.length-1&&(R(o),x(h.docs.length-1));const w=o.data().message,S=o.data().userUid,B=o.data().userName,F=o.data().messageClock,A=o.data().messageClockNumber||0,Y=(q=o.data())==null?void 0:q.profileImageUrl,Q=(K=o.data())==null?void 0:K.defaultProfile,Z=(O=o.data())==null?void 0:O.profileImage,G=o.data();a.push({msg:w,userUid:S,id:B,messageClockNumber:A,messageClock:F,conversation:null,profileImageUrl:Y,defaultProfile:Q,profileImage:Z||!1,...G})}),a.reverse(),l([...a,...t]),k(!1)};P==="piazza"?(j||!t.length)&&s():(j||!t.length)&&d(P)},[j,P]);const C=()=>{m.current.scrollTop!==0||j||(console.log("scroll"),k(!0))};return c.useEffect(()=>{var s;return(s=m.current)==null||s.addEventListener("scroll",C),()=>{var d;return(d=m.current)==null?void 0:d.removeEventListener("scroll",C)}},[j]),console.log(P),console.log(t),console.log(b),e.jsx(e.Fragment,{children:e.jsx("div",{ref:m,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[j&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((s,d)=>{let i;P==="piazza"?i=s:s.userUid===s.userOne?i={userUid:s.userOne,id:s.userOneDisplayName,profileImage:s.userOneProfileImage||s.profileImage,defaultProfile:s.userOneDefaultProfile||s.defaultProfile,profileImageUrl:s.userOneProfileUrl||s.profileImageUrl}:i={userUid:s.userTwo,id:s.userTwoDisplayName,profileImage:s.userTwoProfileImage||s.profileImage,defaultProfile:s.userTwoDefaultProfile||s.defaultProfile,profileImageUrl:s.userTwoProfileUrl||s.profileImageUrl};let v;const u=new Date(s.messageClock);s.userUid===n.uid?v="text-right":v="text-left";let h,a;d>0&&(h=t[d-1].userUid),d<t.length-1&&t[d+1].userUid===n.uid&&(a=new Date(t[d+1].messageClock),u.getFullYear()===a.getFullYear()&&u.getMonth()===a.getMonth()&&u.getDate()===a.getDate()&&u.getHours()===a.getHours()&&(u.getMinutes(),a.getMinutes()));let o,p=u.getHours(),w=(u.getMonth()+1).toString(),S=u.getDate().toString();return p>=13?(o="오후",p!==12&&(p=p-12)):(o="오전",p===0&&(p=p+12)),u.getMonth()+1<10&&(w="0"+w),S.length===1&&(S="0"+S),e.jsxs("li",{ref:d===z?U:null,className:v,children:[h!==s.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${s.userUid!==n.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(Ne,{initiateContinuing:()=>R(null),multiple:f,handleMultiple:N,user:b,userObj:n,handleMessagesList:l,displayedName:r})}),e.jsx("div",{children:s.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:s.id}),e.jsx(fe,{trigger:e.jsx(ue,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:e.jsx(Ce,{}),content:e.jsx(Ne,{initiateContinuing:()=>R(null),multiple:f,handleMultiple:N,user:b,userObj:n,handleMessagesList:l,displayedName:r})})]})})}),s.userUid!==n.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),e.jsxs("div",{children:[u.getFullYear(),"-",w,"-",S," ",J==="ko"&&o," ",p,":",u.getMinutes()<10&&"0",u.getMinutes(),J==="en"&&(o==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[u.getFullYear(),"-",w,"-",S," ",J==="ko"&&o," ",p,":",u.getMinutes()<10&&"0",u.getMinutes(),J==="en"&&(o==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},d)}),e.jsx("li",{ref:U})]})})})}function Ge({isKeyboardOpen:n,userObj:f,multiple:N,handleMultiple:t,messagesList:l,handleMessagesList:U}){return e.jsx(e.Fragment,{children:n?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(De,{userObj:f,multiple:N,handleMultiple:t,messagesList:l,handleMessagesList:U})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(De,{userObj:f,multiple:N,handleMultiple:t,messagesList:l,handleMessagesList:U})})})}const Xe=Me(Te)(({theme:n})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(n.palette.getContrastText(n.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Je(){const n=te(l=>l.languages.value),f=ne(l=>l.piazzaSwitch.value),N=pe(),t=()=>{f==="true"?(window.localStorage.setItem("piazza","false"),N(Se("false"))):(window.localStorage.setItem("piazza","true"),N(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:n==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Xe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:f==="true"})})]})}const Ie={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Qe=({multiple:n,displayName:f})=>{const N=te(m=>m.languages.value),t=N==="ko"||N==="en"?N:"ko",{state:l}=oe(),U=(l==null?void 0:l.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx($e,{icon:e.jsx(Re,{}),title:U==="piazza"?Ie[t][0]:`${Ie[t][1]} ${f}`}),n&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Je,{})})]})};function We(){const[n,f]=c.useState([]),[N,t]=c.useState(!0),[l,U]=c.useState(!0),[m,b]=c.useState(""),[D,r]=c.useState(null),[L,j]=c.useState(null),k=Ve(),E=document.getElementById("myScreen"),R={audio:!0,video:!0},z=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],x=new RTCPeerConnection({iceServers:[{urls:z.map(a=>a.urls)}]}),M=location.search.slice(4);console.log(location.search.slice(4)),c.useEffect(()=>{(async()=>{await navigator.mediaDevices.getUserMedia(R),await g()})()},[]),c.useEffect(()=>{E&&(E.srcObject=D)},[D]);async function X(){const a=D;a&&a.getAudioTracks().forEach(o=>o.enabled=!o.enabled),t(!N)}async function W(){const a=D;a&&a.getVideoTracks().forEach(o=>o.enabled=!o.enabled),U(!l)}const P=()=>{E.srcObject.getTracks().forEach(a=>a.stop()),console.log(E)};async function J(a){if(E.srcObject.getTracks().forEach(o=>o.stop()),j(a.target.value),x){console.log(x.getSenders());const o=D.getVideoTracks()[0];x.getSenders().find(w=>w.track.kind==="video").replaceTrack(o)}}c.useEffect(()=>{L&&I(L)},[L]);async function g(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(p=>p.kind==="videoinput");f(o)}catch(a){console.log(a)}}async function I(a){const p=a?{audio:!0,video:{deviceId:{exact:a}}}:R;console.log("practice");const w=await navigator.mediaDevices.getUserMedia(p);r(w),await navigator.mediaDevices.enumerateDevices(),b("");try{const B=a?{audio:!0,video:{deviceId:{exact:a}}}:R;console.log("practice");const F=await navigator.mediaDevices.getUserMedia(B);r(F);const A=await navigator.mediaDevices.enumerateDevices();b("")}catch(S){b(S)}}function T(a){console.log("icecandidate"),console.log(a),y.emit("ice",a.candidate,M)}function V(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",D);const o=document.getElementById("yourScreen");o.srcObject=a.stream}function C(){x.addEventListener("icecandidate",T),x.addEventListener("addstream",V),D&&D.getTracks().forEach(a=>x.addTrack(a,D))}async function s(){await I(null),C()}async function d(){await s(),y.emit("joinRoom",M,s)}c.useEffect(()=>{d()},[]);const i=async()=>{console.log("sent the offer"),console.log(x);const a=await x.createOffer();x.setLocalDescription(a),console.log(a),y.emit("offer",a,M)};c.useEffect(()=>{if(y)return y.on("welcome",i),()=>{y.off("welcome",i)}});const v=async a=>{console.log("received the offer"),x.setRemoteDescription(a);const o=await x.createAnswer();console.log("sent the answer"),x.setLocalDescription(o),y.emit("answer",o,M)};c.useEffect(()=>{if(y)return y.on("offer",v),()=>{y.off("offer",v)}});const u=a=>{console.log("received the answer"),x.setRemoteDescription(a)};c.useEffect(()=>{if(y)return y.on("answer",u),()=>{y.off("answer",u)}});const h=a=>{console.log("received candidate"),x.addIceCandidate(a)};return c.useEffect(()=>{if(y)return y.on("ice",h),()=>{y.off("ice",h)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!k&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(se,{onClick:X,children:N?"unmute":"mute"}),e.jsx(se,{onClick:W,children:l?"turn stream on":"turn stream off"}),e.jsx(se,{onClick:P,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:J,children:n.map((a,o)=>e.jsx("option",{value:a.deviceId,selected:(D==null?void 0:D.getVideoTracks()[0].id)===a.deviceId,children:a.label},o))})]}),m&&e.jsx("div",{children:m.toString()})]})}function tt({userObj:n}){const[f,N]=c.useState(""),[t,l]=c.useState([]),U=pe(),{state:m}=oe(),[b,D]=c.useState(!0),[r,L]=c.useState(!1),[j,k]=c.useState(null);c.useEffect(()=>{const z=async()=>{if(m!=null&&m.chattingUid){const x=H($,`members/${m.chattingUid}`),M=await _(x);k(M.data())}};m!=null&&m.multiple||z()},[m]);const E=ne(z=>z.piazzaForm.value);c.useEffect(()=>{var x;const z=()=>{var X;const M=window.screen.height-300>(((X=window.visualViewport)==null?void 0:X.height)||window.screen.height);r!==M&&L(M)};return window.addEventListener("resize",z),typeof visualViewport<"u"&&((x=window.visualViewport)==null||x.addEventListener("resize",z)),visualViewport==null||visualViewport.addEventListener("resize",z),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",z)),()=>{var M;typeof visualViewport<"u"&&((M=window.visualViewport)==null||M.removeEventListener("resize",z))}},[r]),c.useEffect(()=>{(m==null?void 0:m.multiple)!==void 0&&D(m==null?void 0:m.multiple)},[]),c.useEffect(()=>{U(Fe(5))});const R=m==null?void 0:m.displayName;return e.jsxs(e.Fragment,{children:[!r&&e.jsx(Qe,{multiple:b,displayName:R}),e.jsx(Ge,{isKeyboardOpen:E,userObj:n,multiple:b,handleMultiple:z=>D(z),messagesList:t,handleMessagesList:z=>l(z)}),e.jsx(Ze,{chattingUser:j,userObj:n,multiple:b,messages:f,handleMessages:z=>N(z),messagesList:t,handleMessagesList:z=>l(z)}),e.jsxs(Be,{children:[e.jsx(Ae,{children:e.jsx("div",{id:"calls"})}),e.jsx(Le,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(We,{})}),e.jsx(He,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{tt as default};
