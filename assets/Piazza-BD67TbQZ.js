import{u as G,K as ae,aE as se,c as K,j as a,k as B,g as S,V as P,S as $,aJ as oe,f as V,v as q,aL as ue,r as m,I as te,O as ce,B as le,as as he,P as re,aM as de,q as W,U as X,E as O,h as ee,aH as ge,ad as we,aN as xe,Q as me,w as ve,a5 as ke}from"./index-BKVfJT17.js";const ye={ko:"메세지를 작성해 주세요",en:"Input message"},Ce={ko:"전송",en:"send"};function be({userObj:t,multiple:h,messages:f,handleMessages:e,messagesList:i,handleMessagesList:U}){const u=G(p=>p.profileColor.value),z=G(p=>p.profileUrl.value),j=ae(),{state:l}=se(),k=l==null?void 0:l.conversation,w=K(p=>p.languages.value),C=w==="ko"||w==="en"?w:"ko",v=async p=>{var c;p.preventDefault();const D=f,b=t.uid,E=t.displayName,M=Date.now(),R=new Date().toString();let L,I,T;l.chattingUid&&(L=B(S,`members/${l.chattingUid}`),I=await P(L),T=(c=I.data())==null?void 0:c.messagingToken);const s={msg:D,userUid:b,id:E,messageClockNumber:M,messageClock:R,conversation:k,conversationUid:l.chattingUid,conversationName:l.displayName,profileUrl:z,sendingToken:T};h?s&&D&&($.emit("piazzaMessage",s),J()):D&&(i.length!==0?($.emit("message",s),console.log("message")):($.emit("messageNew",s),console.log("messageNew")),H(),Q()),e("")},A=p=>{e(p.target.value)},J=async()=>{try{const p=f,D=t.uid,b=t.displayName,E=new Date().toString(),M=Date.now();p&&(await oe(V(S,"chats_group"),{userUid:D,userName:b,message:p,messageClock:E,messageClockNumber:M,profileImageUrl:z,profileColor:u,piazzaChecked:[t.uid]}),U(R=>[...R,{msg:p,type:"me",userUid:t.uid,id:t.displayName,messageClock:E,conversation:null,profileImageUrl:z,profileColor:u}]))}catch(p){console.log(p)}},H=async()=>{var D,b,E;const p=f;try{const M=t.uid,R=t.displayName,L=Date.now(),I=new Date().toString();let T,s,c,g,n,x;if(l.userUid<l.chattingUid?(T=l.userUid,s=l.chattingUid,c=t.displayName,g=l.displayName,n=z,x=l.profileUrl):(T=l.chattingUid,s=l.userUid,c=l.displayName,g=t.displayName,n=l.profileUrl,x=z),!n){const o=B(S,`members/${T}`);n=(D=(await P(o)).data())==null?void 0:D.profileImageUrl}if(!x){const o=B(S,`members/${s}`);x=(b=(await P(o)).data())==null?void 0:b.profileImageUrl}if(p){const o={userUid:M,userName:R,message:p,messageClock:I,messageClockNumber:L,userOne:T,userTwo:s,userOneDisplayName:c,userTwoDisplayName:g,userOneProfileUrl:n,userTwoProfileUrl:x};await oe(V(S,`chats_${k}`),o);const r=B(S,`members/${M}`),y=(await P(r)).data().chattings||{},N=B(S,`members/${l.chattingUid}`),F=(await P(N)).data().chattings||{},_=((E=F[k])==null?void 0:E.messageCount)||0;y[k]=o,F[k]={...o,messageCount:_+1},await q(r,{chattings:y}),await q(N,{chattings:F}),U(Y=>[...Y,{msg:p,type:"me",userUid:t.uid,id:t.displayName,messageClock:I,conversation:k}])}}catch(M){console.log(M)}},Q=async()=>{try{const p=t.uid,D=l.chattingUid,b=B(S,`members/${p}`),M=(await P(b)).data().conversation||[],R=B(S,`members/${D}`),I=(await P(R)).data().conversation||[];M.indexOf(k)===-1&&(await q(b,{conversation:[...M,k]}),j(ue())),I.indexOf(k)===-1&&await q(R,{conversation:[...I,k]})}catch(p){console.log(p)}};return a.jsx(a.Fragment,{children:a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:v,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ye[C],onChange:A,value:f,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ce[C]})]})})}const fe=({initiateContinuing:t,multiple:h,handleMultiple:f,user:e,userObj:i,handleMessagesList:U,displayedName:u})=>{const[z,j]=m.useState(null),l=K(k=>k.languages.value);return m.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?j((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):j(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(te,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==u&&a.jsx("div",{children:l==="ko"?a.jsxs("div",{children:["(",u,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",u,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(ce,{to:"/profile",state:{element:e},children:a.jsx(le,{variant:"outlined",onClick:()=>{},children:l==="ko"?"프로필 확인":"Check Profile"})}),h&&i.uid!==(e==null?void 0:e.uid)&&a.jsx(ce,{to:"/piazza",state:{conversation:z,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(he,{children:a.jsx(le,{variant:"outlined",onClick:()=>{U([]),f(!1),t()},children:l==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:t,multiple:h,handleMultiple:f,messagesList:e,handleMessagesList:i}){const U=m.useRef(null),u=m.useRef(null),[z,j]=m.useState(null),[l,k]=m.useState(""),[w,C]=m.useState(!1),[v,A]=m.useState(null),[J,H]=m.useState(0),Q=G(s=>s.profileColor.value),p=G(s=>s.profileUrl.value),{state:D}=se(),b=D==null?void 0:D.conversation,E=K(s=>s.languages.value),M=async({userUid:s,displayName:c})=>{const g=B(S,`members/${s}`),x=(await P(g)).data();j(x),k(c)},R=({userUid:s,displayName:c})=>{var g;(g=document.getElementById("drawer"))==null||g.click(),M({userUid:s,displayName:c})},L=20;m.useEffect(()=>{if(!$)return;function s(c){const{msg:g,userUid:n,id:x,target:o,messageClock:r,messageClockNumber:d,conversation:y}=c;i(N=>[...N,{msg:g,type:o?"private":"other",userUid:n,id:x,messageClock:r,messageClockNumber:d,conversation:null,profileImageUrl:p,profileColor:Q}])}return $.on("sMessagePiazza",s),()=>{$.off("sMessagePiazza",s)}},[]),m.useEffect(()=>{if(!$)return;function s(c){const{msg:g,userUid:n,id:x,target:o,messageClock:r,messageClockNumber:d,conversation:y}=c;i(N=>[...N,{msg:g,type:o?"private":"other",userUid:n,id:x,messageClock:r,messageClockNumber:d,conversation:null}])}return $.on(`sMessage${b}`,s),()=>{$.off(`sMessage${b}`,s)}},[]),m.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),m.useEffect(()=>{I(),(async()=>{if(h){const c=V(S,"chats_group"),g=W(c,O("messageClockNumber","desc"),X(1));(await ee(g)).forEach(async x=>{const o=B(S,`chats_group/${x.id}`),d=(await P(o)).data(),y=d.piazzaChecked||[];y.indexOf(t.uid)===-1&&(y.splice(-1,t.uid,0),y.push(t.uid),await q(o,{...d,piazzaChecked:y}))})}else{const c=B(S,`members/${t.uid}`),n=(await P(c)).data().chattings;n[b].messageCount=0,await q(c,{chattings:n})}})()},[e]);const I=()=>{var s;(s=U.current)==null||s.scrollIntoView()};m.useEffect(()=>{const s=async()=>{const g=[],n=V(S,"chats_group"),x=W(n,O("messageClockNumber","desc"),X(L),ge(v||"")),o=await ee(x);o.docs.length||H(o.docs.length),o.forEach(r=>{var ie,ne;g.length===o.docs.length-1&&(A(r),H(o.docs.length-1));const d=r.data().message,y=r.data().userUid,N=r.data().userName,Z=r.data().messageClock,F=r.data().messageClockNumber,_=(ie=r.data())==null?void 0:ie.profileColor,Y=(ne=r.data())==null?void 0:ne.profileImageUrl;g.push({msg:d,type:"me",userUid:y,id:N,messageClockNumber:F,messageClock:Z,conversation:null,profileColor:_,profileImageUrl:Y})}),g.reverse(),i([...g,...e]),C(!1)},c=async g=>{const n=V(S,`chats_${g}`),x=W(n,O("messageClockNumber","desc"),X(L),ge(v||"")),o=await ee(x),r=[];o.docs.length||H(o.docs.length),o.forEach((d,y)=>{r.length===o.docs.length-1&&(A(d),H(o.docs.length-1));const N=d.data().message,Z=d.data().userUid,F=d.data().userName,_=d.data().messageClock,Y=d.data().messageClockNumber||0;r.push({msg:N,type:"me",userUid:Z,id:F,messageClock:_,messageClockNumber:Y})}),r.reverse(),i([...r,...e]),C(!1)};b?(w||!e.length)&&c(b):(w||!e.length)&&s()},[w,b]);const T=()=>{u.current.scrollTop!==0||w||(console.log("scroll"),C(!0))};return m.useEffect(()=>{var s;return(s=u.current)==null||s.addEventListener("scroll",T),()=>{var c;return(c=u.current)==null?void 0:c.removeEventListener("scroll",T)}},[w]),a.jsx(a.Fragment,{children:a.jsx("div",{className:"fixed bottom-[110px] w-screen flex flex-col pt-5",children:a.jsx("div",{ref:u,className:"p-1 border-t rounded-xl h-[50vh] overflow-auto",children:a.jsxs("ul",{children:[w&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((s,c)=>{let g;const n=new Date(s.messageClock);s.userUid===t.uid?g="text-right":g="text-left";let x,o;c>0&&(x=e[c-1].userUid),c<e.length-1&&e[c+1].userUid===t.uid&&(o=new Date(e[c+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let r,d=n.getHours(),y=(n.getMonth()+1).toString(),N=n.getDate().toString();return d>=13?(r="오후",d!==12&&(d=d-12)):(r="오전",d===0&&(d=d+12)),n.getMonth()+1<10&&(y="0"+y),N.length===1&&(N="0"+N),a.jsxs("li",{ref:c===J?U:null,className:g,children:[x!==s.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${s.userUid!==t.uid?"start":"end"}`,children:g==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(re,{trigger:a.jsx(te,{uid:t.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>R({userUid:s.userUid,displayName:s.id})}),title:a.jsx(de,{}),content:a.jsx(fe,{initiateContinuing:()=>A(null),multiple:h,handleMultiple:f,user:z,userObj:t,handleMessagesList:i,displayedName:l})}),a.jsx("div",{children:s.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:s.id}),a.jsx(re,{trigger:a.jsx(te,{uid:t.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>R({userUid:s.userUid,displayName:s.id})}),title:a.jsx(de,{}),content:a.jsx(fe,{initiateContinuing:()=>A(null),multiple:h,handleMultiple:f,user:z,userObj:t,handleMessagesList:i,displayedName:l})})]})})}),s.userUid!==t.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),a.jsxs("div",{children:[n.getFullYear(),"-",y,"-",N," ",E==="ko"&&r," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),E==="en"&&(r==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[n.getFullYear(),"-",y,"-",N," ",E==="ko"&&r," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),E==="en"&&(r==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},c)}),a.jsx("li",{ref:U})]})})})})}const Ue=we(xe)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function ze(){const t=K(i=>i.languages.value),h=G(i=>i.piazzaSwitch.value),f=ae(),e=()=>{h==="true"?(window.localStorage.setItem("piazza","false"),f(me("false"))):(window.localStorage.setItem("piazza","true"),f(me("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:t==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Ue,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:h==="true"})})]})}const pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Se=({multiple:t,displayName:h})=>{const f=K(i=>i.languages.value),e=f==="ko"||f==="en"?f:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(ve,{title:t?pe[e][0]:`${pe[e][1]} ${h}`}),t&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx(ze,{})})]})};function De(t){const[h,f]=m.useState(new Date),e=m.useRef(0);return m.useEffect(()=>{function i(){e.current=setTimeout(()=>{i()},t),f(new Date)}return i(),()=>clearTimeout(e.current)},[]),h.getMilliseconds()}const Ee=()=>{let t=navigator.userAgent;return t.indexOf("Firefox")>-1?"Mozilla Firefox":t.indexOf("SamsungBrowser")>-1?"Samsung Internet":t.indexOf("Opera")>-1||t.indexOf("OPR")>-1?"Opera":t.indexOf("Trident")>-1?"Microsoft Internet Explorer":t.indexOf("Edge")>-1?"Microsoft Edge (Legacy)":t.indexOf("Edg")>-1?"Microsoft Edge (Chromium)":t.indexOf("Chrome")>-1?"Google Chrome or Chromium":t.indexOf("Safari")>-1?"Apple Safari":"unknown"},Me=()=>{let t=!1;return function(h){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(h)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(h.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t},je=()=>{const[t,h]=m.useState(0),f=document.getElementById("keyboardOffsetAnchor")||{},e=document.body||{};e.childNodes;const i=Ee(),U=Me(),u=U&&i==="Apple Safari"&&t<0,j=De(u?250:25e4),l=u?j:0;m.useEffect(()=>{if(f.id){const v=f.getBoundingClientRect()||{};t<0&&v!==t&&h(v.top)}},[l]);const k=()=>{let v=document.createElement("div");v.id="keyboardOffsetAnchor",v.style.width="0px",v.style.height="0px",v.style.position="absolute",v.style.left="0px",v.style.top="0px",e.insertBefore(v,e.firstChild)};m.useEffect(()=>{!f&&U&&k()},[]),m.useLayoutEffect(()=>(U&&(window.addEventListener("click",w),window.addEventListener("blur",w),window.addEventListener("focus",w),window.addEventListener("keyup",w),w()),()=>{U&&(window.removeEventListener("click",w),window.removeEventListener("blur",w),window.removeEventListener("focus",w),window.removeEventListener("keyup",w))}),[]);const w=()=>{setTimeout(()=>C(),100)},C=()=>{if(f.id){const v=f.getBoundingClientRect()||{};h(v.top)}};return{keyBoardOffset:t,windowHeight:window.innerHeight+t}};function Ie({userObj:t}){const[h,f]=m.useState(""),[e,i]=m.useState([]),U=ae(),{state:u}=se(),[z,j]=m.useState(!0);m.useEffect(()=>{(u==null?void 0:u.multiple)!==void 0&&j(u==null?void 0:u.multiple)},[]);const{keyBoardOffset:l,windowHeight:k}=je();console.log(l,k),m.useEffect(()=>{U(ke(5))});const w=u==null?void 0:u.displayName;return a.jsxs(a.Fragment,{children:[a.jsx(Se,{multiple:z,displayName:w}),a.jsx(Ne,{userObj:t,multiple:z,handleMultiple:C=>j(C),messagesList:e,handleMessagesList:C=>i(C)}),a.jsx(be,{userObj:t,multiple:z,messages:h,handleMessages:C=>f(C),messagesList:e,handleMessagesList:C=>i(C)})]})}export{Ie as default};
