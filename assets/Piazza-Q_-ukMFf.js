import{c as Ue,u as le,d as se,G as xe,j as e,P as me,a0 as ve,b8 as we,b7 as pe,b0 as $e,x as O,p as $,O as q,a4 as g,b4 as ye,n as oe,E as te,b9 as Ve,a_ as Me,r as a,W as he,a1 as Ce,B as Q,ba as ke,q as de,a2 as fe,a3 as ge,t as ue,b2 as ze,s as Ae,S as Fe,X as Se,H as Be,bb as Le,aN as Te,af as He,bc as je,bd as Ne,be as De,bf as Ie}from"./index-BL6tsEf9.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ue("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Ue("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Oe={ko:"메세지를 작성해 주세요",en:"Input message"},qe={ko:"전송",en:"send"};function Ge({chattingUser:l,userObj:t,multiple:r,messages:S,handleMessages:y,messagesList:V,handleMessagesList:T}){const N=le(i=>i.profileColor.value),b=le(i=>i.piazzaForm.value),d=se(i=>i.profile.value),A=xe(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",U=se(i=>i.languages.value),M=U==="ko"||U==="en"?U:"ko",I=async i=>{var o;i.preventDefault();const j=S,E=t.uid,m=t.displayName,C=Date.now(),z=new Date().toString(),P=d==null?void 0:d.profileImageUrl,n=d==null?void 0:d.defaultProfile,h=d==null?void 0:d.profileImage;let p,w,u;l&&(p=O($,`members/${l.uid}`),w=await q(p),u=(o=w.data())==null?void 0:o.messagingToken);const x=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const f={msg:j,userUid:E,id:m,messageClockNumber:C,messageClock:z,conversation:v,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:h,defaultProfile:n,profileImageUrl:P,profileUrl:x,sendingToken:u};r?f&&j&&(g.emit("piazzaMessage",f),R()):j&&(V.length!==0?(g.emit("message",f),console.log("message")):(g.emit("messageNew",f),console.log("messageNew")),D(),H()),y("")},Z=i=>{y(i.target.value)},R=async()=>{try{const i=S,j=t.uid,E=t.displayName,m=new Date().toString(),C=Date.now(),z=d==null?void 0:d.profileImageUrl,P=d==null?void 0:d.defaultProfile,n=d==null?void 0:d.profileImage;i&&(await ye(oe($,"chats_group"),{userUid:j,userName:E,message:i,messageClock:m,messageClockNumber:C,profileImageUrl:z,defaultProfile:P,profileColor:N,piazzaChecked:[t.uid],profileImage:n}),T(h=>[...h,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileColor:N,messageClockNumber:C,defaultProfile:P,profileImageUrl:z,profileImage:n||!1}]))}catch(i){console.log(i)}},D=async()=>{var j,E,m;const i=S;try{const C=t.uid,z=t.displayName,P=Date.now(),n=new Date().toString(),h=d.profileImage,p=l.profileImage,w=d.profileImageUrl,u=l.profileImageUrl,x=d.defaultProfile,f=l.defaultProfile;let o,s,c,k,F,B,G,X,J,W;if(t.uid<l.uid?(o=t.uid,s=l.uid,c=t.displayName,k=l.displayName,F=w,B=u,G=x,X=f,J=d.profileImage,W=l.profileImage):(o=l.uid,s=t.uid,c=l.displayName,k=t.displayName,F=u,B=w,G=f,X=x,J=l.profileImage,W=d.profileImage),!F){const _=O($,`members/${o}`);F=(j=(await q(_)).data())==null?void 0:j.profileImageUrl}if(!B){const _=O($,`members/${s}`);B=(E=(await q(_)).data())==null?void 0:E.profileImageUrl}if(i){const _={userUid:C,userName:z,message:i,messageClock:n,messageClockNumber:P,userOne:o,userTwo:s,userOneDisplayName:c,userTwoDisplayName:k,userOneProfileUrl:F,userTwoProfileUrl:B,userOneDefaultProfile:G,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W};await ye(oe($,`chats_${v}`),_);const K=O($,`members/${C}`),ae=(await q(K)).data().chattings||{},ie=O($,`members/${l.uid}`),ee=(await q(ie)).data().chattings||{},ce=((m=ee[v])==null?void 0:m.messageCount)||0;ae[v]=_,ee[v]={..._,messageCount:ce+1},await te(K,{chattings:ae}),await te(ie,{chattings:ee}),T(Re=>[...Re,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:n,conversation:v,userName:z,messageClockNumber:P,userOne:o,userTwo:s,userOneDisplayName:c,userTwoDisplayName:k,userOneProfileUrl:F,userTwoProfileUrl:B,userOneDefaultProfile:G,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:W}])}}catch(C){console.log(C)}},H=async()=>{try{const i=t.uid,j=l.uid,E=O($,`members/${i}`),C=(await q(E)).data().conversation||[],z=O($,`members/${j}`),n=(await q(z)).data().conversation||[];C.indexOf(v)===-1&&(await te(E,{conversation:[...C,v]}),A(Ve())),n.indexOf(v)===-1&&await te(z,{conversation:[...n,v]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${b?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:I,children:[v&&v!=="piazza"&&e.jsx(me,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_e,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Oe[M],onChange:Z,value:S,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:qe[M]})]})}const be=({initiateContinuing:l,user:t,userObj:r,handleMessagesList:S,displayedName:y,handleChatUid:V,handleChatDisplayName:T})=>{const{state:N}=Me(),b=(N==null?void 0:N.conversation)||"piazza",d=se(U=>U.languages.value),[A,v]=a.useState("");return a.useEffect(()=>{t&&((t==null?void 0:t.uid)<r.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):v(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:r.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==y&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",y,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(Q,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),b==="piazza"&&r.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${A}`,state:{conversation:A,displayName:t==null?void 0:t.displayName,userUid:r.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(Q,{variant:"outlined",onClick:()=>{S([]),l()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ee({userObj:l,messagesList:t,handleMessagesList:r,handleChatUid:S,handleChatDisplayName:y}){const V=a.useRef(null),T=a.useRef(null),[N,b]=a.useState(null),[d,A]=a.useState(""),[v,U]=a.useState(!1),[M,I]=a.useState(null),[Z,R]=a.useState(0),[D,H]=a.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";a.useEffect(()=>{(D!==i||i==="piazza")&&(r([]),I(null),R(0),H(i))},[i]);const j=se(n=>n.languages.value),E=async({userUid:n,displayName:h})=>{const p=O($,`members/${n}`),u=(await q(p)).data();b(u),A(h),console.log("practice")},m=({userUid:n,displayName:h})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),E({userUid:n,displayName:h})},C=20;a.useEffect(()=>{if(!g)return;function n(h){const{msg:p,userUid:w,id:u,target:x,messageClock:f,messageClockNumber:o,profileImageUrl:s,defaultProfile:c,profileImage:k,conversation:F}=h;r(B=>[...B,{msg:p,type:x?"private":"other",userUid:w,id:u,messageClock:f,messageClockNumber:o,conversation:null,profileImageUrl:s,defaultProfile:c,profileImage:k}])}return g.on("sMessagePiazza",n),()=>{g.off("sMessagePiazza",n)}},[]),a.useEffect(()=>{if(!g)return;function n(h){const{msg:p,userUid:w,id:u,target:x,messageClock:f,messageClockNumber:o,conversation:s,profileImageUrl:c,defaultProfile:k,profileImage:F,piazzaData:B}=h;r(G=>[...G,{msg:p,type:x?"private":"other",userUid:w,id:u,messageClock:f,messageClockNumber:o,conversation:null,profileImageUrl:c,defaultProfile:k,profileImage:F,...B}])}return g.on(`sMessage${i}`,n),()=>{g.off(`sMessage${i}`,n)}},[i]),a.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),a.useEffect(()=>{z(),(async()=>{if(i==="piazza"){const h=oe($,"chats_group"),p=de(h,ge("messageClockNumber","desc"),fe(1));(await ue(p)).forEach(async u=>{const x=O($,`chats_group/${u.id}`),o=(await q(x)).data(),s=o.piazzaChecked||[];s.indexOf(l.uid)===-1&&(s.splice(-1,l.uid,0),s.push(l.uid),await te(x,{...o,piazzaChecked:s}))})}else{const h=O($,`members/${l.uid}`),w=(await q(h)).data().chattings;w[i]&&(w[i].messageCount=0),await te(h,{chattings:w})}})()},[t]);const z=()=>{var n;(n=V.current)==null||n.scrollIntoView()};a.useEffect(()=>{const n=async()=>{const p=[],w=oe($,"chats_group"),u=de(w,ge("messageClockNumber","desc"),fe(C),ze(M||"")),x=await ue(u);x.docs.length||R(x.docs.length),x.forEach(f=>{var W,_,K;p.length===x.docs.length-1&&(I(f),R(x.docs.length-1));const o=f.data().message,s=f.data().userUid,c=f.data().userName,k=f.data().messageClock,F=f.data().messageClockNumber,B=(W=f.data())==null?void 0:W.profileImageUrl,G=(_=f.data())==null?void 0:_.defaultProfile,X=(K=f.data())==null?void 0:K.profileImage,J=f.data();p.push({msg:o,userUid:s,id:c,messageClockNumber:F,messageClock:k,conversation:null,profileImageUrl:B,defaultProfile:G,profileImage:X||!1,...J})}),p.reverse(),r([...p,...t]),U(!1)},h=async p=>{const w=oe($,`chats_${p}`),u=de(w,ge("messageClockNumber","desc"),fe(C),ze(M||"")),x=await ue(u),f=[];x.docs.length||R(x.docs.length),x.forEach((o,s)=>{var re,ee,ce;f.length===x.docs.length-1&&(I(o),R(x.docs.length-1));const c=o.data().message,k=o.data().userUid,F=o.data().userName,B=o.data().messageClock,G=o.data().messageClockNumber||0,X=(re=o.data())==null?void 0:re.profileImageUrl,J=(ee=o.data())==null?void 0:ee.defaultProfile,W=(ce=o.data())==null?void 0:ce.profileImage,_=o.data(),K=o.data().userOne,ne=o.data().userOneDisplayName,ae=o.data().userTwo,ie=o.data().userTwoDisplayName;K!==l.uid?(S(K),y(ne)):(S(ae),y(ie)),f.push({msg:c,userUid:k,id:F,messageClockNumber:G,messageClock:B,conversation:null,profileImageUrl:X,defaultProfile:J,profileImage:W||!1,..._})}),f.reverse(),r([...f,...t]),U(!1)};console.log(t.length),i==="piazza"?(v||!t.length)&&n():(v||!t.length)&&h(i)},[v,D]);const P=()=>{T.current.scrollTop!==0||v||(console.log("scroll"),U(!0))};return a.useEffect(()=>{var n;return(n=T.current)==null||n.addEventListener("scroll",P),()=>{var h;return(h=T.current)==null?void 0:h.removeEventListener("scroll",P)}},[v]),console.log(i),console.log(t),console.log(N),e.jsx(e.Fragment,{children:e.jsx("div",{ref:T,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((n,h)=>{let p;i==="piazza"?p=n:n.userUid===n.userOne?p={userUid:n.userOne,id:n.userOneDisplayName,profileImage:n.userOneProfileImage||n.profileImage,defaultProfile:n.userOneDefaultProfile||n.defaultProfile,profileImageUrl:n.userOneProfileUrl||n.profileImageUrl}:p={userUid:n.userTwo,id:n.userTwoDisplayName,profileImage:n.userTwoProfileImage||n.profileImage,defaultProfile:n.userTwoDefaultProfile||n.defaultProfile,profileImageUrl:n.userTwoProfileUrl||n.profileImageUrl};let w;const u=new Date(n.messageClock);n.userUid===l.uid?w="text-right":w="text-left";let x,f;h>0&&(x=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===l.uid&&(f=new Date(t[h+1].messageClock),u.getFullYear()===f.getFullYear()&&u.getMonth()===f.getMonth()&&u.getDate()===f.getDate()&&u.getHours()===f.getHours()&&(u.getMinutes(),f.getMinutes()));let o,s=u.getHours(),c=(u.getMonth()+1).toString(),k=u.getDate().toString();return s>=13?(o="오후",s!==12&&(s=s-12)):(o="오전",s===0&&(s=s+12)),u.getMonth()+1<10&&(c="0"+c),k.length===1&&(k="0"+k),e.jsxs("li",{ref:h===Z?V:null,className:w,children:[x!==n.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${n.userUid!==l.uid?"start":"end"}`,children:w==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(me,{trigger:e.jsx(he,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>I(null),user:N,userObj:l,handleMessagesList:r,displayedName:d})}),e.jsx("div",{children:n.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:n.id}),e.jsx(me,{trigger:e.jsx(he,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>I(null),user:N,userObj:l,handleMessagesList:r,displayedName:d,handleChatUid:S,handleChatDisplayName:y})})]})})}),n.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg}),e.jsxs("div",{children:[u.getFullYear(),"-",c,"-",k," ",j==="ko"&&o," ",s,":",u.getMinutes()<10&&"0",u.getMinutes(),j==="en"&&(o==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[u.getFullYear(),"-",c,"-",k," ",j==="ko"&&o," ",s,":",u.getMinutes()<10&&"0",u.getMinutes(),j==="en"&&(o==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg})]})]},h)}),e.jsx("li",{ref:V})]})})})}function Ke({isKeyboardOpen:l,userObj:t,messagesList:r,handleMessagesList:S,handleChatUid:y,handleChatDisplayName:V}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ee,{userObj:t,messagesList:r,handleMessagesList:S,handleChatUid:y,handleChatDisplayName:V})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ee,{userObj:t,messagesList:r,handleMessagesList:S,handleChatUid:y,handleChatDisplayName:V})})})}const We=Ae(Fe)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ze(){const l=se(y=>y.languages.value),t=le(y=>y.piazzaSwitch.value),r=xe(),S=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),r(Se("false"))):(window.localStorage.setItem("piazza","true"),r(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(We,{onClick:()=>S(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:l})=>{const t=se(y=>y.languages.value),r=t==="ko"||t==="en"?t:"ko",S=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Be,{icon:e.jsx(Le,{}),title:S==="piazza"?Pe[r][0]:`${Pe[r][1]} ${l}`}),S==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ze,{})})]})};function Je(){const[l,t]=a.useState([]),[r,S]=a.useState(!0),[y,V]=a.useState(!0),[T,N]=a.useState(""),[b,d]=a.useState(null),[A,v]=a.useState(null),U=Te(),M=a.useRef(null),I=a.useRef(null),Z={audio:!0,video:!1},R=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:R.map(o=>o.urls)}]}),H=location.search.slice(4);console.log(location.search.slice(4)),a.useEffect(()=>{(async()=>{await m()})()},[]),a.useEffect(()=>{M.current&&(M.current.srcObject=b)},[b]);async function i(){const o=b;o&&o.getAudioTracks().forEach(s=>s.enabled=!s.enabled),S(!r)}async function j(){const o=b;o&&o.getVideoTracks().forEach(s=>s.enabled=!s.enabled),V(!y)}const E=()=>{M.current.srcObject.getTracks().forEach(o=>o.stop()),console.log(M.current)};a.useEffect(()=>{A&&C(A)},[A]);async function m(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(c=>c.kind==="videoinput");t(s)}catch(o){console.log(o)}}async function C(o){try{const c=o?{audio:!0,video:{deviceId:{exact:o}}}:Z,k=await navigator.mediaDevices.getUserMedia(c);d(k),N("")}catch(s){const c=s==null?void 0:s.toString();c&&N(c),console.log(s)}}function z(o){console.log("icecandidate"),console.log(o),g.emit("ice",o.candidate,H)}function P(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",b),I.current=o.stream}function n(){D.addEventListener("icecandidate",z),D.addEventListener("addstream",P),b&&b.getTracks().forEach(o=>D.addTrack(o,b))}async function h(){await C(null),n()}async function p(){await h(),g.emit("joinRoom",H,h)}a.useEffect(()=>{p()},[]);const w=async()=>{console.log("sent the offer"),console.log(D);const o=await D.createOffer();D.setLocalDescription(o),console.log(o),g.emit("offer",o,H)};a.useEffect(()=>{if(g)return g.on("welcome",w),()=>{g.off("welcome",w)}});const u=async o=>{console.log("received the offer"),D.setRemoteDescription(o);const s=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(s),g.emit("answer",s,H)};a.useEffect(()=>{if(g)return g.on("offer",u),()=>{g.off("offer",u)}});const x=o=>{console.log("received the answer"),D.setRemoteDescription(o)};a.useEffect(()=>{if(g)return g.on("answer",x),()=>{g.off("answer",x)}});const f=o=>{console.log("received candidate"),D.addIceCandidate(o)};return a.useEffect(()=>{if(g)return g.on("ice",f),()=>{g.off("ice",f)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!U&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:I,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:M,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:i,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:j,children:y?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:E,children:"stop"})]})}),T&&e.jsx("div",{children:T})]})}let L,Y;function Qe(){const[l,t]=a.useState([]),[r,S]=a.useState(!0),[y,V]=a.useState(!0),[T,N]=a.useState(""),[b,d]=a.useState(null);a.useState(null);const[A,v]=a.useState(""),U=Te(),M=document.getElementById("myScreen"),I=document.getElementById("devices"),Z={audio:!0,video:!0},R=location.search.slice(4);console.log(location.search.slice(4));const D=a.useRef(null),H=a.useRef(null);async function i(){const s=L;s&&s.getAudioTracks().forEach(c=>c.enabled=!c.enabled),S(!r)}async function j(){const s=L;s&&s.getVideoTracks().forEach(c=>c.enabled=!c.enabled),V(!y)}async function E(){console.log(I.value),L.getTracks().forEach(c=>c.stop()),d(I.value),await z(I.value)}const m=()=>{L.getTracks().forEach(c=>c.stop())};a.useEffect(()=>{z(b)},[I]);async function C(){try{const c=(await navigator.mediaDevices.enumerateDevices()).filter(k=>k.kind==="videoinput");t(c)}catch(s){console.log(s)}}async function z(s){try{const k=s?{audio:!0,video:{deviceId:{exact:s}}}:Z;L=await navigator.mediaDevices.getUserMedia(k);const F=await navigator.mediaDevices.enumerateDevices();M.srcObject=L,await C(),N(""),v("")}catch(c){console.log(c),N(c);const k=c==null?void 0:c.toString();k&&v(k)}}function P(s){console.log("icecandidate"),console.log(s),g.emit("ice",s.candidate,R)}function n(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",L);const c=document.getElementById("yourScreen");c.srcObject=s.stream}function h(){const s=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];Y=new RTCPeerConnection({iceServers:[{urls:s.map(c=>c.urls)}]}),Y.addEventListener("icecandidate",P),Y.addEventListener("addstream",n),L&&L.getTracks().forEach(c=>Y.addTrack(c,L))}async function p(){await z(null),h()}async function w(){await p(),g.emit("joinRoom",R,p)}a.useEffect(()=>{w()},[]);const u=async()=>{console.log("sent the offer"),console.log(Y);const s=await Y.createOffer();Y.setLocalDescription(s),console.log(s),g.emit("offer",s,R)};a.useEffect(()=>{if(g)return g.on("welcome",u),()=>{g.off("welcome",u)}});const x=async s=>{console.log("received the offer"),Y.setRemoteDescription(s);const c=await Y.createAnswer();console.log("sent the answer"),Y.setLocalDescription(c),g.emit("answer",c,R)};a.useEffect(()=>{if(g)return g.on("offer",x),()=>{g.off("offer",x)}});const f=s=>{console.log("received the answer"),Y.setRemoteDescription(s)};a.useEffect(()=>{if(g)return g.on("answer",f),()=>{g.off("answer",f)}});const o=s=>{console.log("received candidate"),Y.addIceCandidate(s)};return a.useEffect(()=>{if(g)return g.on("ice",o),()=>{g.off("ice",o)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!U&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"yourScreen",ref:H,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:D,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:i,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:j,children:y?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:m,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:E,children:l.map((s,c)=>e.jsx("option",{value:s.deviceId,selected:(L==null?void 0:L.getVideoTracks()[0].id)===s.deviceId,children:s.label},c))})]}),A&&e.jsx("div",{children:A})]})}function tt({userObj:l}){const[t,r]=a.useState(""),[S,y]=a.useState([]),V=xe(),{state:T}=Me(),[N,b]=a.useState(!1),[d,A]=a.useState(null),[v,U]=a.useState(""),[M,I]=a.useState(""),[Z,R]=a.useState(""),D=m=>{U(m)},H=m=>{I(m)},i=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(v),a.useEffect(()=>{T?(U(T.chattingUid),I(T.displayName)):(U(""),I(""))},[i]),a.useEffect(()=>{i&&(async()=>{if(v){const C=O($,`members/${v}`),z=await q(C);A(z.data())}})()},[i,v]);const j=le(m=>m.piazzaForm.value);a.useEffect(()=>{var C;const m=()=>{var P;const z=window.screen.height-300>(((P=window.visualViewport)==null?void 0:P.height)||window.screen.height);N!==z&&b(z)};return window.addEventListener("resize",m),typeof visualViewport<"u"&&((C=window.visualViewport)==null||C.addEventListener("resize",m)),visualViewport==null||visualViewport.addEventListener("resize",m),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",m)),()=>{var z;typeof visualViewport<"u"&&((z=window.visualViewport)==null||z.removeEventListener("resize",m))}},[N]);const E=()=>{var m;R(""),(m=document.getElementById("myScreen"))==null||m.srcObject.getTracks().forEach(C=>C.stop())};return a.useEffect(()=>{V(He(5))}),e.jsxs(e.Fragment,{children:[!N&&e.jsx(Xe,{multiple:!i,displayName:M}),e.jsx(Ke,{isKeyboardOpen:j,userObj:l,messagesList:S,handleMessagesList:m=>y(m),handleChatUid:D,handleChatDisplayName:H}),e.jsx(Ge,{chattingUser:d,userObj:l,multiple:!i,messages:t,handleMessages:m=>r(m),messagesList:S,handleMessagesList:m=>y(m)}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Qe,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:E,children:"전화 종료"})})]})})]}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:E,children:"전화 종료"})})]})})]})]})}export{tt as default};
