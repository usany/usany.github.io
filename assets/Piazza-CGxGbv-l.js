import{c as Ue,u as ce,d as se,G as xe,j as e,P as me,a0 as ve,b8 as we,b7 as pe,b0 as $e,x as O,p as R,O as Y,a4 as u,b4 as ye,n as oe,E as te,b9 as Ve,a_ as Me,r as n,W as he,a1 as Ce,B as Q,ba as ke,q as de,a2 as fe,a3 as ge,t as ue,b2 as ze,s as Ae,S as Fe,X as Se,H as Le,bb as Be,aN as Te,af as He,bc as je,bd as Ne,be as De,bf as Ie}from"./index-Bm9dkf9j.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ue("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=Ue("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ye={ko:"메세지를 작성해 주세요",en:"Input message"},qe={ko:"전송",en:"send"};function Ge({chattingUser:c,userObj:t,multiple:d,messages:C,handleMessages:w,messagesList:$,handleMessagesList:E}){const N=ce(i=>i.profileColor.value),S=ce(i=>i.piazzaForm.value),g=se(i=>i.profile.value),A=xe(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",D=se(i=>i.languages.value),M=D==="ko"||D==="en"?D:"ko",T=async i=>{var s;i.preventDefault();const j=C,U=t.uid,m=t.displayName,y=Date.now(),k=new Date().toString(),P=g==null?void 0:g.profileImageUrl,a=g==null?void 0:g.defaultProfile,h=g==null?void 0:g.profileImage;let o,l,r;c&&(o=O(R,`members/${c.uid}`),l=await Y(o),r=(s=l.data())==null?void 0:s.messagingToken);const x=g.profileImage?g.profileImageUrl:g.defaultProfile;console.log(g);const p={msg:j,userUid:U,id:m,messageClockNumber:y,messageClock:k,conversation:v,conversationUid:c==null?void 0:c.uid,conversationName:c==null?void 0:c.displayName,profileImage:h,defaultProfile:a,profileImageUrl:P,profileUrl:x,sendingToken:r};d?p&&j&&(u.emit("piazzaMessage",p),L()):j&&($.length!==0?(u.emit("message",p),console.log("message")):(u.emit("messageNew",p),console.log("messageNew")),I(),B()),w("")},Z=i=>{w(i.target.value)},L=async()=>{try{const i=C,j=t.uid,U=t.displayName,m=new Date().toString(),y=Date.now(),k=g==null?void 0:g.profileImageUrl,P=g==null?void 0:g.defaultProfile,a=g==null?void 0:g.profileImage;i&&(await ye(oe(R,"chats_group"),{userUid:j,userName:U,message:i,messageClock:m,messageClockNumber:y,profileImageUrl:k,defaultProfile:P,profileColor:N,piazzaChecked:[t.uid],profileImage:a}),E(h=>[...h,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileColor:N,messageClockNumber:y,defaultProfile:P,profileImageUrl:k,profileImage:a||!1}]))}catch(i){console.log(i)}},I=async()=>{var j,U,m;const i=C;try{const y=t.uid,k=t.displayName,P=Date.now(),a=new Date().toString(),h=g.profileImage,o=c.profileImage,l=g.profileImageUrl,r=c.profileImageUrl,x=g.defaultProfile,p=c.defaultProfile;let s,f,z,b,H,F,q,X,J,K;if(t.uid<c.uid?(s=t.uid,f=c.uid,z=t.displayName,b=c.displayName,H=l,F=r,q=x,X=p,J=g.profileImage,K=c.profileImage):(s=c.uid,f=t.uid,z=c.displayName,b=t.displayName,H=r,F=l,q=p,X=x,J=c.profileImage,K=g.profileImage),!H){const _=O(R,`members/${s}`);H=(j=(await Y(_)).data())==null?void 0:j.profileImageUrl}if(!F){const _=O(R,`members/${f}`);F=(U=(await Y(_)).data())==null?void 0:U.profileImageUrl}if(i){const _={userUid:y,userName:k,message:i,messageClock:a,messageClockNumber:P,userOne:s,userTwo:f,userOneDisplayName:z,userTwoDisplayName:b,userOneProfileUrl:H,userTwoProfileUrl:F,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K};await ye(oe(R,`chats_${v}`),_);const G=O(R,`members/${y}`),ne=(await Y(G)).data().chattings||{},ie=O(R,`members/${c.uid}`),ee=(await Y(ie)).data().chattings||{},le=((m=ee[v])==null?void 0:m.messageCount)||0;ne[v]=_,ee[v]={..._,messageCount:le+1},await te(G,{chattings:ne}),await te(ie,{chattings:ee}),E(Re=>[...Re,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:a,conversation:v,userName:k,messageClockNumber:P,userOne:s,userTwo:f,userOneDisplayName:z,userTwoDisplayName:b,userOneProfileUrl:H,userTwoProfileUrl:F,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K}])}}catch(y){console.log(y)}},B=async()=>{try{const i=t.uid,j=c.uid,U=O(R,`members/${i}`),y=(await Y(U)).data().conversation||[],k=O(R,`members/${j}`),a=(await Y(k)).data().conversation||[];y.indexOf(v)===-1&&(await te(U,{conversation:[...y,v]}),A(Ve())),a.indexOf(v)===-1&&await te(k,{conversation:[...a,v]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${S?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:T,children:[v&&v!=="piazza"&&e.jsx(me,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Oe,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_e,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ye[M],onChange:Z,value:C,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:qe[M]})]})}const be=({initiateContinuing:c,user:t,userObj:d,handleMessagesList:C,displayedName:w,handleChatUid:$,handleChatDisplayName:E})=>{const{state:N}=Me(),S=(N==null?void 0:N.conversation)||"piazza",g=se(D=>D.languages.value),[A,v]=n.useState("");return n.useEffect(()=>{t&&((t==null?void 0:t.uid)<d.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]):v(d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:d.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==w&&e.jsx("div",{children:g==="ko"?e.jsxs("div",{children:["(",w,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(Q,{variant:"outlined",onClick:()=>{},children:g==="ko"?"프로필 확인":"Check Profile"})}),S==="piazza"&&d.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${A}`,state:{conversation:A,displayName:t==null?void 0:t.displayName,userUid:d.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(Q,{variant:"outlined",onClick:()=>{C([]),c()},children:g==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Pe({userObj:c,messagesList:t,handleMessagesList:d,handleChatUid:C,handleChatDisplayName:w}){const $=n.useRef(null),E=n.useRef(null),[N,S]=n.useState(null),[g,A]=n.useState(""),[v,D]=n.useState(!1),[M,T]=n.useState(null),[Z,L]=n.useState(0),[I,B]=n.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";n.useEffect(()=>{(I!==i||i==="piazza")&&(d([]),T(null),L(0),B(i))},[i]);const j=se(a=>a.languages.value),U=async({userUid:a,displayName:h})=>{const o=O(R,`members/${a}`),r=(await Y(o)).data();S(r),A(h),console.log("practice")},m=({userUid:a,displayName:h})=>{var o;(o=document.getElementById("drawer"))==null||o.click(),U({userUid:a,displayName:h})},y=20;n.useEffect(()=>{if(!u)return;function a(h){const{msg:o,userUid:l,id:r,target:x,messageClock:p,messageClockNumber:s,profileImageUrl:f,defaultProfile:z,profileImage:b,conversation:H}=h;d(F=>[...F,{msg:o,type:x?"private":"other",userUid:l,id:r,messageClock:p,messageClockNumber:s,conversation:null,profileImageUrl:f,defaultProfile:z,profileImage:b}])}return u.on("sMessagePiazza",a),()=>{u.off("sMessagePiazza",a)}},[]),n.useEffect(()=>{if(!u)return;function a(h){const{msg:o,userUid:l,id:r,target:x,messageClock:p,messageClockNumber:s,conversation:f,profileImageUrl:z,defaultProfile:b,profileImage:H,piazzaData:F}=h;d(q=>[...q,{msg:o,type:x?"private":"other",userUid:l,id:r,messageClock:p,messageClockNumber:s,conversation:null,profileImageUrl:z,defaultProfile:b,profileImage:H,...F}])}return u.on(`sMessage${i}`,a),()=>{u.off(`sMessage${i}`,a)}},[i]),n.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),n.useEffect(()=>{k(),(async()=>{if(i==="piazza"){const h=oe(R,"chats_group"),o=de(h,ge("messageClockNumber","desc"),fe(1));(await ue(o)).forEach(async r=>{const x=O(R,`chats_group/${r.id}`),s=(await Y(x)).data(),f=s.piazzaChecked||[];f.indexOf(c.uid)===-1&&(f.splice(-1,c.uid,0),f.push(c.uid),await te(x,{...s,piazzaChecked:f}))})}else{const h=O(R,`members/${c.uid}`),l=(await Y(h)).data().chattings;l[i]&&(l[i].messageCount=0),await te(h,{chattings:l})}})()},[t]);const k=()=>{var a;(a=$.current)==null||a.scrollIntoView()};n.useEffect(()=>{const a=async()=>{const o=[],l=oe(R,"chats_group"),r=de(l,ge("messageClockNumber","desc"),fe(y),ze(M||"")),x=await ue(r);x.docs.length||L(x.docs.length),x.forEach(p=>{var K,_,G;o.length===x.docs.length-1&&(T(p),L(x.docs.length-1));const s=p.data().message,f=p.data().userUid,z=p.data().userName,b=p.data().messageClock,H=p.data().messageClockNumber,F=(K=p.data())==null?void 0:K.profileImageUrl,q=(_=p.data())==null?void 0:_.defaultProfile,X=(G=p.data())==null?void 0:G.profileImage,J=p.data();o.push({msg:s,userUid:f,id:z,messageClockNumber:H,messageClock:b,conversation:null,profileImageUrl:F,defaultProfile:q,profileImage:X||!1,...J})}),o.reverse(),d([...o,...t]),D(!1)},h=async o=>{const l=oe(R,`chats_${o}`),r=de(l,ge("messageClockNumber","desc"),fe(y),ze(M||"")),x=await ue(r),p=[];x.docs.length||L(x.docs.length),x.forEach((s,f)=>{var re,ee,le;p.length===x.docs.length-1&&(T(s),L(x.docs.length-1));const z=s.data().message,b=s.data().userUid,H=s.data().userName,F=s.data().messageClock,q=s.data().messageClockNumber||0,X=(re=s.data())==null?void 0:re.profileImageUrl,J=(ee=s.data())==null?void 0:ee.defaultProfile,K=(le=s.data())==null?void 0:le.profileImage,_=s.data(),G=s.data().userOne,ae=s.data().userOneDisplayName,ne=s.data().userTwo,ie=s.data().userTwoDisplayName;G!==c.uid?(C(G),w(ae)):(C(ne),w(ie)),p.push({msg:z,userUid:b,id:H,messageClockNumber:q,messageClock:F,conversation:null,profileImageUrl:X,defaultProfile:J,profileImage:K||!1,..._})}),p.reverse(),d([...p,...t]),D(!1)};console.log(t.length),i==="piazza"?(v||!t.length)&&a():(v||!t.length)&&h(i)},[v,I]);const P=()=>{E.current.scrollTop!==0||v||(console.log("scroll"),D(!0))};return n.useEffect(()=>{var a;return(a=E.current)==null||a.addEventListener("scroll",P),()=>{var h;return(h=E.current)==null?void 0:h.removeEventListener("scroll",P)}},[v]),console.log(i),console.log(t),console.log(N),e.jsx(e.Fragment,{children:e.jsx("div",{ref:E,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,h)=>{let o;i==="piazza"?o=a:a.userUid===a.userOne?o={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:o={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let l;const r=new Date(a.messageClock);a.userUid===c.uid?l="text-right":l="text-left";let x,p;h>0&&(x=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===c.uid&&(p=new Date(t[h+1].messageClock),r.getFullYear()===p.getFullYear()&&r.getMonth()===p.getMonth()&&r.getDate()===p.getDate()&&r.getHours()===p.getHours()&&(r.getMinutes(),p.getMinutes()));let s,f=r.getHours(),z=(r.getMonth()+1).toString(),b=r.getDate().toString();return f>=13?(s="오후",f!==12&&(f=f-12)):(s="오전",f===0&&(f=f+12)),r.getMonth()+1<10&&(z="0"+z),b.length===1&&(b="0"+b),e.jsxs("li",{ref:h===Z?$:null,className:l,children:[x!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==c.uid?"start":"end"}`,children:l==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(me,{trigger:e.jsx(he,{element:o,piazza:()=>m({userUid:o.userUid,displayName:o.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>T(null),user:N,userObj:c,handleMessagesList:d,displayedName:g})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:a.id}),e.jsx(me,{trigger:e.jsx(he,{element:o,piazza:()=>m({userUid:o.userUid,displayName:o.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>T(null),user:N,userObj:c,handleMessagesList:d,displayedName:g,handleChatUid:C,handleChatDisplayName:w})})]})})}),a.userUid!==c.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[r.getFullYear(),"-",z,"-",b," ",j==="ko"&&s," ",f,":",r.getMinutes()<10&&"0",r.getMinutes(),j==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[r.getFullYear(),"-",z,"-",b," ",j==="ko"&&s," ",f,":",r.getMinutes()<10&&"0",r.getMinutes(),j==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},h)}),e.jsx("li",{ref:$})]})})})}function Ke({isKeyboardOpen:c,userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$}){return e.jsx(e.Fragment,{children:c?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Pe,{userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Pe,{userObj:t,messagesList:d,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})})})}const We=Ae(Fe)(({theme:c})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ze(){const c=se(w=>w.languages.value),t=ce(w=>w.piazzaSwitch.value),d=xe(),C=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),d(Se("false"))):(window.localStorage.setItem("piazza","true"),d(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:c==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(We,{onClick:()=>C(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Ee={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:c})=>{const t=se(w=>w.languages.value),d=t==="ko"||t==="en"?t:"ko",C=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Le,{icon:e.jsx(Be,{}),title:C==="piazza"?Ee[d][0]:`${Ee[d][1]} ${c}`}),C==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ze,{})})]})};function Je(){const[c,t]=n.useState([]),[d,C]=n.useState(!0),[w,$]=n.useState(!0),[E,N]=n.useState(""),[S,g]=n.useState(null),[A,v]=n.useState(null),D=Te(),M=n.useRef(null),T=n.useRef(null),Z={audio:!0,video:!1},L=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],I=new RTCPeerConnection({iceServers:[{urls:L.map(s=>s.urls)}]}),B=location.search.slice(4);console.log(location.search.slice(4)),n.useEffect(()=>{(async()=>{await m()})()},[]),n.useEffect(()=>{M.current&&(M.current.srcObject=S)},[S]);async function i(){const s=S;s&&s.getAudioTracks().forEach(f=>f.enabled=!f.enabled),C(!d)}async function j(){const s=S;s&&s.getVideoTracks().forEach(f=>f.enabled=!f.enabled),$(!w)}const U=()=>{M.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(M.current)};n.useEffect(()=>{A&&y(A)},[A]);async function m(){try{const f=(await navigator.mediaDevices.enumerateDevices()).filter(z=>z.kind==="videoinput");t(f)}catch(s){console.log(s)}}async function y(s){try{const z=s?{audio:!0,video:{deviceId:{exact:s}}}:Z,b=await navigator.mediaDevices.getUserMedia(z);g(b),N("")}catch(f){const z=f==null?void 0:f.toString();z&&N(z),console.log(f)}}function k(s){console.log("icecandidate"),console.log(s),u.emit("ice",s.candidate,B)}function P(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",S),T.current=s.stream}function a(){I.addEventListener("icecandidate",k),I.addEventListener("addstream",P),S&&S.getTracks().forEach(s=>I.addTrack(s,S))}async function h(){await y(null),a()}async function o(){await h(),u.emit("joinRoom",B,h)}n.useEffect(()=>{o()},[]);const l=async()=>{console.log("sent the offer"),console.log(I);const s=await I.createOffer();I.setLocalDescription(s),console.log(s),u.emit("offer",s,B)};n.useEffect(()=>{if(u)return u.on("welcome",l),()=>{u.off("welcome",l)}});const r=async s=>{console.log("received the offer"),I.setRemoteDescription(s);const f=await I.createAnswer();console.log("sent the answer"),I.setLocalDescription(f),u.emit("answer",f,B)};n.useEffect(()=>{if(u)return u.on("offer",r),()=>{u.off("offer",r)}});const x=s=>{console.log("received the answer"),I.setRemoteDescription(s)};n.useEffect(()=>{if(u)return u.on("answer",x),()=>{u.off("answer",x)}});const p=s=>{console.log("received candidate"),I.addIceCandidate(s)};return n.useEffect(()=>{if(u)return u.on("ice",p),()=>{u.off("ice",p)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!D&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:T,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:M,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:i,children:d?"unmute":"mute"}),e.jsx(Q,{onClick:j,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:U,children:"stop"})]})}),E&&e.jsx("div",{children:E})]})}let W,V;function Qe(){const[c,t]=n.useState([]),[d,C]=n.useState(!0),[w,$]=n.useState(!0),[E,N]=n.useState("");n.useState(null),n.useState(null),n.useState(null);const S=n.useRef(null),g=n.useRef(null),A=Te(),v={audio:!0,video:!0},D=location.search.slice(4);async function M(){const o=W;o&&o.getAudioTracks().forEach(l=>l.enabled=!l.enabled),C(!d)}async function T(){const o=W;o&&o.getVideoTracks().forEach(l=>l.enabled=!l.enabled),$(!w)}const Z=()=>{S.current.srcObject.getTracks().forEach(o=>o.stop()),console.log(S.current)};async function L(o){if(console.log(o.target.value),S.current.srcObject.getTracks().forEach(l=>l.stop()),await B(o.target.value),V){console.log(V.getSenders());const l=W.getVideoTracks()[0];V.getSenders().find(x=>x.track.kind==="video").replaceTrack(l)}}async function I(){try{const l=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");t(l)}catch(o){console.log(o)}}async function B(o){try{const r=o?{audio:!0,video:{deviceId:{exact:o}}}:v;W=await navigator.mediaDevices.getUserMedia(r);const x=await navigator.mediaDevices.enumerateDevices();console.log(x),S.current.srcObject=W,await I(),N("")}catch(l){console.log(l);const r=l==null?void 0:l.toString();r&&N(r)}}function i(o){console.log("icecandidate"),console.log(o),u.emit("ice",o.candidate,D)}function j(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",W),g.current.srcObject=o.stream}function U(){const o=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];V=new RTCPeerConnection({iceServers:[{urls:o.map(l=>l.urls)}]}),V.addEventListener("icecandidate",i),V.addEventListener("addstream",j),W&&W.getTracks().forEach(l=>V.addTrack(l,W))}async function m(){await B(null),U()}async function y(){await m(),u.emit("joinRoom",D,m)}n.useEffect(()=>{y()},[]);const k=async()=>{console.log("sent the offer"),console.log(V);const o=await V.createOffer();V.setLocalDescription(o),console.log(o),u.emit("offer",o,D)};n.useEffect(()=>{if(u)return u.on("welcome",k),()=>{u.off("welcome",k)}});const P=async o=>{console.log("received the offer"),V.setRemoteDescription(o);const l=await V.createAnswer();console.log("sent the answer"),V.setLocalDescription(l),u.emit("answer",l,D)};n.useEffect(()=>{if(u)return u.on("offer",P),()=>{u.off("offer",P)}});const a=o=>{console.log("received the answer"),V.setRemoteDescription(o)};n.useEffect(()=>{if(u)return u.on("answer",a),()=>{u.off("answer",a)}});const h=o=>{console.log("received candidate"),V.addIceCandidate(o)};return n.useEffect(()=>{if(u)return u.on("ice",h),()=>{u.off("ice",h)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!A&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"yourScreen",ref:g,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:S,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:M,children:d?"unmute":"mute"}),e.jsx(Q,{onClick:T,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:Z,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:L,children:c.map((o,l)=>e.jsx("option",{value:o.deviceId,children:o.label},l))})]}),E&&e.jsx("div",{children:E})]})}function tt({userObj:c}){const[t,d]=n.useState(""),[C,w]=n.useState([]),$=xe(),{state:E}=Me(),[N,S]=n.useState(!1),[g,A]=n.useState(null),[v,D]=n.useState(""),[M,T]=n.useState(""),[Z,L]=n.useState(""),I=m=>{D(m)},B=m=>{T(m)},i=location.search.slice(location.search.indexOf("=")+1);console.log(g),console.log(v),n.useEffect(()=>{E?(D(E.chattingUid),T(E.displayName)):(D(""),T(""))},[i]),n.useEffect(()=>{i&&(async()=>{if(v){const y=O(R,`members/${v}`),k=await Y(y);A(k.data())}})()},[i,v]);const j=ce(m=>m.piazzaForm.value);n.useEffect(()=>{var y;const m=()=>{var P;const k=window.screen.height-300>(((P=window.visualViewport)==null?void 0:P.height)||window.screen.height);N!==k&&S(k)};return window.addEventListener("resize",m),typeof visualViewport<"u"&&((y=window.visualViewport)==null||y.addEventListener("resize",m)),visualViewport==null||visualViewport.addEventListener("resize",m),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",m)),()=>{var k;typeof visualViewport<"u"&&((k=window.visualViewport)==null||k.removeEventListener("resize",m))}},[N]);const U=()=>{var m;L(""),(m=document.getElementById("myScreen"))==null||m.srcObject.getTracks().forEach(y=>y.stop())};return n.useEffect(()=>{$(He(5))}),e.jsxs(e.Fragment,{children:[!N&&e.jsx(Xe,{multiple:!i,displayName:M}),e.jsx(Ke,{isKeyboardOpen:j,userObj:c,messagesList:C,handleMessagesList:m=>w(m),handleChatUid:I,handleChatDisplayName:B}),e.jsx(Ge,{chattingUser:g,userObj:c,multiple:!i,messages:t,handleMessages:m=>d(m),messagesList:C,handleMessagesList:m=>w(m)}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Qe,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]})]})}export{tt as default};
