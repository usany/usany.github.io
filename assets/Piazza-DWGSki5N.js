import{b2 as Pe,u as ie,c as se,O as xe,aV as ne,r,j as e,P as ue,Y as le,b1 as pe,X as ke,b3 as Ce,aX as Me,v as L,m as U,I as H,$ as y,a_ as ze,l as oe,C as ae,b4 as Te,N as he,B as ce,b5 as Ne,q as de,Z as ge,_ as me,n as fe,aY as De,s as Re,S as $e,Q as Se,D as Fe,b6 as Ve,aJ as Be,aa as Ae,b7 as Le,b8 as He,b9 as _e,ba as Ye}from"./index-BZkvEkSk.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Pe("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=Pe("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ze={ko:"메세지를 작성해 주세요",en:"Input message"},Ge={ko:"전송",en:"send"};function Xe({chattingUser:o,userObj:m,multiple:C,messages:t,handleMessages:i,messagesList:b,handleMessagesList:f}){const I=ie(d=>d.profileColor.value),_=ie(d=>d.piazzaForm.value),c=se(d=>d.profile.value),Y=xe(),{state:N}=ne(),v=N==null?void 0:N.conversation,$=se(d=>d.languages.value),E=$==="ko"||$==="en"?$:"ko",[k,T]=r.useState(!1),R=async d=>{var z;d.preventDefault();const D=t,P=m.uid,M=m.displayName,w=Date.now(),s=new Date().toString(),l=c==null?void 0:c.profileImageUrl,a=c==null?void 0:c.defaultProfile,n=c==null?void 0:c.profileImage;let g,h,u;o&&(g=L(U,`members/${o.uid}`),h=await H(g),u=(z=h.data())==null?void 0:z.messagingToken);const p=c.profileImage?c.profileImageUrl:c.defaultProfile;console.log(c);const x={msg:D,userUid:P,id:M,messageClockNumber:w,messageClock:s,conversation:v,conversationUid:o==null?void 0:o.uid,conversationName:o==null?void 0:o.displayName,profileImage:n,defaultProfile:a,profileImageUrl:l,profileUrl:p,sendingToken:u};C?x&&D&&(y.emit("piazzaMessage",x),G()):D&&(b.length!==0?(y.emit("message",x),console.log("message")):(y.emit("messageNew",x),console.log("messageNew")),j(),O()),i("")},W=d=>{i(d.target.value)},G=async()=>{try{const d=t,D=m.uid,P=m.displayName,M=new Date().toString(),w=Date.now(),s=c==null?void 0:c.profileImageUrl,l=c==null?void 0:c.defaultProfile,a=c==null?void 0:c.profileImage;d&&(await ze(oe(U,"chats_group"),{userUid:D,userName:P,message:d,messageClock:M,messageClockNumber:w,profileImageUrl:s,defaultProfile:l,profileColor:I,piazzaChecked:[m.uid],profileImage:a}),f(n=>[...n,{msg:d,type:"me",userUid:m.uid,id:m.displayName,messageClock:M,conversation:null,profileColor:I,messageClockNumber:w,defaultProfile:l,profileImageUrl:s,profileImage:a||!1}]))}catch(d){console.log(d)}},j=async()=>{var D,P,M;const d=t;try{const w=m.uid,s=m.displayName,l=Date.now(),a=new Date().toString(),n=c.profileImage,g=o.profileImage,h=c.profileImageUrl,u=o.profileImageUrl,p=c.defaultProfile,x=o.defaultProfile;let z,S,A,F,V,q,ee,X,J,K;if(m.uid<o.uid?(z=m.uid,S=o.uid,A=m.displayName,F=o.displayName,V=h,q=u,ee=p,X=x,J=c.profileImage,K=o.profileImage):(z=o.uid,S=m.uid,A=o.displayName,F=m.displayName,V=u,q=h,ee=x,X=p,J=o.profileImage,K=c.profileImage),!V){const Z=L(U,`members/${z}`);V=(D=(await H(Z)).data())==null?void 0:D.profileImageUrl}if(!q){const Z=L(U,`members/${S}`);q=(P=(await H(Z)).data())==null?void 0:P.profileImageUrl}if(d){const Z={userUid:w,userName:s,message:d,messageClock:a,messageClockNumber:l,userOne:z,userTwo:S,userOneDisplayName:A,userTwoDisplayName:F,userOneProfileUrl:V,userTwoProfileUrl:q,userOneDefaultProfile:ee,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K};await ze(oe(U,`chats_${v}`),Z);const te=L(U,`members/${w}`),we=(await H(te)).data().chattings||{},ye=L(U,`members/${o.uid}`),re=(await H(ye)).data().chattings||{},Ue=((M=re[v])==null?void 0:M.messageCount)||0;we[v]=Z,re[v]={...Z,messageCount:Ue+1},await ae(te,{chattings:we}),await ae(ye,{chattings:re}),f(Ee=>[...Ee,{msg:d,type:"me",userUid:m.uid,id:m.displayName,messageClock:a,conversation:v,userName:s,messageClockNumber:l,userOne:z,userTwo:S,userOneDisplayName:A,userTwoDisplayName:F,userOneProfileUrl:V,userTwoProfileUrl:q,userOneDefaultProfile:ee,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K}])}}catch(w){console.log(w)}},O=async()=>{try{const d=m.uid,D=o.uid,P=L(U,`members/${d}`),w=(await H(P)).data().conversation||[],s=L(U,`members/${D}`),a=(await H(s)).data().conversation||[];w.indexOf(v)===-1&&(await ae(P,{conversation:[...w,v]}),Y(Te())),a.indexOf(v)===-1&&await ae(s,{conversation:[...a,v]})}catch(d){console.log(d)}};return r.useEffect(()=>{if(k){document.getElementById("mute"),document.getElementById("stream");const d=document.getElementById("videoInput");document.getElementById("myFace");let D;async function P(){try{const w={video:!0,audio:!0};D=await navigator.mediaDevices.getUserMedia(w),D.getVideoTracks().forEach(s=>s.enabled=!s.enabled),D.getAudioTracks().forEach(s=>s.enabled=!s.enabled),M()}catch(w){console.log(w)}}P();async function M(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput");s.forEach(l=>{const a=document.createElement("option");a.value=l.deviceId,a.innerText=l.label,d==null||d.appendChild(a)}),console.log(s)}catch(w){console.log(w)}}}}),console.log(N),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${_?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:R,children:[v&&v!=="piazza"&&e.jsx(ue,{trigger:e.jsx("button",{className:"px-1 h-full rounded bg-light-2 dark:bg-dark-2",type:"submit",children:e.jsx(Ke,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(le,{to:`/piazza?id=${v}?calls=video`,state:N,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var d;(d=document.getElementById("calls"))==null||d.click()},children:[e.jsx(Me,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(le,{to:`/piazza?id=${v}?calls=audio`,state:N,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(qe,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ze[E],onChange:W,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ge[E]})]})})}const Ie=({initiateContinuing:o,multiple:m,handleMultiple:C,user:t,userObj:i,handleMessagesList:b,displayedName:f})=>{const{state:I}=ne(),_=(I==null?void 0:I.conversation)||"piazza",c=se(v=>v.languages.value),[Y,N]=r.useState("");return r.useEffect(()=>{t&&((t==null?void 0:t.uid)<i.uid?N((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):N(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:i.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==f&&e.jsx("div",{children:c==="ko"?e.jsxs("div",{children:["(",f,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",f,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(le,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ce,{variant:"outlined",onClick:()=>{},children:c==="ko"?"프로필 확인":"Check Profile"})}),_==="piazza"&&i.uid!==(t==null?void 0:t.uid)&&e.jsx(le,{to:`${location.pathname}?id=${Y}`,state:{conversation:Y,displayName:t==null?void 0:t.displayName,userUid:i.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(ce,{variant:"outlined",onClick:()=>{b([]),C(!1),o()},children:c==="ko"?"개인 대화":"Private messaging"})})})]})]})};function je({userObj:o,multiple:m,handleMultiple:C,messagesList:t,handleMessagesList:i}){const b=r.useRef(null),f=r.useRef(null),[I,_]=r.useState(null),[c,Y]=r.useState(""),[N,v]=r.useState(!1),[$,E]=r.useState(null),[k,T]=r.useState(0),[R,W]=r.useState("piazza"),{state:G}=ne(),j=(G==null?void 0:G.conversation)||"piazza";r.useEffect(()=>{R!==j&&(i([]),E(null),T(0),W(j))},[j]);const O=se(s=>s.languages.value),d=async({userUid:s,displayName:l})=>{const a=L(U,`members/${s}`),g=(await H(a)).data();_(g),Y(l),console.log("practice")},D=({userUid:s,displayName:l})=>{var a;(a=document.getElementById("drawer"))==null||a.click(),d({userUid:s,displayName:l})},P=20;r.useEffect(()=>{if(!y)return;function s(l){const{msg:a,userUid:n,id:g,target:h,messageClock:u,messageClockNumber:p,profileImageUrl:x,defaultProfile:z,profileImage:S,conversation:A}=l;i(F=>[...F,{msg:a,type:h?"private":"other",userUid:n,id:g,messageClock:u,messageClockNumber:p,conversation:null,profileImageUrl:x,defaultProfile:z,profileImage:S}])}return y.on("sMessagePiazza",s),()=>{y.off("sMessagePiazza",s)}},[]),r.useEffect(()=>{if(!y)return;function s(l){const{msg:a,userUid:n,id:g,target:h,messageClock:u,messageClockNumber:p,conversation:x,profileImageUrl:z,defaultProfile:S,profileImage:A,piazzaData:F}=l;i(V=>[...V,{msg:a,type:h?"private":"other",userUid:n,id:g,messageClock:u,messageClockNumber:p,conversation:null,profileImageUrl:z,defaultProfile:S,profileImage:A,...F}])}return y.on(`sMessage${j}`,s),()=>{y.off(`sMessage${j}`,s)}},[j]),r.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),r.useEffect(()=>{M(),(async()=>{if(m){const l=oe(U,"chats_group"),a=de(l,me("messageClockNumber","desc"),ge(1));(await fe(a)).forEach(async g=>{const h=L(U,`chats_group/${g.id}`),p=(await H(h)).data(),x=p.piazzaChecked||[];x.indexOf(o.uid)===-1&&(x.splice(-1,o.uid,0),x.push(o.uid),await ae(h,{...p,piazzaChecked:x}))})}else{const l=L(U,`members/${o.uid}`),n=(await H(l)).data().chattings;n[j]&&(n[j].messageCount=0),await ae(l,{chattings:n})}})()},[t]);const M=()=>{var s;(s=b.current)==null||s.scrollIntoView()};r.useEffect(()=>{const s=async()=>{const a=[],n=oe(U,"chats_group"),g=de(n,me("messageClockNumber","desc"),ge(P),De($||"")),h=await fe(g);h.docs.length||T(h.docs.length),h.forEach(u=>{var X,J,K;a.length===h.docs.length-1&&(E(u),T(h.docs.length-1));const p=u.data().message,x=u.data().userUid,z=u.data().userName,S=u.data().messageClock,A=u.data().messageClockNumber,F=(X=u.data())==null?void 0:X.profileImageUrl,V=(J=u.data())==null?void 0:J.defaultProfile,q=(K=u.data())==null?void 0:K.profileImage,ee=u.data();a.push({msg:p,userUid:x,id:z,messageClockNumber:A,messageClock:S,conversation:null,profileImageUrl:F,defaultProfile:V,profileImage:q||!1,...ee})}),a.reverse(),i([...a,...t]),v(!1)},l=async a=>{const n=oe(U,`chats_${a}`),g=de(n,me("messageClockNumber","desc"),ge(P),De($||"")),h=await fe(g),u=[];h.docs.length||T(h.docs.length),h.forEach((p,x)=>{var K,Z,te;u.length===h.docs.length-1&&(E(p),T(h.docs.length-1));const z=p.data().message,S=p.data().userUid,A=p.data().userName,F=p.data().messageClock,V=p.data().messageClockNumber||0,q=(K=p.data())==null?void 0:K.profileImageUrl,ee=(Z=p.data())==null?void 0:Z.defaultProfile,X=(te=p.data())==null?void 0:te.profileImage,J=p.data();u.push({msg:z,userUid:S,id:A,messageClockNumber:V,messageClock:F,conversation:null,profileImageUrl:q,defaultProfile:ee,profileImage:X||!1,...J})}),u.reverse(),i([...u,...t]),v(!1)};j==="piazza"?(N||!t.length)&&s():(N||!t.length)&&l(j)},[N,j]);const w=()=>{f.current.scrollTop!==0||N||(console.log("scroll"),v(!0))};return r.useEffect(()=>{var s;return(s=f.current)==null||s.addEventListener("scroll",w),()=>{var l;return(l=f.current)==null?void 0:l.removeEventListener("scroll",w)}},[N]),console.log(j),console.log(t),console.log(I),e.jsx(e.Fragment,{children:e.jsx("div",{ref:f,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[N&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((s,l)=>{let a;j==="piazza"?a=s:s.userUid===s.userOne?a={userUid:s.userOne,id:s.userOneDisplayName,profileImage:s.userOneProfileImage||s.profileImage,defaultProfile:s.userOneDefaultProfile||s.defaultProfile,profileImageUrl:s.userOneProfileUrl||s.profileImageUrl}:a={userUid:s.userTwo,id:s.userTwoDisplayName,profileImage:s.userTwoProfileImage||s.profileImage,defaultProfile:s.userTwoDefaultProfile||s.defaultProfile,profileImageUrl:s.userTwoProfileUrl||s.profileImageUrl};let n;const g=new Date(s.messageClock);s.userUid===o.uid?n="text-right":n="text-left";let h,u;l>0&&(h=t[l-1].userUid),l<t.length-1&&t[l+1].userUid===o.uid&&(u=new Date(t[l+1].messageClock),g.getFullYear()===u.getFullYear()&&g.getMonth()===u.getMonth()&&g.getDate()===u.getDate()&&g.getHours()===u.getHours()&&(g.getMinutes(),u.getMinutes()));let p,x=g.getHours(),z=(g.getMonth()+1).toString(),S=g.getDate().toString();return x>=13?(p="오후",x!==12&&(x=x-12)):(p="오전",x===0&&(x=x+12)),g.getMonth()+1<10&&(z="0"+z),S.length===1&&(S="0"+S),e.jsxs("li",{ref:l===k?b:null,className:n,children:[h!==s.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${s.userUid!==o.uid?"start":"end"}`,children:n==="text-left"?e.jsxs("div",{className:"flex gap-3",children:[e.jsx(ue,{trigger:e.jsx(he,{element:a,piazza:()=>D({userUid:a.userUid,displayName:a.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(Ie,{initiateContinuing:()=>E(null),multiple:m,handleMultiple:C,user:I,userObj:o,handleMessagesList:i,displayedName:c})}),e.jsx("div",{children:s.id})]}):e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{children:s.id}),e.jsx(ue,{trigger:e.jsx(he,{element:a,piazza:()=>D({userUid:a.userUid,displayName:a.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(Ie,{initiateContinuing:()=>E(null),multiple:m,handleMultiple:C,user:I,userObj:o,handleMessagesList:i,displayedName:c})})]})})}),s.userUid!==o.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),e.jsxs("div",{children:[g.getFullYear(),"-",z,"-",S," ",O==="ko"&&p," ",x,":",g.getMinutes()<10&&"0",g.getMinutes(),O==="en"&&(p==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[g.getFullYear(),"-",z,"-",S," ",O==="ko"&&p," ",x,":",g.getMinutes()<10&&"0",g.getMinutes(),O==="en"&&(p==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},l)}),e.jsx("li",{ref:b})]})})})}function Je({isKeyboardOpen:o,userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:b}){return e.jsx(e.Fragment,{children:o?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(je,{userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:b})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(je,{userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:b})})})}const Qe=Re($e)(({theme:o})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function We(){const o=se(i=>i.languages.value),m=ie(i=>i.piazzaSwitch.value),C=xe(),t=()=>{m==="true"?(window.localStorage.setItem("piazza","false"),C(Se("false"))):(window.localStorage.setItem("piazza","true"),C(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:o==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Qe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:m==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Oe=({multiple:o,displayName:m})=>{const C=se(f=>f.languages.value),t=C==="ko"||C==="en"?C:"ko",{state:i}=ne(),b=(i==null?void 0:i.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Fe,{icon:e.jsx(Ve,{}),title:b==="piazza"?be[t][0]:`${be[t][1]} ${m}`}),o&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(We,{})})]})};let Q,B;function et(){const[o,m]=r.useState([]),[C,t]=r.useState(!0),[i,b]=r.useState(!0),[f,I]=r.useState(""),[_,c]=r.useState(null);r.useState(null);const Y=Be(),N=document.getElementById("myScreen"),v=document.getElementById("devices"),$={audio:!0,video:!0},E=location.search.slice(4);console.log(location.search.slice(4));async function k(){const a=Q;a&&a.getAudioTracks().forEach(n=>n.enabled=!n.enabled),t(!C)}async function T(){const a=Q;a&&a.getVideoTracks().forEach(n=>n.enabled=!n.enabled),b(!i)}async function R(){console.log(v.value),Q.getTracks().forEach(n=>n.stop()),c(v.value),await G(v.value)}r.useEffect(()=>{G(_)},[v]);async function W(){try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(g=>g.kind==="videoinput");m(n)}catch(a){console.log(a)}}async function G(a){try{const g=a?{audio:!0,video:{deviceId:{exact:a}}}:$;Q=await navigator.mediaDevices.getUserMedia(g);const h=await navigator.mediaDevices.enumerateDevices();N.srcObject=Q,await W(),I("")}catch(n){console.log(n),I(n)}}function j(a){console.log("icecandidate"),console.log(a),y.emit("ice",a.candidate,E)}function O(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",Q);const n=document.getElementById("yourScreen");n.srcObject=a.stream}function d(){const a=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];B=new RTCPeerConnection({iceServers:[{urls:a.map(n=>n.urls)}]}),B.addEventListener("icecandidate",j),B.addEventListener("addstream",O),Q&&Q.getTracks().forEach(n=>B.addTrack(n,Q))}async function D(){await G(null),d()}async function P(){await D(),y.emit("joinRoom",E,D)}r.useEffect(()=>{P()},[]);const M=async()=>{console.log("sent the offer"),console.log(B);const a=await B.createOffer();B.setLocalDescription(a),console.log(a),y.emit("offer",a,E)};r.useEffect(()=>{if(y)return y.on("welcome",M),()=>{y.off("welcome",M)}});const w=async a=>{console.log("received the offer"),B.setRemoteDescription(a);const n=await B.createAnswer();console.log("sent the answer"),B.setLocalDescription(n),y.emit("answer",n,E)};r.useEffect(()=>{if(y)return y.on("offer",w),()=>{y.off("offer",w)}});const s=a=>{console.log("received the answer"),B.setRemoteDescription(a)};r.useEffect(()=>{if(y)return y.on("answer",s),()=>{y.off("answer",s)}});const l=a=>{console.log("received candidate"),B.addIceCandidate(a)};return r.useEffect(()=>{if(y)return y.on("ice",l),()=>{y.off("ice",l)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!Y&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ce,{onClick:k,children:C?"unmute":"mute"}),e.jsx(ce,{onClick:T,children:i?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:R,children:o.map((a,n)=>e.jsx("option",{value:a.deviceId,children:a.label},n))})]}),f&&e.jsx("div",{children:f.toString()})]})}function st({userObj:o}){const[m,C]=r.useState(""),[t,i]=r.useState([]),b=xe(),{state:f}=ne(),[I,_]=r.useState(!0),[c,Y]=r.useState(!1),[N,v]=r.useState(null);r.useEffect(()=>{const k=async()=>{if(f!=null&&f.chattingUid){const T=L(U,`members/${f.chattingUid}`),R=await H(T);v(R.data())}};f!=null&&f.multiple||k()},[f]);const $=ie(k=>k.piazzaForm.value);r.useEffect(()=>{var T;const k=()=>{var W;const R=window.screen.height-300>(((W=window.visualViewport)==null?void 0:W.height)||window.screen.height);c!==R&&Y(R)};return window.addEventListener("resize",k),typeof visualViewport<"u"&&((T=window.visualViewport)==null||T.addEventListener("resize",k)),visualViewport==null||visualViewport.addEventListener("resize",k),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",k)),()=>{var R;typeof visualViewport<"u"&&((R=window.visualViewport)==null||R.removeEventListener("resize",k))}},[c]),r.useEffect(()=>{(f==null?void 0:f.multiple)!==void 0&&_(f==null?void 0:f.multiple)},[]),r.useEffect(()=>{b(Ae(5))});const E=f==null?void 0:f.displayName;return e.jsxs(e.Fragment,{children:[!c&&e.jsx(Oe,{multiple:I,displayName:E}),e.jsx(Je,{isKeyboardOpen:$,userObj:o,multiple:I,handleMultiple:k=>_(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsx(Xe,{chattingUser:N,userObj:o,multiple:I,messages:m,handleMessages:k=>C(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsxs(Le,{children:[e.jsx(He,{children:e.jsx("div",{id:"calls"})}),e.jsx(_e,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(et,{})}),e.jsx(Ye,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{st as default};
