import{r as h,j as s,M as K,v as we,bj as Ne,S as V,a5 as te,bk as X,aY as ye,am as Ce,N as O,O as ee,Q as ae,a0 as L,V as u,a1 as H,a2 as Ue,a3 as B,a4 as Y,U as y,W as C,ae as $,aP as se,bl as ve}from"./index-6XYg9rPA.js";import{a as ke,b as De,D as Se}from"./DialogContent-BMAnoBZ9.js";import{A as ze}from"./Avatar-C7rvrCXs.js";import{B as _}from"./Button--dlOmdpj.js";import{w as S}from"./webSocket-BpFYzTQr.js";import{P as Me}from"./PageTitle-B1fGLEOH.js";const be=({multiple:o,selectUser:U,user:e,handleClose:v,userObj:m,handleMsgList:k,handleChangeMessage:E,displayedName:j})=>{const[T,P]=h.useState(null);return h.useEffect(()=>{U&&((e==null?void 0:e.uid)<m.uid?P((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+m.uid[0]+m.uid[1]+m.uid[2]+m.uid[3]+m.uid[4]+m.uid[5]):P(m.uid[0]+m.uid[1]+m.uid[2]+m.uid[3]+m.uid[4]+m.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[U]),s.jsxs(ke,{open:U,onClose:v,children:[s.jsxs(De,{children:[s.jsx("div",{children:s.jsx(ze,{alt:e==null?void 0:e.displayName,sx:{bgcolor:(e==null?void 0:e.profileColor)||"#2196f3"},src:(e==null?void 0:e.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==j&&s.jsxs("div",{children:["(",j,"에서 개명)"]})]}),s.jsxs(Se,{children:[s.jsx(K,{to:"/profile",state:{element:e},children:s.jsx(_,{variant:"outlined",onClick:()=>{v()},children:"프로필 확인"})}),o&&m.uid!==(e==null?void 0:e.uid)&&s.jsx(K,{to:"/piazza",state:{conversation:T,displayName:e==null?void 0:e.displayName,userUid:m.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:s.jsx(_,{variant:"outlined",onClick:()=>{k([]),E(!0),v()},children:"개인 대화"})}),s.jsx(_,{variant:"outlined",onClick:()=>{v()},children:"닫기"})]})]})},je=we(Ne)(({theme:o})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ie(){const o=V(v=>v.piazzaSwitch.value),U=te(),e=()=>{o==="true"?(window.localStorage.setItem("piazza","false"),U(X("false"))):(window.localStorage.setItem("piazza","true"),U(X("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(je,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:o==="true"})})]})}function Fe({userObj:o}){const U=h.useRef(null),[e,v]=h.useState(""),[m,k]=h.useState([]),[E,j]=h.useState(!0),[T,P]=h.useState(""),[ie,oe]=h.useState(null),[ne,Z]=h.useState(!1),A=V(a=>a.profileColor.value),I=V(a=>a.profileUrl.value),[ce,le]=h.useState(null),q=te(),{state:r}=ye(),R=r==null?void 0:r.multiple,x=r==null?void 0:r.conversation;h.useEffect(()=>{if(!S)return;function a(n){const{msg:c,userUid:t,id:l,target:g,messageClock:d,messageClockNumber:i,conversation:p}=n;k(f=>[...f,{msg:c,type:g?"private":"other",userUid:t,id:l,messageClock:d,messageClockNumber:i,conversation:null,profileImageUrl:I,profileColor:A}])}return S.on("sMessagePiazza",a),()=>{S.off("sMessagePiazza",a)}},[]),h.useEffect(()=>{if(!S)return;function a(n){const{msg:c,userUid:t,id:l,target:g,messageClock:d,messageClockNumber:i,conversation:p}=n;k(f=>[...f,{msg:c,type:g?"private":"other",userUid:t,id:l,messageClock:d,messageClockNumber:i,conversation:null}])}return S.on(`sMessage${x}`,a),()=>{S.off(`sMessage${x}`,a)}},[]),h.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),h.useEffect(()=>{de(),(async()=>{if(R){const n=L(u,"chats_group"),c=H(n,B("messageClockNumber","desc"),Ue(1));(await Y(c)).forEach(async l=>{const g=y(u,`chats_group/${l.id}`),i=(await C(g)).data(),p=i.piazzaChecked||[];p.indexOf(o.uid)===-1&&(p.push(o.uid),await $(g,{...i,piazzaChecked:p}))})}else{const n=y(u,`members/${o.uid}`),t=(await C(n)).data().chattings;t[x].messageCount=0,await $(n,{chattings:t})}})()},[m]),h.useEffect(()=>{q(Ce(5))});const de=()=>{var a;(a=U.current)==null||a.scrollIntoView()},re=async a=>{var N;a.preventDefault();const n=e,c=o.uid,t=o.displayName,l=Date.now(),g=new Date().toString();let d,i,p;r.chattingUid&&(d=y(u,`members/${r.chattingUid}`),i=await C(d),p=(N=i.data())==null?void 0:N.messagingToken);const f={msg:n,userUid:c,id:t,messageClockNumber:l,messageClock:g,target:T,conversation:x,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:I,sendingToken:p};R?f&&n&&(S.emit("piazzaMessage",f),fe()):n&&(m.length!==0?(S.emit("message",f),console.log("message")):(S.emit("messageNew",f),console.log("messageNew")),pe(),he()),v("")},ge=a=>{v(a.target.value)},Q=async({userUid:a,displayName:n})=>{const c=y(u,`members/${a}`),l=(await C(c)).data();oe(l),Z(!0),le(n)},me=()=>{Z(!1)},fe=async()=>{try{const a=e,n=o.uid,c=o.displayName,t=new Date().toString(),l=Date.now();a&&(await se(L(u,"chats_group"),{userUid:n,userName:c,message:a,messageClock:t,messageClockNumber:l,profileImageUrl:I,profileColor:A,piazzaChecked:[o.uid]}),k(g=>[...g,{msg:a,type:"me",userUid:o.uid,id:o.displayName,messageClock:t,conversation:null,profileImageUrl:I,profileColor:A}]))}catch(a){console.log(a)}};h.useEffect(()=>{E&&(R?((async()=>{const c=[],t=L(u,"chats_group"),l=H(t,B("messageClockNumber"));(await Y(l)).forEach(d=>{var w,b;const i=d.data().message,p=d.data().userUid,f=d.data().userName,N=d.data().messageClock,z=d.data().messageClockNumber,D=(w=d.data())==null?void 0:w.profileColor,M=(b=d.data())==null?void 0:b.profileImageUrl;c.push({msg:i,type:"me",userUid:p,id:f,messageClockNumber:z,messageClock:N,conversation:null,profileColor:D,profileImageUrl:M}),k(c)})})(),j(!1)):((async c=>{const t=L(u,`chats_${c}`),l=H(t,B("messageClockNumber")),g=await Y(l),d=[];g.forEach(i=>{const p=i.data().message,f=i.data().userUid,N=i.data().userName,z=i.data().messageClock,D=i.data().messageClockNumber||0;d.push({msg:p,type:"me",userUid:f,id:N,messageClock:z,messageClockNumber:D}),k(d)})})(x),j(!1)))},[E]);const pe=async()=>{var n,c,t;const a=e;try{const l=o.uid,g=o.displayName,d=Date.now(),i=new Date().toString();let p,f,N,z,D,M;if(r.userUid<r.chattingUid?(p=r.userUid,f=r.chattingUid,N=o.displayName,z=r.displayName,D=I,M=r.profileUrl):(p=r.chattingUid,f=r.userUid,N=r.displayName,z=o.displayName,D=r.profileUrl,M=I),!D){const w=y(u,`members/${p}`);D=(n=(await C(w)).data())==null?void 0:n.profileImageUrl}if(!M){const w=y(u,`members/${f}`);M=(c=(await C(w)).data())==null?void 0:c.profileImageUrl}if(a){const w={userUid:l,userName:g,message:a,messageClock:i,messageClockNumber:d,userOne:p,userTwo:f,userOneDisplayName:N,userTwoDisplayName:z,userOneProfileUrl:D,userTwoProfileUrl:M};console.log(w),await se(L(u,`chats_${x}`),w);const b=y(u,`members/${l}`),G=(await C(b)).data().chattings||{},J=y(u,`members/${r.chattingUid}`),F=(await C(J)).data().chattings||{},ue=((t=F[x])==null?void 0:t.messageCount)||0;G[x]=w,F[x]={...w,messageCount:ue+1},await $(b,{chattings:G}),await $(J,{chattings:F}),k(xe=>[...xe,{msg:a,type:"me",userUid:o.uid,id:o.displayName,messageClock:i,conversation:x}])}}catch(l){console.log(l)}},he=async()=>{try{const a=o.uid,n=r.chattingUid,c=y(u,`members/${a}`),l=(await C(c)).data().conversation||[],g=y(u,`members/${n}`),i=(await C(g)).data().conversation||[];l.indexOf(x)===-1&&(await $(c,{conversation:[...l,x]}),q(ve())),i.indexOf(x)===-1&&await $(g,{conversation:[...i,x]})}catch(a){console.log(a)}};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex w-screen justify-between",children:[s.jsx(Me,{title:R?"단체 대화":`개인 대화 ${r==null?void 0:r.displayName}`}),R&&s.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:s.jsx(Ie,{})})]}),s.jsx("div",{className:"app-container pt-5",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[m.map((a,n)=>{let c;const t=new Date(a.messageClock);a.userUid===o.uid?c="text-right":c="text-left";let l,g;n>0&&(l=m[n-1].userUid),n<m.length-1&&m[n+1].userUid===o.uid&&(g=new Date(m[n+1].messageClock),t.getFullYear()===g.getFullYear()&&t.getMonth()===g.getMonth()&&t.getDate()===g.getDate()&&t.getHours()===g.getHours()&&(t.getMinutes(),g.getMinutes()));let d,i=t.getHours(),p=(t.getMonth()+1).toString(),f=t.getDate().toString();return i>=13?(d="오후",i!==12&&(i=i-12)):(d="오전",i===0&&(i=i+12)),t.getMonth()+1<10&&(p="0"+p),f.length===1&&(f="0"+f),s.jsxs("li",{className:c,children:[l!==a.userUid&&s.jsx("div",{children:s.jsx("div",{className:`flex justify-${a.userUid!==o.uid?"start":"end"}`,children:c==="text-left"?s.jsxs("div",{className:"flex gap-3",children:[s.jsxs(O,{onClick:()=>Q({userUid:a.userUid,displayName:a.id}),className:"bg-profile-blue",children:[s.jsx(ee,{src:a.profileImageUrl}),s.jsx(ae,{className:"text-xl border-none	",children:a.id[0]})]}),s.jsx("div",{children:a.id})]}):s.jsxs("div",{className:"flex gap-3",children:[s.jsx("div",{children:a.id}),s.jsxs(O,{onClick:()=>Q({userUid:a.userUid,displayName:a.id}),className:"bg-profile-blue",children:[s.jsx(ee,{src:a.profileImageUrl}),s.jsx(ae,{className:"text-xl border-none	",children:a.id[0]})]})]})})}),a.userUid!==o.uid?s.jsxs("div",{className:"flex gap-3 justify-start",children:[s.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),s.jsxs("div",{children:[t.getFullYear(),"-",p,"-",f," ",d," ",i,":",t.getMinutes()]})]}):s.jsxs("div",{className:"flex gap-3 justify-end",children:[s.jsxs("div",{children:[t.getFullYear(),"-",p,"-",f," ",d," ",i,":",t.getMinutes()]}),s.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]})}),s.jsx("li",{ref:U})]}),s.jsxs("form",{className:"flex gap-px",onSubmit:re,children:[s.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:"메세지를 작성해 주세요",onChange:ge,value:e,autoFocus:!0}),s.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:"전송"})]})]}),s.jsx(be,{multiple:R,selectUser:ne,user:ie,handleClose:me,userObj:o,handleMsgList:a=>k(a),handleChangeMessage:a=>j(a),displayedName:ce})]})})]})}export{Fe as default};
