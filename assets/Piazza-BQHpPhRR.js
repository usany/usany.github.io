import{c as Ee,u as ie,d as ee,G as pe,j as e,P as ge,a0 as he,b8 as xe,b7 as ue,b0 as Te,x as _,p as V,O,a4 as f,b4 as ve,n as te,E as Q,b9 as Re,a_ as Pe,r as n,W as me,a1 as we,B as X,ba as ye,q as le,a2 as re,a3 as de,t as fe,b2 as ke,s as $e,S as Ve,X as Ce,H as Ae,bb as Fe,aN as Ue,af as Le,bc as ze,bd as Se,be as je,bf as Ne}from"./index-DP2i6VUH.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=Ee("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=Ee("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),_e={ko:"메세지를 작성해 주세요",en:"Input message"},Oe={ko:"전송",en:"send"};function Ye({chattingUser:c,userObj:t,multiple:l,messages:S,handleMessages:C,messagesList:A,handleMessagesList:P}){const E=ie(i=>i.profileColor.value),y=ie(i=>i.piazzaForm.value),r=ee(i=>i.profile.value),$=pe(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",T=ee(i=>i.languages.value),I=T==="ko"||T==="en"?T:"ko",R=async i=>{var s;i.preventDefault();const b=S,U=t.uid,u=t.displayName,z=Date.now(),j=new Date().toString(),M=r==null?void 0:r.profileImageUrl,a=r==null?void 0:r.defaultProfile,m=r==null?void 0:r.profileImage;let p,w,g;c&&(p=_(V,`members/${c.uid}`),w=await O(p),g=(s=w.data())==null?void 0:s.messagingToken);const h=r.profileImage?r.profileImageUrl:r.defaultProfile;console.log(r);const d={msg:b,userUid:U,id:u,messageClockNumber:z,messageClock:j,conversation:v,conversationUid:c==null?void 0:c.uid,conversationName:c==null?void 0:c.displayName,profileImage:m,defaultProfile:a,profileImageUrl:M,profileUrl:h,sendingToken:g};l?d&&b&&(f.emit("piazzaMessage",d),k()):b&&(A.length!==0?(f.emit("message",d),console.log("message")):(f.emit("messageNew",d),console.log("messageNew")),D(),B()),C("")},K=i=>{C(i.target.value)},k=async()=>{try{const i=S,b=t.uid,U=t.displayName,u=new Date().toString(),z=Date.now(),j=r==null?void 0:r.profileImageUrl,M=r==null?void 0:r.defaultProfile,a=r==null?void 0:r.profileImage;i&&(await ve(te(V,"chats_group"),{userUid:b,userName:U,message:i,messageClock:u,messageClockNumber:z,profileImageUrl:j,defaultProfile:M,profileColor:E,piazzaChecked:[t.uid],profileImage:a}),P(m=>[...m,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:u,conversation:null,profileColor:E,messageClockNumber:z,defaultProfile:M,profileImageUrl:j,profileImage:a||!1}]))}catch(i){console.log(i)}},D=async()=>{var b,U,u;const i=S;try{const z=t.uid,j=t.displayName,M=Date.now(),a=new Date().toString(),m=r.profileImage,p=c.profileImage,w=r.profileImageUrl,g=c.profileImageUrl,h=r.defaultProfile,d=c.defaultProfile;let s,o,x,N,L,F,Y,W,Z,G;if(t.uid<c.uid?(s=t.uid,o=c.uid,x=t.displayName,N=c.displayName,L=w,F=g,Y=h,W=d,Z=r.profileImage,G=c.profileImage):(s=c.uid,o=t.uid,x=c.displayName,N=t.displayName,L=g,F=w,Y=d,W=h,Z=c.profileImage,G=r.profileImage),!L){const H=_(V,`members/${s}`);L=(b=(await O(H)).data())==null?void 0:b.profileImageUrl}if(!F){const H=_(V,`members/${o}`);F=(U=(await O(H)).data())==null?void 0:U.profileImageUrl}if(i){const H={userUid:z,userName:j,message:i,messageClock:a,messageClockNumber:M,userOne:s,userTwo:o,userOneDisplayName:x,userTwoDisplayName:N,userOneProfileUrl:L,userTwoProfileUrl:F,userOneDefaultProfile:Y,userTwoDefaultProfile:W,userOneProfileImage:Z,userTwoProfileImage:G};await ve(te(V,`chats_${v}`),H);const q=_(V,`members/${z}`),oe=(await O(q)).data().chattings||{},ae=_(V,`members/${c.uid}`),J=(await O(ae)).data().chattings||{},ne=((u=J[v])==null?void 0:u.messageCount)||0;oe[v]=H,J[v]={...H,messageCount:ne+1},await Q(q,{chattings:oe}),await Q(ae,{chattings:J}),P(Me=>[...Me,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:a,conversation:v,userName:j,messageClockNumber:M,userOne:s,userTwo:o,userOneDisplayName:x,userTwoDisplayName:N,userOneProfileUrl:L,userTwoProfileUrl:F,userOneDefaultProfile:Y,userTwoDefaultProfile:W,userOneProfileImage:Z,userTwoProfileImage:G}])}}catch(z){console.log(z)}},B=async()=>{try{const i=t.uid,b=c.uid,U=_(V,`members/${i}`),z=(await O(U)).data().conversation||[],j=_(V,`members/${b}`),a=(await O(j)).data().conversation||[];z.indexOf(v)===-1&&(await Q(U,{conversation:[...z,v]}),$(Re())),a.indexOf(v)===-1&&await Q(j,{conversation:[...a,v]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${y?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:R,children:[v&&v!=="piazza"&&e.jsx(ge,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(He,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(ue,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Te,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(ue,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Be,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:_e[I],onChange:K,value:S,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Oe[I]})]})}const De=({initiateContinuing:c,user:t,userObj:l,handleMessagesList:S,displayedName:C,handleChatUid:A,handleChatDisplayName:P})=>{const{state:E}=Pe(),y=(E==null?void 0:E.conversation)||"piazza",r=ee(T=>T.languages.value),[$,v]=n.useState("");return n.useEffect(()=>{t&&((t==null?void 0:t.uid)<l.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]):v(l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(me,{element:t,uid:l.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==C&&e.jsx("div",{children:r==="ko"?e.jsxs("div",{children:["(",C,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",C,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(we,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(X,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),y==="piazza"&&l.uid!==(t==null?void 0:t.uid)&&e.jsx(we,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:l.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(ue,{children:e.jsx(X,{variant:"outlined",onClick:()=>{S([]),c()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ie({userObj:c,messagesList:t,handleMessagesList:l,handleChatUid:S,handleChatDisplayName:C}){const A=n.useRef(null),P=n.useRef(null),[E,y]=n.useState(null),[r,$]=n.useState(""),[v,T]=n.useState(!1),[I,R]=n.useState(null),[K,k]=n.useState(0),[D,B]=n.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";n.useEffect(()=>{(D!==i||i==="piazza")&&(l([]),R(null),k(0),B(i))},[i]);const b=ee(a=>a.languages.value),U=async({userUid:a,displayName:m})=>{const p=_(V,`members/${a}`),g=(await O(p)).data();y(g),$(m),console.log("practice")},u=({userUid:a,displayName:m})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),U({userUid:a,displayName:m})},z=20;n.useEffect(()=>{if(!f)return;function a(m){const{msg:p,userUid:w,id:g,target:h,messageClock:d,messageClockNumber:s,profileImageUrl:o,defaultProfile:x,profileImage:N,conversation:L}=m;l(F=>[...F,{msg:p,type:h?"private":"other",userUid:w,id:g,messageClock:d,messageClockNumber:s,conversation:null,profileImageUrl:o,defaultProfile:x,profileImage:N}])}return f.on("sMessagePiazza",a),()=>{f.off("sMessagePiazza",a)}},[]),n.useEffect(()=>{if(!f)return;function a(m){const{msg:p,userUid:w,id:g,target:h,messageClock:d,messageClockNumber:s,conversation:o,profileImageUrl:x,defaultProfile:N,profileImage:L,piazzaData:F}=m;l(Y=>[...Y,{msg:p,type:h?"private":"other",userUid:w,id:g,messageClock:d,messageClockNumber:s,conversation:null,profileImageUrl:x,defaultProfile:N,profileImage:L,...F}])}return f.on(`sMessage${i}`,a),()=>{f.off(`sMessage${i}`,a)}},[i]),n.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),n.useEffect(()=>{j(),(async()=>{if(i==="piazza"){const m=te(V,"chats_group"),p=le(m,de("messageClockNumber","desc"),re(1));(await fe(p)).forEach(async g=>{const h=_(V,`chats_group/${g.id}`),s=(await O(h)).data(),o=s.piazzaChecked||[];o.indexOf(c.uid)===-1&&(o.splice(-1,c.uid,0),o.push(c.uid),await Q(h,{...s,piazzaChecked:o}))})}else{const m=_(V,`members/${c.uid}`),w=(await O(m)).data().chattings;w[i]&&(w[i].messageCount=0),await Q(m,{chattings:w})}})()},[t]);const j=()=>{var a;(a=A.current)==null||a.scrollIntoView()};n.useEffect(()=>{const a=async()=>{const p=[],w=te(V,"chats_group"),g=le(w,de("messageClockNumber","desc"),re(z),ke(I||"")),h=await fe(g);h.docs.length||k(h.docs.length),h.forEach(d=>{var G,H,q;p.length===h.docs.length-1&&(R(d),k(h.docs.length-1));const s=d.data().message,o=d.data().userUid,x=d.data().userName,N=d.data().messageClock,L=d.data().messageClockNumber,F=(G=d.data())==null?void 0:G.profileImageUrl,Y=(H=d.data())==null?void 0:H.defaultProfile,W=(q=d.data())==null?void 0:q.profileImage,Z=d.data();p.push({msg:s,userUid:o,id:x,messageClockNumber:L,messageClock:N,conversation:null,profileImageUrl:F,defaultProfile:Y,profileImage:W||!1,...Z})}),p.reverse(),l([...p,...t]),T(!1)},m=async p=>{const w=te(V,`chats_${p}`),g=le(w,de("messageClockNumber","desc"),re(z),ke(I||"")),h=await fe(g),d=[];h.docs.length||k(h.docs.length),h.forEach((s,o)=>{var ce,J,ne;d.length===h.docs.length-1&&(R(s),k(h.docs.length-1));const x=s.data().message,N=s.data().userUid,L=s.data().userName,F=s.data().messageClock,Y=s.data().messageClockNumber||0,W=(ce=s.data())==null?void 0:ce.profileImageUrl,Z=(J=s.data())==null?void 0:J.defaultProfile,G=(ne=s.data())==null?void 0:ne.profileImage,H=s.data(),q=s.data().userOne,se=s.data().userOneDisplayName,oe=s.data().userTwo,ae=s.data().userTwoDisplayName;q!==c.uid?(S(q),C(se)):(S(oe),C(ae)),d.push({msg:x,userUid:N,id:L,messageClockNumber:Y,messageClock:F,conversation:null,profileImageUrl:W,defaultProfile:Z,profileImage:G||!1,...H})}),d.reverse(),l([...d,...t]),T(!1)};console.log(t.length),i==="piazza"?(v||!t.length)&&a():(v||!t.length)&&m(i)},[v,D]);const M=()=>{P.current.scrollTop!==0||v||(console.log("scroll"),T(!0))};return n.useEffect(()=>{var a;return(a=P.current)==null||a.addEventListener("scroll",M),()=>{var m;return(m=P.current)==null?void 0:m.removeEventListener("scroll",M)}},[v]),console.log(i),console.log(t),console.log(E),e.jsx(e.Fragment,{children:e.jsx("div",{ref:P,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,m)=>{let p;i==="piazza"?p=a:a.userUid===a.userOne?p={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:p={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let w;const g=new Date(a.messageClock);a.userUid===c.uid?w="text-right":w="text-left";let h,d;m>0&&(h=t[m-1].userUid),m<t.length-1&&t[m+1].userUid===c.uid&&(d=new Date(t[m+1].messageClock),g.getFullYear()===d.getFullYear()&&g.getMonth()===d.getMonth()&&g.getDate()===d.getDate()&&g.getHours()===d.getHours()&&(g.getMinutes(),d.getMinutes()));let s,o=g.getHours(),x=(g.getMonth()+1).toString(),N=g.getDate().toString();return o>=13?(s="오후",o!==12&&(o=o-12)):(s="오전",o===0&&(o=o+12)),g.getMonth()+1<10&&(x="0"+x),N.length===1&&(N="0"+N),e.jsxs("li",{ref:m===K?A:null,className:w,children:[h!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==c.uid?"start":"end"}`,children:w==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(ge,{trigger:e.jsx(me,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>R(null),user:E,userObj:c,handleMessagesList:l,displayedName:r})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:a.id}),e.jsx(ge,{trigger:e.jsx(me,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>R(null),user:E,userObj:c,handleMessagesList:l,displayedName:r,handleChatUid:S,handleChatDisplayName:C})})]})})}),a.userUid!==c.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[g.getFullYear(),"-",x,"-",N," ",b==="ko"&&s," ",o,":",g.getMinutes()<10&&"0",g.getMinutes(),b==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[g.getFullYear(),"-",x,"-",N," ",b==="ko"&&s," ",o,":",g.getMinutes()<10&&"0",g.getMinutes(),b==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},m)}),e.jsx("li",{ref:A})]})})})}function qe({isKeyboardOpen:c,userObj:t,messagesList:l,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:A}){return e.jsx(e.Fragment,{children:c?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ie,{userObj:t,messagesList:l,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:A})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ie,{userObj:t,messagesList:l,handleMessagesList:S,handleChatUid:C,handleChatDisplayName:A})})})}const Ge=$e(Ve)(({theme:c})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ke(){const c=ee(C=>C.languages.value),t=ie(C=>C.piazzaSwitch.value),l=pe(),S=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),l(Ce("false"))):(window.localStorage.setItem("piazza","true"),l(Ce("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:c==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Ge,{onClick:()=>S(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},We=({displayName:c})=>{const t=ee(C=>C.languages.value),l=t==="ko"||t==="en"?t:"ko",S=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Ae,{icon:e.jsx(Fe,{}),title:S==="piazza"?be[l][0]:`${be[l][1]} ${c}`}),S==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ke,{})})]})};function Ze(){const[c,t]=n.useState([]),[l,S]=n.useState(!0),[C,A]=n.useState(!0),[P,E]=n.useState(""),[y,r]=n.useState(null),[$,v]=n.useState(null),T=Ue(),I=n.useRef(null),R=n.useRef(null),K={audio:!0,video:!1},k=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:k.map(s=>s.urls)}]}),B=location.search.slice(4);console.log(location.search.slice(4)),n.useEffect(()=>{(async()=>{await u()})()},[]),n.useEffect(()=>{I.current&&(I.current.srcObject=y)},[y]);async function i(){const s=y;s&&s.getAudioTracks().forEach(o=>o.enabled=!o.enabled),S(!l)}async function b(){const s=y;s&&s.getVideoTracks().forEach(o=>o.enabled=!o.enabled),A(!C)}const U=()=>{I.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(I.current)};n.useEffect(()=>{$&&z($)},[$]);async function u(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput");t(o)}catch(s){console.log(s)}}async function z(s){try{const x=s?{audio:!0,video:{deviceId:{exact:s}}}:K,N=await navigator.mediaDevices.getUserMedia(x);r(N),E("")}catch(o){const x=o==null?void 0:o.toString();x&&E(x),console.log(o)}}function j(s){console.log("icecandidate"),console.log(s),f.emit("ice",s.candidate,B)}function M(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",y),R.current=s.stream}function a(){D.addEventListener("icecandidate",j),D.addEventListener("addstream",M),y&&y.getTracks().forEach(s=>D.addTrack(s,y))}async function m(){await z(null),a()}async function p(){await m(),f.emit("joinRoom",B,m)}n.useEffect(()=>{p()},[]);const w=async()=>{console.log("sent the offer"),console.log(D);const s=await D.createOffer();D.setLocalDescription(s),console.log(s),f.emit("offer",s,B)};n.useEffect(()=>{if(f)return f.on("welcome",w),()=>{f.off("welcome",w)}});const g=async s=>{console.log("received the offer"),D.setRemoteDescription(s);const o=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(o),f.emit("answer",o,B)};n.useEffect(()=>{if(f)return f.on("offer",g),()=>{f.off("offer",g)}});const h=s=>{console.log("received the answer"),D.setRemoteDescription(s)};n.useEffect(()=>{if(f)return f.on("answer",h),()=>{f.off("answer",h)}});const d=s=>{console.log("received candidate"),D.addIceCandidate(s)};return n.useEffect(()=>{if(f)return f.on("ice",d),()=>{f.off("ice",d)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:I,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(X,{onClick:i,children:l?"unmute":"mute"}),e.jsx(X,{onClick:b,children:C?"turn stream on":"turn stream off"}),e.jsx(X,{onClick:U,children:"stop"})]})}),P&&e.jsx("div",{children:P})]})}function Xe(){const[c,t]=n.useState([]),[l,S]=n.useState(!0),[C,A]=n.useState(!0),[P,E]=n.useState(""),[y,r]=n.useState(null),[$,v]=n.useState(null),T=Ue(),I=n.useRef(null),R=n.useRef(null),K={audio:!0,video:!0};let k;const D=location.search.slice(4);console.log(location.search.slice(4)),n.useEffect(()=>{(async()=>{await u()})()},[]),n.useEffect(()=>{I.current&&(I.current.srcObject=y)},[y]);async function B(){const s=y;s&&s.getAudioTracks().forEach(o=>o.enabled=!o.enabled),S(!l)}async function i(){const s=y;s&&s.getVideoTracks().forEach(o=>o.enabled=!o.enabled),A(!C)}const b=()=>{I.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(I.current)};async function U(s){if(I.current.srcObject.getTracks().forEach(o=>o.stop()),v(s.target.value),k){console.log(k.getSenders());const o=y.getVideoTracks()[0];k.getSenders().find(N=>N.track.kind==="video").replaceTrack(o)}}n.useEffect(()=>{$&&z($)},[$]);async function u(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput");t(o)}catch(s){console.log(s)}}async function z(s){try{const x=s?{audio:!0,video:{deviceId:{exact:s}}}:K,N=await navigator.mediaDevices.getUserMedia(x);r(N),E("")}catch(o){const x=o==null?void 0:o.toString();x&&E(x),console.log(o)}}function j(s){console.log("icecandidate"),console.log(s),f.emit("ice",s.candidate,D)}function M(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",y),R.current=s.stream}function a(){k=new RTCPeerConnection,k&&(k.addEventListener("icecandidate",j),k.addEventListener("addstream",M)),y&&y.getTracks().forEach(s=>k.addTrack(s,y))}async function m(){await z(null),a()}async function p(){await m(),f.emit("joinRoom",D,m)}n.useEffect(()=>{p()},[]);const w=async()=>{console.log("sent the offer"),console.log(k);const s=await k.createOffer();k.setLocalDescription(s),console.log(s),f.emit("offer",s,D)};n.useEffect(()=>{if(f)return f.on("welcome",w),()=>{f.off("welcome",w)}});const g=async s=>{console.log("received the offer"),k.setRemoteDescription(s);const o=await k.createAnswer();console.log("sent the answer"),console.log(k),console.log(o),k.setLocalDescription(o),f.emit("answer",o,D),a()};n.useEffect(()=>{if(f)return f.on("offer",g),()=>{f.off("offer",g)}});const h=s=>{console.log("received the answer"),k.setRemoteDescription(s),a()};n.useEffect(()=>{if(f)return f.on("answer",h),()=>{f.off("answer",h)}});const d=s=>{console.log("received candidate"),k.addIceCandidate(s)};return n.useEffect(()=>{if(f)return f.on("ice",d),()=>{f.off("ice",d)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:I,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(X,{onClick:B,children:l?"unmute":"mute"}),e.jsx(X,{onClick:i,children:C?"turn stream on":"turn stream off"}),e.jsx(X,{onClick:b,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:U,children:c.map((s,o)=>e.jsx("option",{value:s.deviceId,selected:(y==null?void 0:y.getVideoTracks()[0].id)===s.deviceId,children:s.label},o))})]}),P&&e.jsx("div",{children:P})]})}function Qe({userObj:c}){const[t,l]=n.useState(""),[S,C]=n.useState([]),A=pe(),{state:P}=Pe(),[E,y]=n.useState(!1),[r,$]=n.useState(null),[v,T]=n.useState(""),[I,R]=n.useState(""),[K,k]=n.useState(""),D=u=>{T(u)},B=u=>{R(u)},i=location.search.slice(location.search.indexOf("=")+1);console.log(r),console.log(v),n.useEffect(()=>{P?(T(P.chattingUid),R(P.displayName)):(T(""),R(""))},[i]),n.useEffect(()=>{i&&(async()=>{if(v){const z=_(V,`members/${v}`),j=await O(z);$(j.data())}})()},[i,v]);const b=ie(u=>u.piazzaForm.value);n.useEffect(()=>{var z;const u=()=>{var M;const j=window.screen.height-300>(((M=window.visualViewport)==null?void 0:M.height)||window.screen.height);E!==j&&y(j)};return window.addEventListener("resize",u),typeof visualViewport<"u"&&((z=window.visualViewport)==null||z.addEventListener("resize",u)),visualViewport==null||visualViewport.addEventListener("resize",u),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",u)),()=>{var j;typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.removeEventListener("resize",u))}},[E]);const U=()=>{var u;k(""),(u=document.getElementById("myScreen"))==null||u.srcObject.getTracks().forEach(z=>z.stop())};return n.useEffect(()=>{A(Le(5))}),e.jsxs(e.Fragment,{children:[!E&&e.jsx(We,{multiple:!i,displayName:I}),e.jsx(qe,{isKeyboardOpen:b,userObj:c,messagesList:S,handleMessagesList:u=>C(u),handleChatUid:D,handleChatDisplayName:B}),e.jsx(Ye,{chattingUser:r,userObj:c,multiple:!i,messages:t,handleMessages:u=>l(u),messagesList:S,handleMessagesList:u=>C(u)}),e.jsxs(ze,{children:[e.jsx(Se,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Xe,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]}),e.jsxs(ze,{children:[e.jsx(Se,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Ze,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]})]})}export{Qe as default};
