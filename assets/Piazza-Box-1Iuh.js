import{b2 as Pe,u as ie,c as oe,O as xe,aV as ne,r as d,j as e,P as ue,Y as le,b1 as pe,X as ke,b3 as Ce,aX as Me,v as _,m as U,I as Y,$ as y,a_ as ze,l as ae,C as se,b4 as Te,N as he,B as ce,b5 as Ne,q as de,Z as ge,_ as fe,n as me,aY as Se,s as $e,S as Re,Q as De,D as Ve,b6 as Fe,aJ as Be,aa as Ae,b7 as Le,b8 as He,b9 as _e,ba as Ye}from"./index-CExUjiOU.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Pe("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=Pe("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ze={ko:"메세지를 작성해 주세요",en:"Input message"},Ge={ko:"전송",en:"send"};function Xe({chattingUser:a,userObj:m,multiple:C,messages:t,handleMessages:i,messagesList:P,handleMessagesList:u}){const j=ie(f=>f.profileColor.value),R=ie(f=>f.piazzaForm.value),c=oe(f=>f.profile.value),q=xe(),{state:N}=ne(),v=N==null?void 0:N.conversation,B=oe(f=>f.languages.value),M=B==="ko"||B==="en"?B:"ko",[k,V]=d.useState(!1),F=async f=>{var z;f.preventDefault();const S=t,E=m.uid,T=m.displayName,w=Date.now(),o=new Date().toString(),l=c==null?void 0:c.profileImageUrl,s=c==null?void 0:c.defaultProfile,n=c==null?void 0:c.profileImage;let r,h,g;a&&(r=_(U,`members/${a.uid}`),h=await Y(r),g=(z=h.data())==null?void 0:z.messagingToken);const p=c.profileImage?c.profileImageUrl:c.defaultProfile;console.log(c);const x={msg:S,userUid:E,id:T,messageClockNumber:w,messageClock:o,conversation:v,conversationUid:a==null?void 0:a.uid,conversationName:a==null?void 0:a.displayName,profileImage:n,defaultProfile:s,profileImageUrl:l,profileUrl:p,sendingToken:g};C?x&&S&&(y.emit("piazzaMessage",x),K()):S&&(P.length!==0?(y.emit("message",x),console.log("message")):(y.emit("messageNew",x),console.log("messageNew")),b(),O()),i("")},W=f=>{i(f.target.value)},K=async()=>{try{const f=t,S=m.uid,E=m.displayName,T=new Date().toString(),w=Date.now(),o=c==null?void 0:c.profileImageUrl,l=c==null?void 0:c.defaultProfile,s=c==null?void 0:c.profileImage;f&&(await ze(ae(U,"chats_group"),{userUid:S,userName:E,message:f,messageClock:T,messageClockNumber:w,profileImageUrl:o,defaultProfile:l,profileColor:j,piazzaChecked:[m.uid],profileImage:s}),u(n=>[...n,{msg:f,type:"me",userUid:m.uid,id:m.displayName,messageClock:T,conversation:null,profileColor:j,messageClockNumber:w,defaultProfile:l,profileImageUrl:o,profileImage:s||!1}]))}catch(f){console.log(f)}},b=async()=>{var S,E,T;const f=t;try{const w=m.uid,o=m.displayName,l=Date.now(),s=new Date().toString(),n=c.profileImage,r=a.profileImage,h=c.profileImageUrl,g=a.profileImageUrl,p=c.defaultProfile,x=a.defaultProfile;let z,D,H,A,L,Z,ee,J,Q,G;if(m.uid<a.uid?(z=m.uid,D=a.uid,H=m.displayName,A=a.displayName,L=h,Z=g,ee=p,J=x,Q=c.profileImage,G=a.profileImage):(z=a.uid,D=m.uid,H=a.displayName,A=m.displayName,L=g,Z=h,ee=x,J=p,Q=a.profileImage,G=c.profileImage),!L){const X=_(U,`members/${z}`);L=(S=(await Y(X)).data())==null?void 0:S.profileImageUrl}if(!Z){const X=_(U,`members/${D}`);Z=(E=(await Y(X)).data())==null?void 0:E.profileImageUrl}if(f){const X={userUid:w,userName:o,message:f,messageClock:s,messageClockNumber:l,userOne:z,userTwo:D,userOneDisplayName:H,userTwoDisplayName:A,userOneProfileUrl:L,userTwoProfileUrl:Z,userOneDefaultProfile:ee,userTwoDefaultProfile:J,userOneProfileImage:Q,userTwoProfileImage:G};await ze(ae(U,`chats_${v}`),X);const te=_(U,`members/${w}`),we=(await Y(te)).data().chattings||{},ye=_(U,`members/${a.uid}`),re=(await Y(ye)).data().chattings||{},Ee=((T=re[v])==null?void 0:T.messageCount)||0;we[v]=X,re[v]={...X,messageCount:Ee+1},await se(te,{chattings:we}),await se(ye,{chattings:re}),u(Ue=>[...Ue,{msg:f,type:"me",userUid:m.uid,id:m.displayName,messageClock:s,conversation:v,userName:o,messageClockNumber:l,userOne:z,userTwo:D,userOneDisplayName:H,userTwoDisplayName:A,userOneProfileUrl:L,userTwoProfileUrl:Z,userOneDefaultProfile:ee,userTwoDefaultProfile:J,userOneProfileImage:Q,userTwoProfileImage:G}])}}catch(w){console.log(w)}},O=async()=>{try{const f=m.uid,S=a.uid,E=_(U,`members/${f}`),w=(await Y(E)).data().conversation||[],o=_(U,`members/${S}`),s=(await Y(o)).data().conversation||[];w.indexOf(v)===-1&&(await se(E,{conversation:[...w,v]}),q(Te())),s.indexOf(v)===-1&&await se(o,{conversation:[...s,v]})}catch(f){console.log(f)}};return d.useEffect(()=>{if(k){document.getElementById("mute"),document.getElementById("stream");const f=document.getElementById("videoInput");document.getElementById("myFace");let S;async function E(){try{const w={video:!0,audio:!0};S=await navigator.mediaDevices.getUserMedia(w),S.getVideoTracks().forEach(o=>o.enabled=!o.enabled),S.getAudioTracks().forEach(o=>o.enabled=!o.enabled),T()}catch(w){console.log(w)}}E();async function T(){try{const o=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput");o.forEach(l=>{const s=document.createElement("option");s.value=l.deviceId,s.innerText=l.label,f==null||f.appendChild(s)}),console.log(o)}catch(w){console.log(w)}}}}),console.log(N),e.jsx(e.Fragment,{children:e.jsxs("form",{className:`fixed w-screen ${R?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:F,children:[v&&v!=="piazza"&&e.jsx(ue,{trigger:e.jsx("button",{className:"px-1 h-full rounded bg-light-2 dark:bg-dark-2",type:"submit",children:e.jsx(Ke,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(le,{to:`/piazza?id=${v}?calls=video`,state:N,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var f;(f=document.getElementById("calls"))==null||f.click()},children:[e.jsx(Me,{}),e.jsx("div",{children:"화상 전화"})]})})})})}),e.jsx(le,{to:`/piazza?id=${v}?calls=audio`,state:N,children:e.jsx(pe,{children:e.jsx(ke,{className:"colorOne",sx:{height:"100%"},children:e.jsx(Ce,{children:e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[e.jsx(qe,{}),e.jsx("div",{children:"음성 전화"})]})})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ze[M],onChange:W,value:t,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ge[M]})]})})}const Ie=({initiateContinuing:a,multiple:m,handleMultiple:C,user:t,userObj:i,handleMessagesList:P,displayedName:u})=>{const{state:j}=ne(),R=(j==null?void 0:j.conversation)||"piazza",c=oe(v=>v.languages.value),[q,N]=d.useState("");return d.useEffect(()=>{t&&((t==null?void 0:t.uid)<i.uid?N((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):N(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:i.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==u&&e.jsx("div",{children:c==="ko"?e.jsxs("div",{children:["(",u,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",u,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(le,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ce,{variant:"outlined",onClick:()=>{},children:c==="ko"?"프로필 확인":"Check Profile"})}),R==="piazza"&&i.uid!==(t==null?void 0:t.uid)&&e.jsx(le,{to:`${location.pathname}?id=${q}`,state:{conversation:q,displayName:t==null?void 0:t.displayName,userUid:i.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(ce,{variant:"outlined",onClick:()=>{P([]),C(!1),a()},children:c==="ko"?"개인 대화":"Private messaging"})})})]})]})};function je({userObj:a,multiple:m,handleMultiple:C,messagesList:t,handleMessagesList:i}){const P=d.useRef(null),u=d.useRef(null),[j,R]=d.useState(null),[c,q]=d.useState(""),[N,v]=d.useState(!1),[B,M]=d.useState(null),[k,V]=d.useState(0),[F,W]=d.useState("piazza"),{state:K}=ne(),b=(K==null?void 0:K.conversation)||"piazza";d.useEffect(()=>{F!==b&&(i([]),M(null),V(0),W(b))},[b]);const O=oe(o=>o.languages.value),f=async({userUid:o,displayName:l})=>{const s=_(U,`members/${o}`),r=(await Y(s)).data();R(r),q(l),console.log("practice")},S=({userUid:o,displayName:l})=>{var s;(s=document.getElementById("drawer"))==null||s.click(),f({userUid:o,displayName:l})},E=20;d.useEffect(()=>{if(!y)return;function o(l){const{msg:s,userUid:n,id:r,target:h,messageClock:g,messageClockNumber:p,profileImageUrl:x,defaultProfile:z,profileImage:D,conversation:H}=l;i(A=>[...A,{msg:s,type:h?"private":"other",userUid:n,id:r,messageClock:g,messageClockNumber:p,conversation:null,profileImageUrl:x,defaultProfile:z,profileImage:D}])}return y.on("sMessagePiazza",o),()=>{y.off("sMessagePiazza",o)}},[]),d.useEffect(()=>{if(!y)return;function o(l){const{msg:s,userUid:n,id:r,target:h,messageClock:g,messageClockNumber:p,conversation:x,profileImageUrl:z,defaultProfile:D,profileImage:H,piazzaData:A}=l;i(L=>[...L,{msg:s,type:h?"private":"other",userUid:n,id:r,messageClock:g,messageClockNumber:p,conversation:null,profileImageUrl:z,defaultProfile:D,profileImage:H,...A}])}return y.on(`sMessage${b}`,o),()=>{y.off(`sMessage${b}`,o)}},[b]),d.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),d.useEffect(()=>{T(),(async()=>{if(m){const l=ae(U,"chats_group"),s=de(l,fe("messageClockNumber","desc"),ge(1));(await me(s)).forEach(async r=>{const h=_(U,`chats_group/${r.id}`),p=(await Y(h)).data(),x=p.piazzaChecked||[];x.indexOf(a.uid)===-1&&(x.splice(-1,a.uid,0),x.push(a.uid),await se(h,{...p,piazzaChecked:x}))})}else{const l=_(U,`members/${a.uid}`),n=(await Y(l)).data().chattings;n[b]&&(n[b].messageCount=0),await se(l,{chattings:n})}})()},[t]);const T=()=>{var o;(o=P.current)==null||o.scrollIntoView()};d.useEffect(()=>{const o=async()=>{const s=[],n=ae(U,"chats_group"),r=de(n,fe("messageClockNumber","desc"),ge(E),Se(B||"")),h=await me(r);h.docs.length||V(h.docs.length),h.forEach(g=>{var J,Q,G;s.length===h.docs.length-1&&(M(g),V(h.docs.length-1));const p=g.data().message,x=g.data().userUid,z=g.data().userName,D=g.data().messageClock,H=g.data().messageClockNumber,A=(J=g.data())==null?void 0:J.profileImageUrl,L=(Q=g.data())==null?void 0:Q.defaultProfile,Z=(G=g.data())==null?void 0:G.profileImage,ee=g.data();s.push({msg:p,userUid:x,id:z,messageClockNumber:H,messageClock:D,conversation:null,profileImageUrl:A,defaultProfile:L,profileImage:Z||!1,...ee})}),s.reverse(),i([...s,...t]),v(!1)},l=async s=>{const n=ae(U,`chats_${s}`),r=de(n,fe("messageClockNumber","desc"),ge(E),Se(B||"")),h=await me(r),g=[];h.docs.length||V(h.docs.length),h.forEach((p,x)=>{var G,X,te;g.length===h.docs.length-1&&(M(p),V(h.docs.length-1));const z=p.data().message,D=p.data().userUid,H=p.data().userName,A=p.data().messageClock,L=p.data().messageClockNumber||0,Z=(G=p.data())==null?void 0:G.profileImageUrl,ee=(X=p.data())==null?void 0:X.defaultProfile,J=(te=p.data())==null?void 0:te.profileImage,Q=p.data();g.push({msg:z,userUid:D,id:H,messageClockNumber:L,messageClock:A,conversation:null,profileImageUrl:Z,defaultProfile:ee,profileImage:J||!1,...Q})}),g.reverse(),i([...g,...t]),v(!1)};b==="piazza"?(N||!t.length)&&o():(N||!t.length)&&l(b)},[N,b]);const w=()=>{u.current.scrollTop!==0||N||(console.log("scroll"),v(!0))};return d.useEffect(()=>{var o;return(o=u.current)==null||o.addEventListener("scroll",w),()=>{var l;return(l=u.current)==null?void 0:l.removeEventListener("scroll",w)}},[N]),console.log(b),console.log(t),console.log(j),e.jsx(e.Fragment,{children:e.jsx("div",{ref:u,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[N&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((o,l)=>{let s;b==="piazza"?s=o:o.userUid===o.userOne?s={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:s={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let n;const r=new Date(o.messageClock);o.userUid===a.uid?n="text-right":n="text-left";let h,g;l>0&&(h=t[l-1].userUid),l<t.length-1&&t[l+1].userUid===a.uid&&(g=new Date(t[l+1].messageClock),r.getFullYear()===g.getFullYear()&&r.getMonth()===g.getMonth()&&r.getDate()===g.getDate()&&r.getHours()===g.getHours()&&(r.getMinutes(),g.getMinutes()));let p,x=r.getHours(),z=(r.getMonth()+1).toString(),D=r.getDate().toString();return x>=13?(p="오후",x!==12&&(x=x-12)):(p="오전",x===0&&(x=x+12)),r.getMonth()+1<10&&(z="0"+z),D.length===1&&(D="0"+D),e.jsxs("li",{ref:l===k?P:null,className:n,children:[h!==o.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${o.userUid!==a.uid?"start":"end"}`,children:n==="text-left"?e.jsxs("div",{className:"flex gap-3",children:[e.jsx(ue,{trigger:e.jsx(he,{element:s,piazza:()=>S({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(Ie,{initiateContinuing:()=>M(null),multiple:m,handleMultiple:C,user:j,userObj:a,handleMessagesList:i,displayedName:c})}),e.jsx("div",{children:o.id})]}):e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{children:o.id}),e.jsx(ue,{trigger:e.jsx(he,{element:s,piazza:()=>S({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(Ne,{}),content:e.jsx(Ie,{initiateContinuing:()=>M(null),multiple:m,handleMultiple:C,user:j,userObj:a,handleMessagesList:i,displayedName:c})})]})})}),o.userUid!==a.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),e.jsxs("div",{children:[r.getFullYear(),"-",z,"-",D," ",O==="ko"&&p," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),O==="en"&&(p==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[r.getFullYear(),"-",z,"-",D," ",O==="ko"&&p," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),O==="en"&&(p==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},l)}),e.jsx("li",{ref:P})]})})})}function Je({isKeyboardOpen:a,userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:P}){return e.jsx(e.Fragment,{children:a?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(je,{userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:P})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(je,{userObj:m,multiple:C,handleMultiple:t,messagesList:i,handleMessagesList:P})})})}const Qe=$e(Re)(({theme:a})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function We(){const a=oe(i=>i.languages.value),m=ie(i=>i.piazzaSwitch.value),C=xe(),t=()=>{m==="true"?(window.localStorage.setItem("piazza","false"),C(De("false"))):(window.localStorage.setItem("piazza","true"),C(De("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:a==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Qe,{onClick:()=>t(),inputProps:{"aria-label":"ant design"},checked:m==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Oe=({multiple:a,displayName:m})=>{const C=oe(u=>u.languages.value),t=C==="ko"||C==="en"?C:"ko",{state:i}=ne(),P=(i==null?void 0:i.conversation)||"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Ve,{icon:e.jsx(Fe,{}),title:P==="piazza"?be[t][0]:`${be[t][1]} ${m}`}),a&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(We,{})})]})};let I,$;function et(){const[a,m]=d.useState([]),[C,t]=d.useState(!0),[i,P]=d.useState(!0),[u,j]=d.useState(""),[R,c]=d.useState(null),q=Be(),N=document.getElementById("myScreen"),v=document.getElementById("devices"),B={audio:!0,video:!0},M=location.search.slice(4);console.log(location.search.slice(4));async function k(){const s=I;s&&s.getAudioTracks().forEach(n=>n.enabled=!n.enabled),t(!C)}async function V(){const s=I;s&&s.getVideoTracks().forEach(n=>n.enabled=!n.enabled),P(!i)}async function F(s){if(console.log(v.value),I.getTracks().forEach(r=>r.stop()),c(s.target.value),$){console.log($.getSenders());const r=I.getVideoTracks()[0];$.getSenders().find(g=>g.track.kind==="video").replaceTrack(r)}}d.useEffect(()=>{I?(I.getTracks().forEach(s=>s.stop()),setTimeout(()=>K(R),1e3)):K(R),noDevice&&setTimeout(()=>K(R),1e3)},[v,R]);async function W(){try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");m(n)}catch(s){console.log(s)}}async function K(s){try{const r=s?{audio:!0,video:{deviceId:{exact:s}}}:B;I&&I.getTracks().forEach(g=>g.stop()),I=await navigator.mediaDevices.getUserMedia(r);const h=await navigator.mediaDevices.enumerateDevices();N.srcObject=I,await W(),j(""),console.log(I.getVideoTracks()[0].label)}catch(n){console.log(n),j(n)}}function b(s){console.log("icecandidate"),console.log(s),y.emit("ice",s.candidate,M)}function O(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",I);const n=document.getElementById("yourScreen");n.srcObject=s.stream}function f(){const s=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];$=new RTCPeerConnection({iceServers:[{urls:s.map(n=>n.urls)}]}),$.addEventListener("icecandidate",b),$.addEventListener("addstream",O),I&&I.getTracks().forEach(n=>$.addTrack(n,I))}async function S(){await K(null),f()}async function E(){await S(),y.emit("joinRoom",M,S)}d.useEffect(()=>{E()},[]);const T=async()=>{console.log("sent the offer"),console.log($);const s=await $.createOffer();$.setLocalDescription(s),console.log(s),y.emit("offer",s,M)};d.useEffect(()=>{if(y)return y.on("welcome",T),()=>{y.off("welcome",T)}});const w=async s=>{console.log("received the offer"),$.setRemoteDescription(s);const n=await $.createAnswer();console.log("sent the answer"),$.setLocalDescription(n),y.emit("answer",n,M)};d.useEffect(()=>{if(y)return y.on("offer",w),()=>{y.off("offer",w)}});const o=s=>{console.log("received the answer"),$.setRemoteDescription(s)};d.useEffect(()=>{if(y)return y.on("answer",o),()=>{y.off("answer",o)}});const l=s=>{console.log("received candidate"),$.addIceCandidate(s)};return d.useEffect(()=>{if(y)return y.on("ice",l),()=>{y.off("ice",l)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!q&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ce,{onClick:k,children:C?"unmute":"mute"}),e.jsx(ce,{onClick:V,children:i?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:F,children:a.map((s,n)=>e.jsx("option",{value:s.deviceId,selected:(I==null?void 0:I.getVideoTracks()[0].id)===s.deviceId,children:s.label},n))})]}),u&&e.jsx("div",{children:u.toString()})]})}function ot({userObj:a}){const[m,C]=d.useState(""),[t,i]=d.useState([]),P=xe(),{state:u}=ne(),[j,R]=d.useState(!0),[c,q]=d.useState(!1),[N,v]=d.useState(null);d.useEffect(()=>{const k=async()=>{if(u!=null&&u.chattingUid){const V=_(U,`members/${u.chattingUid}`),F=await Y(V);v(F.data())}};u!=null&&u.multiple||k()},[u]);const B=ie(k=>k.piazzaForm.value);d.useEffect(()=>{var V;const k=()=>{var W;const F=window.screen.height-300>(((W=window.visualViewport)==null?void 0:W.height)||window.screen.height);c!==F&&q(F)};return window.addEventListener("resize",k),typeof visualViewport<"u"&&((V=window.visualViewport)==null||V.addEventListener("resize",k)),visualViewport==null||visualViewport.addEventListener("resize",k),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",k)),()=>{var F;typeof visualViewport<"u"&&((F=window.visualViewport)==null||F.removeEventListener("resize",k))}},[c]),d.useEffect(()=>{(u==null?void 0:u.multiple)!==void 0&&R(u==null?void 0:u.multiple)},[]),d.useEffect(()=>{P(Ae(5))});const M=u==null?void 0:u.displayName;return e.jsxs(e.Fragment,{children:[!c&&e.jsx(Oe,{multiple:j,displayName:M}),e.jsx(Je,{isKeyboardOpen:B,userObj:a,multiple:j,handleMultiple:k=>R(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsx(Xe,{chattingUser:N,userObj:a,multiple:j,messages:m,handleMessages:k=>C(k),messagesList:t,handleMessagesList:k=>i(k)}),e.jsxs(Le,{children:[e.jsx(He,{children:e.jsx("div",{id:"calls"})}),e.jsx(_e,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(et,{})}),e.jsx(Ye,{children:e.jsx("div",{children:"전화 종료"})})]})})]})]})}export{ot as default};
