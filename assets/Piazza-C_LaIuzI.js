import{c as Ee,u as ie,d as ee,G as pe,j as e,P as ge,a0 as he,b8 as xe,b7 as me,b0 as Te,x as O,p as A,O as Y,a4 as g,b4 as ve,n as te,E as Q,b9 as Re,a_ as Pe,r as i,W as ue,a1 as we,B as X,ba as ye,q as le,a2 as re,a3 as de,t as fe,b2 as Ce,s as $e,S as Ve,X as ke,H as Ae,bb as Fe,aN as Ue,af as Le,bc as Se,bd as ze,be as je,bf as Ne}from"./index-Dq8qVTUD.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=Ee("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=Ee("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),_e={ko:"메세지를 작성해 주세요",en:"Input message"},Oe={ko:"전송",en:"send"};function Ye({chattingUser:l,userObj:t,multiple:d,messages:k,handleMessages:y,messagesList:F,handleMessagesList:M}){const D=ie(c=>c.profileColor.value),w=ie(c=>c.piazzaForm.value),f=ee(c=>c.profile.value),$=pe(),x=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",T=ee(c=>c.languages.value),E=T==="ko"||T==="en"?T:"ko",R=async c=>{var s;c.preventDefault();const N=k,P=t.uid,u=t.displayName,C=Date.now(),z=new Date().toString(),U=f==null?void 0:f.profileImageUrl,o=f==null?void 0:f.defaultProfile,h=f==null?void 0:f.profileImage;let p,v,m;l&&(p=O(A,`members/${l.uid}`),v=await Y(p),m=(s=v.data())==null?void 0:s.messagingToken);const a=f.profileImage?f.profileImageUrl:f.defaultProfile;console.log(f);const n={msg:N,userUid:P,id:u,messageClockNumber:C,messageClock:z,conversation:x,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:h,defaultProfile:o,profileImageUrl:U,profileUrl:a,sendingToken:m};d?n&&N&&(g.emit("piazzaMessage",n),V()):N&&(F.length!==0?(g.emit("message",n),console.log("message")):(g.emit("messageNew",n),console.log("messageNew")),I(),H()),y("")},j=c=>{y(c.target.value)},V=async()=>{try{const c=k,N=t.uid,P=t.displayName,u=new Date().toString(),C=Date.now(),z=f==null?void 0:f.profileImageUrl,U=f==null?void 0:f.defaultProfile,o=f==null?void 0:f.profileImage;c&&(await ve(te(A,"chats_group"),{userUid:N,userName:P,message:c,messageClock:u,messageClockNumber:C,profileImageUrl:z,defaultProfile:U,profileColor:D,piazzaChecked:[t.uid],profileImage:o}),M(h=>[...h,{msg:c,type:"me",userUid:t.uid,id:t.displayName,messageClock:u,conversation:null,profileColor:D,messageClockNumber:C,defaultProfile:U,profileImageUrl:z,profileImage:o||!1}]))}catch(c){console.log(c)}},I=async()=>{var N,P,u;const c=k;try{const C=t.uid,z=t.displayName,U=Date.now(),o=new Date().toString(),h=f.profileImage,p=l.profileImage,v=f.profileImageUrl,m=l.profileImageUrl,a=f.defaultProfile,n=l.defaultProfile;let s,r,S,b,B,L,q,W,Z,K;if(t.uid<l.uid?(s=t.uid,r=l.uid,S=t.displayName,b=l.displayName,B=v,L=m,q=a,W=n,Z=f.profileImage,K=l.profileImage):(s=l.uid,r=t.uid,S=l.displayName,b=t.displayName,B=m,L=v,q=n,W=a,Z=l.profileImage,K=f.profileImage),!B){const _=O(A,`members/${s}`);B=(N=(await Y(_)).data())==null?void 0:N.profileImageUrl}if(!L){const _=O(A,`members/${r}`);L=(P=(await Y(_)).data())==null?void 0:P.profileImageUrl}if(c){const _={userUid:C,userName:z,message:c,messageClock:o,messageClockNumber:U,userOne:s,userTwo:r,userOneDisplayName:S,userTwoDisplayName:b,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:q,userTwoDefaultProfile:W,userOneProfileImage:Z,userTwoProfileImage:K};await ve(te(A,`chats_${x}`),_);const G=O(A,`members/${C}`),ae=(await Y(G)).data().chattings||{},oe=O(A,`members/${l.uid}`),J=(await Y(oe)).data().chattings||{},ne=((u=J[x])==null?void 0:u.messageCount)||0;ae[x]=_,J[x]={..._,messageCount:ne+1},await Q(G,{chattings:ae}),await Q(oe,{chattings:J}),M(Me=>[...Me,{msg:c,type:"me",userUid:t.uid,id:t.displayName,messageClock:o,conversation:x,userName:z,messageClockNumber:U,userOne:s,userTwo:r,userOneDisplayName:S,userTwoDisplayName:b,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:q,userTwoDefaultProfile:W,userOneProfileImage:Z,userTwoProfileImage:K}])}}catch(C){console.log(C)}},H=async()=>{try{const c=t.uid,N=l.uid,P=O(A,`members/${c}`),C=(await Y(P)).data().conversation||[],z=O(A,`members/${N}`),o=(await Y(z)).data().conversation||[];C.indexOf(x)===-1&&(await Q(P,{conversation:[...C,x]}),$(Re())),o.indexOf(x)===-1&&await Q(z,{conversation:[...o,x]})}catch(c){console.log(c)}};return e.jsxs("form",{className:`fixed w-screen ${w?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:R,children:[x&&x!=="piazza"&&e.jsx(ge,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(He,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var c;(c=document.getElementById("videoCall"))==null||c.click()},children:e.jsxs(me,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Te,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var c;(c=document.getElementById("audioCall"))==null||c.click()},children:e.jsxs(me,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Be,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:_e[E],onChange:j,value:k,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Oe[E]})]})}const De=({initiateContinuing:l,user:t,userObj:d,handleMessagesList:k,displayedName:y,handleChatUid:F,handleChatDisplayName:M})=>{const{state:D}=Pe(),w=(D==null?void 0:D.conversation)||"piazza",f=ee(T=>T.languages.value),[$,x]=i.useState("");return i.useEffect(()=>{t&&((t==null?void 0:t.uid)<d.uid?x((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]):x(d.uid[0]+d.uid[1]+d.uid[2]+d.uid[3]+d.uid[4]+d.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(ue,{element:t,uid:d.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==y&&e.jsx("div",{children:f==="ko"?e.jsxs("div",{children:["(",y,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(we,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(X,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),w==="piazza"&&d.uid!==(t==null?void 0:t.uid)&&e.jsx(we,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:d.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(me,{children:e.jsx(X,{variant:"outlined",onClick:()=>{k([]),l()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ie({userObj:l,messagesList:t,handleMessagesList:d,handleChatUid:k,handleChatDisplayName:y}){const F=i.useRef(null),M=i.useRef(null),[D,w]=i.useState(null),[f,$]=i.useState(""),[x,T]=i.useState(!1),[E,R]=i.useState(null),[j,V]=i.useState(0),[I,H]=i.useState("piazza"),c=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";i.useEffect(()=>{(I!==c||c==="piazza")&&(d([]),R(null),V(0),H(c))},[c]);const N=ee(o=>o.languages.value),P=async({userUid:o,displayName:h})=>{const p=O(A,`members/${o}`),m=(await Y(p)).data();w(m),$(h),console.log("practice")},u=({userUid:o,displayName:h})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),P({userUid:o,displayName:h})},C=20;i.useEffect(()=>{if(!g)return;function o(h){const{msg:p,userUid:v,id:m,target:a,messageClock:n,messageClockNumber:s,profileImageUrl:r,defaultProfile:S,profileImage:b,conversation:B}=h;d(L=>[...L,{msg:p,type:a?"private":"other",userUid:v,id:m,messageClock:n,messageClockNumber:s,conversation:null,profileImageUrl:r,defaultProfile:S,profileImage:b}])}return g.on("sMessagePiazza",o),()=>{g.off("sMessagePiazza",o)}},[]),i.useEffect(()=>{if(!g)return;function o(h){const{msg:p,userUid:v,id:m,target:a,messageClock:n,messageClockNumber:s,conversation:r,profileImageUrl:S,defaultProfile:b,profileImage:B,piazzaData:L}=h;d(q=>[...q,{msg:p,type:a?"private":"other",userUid:v,id:m,messageClock:n,messageClockNumber:s,conversation:null,profileImageUrl:S,defaultProfile:b,profileImage:B,...L}])}return g.on(`sMessage${c}`,o),()=>{g.off(`sMessage${c}`,o)}},[c]),i.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),i.useEffect(()=>{z(),(async()=>{if(c==="piazza"){const h=te(A,"chats_group"),p=le(h,de("messageClockNumber","desc"),re(1));(await fe(p)).forEach(async m=>{const a=O(A,`chats_group/${m.id}`),s=(await Y(a)).data(),r=s.piazzaChecked||[];r.indexOf(l.uid)===-1&&(r.splice(-1,l.uid,0),r.push(l.uid),await Q(a,{...s,piazzaChecked:r}))})}else{const h=O(A,`members/${l.uid}`),v=(await Y(h)).data().chattings;v[c]&&(v[c].messageCount=0),await Q(h,{chattings:v})}})()},[t]);const z=()=>{var o;(o=F.current)==null||o.scrollIntoView()};i.useEffect(()=>{const o=async()=>{const p=[],v=te(A,"chats_group"),m=le(v,de("messageClockNumber","desc"),re(C),Ce(E||"")),a=await fe(m);a.docs.length||V(a.docs.length),a.forEach(n=>{var K,_,G;p.length===a.docs.length-1&&(R(n),V(a.docs.length-1));const s=n.data().message,r=n.data().userUid,S=n.data().userName,b=n.data().messageClock,B=n.data().messageClockNumber,L=(K=n.data())==null?void 0:K.profileImageUrl,q=(_=n.data())==null?void 0:_.defaultProfile,W=(G=n.data())==null?void 0:G.profileImage,Z=n.data();p.push({msg:s,userUid:r,id:S,messageClockNumber:B,messageClock:b,conversation:null,profileImageUrl:L,defaultProfile:q,profileImage:W||!1,...Z})}),p.reverse(),d([...p,...t]),T(!1)},h=async p=>{const v=te(A,`chats_${p}`),m=le(v,de("messageClockNumber","desc"),re(C),Ce(E||"")),a=await fe(m),n=[];a.docs.length||V(a.docs.length),a.forEach((s,r)=>{var ce,J,ne;n.length===a.docs.length-1&&(R(s),V(a.docs.length-1));const S=s.data().message,b=s.data().userUid,B=s.data().userName,L=s.data().messageClock,q=s.data().messageClockNumber||0,W=(ce=s.data())==null?void 0:ce.profileImageUrl,Z=(J=s.data())==null?void 0:J.defaultProfile,K=(ne=s.data())==null?void 0:ne.profileImage,_=s.data(),G=s.data().userOne,se=s.data().userOneDisplayName,ae=s.data().userTwo,oe=s.data().userTwoDisplayName;G!==l.uid?(k(G),y(se)):(k(ae),y(oe)),n.push({msg:S,userUid:b,id:B,messageClockNumber:q,messageClock:L,conversation:null,profileImageUrl:W,defaultProfile:Z,profileImage:K||!1,..._})}),n.reverse(),d([...n,...t]),T(!1)};console.log(t.length),c==="piazza"?(x||!t.length)&&o():(x||!t.length)&&h(c)},[x,I]);const U=()=>{M.current.scrollTop!==0||x||(console.log("scroll"),T(!0))};return i.useEffect(()=>{var o;return(o=M.current)==null||o.addEventListener("scroll",U),()=>{var h;return(h=M.current)==null?void 0:h.removeEventListener("scroll",U)}},[x]),console.log(c),console.log(t),console.log(D),e.jsx(e.Fragment,{children:e.jsx("div",{ref:M,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[x&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((o,h)=>{let p;c==="piazza"?p=o:o.userUid===o.userOne?p={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:p={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let v;const m=new Date(o.messageClock);o.userUid===l.uid?v="text-right":v="text-left";let a,n;h>0&&(a=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===l.uid&&(n=new Date(t[h+1].messageClock),m.getFullYear()===n.getFullYear()&&m.getMonth()===n.getMonth()&&m.getDate()===n.getDate()&&m.getHours()===n.getHours()&&(m.getMinutes(),n.getMinutes()));let s,r=m.getHours(),S=(m.getMonth()+1).toString(),b=m.getDate().toString();return r>=13?(s="오후",r!==12&&(r=r-12)):(s="오전",r===0&&(r=r+12)),m.getMonth()+1<10&&(S="0"+S),b.length===1&&(b="0"+b),e.jsxs("li",{ref:h===j?F:null,className:v,children:[a!==o.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${o.userUid!==l.uid?"start":"end"}`,children:v==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(ge,{trigger:e.jsx(ue,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>R(null),user:D,userObj:l,handleMessagesList:d,displayedName:f})}),e.jsx("div",{children:o.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:o.id}),e.jsx(ge,{trigger:e.jsx(ue,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>R(null),user:D,userObj:l,handleMessagesList:d,displayedName:f,handleChatUid:k,handleChatDisplayName:y})})]})})}),o.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),e.jsxs("div",{children:[m.getFullYear(),"-",S,"-",b," ",N==="ko"&&s," ",r,":",m.getMinutes()<10&&"0",m.getMinutes(),N==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[m.getFullYear(),"-",S,"-",b," ",N==="ko"&&s," ",r,":",m.getMinutes()<10&&"0",m.getMinutes(),N==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},h)}),e.jsx("li",{ref:F})]})})})}function qe({isKeyboardOpen:l,userObj:t,messagesList:d,handleMessagesList:k,handleChatUid:y,handleChatDisplayName:F}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ie,{userObj:t,messagesList:d,handleMessagesList:k,handleChatUid:y,handleChatDisplayName:F})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ie,{userObj:t,messagesList:d,handleMessagesList:k,handleChatUid:y,handleChatDisplayName:F})})})}const Ge=$e(Ve)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ke(){const l=ee(y=>y.languages.value),t=ie(y=>y.piazzaSwitch.value),d=pe(),k=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),d(ke("false"))):(window.localStorage.setItem("piazza","true"),d(ke("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Ge,{onClick:()=>k(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},We=({displayName:l})=>{const t=ee(y=>y.languages.value),d=t==="ko"||t==="en"?t:"ko",k=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Ae,{icon:e.jsx(Fe,{}),title:k==="piazza"?be[d][0]:`${be[d][1]} ${l}`}),k==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ke,{})})]})};function Ze(){const[l,t]=i.useState([]),[d,k]=i.useState(!0),[y,F]=i.useState(!0),[M,D]=i.useState(""),[w,f]=i.useState(null),[$,x]=i.useState(null),T=Ue(),E=i.useRef(null),R=i.useRef(null),j={audio:!0,video:!1},V=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],I=new RTCPeerConnection({iceServers:[{urls:V.map(s=>s.urls)}]}),H=location.search.slice(4);console.log(location.search.slice(4)),i.useEffect(()=>{(async()=>{await u()})()},[]),i.useEffect(()=>{E.current&&(E.current.srcObject=w)},[w]);async function c(){const s=w;s&&s.getAudioTracks().forEach(r=>r.enabled=!r.enabled),k(!d)}async function N(){const s=w;s&&s.getVideoTracks().forEach(r=>r.enabled=!r.enabled),F(!y)}const P=()=>{E.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(E.current)};i.useEffect(()=>{$&&C($)},[$]);async function u(){try{const r=(await navigator.mediaDevices.enumerateDevices()).filter(S=>S.kind==="videoinput");t(r)}catch(s){console.log(s)}}async function C(s){try{const S=s?{audio:!0,video:{deviceId:{exact:s}}}:j,b=await navigator.mediaDevices.getUserMedia(S);f(b),D("")}catch(r){const S=r==null?void 0:r.toString();S&&D(S),console.log(r)}}function z(s){console.log("icecandidate"),console.log(s),g.emit("ice",s.candidate,H)}function U(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",w),R.current=s.stream}function o(){I.addEventListener("icecandidate",z),I.addEventListener("addstream",U),w&&w.getTracks().forEach(s=>I.addTrack(s,w))}async function h(){await C(null),o()}async function p(){await h(),g.emit("joinRoom",H,h)}i.useEffect(()=>{p()},[]);const v=async()=>{console.log("sent the offer"),console.log(I);const s=await I.createOffer();I.setLocalDescription(s),console.log(s),g.emit("offer",s,H)};i.useEffect(()=>{if(g)return g.on("welcome",v),()=>{g.off("welcome",v)}});const m=async s=>{console.log("received the offer"),I.setRemoteDescription(s);const r=await I.createAnswer();console.log("sent the answer"),I.setLocalDescription(r),g.emit("answer",r,H)};i.useEffect(()=>{if(g)return g.on("offer",m),()=>{g.off("offer",m)}});const a=s=>{console.log("received the answer"),I.setRemoteDescription(s)};i.useEffect(()=>{if(g)return g.on("answer",a),()=>{g.off("answer",a)}});const n=s=>{console.log("received candidate"),I.addIceCandidate(s)};return i.useEffect(()=>{if(g)return g.on("ice",n),()=>{g.off("ice",n)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:E,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(X,{onClick:c,children:d?"unmute":"mute"}),e.jsx(X,{onClick:N,children:y?"turn stream on":"turn stream off"}),e.jsx(X,{onClick:P,children:"stop"})]})}),M&&e.jsx("div",{children:M})]})}function Xe(){const[l,t]=i.useState([]),[d,k]=i.useState(!0),[y,F]=i.useState(!0),[M,D]=i.useState(""),[w,f]=i.useState(null),[$,x]=i.useState(null),T=Ue(),E=document.getElementById("myScreen"),R={audio:!0,video:!0},j=new RTCPeerConnection,V=location.search.slice(4);console.log(location.search.slice(4)),i.useEffect(()=>{(async()=>{await navigator.mediaDevices.getUserMedia(R),await N()})()},[]),i.useEffect(()=>{E&&(E.srcObject=w)},[w]);async function I(){const a=w;a&&a.getAudioTracks().forEach(n=>n.enabled=!n.enabled),k(!d)}async function H(){const a=w;a&&a.getVideoTracks().forEach(n=>n.enabled=!n.enabled),F(!y)}async function c(a){if(E.srcObject.getTracks().forEach(n=>n.stop()),x(a.target.value),j){console.log(j.getSenders());const n=w.getVideoTracks()[0];j.getSenders().find(r=>r.track.kind==="video").replaceTrack(n)}}i.useEffect(()=>{$&&P($)},[$]);async function N(){try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput");t(n)}catch(a){console.log(a)}}async function P(a){try{const s=a?{audio:!0,video:{deviceId:{exact:a}}}:R;console.log("practice");const r=await navigator.mediaDevices.getUserMedia(s);f(r);const S=await navigator.mediaDevices.enumerateDevices();D("")}catch(n){D(n)}}function u(a){console.log("icecandidate"),console.log(a),g.emit("ice",a.candidate,V)}function C(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",w);const n=document.getElementById("yourScreen");n.srcObject=a.stream}function z(){j.addEventListener("icecandidate",u),j.addEventListener("addstream",C),w&&w.getTracks().forEach(a=>j.addTrack(a,w))}async function U(){await P(null),z()}async function o(){await U(),g.emit("joinRoom",V,U)}i.useEffect(()=>{o()},[]);const h=async()=>{console.log("sent the offer"),console.log(j);const a=await j.createOffer();j.setLocalDescription(a),console.log(a),g.emit("offer",a,V)};i.useEffect(()=>{if(g)return g.on("welcome",h),()=>{g.off("welcome",h)}});const p=async a=>{console.log("received the offer"),j.setRemoteDescription(a);const n=await j.createAnswer();console.log("sent the answer"),j.setLocalDescription(n),g.emit("answer",n,V)};i.useEffect(()=>{if(g)return g.on("offer",p),()=>{g.off("offer",p)}});const v=a=>{console.log("received the answer"),j.setRemoteDescription(a)};i.useEffect(()=>{if(g)return g.on("answer",v),()=>{g.off("answer",v)}});const m=a=>{console.log("received candidate"),j.addIceCandidate(a)};return i.useEffect(()=>{if(g)return g.on("ice",m),()=>{g.off("ice",m)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(X,{onClick:I,children:d?"unmute":"mute"}),e.jsx(X,{onClick:H,children:y?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:c,children:l.map((a,n)=>e.jsx("option",{value:a.deviceId,selected:(w==null?void 0:w.getVideoTracks()[0].id)===a.deviceId,children:a.label},n))})]}),M&&e.jsx("div",{children:M.toString()})]})}function Qe({userObj:l}){const[t,d]=i.useState(""),[k,y]=i.useState([]),F=pe(),{state:M}=Pe(),[D,w]=i.useState(!1),[f,$]=i.useState(null),[x,T]=i.useState(""),[E,R]=i.useState(""),[j,V]=i.useState(""),I=u=>{T(u)},H=u=>{R(u)},c=location.search.slice(location.search.indexOf("=")+1);console.log(f),console.log(x),i.useEffect(()=>{M?(T(M.chattingUid),R(M.displayName)):(T(""),R(""))},[c]),i.useEffect(()=>{c&&(async()=>{if(x){const C=O(A,`members/${x}`),z=await Y(C);$(z.data())}})()},[c,x]);const N=ie(u=>u.piazzaForm.value);i.useEffect(()=>{var C;const u=()=>{var U;const z=window.screen.height-300>(((U=window.visualViewport)==null?void 0:U.height)||window.screen.height);D!==z&&w(z)};return window.addEventListener("resize",u),typeof visualViewport<"u"&&((C=window.visualViewport)==null||C.addEventListener("resize",u)),visualViewport==null||visualViewport.addEventListener("resize",u),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",u)),()=>{var z;typeof visualViewport<"u"&&((z=window.visualViewport)==null||z.removeEventListener("resize",u))}},[D]);const P=()=>{var u;V(""),(u=document.getElementById("myScreen"))==null||u.srcObject.getTracks().forEach(C=>C.stop())};return i.useEffect(()=>{F(Le(5))}),e.jsxs(e.Fragment,{children:[!D&&e.jsx(We,{multiple:!c,displayName:E}),e.jsx(qe,{isKeyboardOpen:N,userObj:l,messagesList:k,handleMessagesList:u=>y(u),handleChatUid:I,handleChatDisplayName:H}),e.jsx(Ye,{chattingUser:f,userObj:l,multiple:!c,messages:t,handleMessages:u=>d(u),messagesList:k,handleMessagesList:u=>y(u)}),e.jsxs(Se,{children:[e.jsx(ze,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Xe,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]}),e.jsxs(Se,{children:[e.jsx(ze,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Ze,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]})]})}export{Qe as default};
