import{u as O,c as ee,I as ce,aQ as re,j as a,k as R,g as N,L as $,U as Z,aT as me,f as ae,v as W,aX as De,r as u,H as le,R as pe,B as ue,aV as Ie,P as he,aY as xe,q as se,S as ie,z as oe,h as ne,aS as we,aq as Pe,aZ as be,J as ve,w as je,a5 as Me}from"./index-Dnd706QO.js";const ke={ko:"메세지를 작성해 주세요",en:"Input message"},ye={ko:"전송",en:"send"};function Ee({chattingUser:s,userObj:l,multiple:k,messages:e,handleMessages:o,messagesList:b,handleMessagesList:p}){const U=O(m=>m.profileColor.value),_=O(m=>m.piazzaForm.value),f=ee(m=>m.profile.value),J=ce(),{state:S}=re(),z=S==null?void 0:S.conversation,F=ee(m=>m.languages.value),E=F==="ko"||F==="en"?F:"ko",w=async m=>{var c;m.preventDefault();const I=e,M=l.uid,V=l.displayName,C=Date.now(),t=new Date().toString();let n,i,h;s&&(n=R(N,`members/${s.uid}`),i=await $(n),h=(c=i.data())==null?void 0:c.messagingToken);const r=f.profileImage?f.profileUrl:f.defaultProfile,d={msg:I,userUid:M,id:V,messageClockNumber:C,messageClock:t,conversation:z,conversationUid:s.uid,conversationName:s.displayName,profileUrl:r,sendingToken:h};k?d&&I&&(Z.emit("piazzaMessage",d),D()):I&&(b.length!==0?(Z.emit("message",d),console.log("message")):(Z.emit("messageNew",d),console.log("messageNew")),T(),X()),o("")},j=m=>{o(m.target.value)},D=async()=>{try{const m=e,I=l.uid,M=l.displayName,V=new Date().toString(),C=Date.now(),t=f==null?void 0:f.profileImageUrl,n=f==null?void 0:f.defaultProfile,i=f==null?void 0:f.profileImage;m&&(await me(ae(N,"chats_group"),{userUid:I,userName:M,message:m,messageClock:V,messageClockNumber:C,profileImageUrl:t,defaultProfile:n,profileColor:U,piazzaChecked:[l.uid],profileImage:i}),p(h=>[...h,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:V,conversation:null,profileColor:U,messageClockNumber:C,defaultProfile:n,profileImageUrl:t,profileImage:i||!1}]))}catch(m){console.log(m)}},T=async()=>{var I,M,V;const m=e;try{const C=l.uid,t=l.displayName,n=Date.now(),i=new Date().toString(),h=f.profileImage,r=s.profileImage,d=f.profileImageUrl,c=s.profileImageUrl,g=f.defaultProfile,x=s.defaultProfile;let y,v,A,H,B,L,G,q,K,Y;if(l.uid<s.uid?(y=l.uid,v=s.uid,A=l.displayName,H=s.displayName,B=d,L=c,G=g,q=x,K=f.profileImage,Y=s.profileImage):(y=s.uid,v=l.uid,A=s.displayName,H=l.displayName,B=c,L=d,G=x,q=g,K=s.profileImage,Y=f.profileImage),!B){const P=R(N,`members/${y}`);B=(I=(await $(P)).data())==null?void 0:I.profileImageUrl}if(!L){const P=R(N,`members/${v}`);L=(M=(await $(P)).data())==null?void 0:M.profileImageUrl}if(m){const P={userUid:C,userName:t,message:m,messageClock:i,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:G,userTwoDefaultProfile:q,userOneProfileImage:K,userTwoProfileImage:Y};await me(ae(N,`chats_${z}`),P);const Q=R(N,`members/${C}`),ge=(await $(Q)).data().chattings||{},fe=R(N,`members/${s.uid}`),te=(await $(fe)).data().chattings||{},Ue=((V=te[z])==null?void 0:V.messageCount)||0;ge[z]=P,te[z]={...P,messageCount:Ue+1},await W(Q,{chattings:ge}),await W(fe,{chattings:te}),p(Se=>[...Se,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:i,conversation:z,userName:t,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:G,userTwoDefaultProfile:q,userOneProfileImage:K,userTwoProfileImage:Y}])}}catch(C){console.log(C)}},X=async()=>{try{const m=l.uid,I=s.uid,M=R(N,`members/${m}`),C=(await $(M)).data().conversation||[],t=R(N,`members/${I}`),i=(await $(t)).data().conversation||[];C.indexOf(z)===-1&&(await W(M,{conversation:[...C,z]}),J(De())),i.indexOf(z)===-1&&await W(t,{conversation:[...i,z]})}catch(m){console.log(m)}};return a.jsx(a.Fragment,{children:_?a.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[E],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[E]})]}):a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[E],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[E]})]})})}const ze=({initiateContinuing:s,multiple:l,handleMultiple:k,user:e,userObj:o,handleMessagesList:b,displayedName:p})=>{const[U,_]=u.useState(null),f=ee(J=>J.languages.value);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<o.uid?_((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+o.uid[0]+o.uid[1]+o.uid[2]+o.uid[3]+o.uid[4]+o.uid[5]):_(o.uid[0]+o.uid[1]+o.uid[2]+o.uid[3]+o.uid[4]+o.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(le,{element:e,uid:o.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&a.jsx("div",{children:f==="ko"?a.jsxs("div",{children:["(",p,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(pe,{to:`${location.pathname}?id=${U}`,state:{element:e},children:a.jsx(ue,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),l&&o.uid!==(e==null?void 0:e.uid)&&a.jsx(pe,{to:`${location.pathname}?id=${U}`,state:{conversation:U,displayName:e==null?void 0:e.displayName,userUid:o.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(Ie,{children:a.jsx(ue,{variant:"outlined",onClick:()=>{b([]),k(!1),s()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:s,multiple:l,handleMultiple:k,messagesList:e,handleMessagesList:o}){const b=u.useRef(null),p=u.useRef(null),[U,_]=u.useState(null),[f,J]=u.useState(""),[S,z]=u.useState(!1),[F,E]=u.useState(null),[w,j]=u.useState(0);O(t=>t.profileColor.value),O(t=>t.profileUrl.value);const{state:D}=re(),T=(D==null?void 0:D.conversation)||"piazza",X=ee(t=>t.languages.value),m=async({userUid:t,displayName:n})=>{const i=R(N,`members/${t}`),r=(await $(i)).data();_(r),J(n)},I=({userUid:t,displayName:n})=>{var i;(i=document.getElementById("drawer"))==null||i.click(),m({userUid:t,displayName:n})},M=20;u.useEffect(()=>{if(!Z)return;function t(n){const{msg:i,userUid:h,id:r,target:d,messageClock:c,messageClockNumber:g,profileImageUrl:x,defaultProfile:y,profileImage:v,conversation:A}=n;o(H=>[...H,{msg:i,type:d?"private":"other",userUid:h,id:r,messageClock:c,messageClockNumber:g,conversation:null,profileImageUrl:x,defaultProfile:y,profileImage:v}])}return Z.on("sMessagePiazza",t),()=>{Z.off("sMessagePiazza",t)}},[]),u.useEffect(()=>{if(!Z)return;function t(n){const{msg:i,userUid:h,id:r,target:d,messageClock:c,messageClockNumber:g,conversation:x,piazzaData:y}=n;o(v=>[...v,{msg:i,type:d?"private":"other",userUid:h,id:r,messageClock:c,messageClockNumber:g,conversation:null,...y}])}return Z.on(`sMessage${T}`,t),()=>{Z.off(`sMessage${T}`,t)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{V(),(async()=>{if(l){const n=ae(N,"chats_group"),i=se(n,oe("messageClockNumber","desc"),ie(1));(await ne(i)).forEach(async r=>{const d=R(N,`chats_group/${r.id}`),g=(await $(d)).data(),x=g.piazzaChecked||[];x.indexOf(s.uid)===-1&&(x.splice(-1,s.uid,0),x.push(s.uid),await W(d,{...g,piazzaChecked:x}))})}else{const n=R(N,`members/${s.uid}`),h=(await $(n)).data().chattings;h[T].messageCount=0,await W(n,{chattings:h})}})()},[e]);const V=()=>{var t;(t=b.current)==null||t.scrollIntoView()};u.useEffect(()=>{const t=async()=>{const i=[],h=ae(N,"chats_group"),r=se(h,oe("messageClockNumber","desc"),ie(M),we(F||"")),d=await ne(r);d.docs.length||j(d.docs.length),d.forEach(c=>{var q,K,Y,P;i.length===d.docs.length-1&&(E(c),j(d.docs.length-1));const g=c.data().message,x=c.data().userUid,y=c.data().userName,v=c.data().messageClock,A=c.data().messageClockNumber;(q=c.data())==null||q.profileColor;const H=(K=c.data())==null?void 0:K.profileImageUrl,B=(Y=c.data())==null?void 0:Y.defaultProfile,L=(P=c.data())==null?void 0:P.profileImage,G=c.data();i.push({msg:g,userUid:x,id:y,messageClockNumber:A,messageClock:v,conversation:null,profileImageUrl:H,defaultProfile:B,profileImage:L||!1,...G})}),i.reverse(),o([...i,...e]),z(!1)},n=async i=>{const h=ae(N,`chats_${i}`),r=se(h,oe("messageClockNumber","desc"),ie(M),we(F||"")),d=await ne(r),c=[];d.docs.length||j(d.docs.length),d.forEach((g,x)=>{var Y,P,Q;c.length===d.docs.length-1&&(E(g),j(d.docs.length-1));const y=g.data().message,v=g.data().userUid,A=g.data().userName,H=g.data().messageClock,B=g.data().messageClockNumber||0,L=(Y=g.data())==null?void 0:Y.profileImageUrl,G=(P=g.data())==null?void 0:P.defaultProfile,q=(Q=g.data())==null?void 0:Q.profileImage,K=g.data();c.push({msg:y,userUid:v,id:A,messageClockNumber:B,messageClock:H,conversation:null,profileImageUrl:L,defaultProfile:G,profileImage:q||!1,...K})}),c.reverse(),o([...c,...e]),z(!1)};T==="piazza"?(S||!e.length)&&t():(S||!e.length)&&n(T)},[S,T]);const C=()=>{p.current.scrollTop!==0||S||(console.log("scroll"),z(!0))};return u.useEffect(()=>{var t;return(t=p.current)==null||t.addEventListener("scroll",C),()=>{var n;return(n=p.current)==null?void 0:n.removeEventListener("scroll",C)}},[S]),console.log(e),a.jsx(a.Fragment,{children:a.jsx(a.Fragment,{children:a.jsx("div",{ref:p,className:"p-1 border-t rounded-xl overflow-auto",children:a.jsxs("ul",{children:[S&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((t,n)=>{let i;l?i=t:(console.log(t.userUid===s.uid),t.userUid===t.userOne?i={userUid:t.userOne,id:t.userOneDisplayName,profileImage:t.userOneProfileImage,defaultProfile:t.userOneDefaultProfile,profileImageUrl:t.userOneProfileUrl}:i={userUid:t.userTwo,id:t.userTwoDisplayName,profileImage:t.userTwoProfileImage,defaultProfile:t.userTwoDefaultProfile,profileImageUrl:t.userTwoProfileUrl});let h;const r=new Date(t.messageClock);t.userUid===s.uid?h="text-right":h="text-left";let d,c;n>0&&(d=e[n-1].userUid),n<e.length-1&&e[n+1].userUid===s.uid&&(c=new Date(e[n+1].messageClock),r.getFullYear()===c.getFullYear()&&r.getMonth()===c.getMonth()&&r.getDate()===c.getDate()&&r.getHours()===c.getHours()&&(r.getMinutes(),c.getMinutes()));let g,x=r.getHours(),y=(r.getMonth()+1).toString(),v=r.getDate().toString();return x>=13?(g="오후",x!==12&&(x=x-12)):(g="오전",x===0&&(x=x+12)),r.getMonth()+1<10&&(y="0"+y),v.length===1&&(v="0"+v),a.jsxs("li",{ref:n===w?b:null,className:h,children:[d!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==s.uid?"start":"end"}`,children:h==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(he,{trigger:a.jsx(le,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>E(null),multiple:l,handleMultiple:k,user:U,userObj:s,handleMessagesList:o,displayedName:f})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(he,{trigger:a.jsx(le,{element:i,piazza:()=>I({userUid:i.userUid,displayName:i.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>E(null),multiple:l,handleMultiple:k,user:U,userObj:s,handleMessagesList:o,displayedName:f})})]})})}),t.userUid!==s.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",X==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),X==="en"&&(g==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",X==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),X==="en"&&(g==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},n)}),a.jsx("li",{ref:b})]})})})})}function Te({isKeyboardOpen:s,userObj:l,multiple:k,handleMultiple:e,messagesList:o,handleMessagesList:b}){return a.jsx(a.Fragment,{children:s?a.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:o,handleMessagesList:b})}):a.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:o,handleMessagesList:b})})})}const Re=Pe(be)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function $e(){const s=ee(o=>o.languages.value),l=O(o=>o.piazzaSwitch.value),k=ce(),e=()=>{l==="true"?(window.localStorage.setItem("piazza","false"),k(ve("false"))):(window.localStorage.setItem("piazza","true"),k(ve("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Re,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:l==="true"})})]})}const Ce={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Fe=({multiple:s,displayName:l})=>{const k=ee(o=>o.languages.value),e=k==="ko"||k==="en"?k:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(je,{title:s?Ce[e][0]:`${Ce[e][1]} ${l}`}),s&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx($e,{})})]})};function Be({userObj:s}){const[l,k]=u.useState(""),[e,o]=u.useState([]),b=ce(),{state:p}=re(),[U,_]=u.useState(!0),[f,J]=u.useState(!1),[S,z]=u.useState(null);u.useEffect(()=>{const w=async()=>{if(p.chattingUid){const j=R(N,`members/${p.chattingUid}`),D=await $(j);z(D.data())}};p.multiple||w()},[]);const F=O(w=>w.piazzaForm.value);u.useEffect(()=>{var j;const w=()=>{var T;const D=window.screen.height-300>(((T=window.visualViewport)==null?void 0:T.height)||window.screen.height);f!==D&&J(D)};return window.addEventListener("resize",w),typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.addEventListener("resize",w)),visualViewport==null||visualViewport.addEventListener("resize",w),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",w)),()=>{var D;typeof visualViewport<"u"&&((D=window.visualViewport)==null||D.removeEventListener("resize",w))}},[f]),u.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&_(p==null?void 0:p.multiple)},[]),u.useEffect(()=>{b(Me(5))});const E=p==null?void 0:p.displayName;return console.log(S),a.jsxs(a.Fragment,{children:[!f&&a.jsx(Fe,{multiple:U,displayName:E}),a.jsx(Te,{isKeyboardOpen:F,userObj:s,multiple:U,handleMultiple:w=>_(w),messagesList:e,handleMessagesList:w=>o(w)}),a.jsx(Ee,{chattingUser:S,userObj:s,multiple:U,messages:l,handleMessages:w=>k(w),messagesList:e,handleMessagesList:w=>o(w)})]})}export{Be as default};
