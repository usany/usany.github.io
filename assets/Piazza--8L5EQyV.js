import{c as Te,u as re,d as ae,G as ve,b1 as Ue,j as e,P as pe,a0 as we,b8 as ye,b7 as he,b0 as Le,x as H,p as M,O as _,a4 as m,b4 as ke,n as ce,E as oe,b9 as Fe,a_ as Re,r as c,W as xe,a1 as Ce,B as ee,ba as Se,q as fe,a2 as ge,a3 as ue,t as me,b2 as ze,s as Be,S as He,X as je,H as _e,bb as Oe,aN as $e,af as Ye,bc as Ne,bd as De,be as Ie,bf as be}from"./index-D_uSOSKc.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Te("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Te("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ke={ko:"메세지를 작성해 주세요",en:"Input message"},We={ko:"전송",en:"send"};function Ze({chattingUser:l,userObj:t,multiple:f,messages:z,handleMessages:k,messagesList:U,handleMessagesList:P}){const I=re(n=>n.profileColor.value),j=re(n=>n.piazzaForm.value),u=ae(n=>n.profile.value),$=ve(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",b=ae(n=>n.languages.value),E=b==="ko"||b==="en"?b:"ko",[R,O]=Ue(),A=async n=>{var y;n.preventDefault();const x=z,C=t.uid,D=t.displayName,o=Date.now(),d=new Date().toString(),s=u==null?void 0:u.profileImageUrl,i=u==null?void 0:u.defaultProfile,r=u==null?void 0:u.profileImage;let w,h,p;l&&(w=H(M,`members/${l.uid}`),h=await _(w),p=(y=h.data())==null?void 0:y.messagingToken);const a=u.profileImage?u.profileImageUrl:u.defaultProfile;console.log(u);const g={msg:x,userUid:C,id:D,messageClockNumber:o,messageClock:d,conversation:v,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:r,defaultProfile:i,profileImageUrl:s,profileUrl:a,sendingToken:p};f?g&&x&&(m.emit("piazzaMessage",g),L()):x&&(U.length!==0?(m.emit("message",g),console.log("message")):(m.emit("messageNew",g),console.log("messageNew")),S(),F()),k("")},N=n=>{k(n.target.value)},L=async()=>{try{const n=z,x=t.uid,C=t.displayName,D=new Date().toString(),o=Date.now(),d=u==null?void 0:u.profileImageUrl,s=u==null?void 0:u.defaultProfile,i=u==null?void 0:u.profileImage;n&&(await ke(ce(M,"chats_group"),{userUid:x,userName:C,message:n,messageClock:D,messageClockNumber:o,profileImageUrl:d,defaultProfile:s,profileColor:I,piazzaChecked:[t.uid],profileImage:i}),P(r=>[...r,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:D,conversation:null,profileColor:I,messageClockNumber:o,defaultProfile:s,profileImageUrl:d,profileImage:i||!1}]))}catch(n){console.log(n)}},S=async()=>{var x,C,D;const n=z;try{const o=t.uid,d=t.displayName,s=Date.now(),i=new Date().toString(),r=u.profileImage,w=l.profileImage,h=u.profileImageUrl,p=l.profileImageUrl,a=u.defaultProfile,g=l.defaultProfile;let y,T,B,q,G,K,Z,X,W,te;if(t.uid<l.uid?(y=t.uid,T=l.uid,B=t.displayName,q=l.displayName,G=h,K=p,Z=a,X=g,W=u.profileImage,te=l.profileImage):(y=l.uid,T=t.uid,B=l.displayName,q=t.displayName,G=p,K=h,Z=g,X=a,W=l.profileImage,te=u.profileImage),!G){const J=H(M,`members/${y}`);G=(x=(await _(J)).data())==null?void 0:x.profileImageUrl}if(!K){const J=H(M,`members/${T}`);K=(C=(await _(J)).data())==null?void 0:C.profileImageUrl}if(n){const J={userUid:o,userName:d,message:n,messageClock:i,messageClockNumber:s,userOne:y,userTwo:T,userOneDisplayName:B,userTwoDisplayName:q,userOneProfileUrl:G,userTwoProfileUrl:K,userOneDefaultProfile:Z,userTwoDefaultProfile:X,userOneProfileImage:W,userTwoProfileImage:te};await ke(ce(M,`chats_${v}`),J);const se=H(M,`members/${o}`),ie=(await _(se)).data().chattings||{},le=H(M,`members/${l.uid}`),de=(await _(le)).data().chattings||{},Ve=((D=de[v])==null?void 0:D.messageCount)||0;ie[v]=J,de[v]={...J,messageCount:Ve+1},await oe(se,{chattings:ie}),await oe(le,{chattings:de}),P(Ae=>[...Ae,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:i,conversation:v,userName:d,messageClockNumber:s,userOne:y,userTwo:T,userOneDisplayName:B,userTwoDisplayName:q,userOneProfileUrl:G,userTwoProfileUrl:K,userOneDefaultProfile:Z,userTwoDefaultProfile:X,userOneProfileImage:W,userTwoProfileImage:te}])}}catch(o){console.log(o)}},F=async()=>{try{const n=t.uid,x=l.uid,C=H(M,`members/${n}`),o=(await _(C)).data().conversation||[],d=H(M,`members/${x}`),i=(await _(d)).data().conversation||[];o.indexOf(v)===-1&&(await oe(C,{conversation:[...o,v]}),$(Fe())),i.indexOf(v)===-1&&await oe(d,{conversation:[...i,v]})}catch(n){console.log(n)}},Y=async()=>{var d,s,i;(d=document.getElementById("videoCall"))==null||d.click();let n,x,C,D;l&&(n=H(M,`members/${l.uid}`),x=await _(n),C=(s=x.data())==null?void 0:s.messagingToken,D=(i=x.data())==null?void 0:i.preferLanguage);const o={conversation:v,isVideo:!0,sendingToken:C,connectedUrl:`/piazza?id=${v}&call=video`,preferLanguage:D,userUid:t.uid,id:t.displayName,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName};console.log(o),m.emit("call",o),O(r=>(r.set("call","video"),r))};return e.jsxs("form",{className:`fixed w-screen ${j?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:A,children:[v&&v!=="piazza"&&e.jsx(pe,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ge,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{Y()},children:e.jsxs(he,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Le,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(we,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ye,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var n;(n=document.getElementById("audioCall"))==null||n.click()},children:e.jsxs(he,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(qe,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ke[E],onChange:N,value:z,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:We[E]})]})}const Pe=({initiateContinuing:l,user:t,userObj:f,handleMessagesList:z,displayedName:k,handleChatUid:U,handleChatDisplayName:P})=>{const{state:I}=Re(),j=(I==null?void 0:I.conversation)||"piazza",u=ae(b=>b.languages.value),[$,v]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<f.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]):v(f.uid[0]+f.uid[1]+f.uid[2]+f.uid[3]+f.uid[4]+f.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(xe,{element:t,uid:f.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==k&&e.jsx("div",{children:u==="ko"?e.jsxs("div",{children:["(",k,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",k,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(ee,{variant:"outlined",onClick:()=>{},children:u==="ko"?"프로필 확인":"Check Profile"})}),j==="piazza"&&f.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:f.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(he,{children:e.jsx(ee,{variant:"outlined",onClick:()=>{z([]),l()},children:u==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ee({userObj:l,messagesList:t,handleMessagesList:f,handleChatUid:z,handleChatDisplayName:k}){const U=c.useRef(null),P=c.useRef(null),[I,j]=c.useState(null),[u,$]=c.useState(""),[v,b]=c.useState(!1),[E,R]=c.useState(null),[O,A]=c.useState(0),[N,L]=c.useState("piazza"),S=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";c.useEffect(()=>{(N!==S||S==="piazza")&&(f([]),R(null),A(0),L(S))},[S]);const F=ae(o=>o.languages.value),Y=async({userUid:o,displayName:d})=>{const s=H(M,`members/${o}`),r=(await _(s)).data();j(r),$(d),console.log("practice")},n=({userUid:o,displayName:d})=>{var s;(s=document.getElementById("drawer"))==null||s.click(),Y({userUid:o,displayName:d})},x=20;c.useEffect(()=>{if(!m)return;function o(d){const{msg:s,userUid:i,id:r,target:w,messageClock:h,messageClockNumber:p,profileImageUrl:a,defaultProfile:g,profileImage:y,conversation:T}=d;f(B=>[...B,{msg:s,type:w?"private":"other",userUid:i,id:r,messageClock:h,messageClockNumber:p,conversation:null,profileImageUrl:a,defaultProfile:g,profileImage:y}])}return m.on("sMessagePiazza",o),()=>{m.off("sMessagePiazza",o)}},[]),c.useEffect(()=>{if(!m)return;function o(d){const{msg:s,userUid:i,id:r,target:w,messageClock:h,messageClockNumber:p,conversation:a,profileImageUrl:g,defaultProfile:y,profileImage:T,piazzaData:B}=d;f(q=>[...q,{msg:s,type:w?"private":"other",userUid:i,id:r,messageClock:h,messageClockNumber:p,conversation:null,profileImageUrl:g,defaultProfile:y,profileImage:T,...B}])}return m.on(`sMessage${S}`,o),()=>{m.off(`sMessage${S}`,o)}},[S]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{C(),(async()=>{if(S==="piazza"){const d=ce(M,"chats_group"),s=fe(d,ue("messageClockNumber","desc"),ge(1));(await me(s)).forEach(async r=>{const w=H(M,`chats_group/${r.id}`),p=(await _(w)).data(),a=p.piazzaChecked||[];a.indexOf(l.uid)===-1&&(a.splice(-1,l.uid,0),a.push(l.uid),await oe(w,{...p,piazzaChecked:a}))})}else{const d=H(M,`members/${l.uid}`),i=(await _(d)).data().chattings;i[S]&&(i[S].messageCount=0),await oe(d,{chattings:i})}})()},[t]);const C=()=>{var o;(o=U.current)==null||o.scrollIntoView()};c.useEffect(()=>{const o=async()=>{const s=[],i=ce(M,"chats_group"),r=fe(i,ue("messageClockNumber","desc"),ge(x),ze(E||"")),w=await me(r);w.docs.length||A(w.docs.length),w.forEach(h=>{var Z,X,W;s.length===w.docs.length-1&&(R(h),A(w.docs.length-1));const p=h.data().message,a=h.data().userUid,g=h.data().userName,y=h.data().messageClock,T=h.data().messageClockNumber,B=(Z=h.data())==null?void 0:Z.profileImageUrl,q=(X=h.data())==null?void 0:X.defaultProfile,G=(W=h.data())==null?void 0:W.profileImage,K=h.data();s.push({msg:p,userUid:a,id:g,messageClockNumber:T,messageClock:y,conversation:null,profileImageUrl:B,defaultProfile:q,profileImage:G||!1,...K})}),s.reverse(),f([...s,...t]),b(!1)},d=async s=>{const i=ce(M,`chats_${s}`),r=fe(i,ue("messageClockNumber","desc"),ge(x),ze(E||"")),w=await me(r),h=[];w.docs.length||A(w.docs.length),w.forEach((p,a)=>{var ne,ie,le;h.length===w.docs.length-1&&(R(p),A(w.docs.length-1));const g=p.data().message,y=p.data().userUid,T=p.data().userName,B=p.data().messageClock,q=p.data().messageClockNumber||0,G=(ne=p.data())==null?void 0:ne.profileImageUrl,K=(ie=p.data())==null?void 0:ie.defaultProfile,Z=(le=p.data())==null?void 0:le.profileImage,X=p.data(),W=p.data().userOne,te=p.data().userOneDisplayName,J=p.data().userTwo,se=p.data().userTwoDisplayName;W!==l.uid?(z(W),k(te)):(z(J),k(se)),h.push({msg:g,userUid:y,id:T,messageClockNumber:q,messageClock:B,conversation:null,profileImageUrl:G,defaultProfile:K,profileImage:Z||!1,...X})}),h.reverse(),f([...h,...t]),b(!1)};console.log(t.length),S==="piazza"?(v||!t.length)&&o():(v||!t.length)&&d(S)},[v,N]);const D=()=>{P.current.scrollTop!==0||v||(console.log("scroll"),b(!0))};return c.useEffect(()=>{var o;return(o=P.current)==null||o.addEventListener("scroll",D),()=>{var d;return(d=P.current)==null?void 0:d.removeEventListener("scroll",D)}},[v]),console.log(S),console.log(t),console.log(I),e.jsx(e.Fragment,{children:e.jsx("div",{ref:P,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((o,d)=>{let s;S==="piazza"?s=o:o.userUid===o.userOne?s={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:s={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let i;const r=new Date(o.messageClock);o.userUid===l.uid?i="text-right":i="text-left";let w,h;d>0&&(w=t[d-1].userUid),d<t.length-1&&t[d+1].userUid===l.uid&&(h=new Date(t[d+1].messageClock),r.getFullYear()===h.getFullYear()&&r.getMonth()===h.getMonth()&&r.getDate()===h.getDate()&&r.getHours()===h.getHours()&&(r.getMinutes(),h.getMinutes()));let p,a=r.getHours(),g=(r.getMonth()+1).toString(),y=r.getDate().toString();return a>=13?(p="오후",a!==12&&(a=a-12)):(p="오전",a===0&&(a=a+12)),r.getMonth()+1<10&&(g="0"+g),y.length===1&&(y="0"+y),e.jsxs("li",{ref:d===O?U:null,className:i,children:[w!==o.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${o.userUid!==l.uid?"start":"end"}`,children:i==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(pe,{trigger:e.jsx(xe,{element:s,piazza:()=>n({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(Se,{}),content:e.jsx(Pe,{initiateContinuing:()=>R(null),user:I,userObj:l,handleMessagesList:f,displayedName:u})}),e.jsx("div",{children:o.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:o.id}),e.jsx(pe,{trigger:e.jsx(xe,{element:s,piazza:()=>n({userUid:s.userUid,displayName:s.id}),profile:!1}),title:e.jsx(Se,{}),content:e.jsx(Pe,{initiateContinuing:()=>R(null),user:I,userObj:l,handleMessagesList:f,displayedName:u,handleChatUid:z,handleChatDisplayName:k})})]})})}),o.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),e.jsxs("div",{children:[r.getFullYear(),"-",g,"-",y," ",F==="ko"&&p," ",a,":",r.getMinutes()<10&&"0",r.getMinutes(),F==="en"&&(p==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[r.getFullYear(),"-",g,"-",y," ",F==="ko"&&p," ",a,":",r.getMinutes()<10&&"0",r.getMinutes(),F==="en"&&(p==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},d)}),e.jsx("li",{ref:U})]})})})}function Xe({isKeyboardOpen:l,userObj:t,messagesList:f,handleMessagesList:z,handleChatUid:k,handleChatDisplayName:U}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ee,{userObj:t,messagesList:f,handleMessagesList:z,handleChatUid:k,handleChatDisplayName:U})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ee,{userObj:t,messagesList:f,handleMessagesList:z,handleChatUid:k,handleChatDisplayName:U})})})}const Je=Be(He)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Qe(){const l=ae(k=>k.languages.value),t=re(k=>k.piazzaSwitch.value),f=ve(),z=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),f(je("false"))):(window.localStorage.setItem("piazza","true"),f(je("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Je,{onClick:()=>z(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Me={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},et=({displayName:l})=>{const t=ae(k=>k.languages.value),f=t==="ko"||t==="en"?t:"ko",z=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(_e,{icon:e.jsx(Oe,{}),title:z==="piazza"?Me[f][0]:`${Me[f][1]} ${l}`}),z==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Qe,{})})]})};function tt(){const[l,t]=c.useState([]),[f,z]=c.useState(!0),[k,U]=c.useState(!0),[P,I]=c.useState(""),[j,u]=c.useState(null),[$,v]=c.useState(null),b=$e(),E=c.useRef(null),R=c.useRef(null),O={audio:!0,video:!1},A=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],N=new RTCPeerConnection({iceServers:[{urls:A.map(a=>a.urls)}]}),L=location.search.slice(4);console.log(location.search.slice(4)),c.useEffect(()=>{(async()=>{await x()})()},[]),c.useEffect(()=>{E.current&&(E.current.srcObject=j)},[j]);async function S(){const a=j;a&&a.getAudioTracks().forEach(g=>g.enabled=!g.enabled),z(!f)}async function F(){const a=j;a&&a.getVideoTracks().forEach(g=>g.enabled=!g.enabled),U(!k)}const Y=()=>{E.current.srcObject.getTracks().forEach(a=>a.stop()),console.log(E.current)};async function n(a){if(E.current.srcObject.getTracks().forEach(g=>g.stop()),v(a.target.value),N){console.log(N.getSenders());const g=j.getVideoTracks()[0];N.getSenders().find(T=>T.track.kind==="video").replaceTrack(g)}}c.useEffect(()=>{$&&C($)},[$]);async function x(){try{const g=(await navigator.mediaDevices.enumerateDevices()).filter(y=>y.kind==="videoinput");t(g)}catch(a){console.log(a)}}async function C(a){try{const y=a?{audio:!0,video:{deviceId:{exact:a}}}:O,T=await navigator.mediaDevices.getUserMedia(y);u(T),I("")}catch(g){const y=g==null?void 0:g.toString();y&&I(y),console.log(g)}}function D(a){console.log("icecandidate"),console.log(a),m.emit("ice",a.candidate,L)}function o(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",j),R.current=a.stream}function d(){N.addEventListener("icecandidate",D),N.addEventListener("addstream",o),j&&j.getTracks().forEach(a=>N.addTrack(a,j))}async function s(){await C(null),d()}async function i(){await s(),m.emit("joinRoom",L,s)}c.useEffect(()=>{i()},[]);const r=async()=>{console.log("sent the offer"),console.log(N);const a=await N.createOffer();N.setLocalDescription(a),console.log(a),m.emit("offer",a,L)};c.useEffect(()=>{if(m)return m.on("welcome",r),()=>{m.off("welcome",r)}});const w=async a=>{console.log("received the offer"),N.setRemoteDescription(a);const g=await N.createAnswer();console.log("sent the answer"),N.setLocalDescription(g),m.emit("answer",g,L)};c.useEffect(()=>{if(m)return m.on("offer",w),()=>{m.off("offer",w)}});const h=a=>{console.log("received the answer"),N.setRemoteDescription(a)};c.useEffect(()=>{if(m)return m.on("answer",h),()=>{m.off("answer",h)}});const p=a=>{console.log("received candidate"),N.addIceCandidate(a)};return c.useEffect(()=>{if(m)return m.on("ice",p),()=>{m.off("ice",p)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!b&&"flex-col"} gap-1 items-center`,children:[e.jsx("audio",{ref:R,width:"160",height:"120",controls:!0,autoPlay:!0}),e.jsx("audio",{id:"myScreen",ref:E,width:"160",height:"120",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ee,{onClick:S,children:f?"unmute":"mute"}),e.jsx(ee,{onClick:F,children:k?"turn stream on":"turn stream off"}),e.jsx(ee,{onClick:Y,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:n,children:l.map((a,g)=>e.jsx("option",{value:a.deviceId,children:a.label},g))})]}),P&&e.jsx("div",{children:P})]})}let Q,V;function st(){const[l,t]=c.useState([]),[f,z]=c.useState(!0),[k,U]=c.useState(!0),[P,I]=c.useState(""),j=c.useRef(null),u=c.useRef(null),$=$e(),v={audio:!0,video:!0},b=location.search.slice(4);async function E(){const s=Q;s&&s.getAudioTracks().forEach(i=>i.enabled=!i.enabled),z(!f)}async function R(){const s=Q;s&&s.getVideoTracks().forEach(i=>i.enabled=!i.enabled),U(!k)}const O=()=>{j.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(j.current)};async function A(s){if(console.log(s.target.value),j.current.srcObject.getTracks().forEach(i=>i.stop()),await L(s.target.value),V){console.log(V.getSenders());const i=Q.getVideoTracks()[0];V.getSenders().find(w=>w.track.kind==="video").replaceTrack(i)}}async function N(){try{const i=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");t(i)}catch(s){console.log(s)}}async function L(s){try{const r=s?{audio:!0,video:{deviceId:{exact:s}}}:v;Q=await navigator.mediaDevices.getUserMedia(r),j.current.srcObject=Q,await N(),I("")}catch(i){console.log(i);const r=i==null?void 0:i.toString();r&&I(r)}}function S(s){console.log("icecandidate"),console.log(s),m.emit("ice",s.candidate,b)}function F(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",Q),u.current.srcObject=s.stream}function Y(){const s=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}];V=new RTCPeerConnection({iceServers:[{urls:s.map(i=>i.urls)}]}),V.addEventListener("icecandidate",S),V.addEventListener("addstream",F),Q&&Q.getTracks().forEach(i=>V.addTrack(i,Q))}async function n(){await L(null),Y()}async function x(){await n(),m.emit("joinRoom",b,n)}c.useEffect(()=>{x()},[]);const C=async()=>{const s=await V.createOffer();V.setLocalDescription(s),m.emit("offer",s,b),console.log(s),console.log("sent the offer")};c.useEffect(()=>{if(m)return m.on("welcome",C),()=>{m.off("welcome",C)}});const D=async s=>{V.setRemoteDescription(s),console.log("received the offer");const i=await V.createAnswer();V.setLocalDescription(i),m.emit("answer",i,b),console.log("sent the answer")};c.useEffect(()=>{if(m)return m.on("offer",D),()=>{m.off("offer",D)}});const o=s=>{V.setRemoteDescription(s),console.log("received the answer")};c.useEffect(()=>{if(m)return m.on("answer",o),()=>{m.off("answer",o)}});const d=s=>{V.addIceCandidate(s),console.log("received candidate")};return c.useEffect(()=>{if(m)return m.on("ice",d),()=>{m.off("ice",d)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!$&&"flex-col"} gap-1 items-center`,children:[e.jsx("video",{ref:u,width:"160",height:"120",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:j,width:"160",height:"120",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(ee,{onClick:E,children:f?"unmute":"mute"}),e.jsx(ee,{onClick:R,children:k?"turn stream on":"turn stream off"}),e.jsx(ee,{onClick:O,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:A,children:l.map((s,i)=>e.jsx("option",{value:s.deviceId,children:s.label},i))})]}),P&&e.jsx("div",{children:P})]})}function nt({userObj:l}){const[t,f]=c.useState(""),[z,k]=c.useState([]),U=ve(),{state:P}=Re(),[I,j]=c.useState(!1),[u,$]=c.useState(null),[v,b]=c.useState(""),[E,R]=c.useState(""),[O,A]=Ue(),N=n=>{b(n)},L=n=>{R(n)},S=location.search.slice(location.search.indexOf("=")+1);console.log(u),console.log(v),c.useEffect(()=>{P?(b(P.chattingUid),R(P.displayName)):(b(""),R(""))},[S]),c.useEffect(()=>{S&&(async()=>{if(v){const x=H(M,`members/${v}`),C=await _(x);$(C.data())}})()},[S,v]);const F=re(n=>n.piazzaForm.value);c.useEffect(()=>{var x;const n=()=>{var D;const C=window.screen.height-300>(((D=window.visualViewport)==null?void 0:D.height)||window.screen.height);I!==C&&j(C)};return window.addEventListener("resize",n),typeof visualViewport<"u"&&((x=window.visualViewport)==null||x.addEventListener("resize",n)),visualViewport==null||visualViewport.addEventListener("resize",n),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",n)),()=>{var C;typeof visualViewport<"u"&&((C=window.visualViewport)==null||C.removeEventListener("resize",n))}},[I]);const Y=()=>{var n;A(x=>(x.delete("call"),x)),(n=document.getElementById("myScreen"))==null||n.srcObject.getTracks().forEach(x=>x.stop())};return c.useEffect(()=>{U(Ye(5))}),c.useEffect(()=>{var n,x;O.get("call")==="video"&&((n=document.getElementById("videoCall"))==null||n.click()),O.get("call")==="audio"&&((x=document.getElementById("audioCall"))==null||x.click())},[]),e.jsxs(e.Fragment,{children:[!I&&e.jsx(et,{multiple:!S,displayName:E}),e.jsx(Xe,{isKeyboardOpen:F,userObj:l,messagesList:z,handleMessagesList:n=>k(n),handleChatUid:N,handleChatDisplayName:L}),e.jsx(Ze,{chattingUser:u,userObj:l,multiple:!S,messages:t,handleMessages:n=>f(n),messagesList:z,handleMessagesList:n=>k(n)}),e.jsxs(Ne,{children:[e.jsx(De,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(Ie,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(st,{})}),e.jsx(be,{children:e.jsx("div",{onClick:Y,children:"전화 종료"})})]})})]}),e.jsxs(Ne,{children:[e.jsx(De,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(Ie,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(tt,{})}),e.jsx(be,{children:e.jsx("div",{onClick:Y,children:"전화 종료"})})]})})]})]})}export{nt as default};
