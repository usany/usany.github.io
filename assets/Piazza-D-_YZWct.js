import{b2 as je,u as ie,c as O,O as he,j as t,P as me,Y as le,b1 as ue,X as xe,b3 as ve,aX as Pe,v as H,m as U,I as _,$ as k,a_ as we,l as ee,C as W,b4 as be,aV as De,r as i,N as pe,B as te,b5 as ye,q as re,Z as de,_ as ge,n as fe,aY as ke,s as Ue,S as Me,Q as Ce,D as Ee,b6 as Te,aJ as Re,aa as $e,b7 as Ve,b8 as Fe,b9 as Ae,ba as Le}from"./index-B7txX3KU.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=je("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=je("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),_e={ko:"메세지를 작성해 주세요",en:"Input message"},Ye={ko:"전송",en:"send"};function qe({chattingUser:o,userObj:e,multiple:c,messages:z,handleMessages:y,messagesList:$,handleMessagesList:M}){const I=ie(n=>n.profileColor.value),S=ie(n=>n.piazzaForm.value),d=O(n=>n.profile.value),A=he(),h=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",T=O(n=>n.languages.value),b=T==="ko"||T==="en"?T:"ko",V=async n=>{var l;n.preventDefault();const g=z,j=e.uid,N=e.displayName,D=Date.now(),E=new Date().toString(),F=d==null?void 0:d.profileImageUrl,a=d==null?void 0:d.defaultProfile,p=d==null?void 0:d.profileImage;let u,v,m;o&&(u=H(U,`members/${o.uid}`),v=await _(u),m=(l=v.data())==null?void 0:l.messagingToken);const x=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const f={msg:g,userUid:j,id:N,messageClockNumber:D,messageClock:E,conversation:h,conversationUid:o==null?void 0:o.uid,conversationName:o==null?void 0:o.displayName,profileImage:p,defaultProfile:a,profileImageUrl:F,profileUrl:x,sendingToken:m};c?f&&g&&(k.emit("piazzaMessage",f),B()):g&&($.length!==0?(k.emit("message",f),console.log("message")):(k.emit("messageNew",f),console.log("messageNew")),C(),Y()),y("")},J=n=>{y(n.target.value)},B=async()=>{try{const n=z,g=e.uid,j=e.displayName,N=new Date().toString(),D=Date.now(),E=d==null?void 0:d.profileImageUrl,F=d==null?void 0:d.defaultProfile,a=d==null?void 0:d.profileImage;n&&(await we(ee(U,"chats_group"),{userUid:g,userName:j,message:n,messageClock:N,messageClockNumber:D,profileImageUrl:E,defaultProfile:F,profileColor:I,piazzaChecked:[e.uid],profileImage:a}),M(p=>[...p,{msg:n,type:"me",userUid:e.uid,id:e.displayName,messageClock:N,conversation:null,profileColor:I,messageClockNumber:D,defaultProfile:F,profileImageUrl:E,profileImage:a||!1}]))}catch(n){console.log(n)}},C=async()=>{var g,j,N;const n=z;try{const D=e.uid,E=e.displayName,F=Date.now(),a=new Date().toString(),p=d.profileImage,u=o.profileImage,v=d.profileImageUrl,m=o.profileImageUrl,x=d.defaultProfile,f=o.defaultProfile;let l,s,r,w,P,R,q,G,X,Z;if(e.uid<o.uid?(l=e.uid,s=o.uid,r=e.displayName,w=o.displayName,P=v,R=m,q=x,G=f,X=d.profileImage,Z=o.profileImage):(l=o.uid,s=e.uid,r=o.displayName,w=e.displayName,P=m,R=v,q=f,G=x,X=o.profileImage,Z=d.profileImage),!P){const L=H(U,`members/${l}`);P=(g=(await _(L)).data())==null?void 0:g.profileImageUrl}if(!R){const L=H(U,`members/${s}`);R=(j=(await _(L)).data())==null?void 0:j.profileImageUrl}if(n){const L={userUid:D,userName:E,message:n,messageClock:a,messageClockNumber:F,userOne:l,userTwo:s,userOneDisplayName:r,userTwoDisplayName:w,userOneProfileUrl:P,userTwoProfileUrl:R,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:Z};await we(ee(U,`chats_${h}`),L);const K=H(U,`members/${D}`),ae=(await _(K)).data().chattings||{},oe=H(U,`members/${o.uid}`),Q=(await _(oe)).data().chattings||{},ne=((N=Q[h])==null?void 0:N.messageCount)||0;ae[h]=L,Q[h]={...L,messageCount:ne+1},await W(K,{chattings:ae}),await W(oe,{chattings:Q}),M(Ie=>[...Ie,{msg:n,type:"me",userUid:e.uid,id:e.displayName,messageClock:a,conversation:h,userName:E,messageClockNumber:F,userOne:l,userTwo:s,userOneDisplayName:r,userTwoDisplayName:w,userOneProfileUrl:P,userTwoProfileUrl:R,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:X,userTwoProfileImage:Z}])}}catch(D){console.log(D)}},Y=async()=>{try{const n=e.uid,g=o.uid,j=H(U,`members/${n}`),D=(await _(j)).data().conversation||[],E=H(U,`members/${g}`),a=(await _(E)).data().conversation||[];D.indexOf(h)===-1&&(await W(j,{conversation:[...D,h]}),A(be())),a.indexOf(h)===-1&&await W(E,{conversation:[...a,h]})}catch(n){console.log(n)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:`fixed w-screen ${S?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:V,children:[h&&h!=="piazza"&&t.jsx(me,{trigger:t.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:t.jsx(He,{})}),title:t.jsx("div",{children:"전화 선택"}),content:t.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[t.jsx(le,{to:`/piazza?id=${h}?calls=video`,children:t.jsx(ue,{children:t.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:t.jsx(ve,{children:t.jsxs("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var n;(n=document.getElementById("calls"))==null||n.click()},children:[t.jsx(Pe,{}),t.jsx("div",{children:"화상 전화"})]})})})})}),t.jsx(le,{to:`/piazza?id=${h}?calls=audio`,children:t.jsx(ue,{children:t.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:t.jsx(ve,{children:t.jsxs("div",{className:"flex flex-col items-center gap-5",children:[t.jsx(Be,{}),t.jsx("div",{children:"음성 전화"})]})})})})})]})}),t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:_e[b],onChange:J,value:z,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ye[b]})]})})}const ze=({initiateContinuing:o,user:e,userObj:c,handleMessagesList:z,displayedName:y,handleChatUid:$,handleChatDisplayName:M})=>{const{state:I}=De(),S=(I==null?void 0:I.conversation)||"piazza",d=O(T=>T.languages.value),[A,h]=i.useState("");return i.useEffect(()=>{e&&((e==null?void 0:e.uid)<c.uid?h((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+c.uid[0]+c.uid[1]+c.uid[2]+c.uid[3]+c.uid[4]+c.uid[5]):h(c.uid[0]+c.uid[1]+c.uid[2]+c.uid[3]+c.uid[4]+c.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(pe,{element:e,uid:c.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==y&&t.jsx("div",{children:d==="ko"?t.jsxs("div",{children:["(",y,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:`/profile?id=${e==null?void 0:e.uid}`,state:{element:e},children:t.jsx(te,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),S==="piazza"&&c.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:`${location.pathname}?id=${A}`,state:{conversation:A,displayName:e==null?void 0:e.displayName,userUid:c.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ue,{children:t.jsx(te,{variant:"outlined",onClick:()=>{z([]),o()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:o,messagesList:e,handleMessagesList:c,handleChatUid:z,handleChatDisplayName:y}){const $=i.useRef(null),M=i.useRef(null),[I,S]=i.useState(null),[d,A]=i.useState(""),[h,T]=i.useState(!1),[b,V]=i.useState(null),[J,B]=i.useState(0),[C,Y]=i.useState("piazza"),n=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";i.useEffect(()=>{C!==n&&(c([]),V(null),B(0),Y(n))},[n]);const g=O(a=>a.languages.value),j=async({userUid:a,displayName:p})=>{const u=H(U,`members/${a}`),m=(await _(u)).data();S(m),A(p),console.log("practice")},N=({userUid:a,displayName:p})=>{var u;(u=document.getElementById("drawer"))==null||u.click(),j({userUid:a,displayName:p})},D=20;i.useEffect(()=>{if(!k)return;function a(p){const{msg:u,userUid:v,id:m,target:x,messageClock:f,messageClockNumber:l,profileImageUrl:s,defaultProfile:r,profileImage:w,conversation:P}=p;c(R=>[...R,{msg:u,type:x?"private":"other",userUid:v,id:m,messageClock:f,messageClockNumber:l,conversation:null,profileImageUrl:s,defaultProfile:r,profileImage:w}])}return k.on("sMessagePiazza",a),()=>{k.off("sMessagePiazza",a)}},[]),i.useEffect(()=>{if(!k)return;function a(p){const{msg:u,userUid:v,id:m,target:x,messageClock:f,messageClockNumber:l,conversation:s,profileImageUrl:r,defaultProfile:w,profileImage:P,piazzaData:R}=p;c(q=>[...q,{msg:u,type:x?"private":"other",userUid:v,id:m,messageClock:f,messageClockNumber:l,conversation:null,profileImageUrl:r,defaultProfile:w,profileImage:P,...R}])}return k.on(`sMessage${n}`,a),()=>{k.off(`sMessage${n}`,a)}},[n]),i.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),i.useEffect(()=>{E(),(async()=>{if(n==="piazza"){const p=ee(U,"chats_group"),u=re(p,ge("messageClockNumber","desc"),de(1));(await fe(u)).forEach(async m=>{const x=H(U,`chats_group/${m.id}`),l=(await _(x)).data(),s=l.piazzaChecked||[];s.indexOf(o.uid)===-1&&(s.splice(-1,o.uid,0),s.push(o.uid),await W(x,{...l,piazzaChecked:s}))})}else{const p=H(U,`members/${o.uid}`),v=(await _(p)).data().chattings;v[n]&&(v[n].messageCount=0),await W(p,{chattings:v})}})()},[e]);const E=()=>{var a;(a=$.current)==null||a.scrollIntoView()};i.useEffect(()=>{const a=async()=>{const u=[],v=ee(U,"chats_group"),m=re(v,ge("messageClockNumber","desc"),de(D),ke(b||"")),x=await fe(m);x.docs.length||B(x.docs.length),x.forEach(f=>{var Z,L,K;u.length===x.docs.length-1&&(V(f),B(x.docs.length-1));const l=f.data().message,s=f.data().userUid,r=f.data().userName,w=f.data().messageClock,P=f.data().messageClockNumber,R=(Z=f.data())==null?void 0:Z.profileImageUrl,q=(L=f.data())==null?void 0:L.defaultProfile,G=(K=f.data())==null?void 0:K.profileImage,X=f.data();u.push({msg:l,userUid:s,id:r,messageClockNumber:P,messageClock:w,conversation:null,profileImageUrl:R,defaultProfile:q,profileImage:G||!1,...X})}),c([...u,...e]),T(!1)},p=async u=>{const v=ee(U,`chats_${u}`),m=re(v,ge("messageClockNumber","desc"),de(D),ke(b||"")),x=await fe(m),f=[];x.docs.length||B(x.docs.length),x.forEach((l,s)=>{var ce,Q,ne;f.length===x.docs.length-1&&(V(l),B(x.docs.length-1));const r=l.data().message,w=l.data().userUid,P=l.data().userName,R=l.data().messageClock,q=l.data().messageClockNumber||0,G=(ce=l.data())==null?void 0:ce.profileImageUrl,X=(Q=l.data())==null?void 0:Q.defaultProfile,Z=(ne=l.data())==null?void 0:ne.profileImage,L=l.data(),K=l.data().userOne,se=l.data().userOneDisplayName,ae=l.data().userTwo,oe=l.data().userTwoDisplayName;K!==o.uid?(z(K),y(se)):(z(ae),y(oe)),f.push({msg:r,userUid:w,id:P,messageClockNumber:q,messageClock:R,conversation:null,profileImageUrl:G,defaultProfile:X,profileImage:Z||!1,...L})}),f.reverse(),c([...f,...e]),T(!1)};n==="piazza"?(h||!e.length)&&a():(h||!e.length)&&p(n)},[h,n]);const F=()=>{M.current.scrollTop!==0||h||(console.log("scroll"),T(!0))};return i.useEffect(()=>{var a;return(a=M.current)==null||a.addEventListener("scroll",F),()=>{var p;return(p=M.current)==null?void 0:p.removeEventListener("scroll",F)}},[h]),console.log(n),console.log(e),console.log(I),t.jsx(t.Fragment,{children:t.jsx("div",{ref:M,className:"p-1 border-t rounded-xl overflow-auto",children:t.jsxs("ul",{children:[h&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((a,p)=>{let u;n==="piazza"?u=a:a.userUid===a.userOne?u={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:u={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let v;const m=new Date(a.messageClock);a.userUid===o.uid?v="text-right":v="text-left";let x,f;p>0&&(x=e[p-1].userUid),p<e.length-1&&e[p+1].userUid===o.uid&&(f=new Date(e[p+1].messageClock),m.getFullYear()===f.getFullYear()&&m.getMonth()===f.getMonth()&&m.getDate()===f.getDate()&&m.getHours()===f.getHours()&&(m.getMinutes(),f.getMinutes()));let l,s=m.getHours(),r=(m.getMonth()+1).toString(),w=m.getDate().toString();return s>=13?(l="오후",s!==12&&(s=s-12)):(l="오전",s===0&&(s=s+12)),m.getMonth()+1<10&&(r="0"+r),w.length===1&&(w="0"+w),t.jsxs("li",{ref:p===J?$:null,className:v,children:[x!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==o.uid?"start":"end"}`,children:v==="text-left"?t.jsxs("div",{className:"flex gap-3 pt-3",children:[t.jsx(me,{trigger:t.jsx(pe,{element:u,piazza:()=>N({userUid:u.userUid,displayName:u.id}),profile:!1}),title:t.jsx(ye,{}),content:t.jsx(ze,{initiateContinuing:()=>V(null),user:I,userObj:o,handleMessagesList:c,displayedName:d})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3 pt-3",children:[t.jsx("div",{children:a.id}),t.jsx(me,{trigger:t.jsx(pe,{element:u,piazza:()=>N({userUid:u.userUid,displayName:u.id}),profile:!1}),title:t.jsx(ye,{}),content:t.jsx(ze,{initiateContinuing:()=>V(null),user:I,userObj:o,handleMessagesList:c,displayedName:d,handleChatUid:z,handleChatDisplayName:y})})]})})}),a.userUid!==o.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[m.getFullYear(),"-",r,"-",w," ",g==="ko"&&l," ",s,":",m.getMinutes()<10&&"0",m.getMinutes(),g==="en"&&(l==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[m.getFullYear(),"-",r,"-",w," ",g==="ko"&&l," ",s,":",m.getMinutes()<10&&"0",m.getMinutes(),g==="en"&&(l==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},p)}),t.jsx("li",{ref:$})]})})})}function Ke({isKeyboardOpen:o,userObj:e,messagesList:c,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:$}){return t.jsx(t.Fragment,{children:o?t.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:t.jsx(Ne,{userObj:e,messagesList:c,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:$})}):t.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:t.jsx(Ne,{userObj:e,messagesList:c,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:$})})})}const Ze=Ue(Me)(({theme:o})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(o.palette.getContrastText(o.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ge(){const o=O(y=>y.languages.value),e=ie(y=>y.piazzaSwitch.value),c=he(),z=()=>{e==="true"?(window.localStorage.setItem("piazza","false"),c(Ce("false"))):(window.localStorage.setItem("piazza","true"),c(Ce("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:o==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Ze,{onClick:()=>z(),inputProps:{"aria-label":"ant design"},checked:e==="true"})})]})}const Se={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:o})=>{const e=O(y=>y.languages.value),c=e==="ko"||e==="en"?e:"ko",z=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(Ee,{icon:t.jsx(Te,{}),title:z==="piazza"?Se[c][0]:`${Se[c][1]} ${o}`}),z==="piazza"&&t.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:t.jsx(Ge,{})})]})};function Je(){const[o,e]=i.useState([]),[c,z]=i.useState(!0),[y,$]=i.useState(!0),[M,I]=i.useState(""),[S,d]=i.useState(null),[A,h]=i.useState(null),T=Re(),b=i.useRef(null),V=i.useRef(null),J={audio:!0,video:!0},B=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],C=new RTCPeerConnection({iceServers:[{urls:B.map(s=>s.urls)}]}),Y=location.search.slice(4);console.log(location.search.slice(4)),i.useEffect(()=>{(async()=>{await D()})()},[]),i.useEffect(()=>{b.current&&(b.current.srcObject=S)},[S]);async function n(){const s=S;s&&s.getAudioTracks().forEach(r=>r.enabled=!r.enabled),z(!c)}async function g(){const s=S;s&&s.getVideoTracks().forEach(r=>r.enabled=!r.enabled),$(!y)}const j=()=>{b.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(b.current)};async function N(s){if(b.current.srcObject.getTracks().forEach(r=>r.stop()),h(s.target.value),C){console.log(C.getSenders());const r=S.getVideoTracks()[0];C.getSenders().find(P=>P.track.kind==="video").replaceTrack(r)}}i.useEffect(()=>{A&&E(A)},[A]);async function D(){try{const r=(await navigator.mediaDevices.enumerateDevices()).filter(w=>w.kind==="videoinput");e(r)}catch(s){console.log(s)}}async function E(s){try{const w=s?{audio:!0,video:{deviceId:{exact:s}}}:J,P=await navigator.mediaDevices.getUserMedia(w);d(P),I("")}catch(r){const w=r==null?void 0:r.toString();w&&I(w),console.log(r)}}function F(s){console.log("icecandidate"),console.log(s),k.emit("ice",s.candidate,Y)}function a(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",S),V.current=s.stream}function p(){C.addEventListener("icecandidate",F),C.addEventListener("addstream",a),S&&S.getTracks().forEach(s=>C.addTrack(s,S))}async function u(){await E(null),p()}async function v(){await u(),k.emit("joinRoom",Y,u)}i.useEffect(()=>{v()},[]);const m=async()=>{console.log("sent the offer"),console.log(C);const s=await C.createOffer();C.setLocalDescription(s),console.log(s),k.emit("offer",s,Y)};i.useEffect(()=>{if(k)return k.on("welcome",m),()=>{k.off("welcome",m)}});const x=async s=>{console.log("received the offer"),C.setRemoteDescription(s);const r=await C.createAnswer();console.log("sent the answer"),C.setLocalDescription(r),k.emit("answer",r,Y)};i.useEffect(()=>{if(k)return k.on("offer",x),()=>{k.off("offer",x)}});const f=s=>{console.log("received the answer"),C.setRemoteDescription(s)};i.useEffect(()=>{if(k)return k.on("answer",f),()=>{k.off("answer",f)}});const l=s=>{console.log("received candidate"),C.addIceCandidate(s)};return i.useEffect(()=>{if(k)return k.on("ice",l),()=>{k.off("ice",l)}}),t.jsxs("div",{children:[t.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[t.jsx("video",{ref:V,width:"320",height:"240",controls:!0,autoPlay:!0}),t.jsx("video",{id:"myScreen",ref:b,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex gap-5",children:[t.jsx(te,{onClick:n,children:c?"unmute":"mute"}),t.jsx(te,{onClick:g,children:y?"turn stream on":"turn stream off"}),t.jsx(te,{onClick:j,children:"stop"})]}),t.jsx("select",{id:"devices",onChange:N,children:o.map((s,r)=>t.jsx("option",{value:s.deviceId,selected:(S==null?void 0:S.getVideoTracks()[0].id)===s.deviceId,children:s.label},r))})]}),M&&t.jsx("div",{children:M})]})}function We({userObj:o}){const[e,c]=i.useState(""),[z,y]=i.useState([]),$=he(),{state:M}=De(),[I,S]=i.useState(!1),[d,A]=i.useState(null),[h,T]=i.useState(""),[b,V]=i.useState(""),J=g=>{T(g)},B=g=>{V(g)},C=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(h),i.useEffect(()=>{M&&(T(M.chattingUid),V(M.displayName))},[C]),i.useEffect(()=>{C&&(async()=>{if(h){const j=H(U,`members/${h}`),N=await _(j);A(N.data())}})()},[C,h]);const Y=ie(g=>g.piazzaForm.value);i.useEffect(()=>{var j;const g=()=>{var D;const N=window.screen.height-300>(((D=window.visualViewport)==null?void 0:D.height)||window.screen.height);I!==N&&S(N)};return window.addEventListener("resize",g),typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.addEventListener("resize",g)),visualViewport==null||visualViewport.addEventListener("resize",g),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",g)),()=>{var N;typeof visualViewport<"u"&&((N=window.visualViewport)==null||N.removeEventListener("resize",g))}},[I]);const n=()=>{var g;(g=document.getElementById("myScreen"))==null||g.srcObject.getTracks().forEach(j=>j.stop())};return i.useEffect(()=>{$($e(5))}),t.jsxs(t.Fragment,{children:[!I&&t.jsx(Xe,{multiple:!C,displayName:b}),t.jsx(Ke,{isKeyboardOpen:Y,userObj:o,messagesList:z,handleMessagesList:g=>y(g),handleChatUid:J,handleChatDisplayName:B}),t.jsx(qe,{chattingUser:d,userObj:o,multiple:!C,messages:e,handleMessages:g=>c(g),messagesList:z,handleMessagesList:g=>y(g)}),t.jsxs(Ve,{children:[t.jsx(Fe,{children:t.jsx("div",{id:"calls"})}),t.jsx(Ae,{children:t.jsxs("div",{children:[t.jsx("div",{className:"flex gap-5",children:t.jsx(Je,{})}),t.jsx(Le,{children:t.jsx("div",{onClick:n,children:"전화 종료"})})]})})]})]})}export{We as default};
