import{c as Pe,u as ce,d as te,G as he,j as e,P as ue,a0 as xe,b8 as ve,b7 as me,b0 as Re,x as O,p as A,O as Y,a4 as f,b4 as we,n as se,E as ee,b9 as $e,a_ as Ue,r as n,W as pe,a1 as ye,B as J,ba as ke,q as re,a2 as de,a3 as fe,t as ge,b2 as Ce,s as Ve,S as Ae,X as ze,H as Fe,bb as Le,aN as Me,af as Be,bc as Se,bd as je,be as Ne,bf as De}from"./index-BaKfJv7D.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=Pe("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Pe("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Oe={ko:"메세지를 작성해 주세요",en:"Input message"},Ye={ko:"전송",en:"send"};function qe({chattingUser:c,userObj:t,multiple:r,messages:z,handleMessages:y,messagesList:F,handleMessagesList:P}){const D=ce(i=>i.profileColor.value),x=ce(i=>i.piazzaForm.value),d=te(i=>i.profile.value),$=he(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",T=te(i=>i.languages.value),j=T==="ko"||T==="en"?T:"ko",R=async i=>{var s;i.preventDefault();const N=z,U=t.uid,u=t.displayName,C=Date.now(),S=new Date().toString(),M=d==null?void 0:d.profileImageUrl,a=d==null?void 0:d.defaultProfile,p=d==null?void 0:d.profileImage;let m,w,g;c&&(m=O(A,`members/${c.uid}`),w=await Y(m),g=(s=w.data())==null?void 0:s.messagingToken);const h=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const o={msg:N,userUid:U,id:u,messageClockNumber:C,messageClock:S,conversation:v,conversationUid:c==null?void 0:c.uid,conversationName:c==null?void 0:c.displayName,profileImage:p,defaultProfile:a,profileImageUrl:M,profileUrl:h,sendingToken:g};r?o&&N&&(f.emit("piazzaMessage",o),V()):N&&(F.length!==0?(f.emit("message",o),console.log("message")):(f.emit("messageNew",o),console.log("messageNew")),I(),H()),y("")},W=i=>{y(i.target.value)},V=async()=>{try{const i=z,N=t.uid,U=t.displayName,u=new Date().toString(),C=Date.now(),S=d==null?void 0:d.profileImageUrl,M=d==null?void 0:d.defaultProfile,a=d==null?void 0:d.profileImage;i&&(await we(se(A,"chats_group"),{userUid:N,userName:U,message:i,messageClock:u,messageClockNumber:C,profileImageUrl:S,defaultProfile:M,profileColor:D,piazzaChecked:[t.uid],profileImage:a}),P(p=>[...p,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:u,conversation:null,profileColor:D,messageClockNumber:C,defaultProfile:M,profileImageUrl:S,profileImage:a||!1}]))}catch(i){console.log(i)}},I=async()=>{var N,U,u;const i=z;try{const C=t.uid,S=t.displayName,M=Date.now(),a=new Date().toString(),p=d.profileImage,m=c.profileImage,w=d.profileImageUrl,g=c.profileImageUrl,h=d.defaultProfile,o=c.defaultProfile;let s,l,k,b,B,L,q,Z,X,K;if(t.uid<c.uid?(s=t.uid,l=c.uid,k=t.displayName,b=c.displayName,B=w,L=g,q=h,Z=o,X=d.profileImage,K=c.profileImage):(s=c.uid,l=t.uid,k=c.displayName,b=t.displayName,B=g,L=w,q=o,Z=h,X=c.profileImage,K=d.profileImage),!B){const _=O(A,`members/${s}`);B=(N=(await Y(_)).data())==null?void 0:N.profileImageUrl}if(!L){const _=O(A,`members/${l}`);L=(U=(await Y(_)).data())==null?void 0:U.profileImageUrl}if(i){const _={userUid:C,userName:S,message:i,messageClock:a,messageClockNumber:M,userOne:s,userTwo:l,userOneDisplayName:k,userTwoDisplayName:b,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:q,userTwoDefaultProfile:Z,userOneProfileImage:X,userTwoProfileImage:K};await we(se(A,`chats_${v}`),_);const G=O(A,`members/${C}`),ae=(await Y(G)).data().chattings||{},ne=O(A,`members/${c.uid}`),Q=(await Y(ne)).data().chattings||{},ie=((u=Q[v])==null?void 0:u.messageCount)||0;ae[v]=_,Q[v]={..._,messageCount:ie+1},await ee(G,{chattings:ae}),await ee(ne,{chattings:Q}),P(Te=>[...Te,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:a,conversation:v,userName:S,messageClockNumber:M,userOne:s,userTwo:l,userOneDisplayName:k,userTwoDisplayName:b,userOneProfileUrl:B,userTwoProfileUrl:L,userOneDefaultProfile:q,userTwoDefaultProfile:Z,userOneProfileImage:X,userTwoProfileImage:K}])}}catch(C){console.log(C)}},H=async()=>{try{const i=t.uid,N=c.uid,U=O(A,`members/${i}`),C=(await Y(U)).data().conversation||[],S=O(A,`members/${N}`),a=(await Y(S)).data().conversation||[];C.indexOf(v)===-1&&(await ee(U,{conversation:[...C,v]}),$($e())),a.indexOf(v)===-1&&await ee(S,{conversation:[...a,v]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${x?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:R,children:[v&&v!=="piazza"&&e.jsx(ue,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(_e,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ve,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(me,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Re,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(xe,{className:"colorOne",sx:{height:"100%"},children:e.jsx(ve,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(me,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(He,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Oe[j],onChange:W,value:z,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ye[j]})]})}const Ie=({initiateContinuing:c,user:t,userObj:r,handleMessagesList:z,displayedName:y,handleChatUid:F,handleChatDisplayName:P})=>{const{state:D}=Ue(),x=(D==null?void 0:D.conversation)||"piazza",d=te(T=>T.languages.value),[$,v]=n.useState("");return n.useEffect(()=>{t&&((t==null?void 0:t.uid)<r.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):v(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(pe,{element:t,uid:r.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==y&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",y,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",y,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(ye,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(J,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),x==="piazza"&&r.uid!==(t==null?void 0:t.uid)&&e.jsx(ye,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:r.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(me,{children:e.jsx(J,{variant:"outlined",onClick:()=>{z([]),c()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function be({userObj:c,messagesList:t,handleMessagesList:r,handleChatUid:z,handleChatDisplayName:y}){const F=n.useRef(null),P=n.useRef(null),[D,x]=n.useState(null),[d,$]=n.useState(""),[v,T]=n.useState(!1),[j,R]=n.useState(null),[W,V]=n.useState(0),[I,H]=n.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";n.useEffect(()=>{(I!==i||i==="piazza")&&(r([]),R(null),V(0),H(i))},[i]);const N=te(a=>a.languages.value),U=async({userUid:a,displayName:p})=>{const m=O(A,`members/${a}`),g=(await Y(m)).data();x(g),$(p),console.log("practice")},u=({userUid:a,displayName:p})=>{var m;(m=document.getElementById("drawer"))==null||m.click(),U({userUid:a,displayName:p})},C=20;n.useEffect(()=>{if(!f)return;function a(p){const{msg:m,userUid:w,id:g,target:h,messageClock:o,messageClockNumber:s,profileImageUrl:l,defaultProfile:k,profileImage:b,conversation:B}=p;r(L=>[...L,{msg:m,type:h?"private":"other",userUid:w,id:g,messageClock:o,messageClockNumber:s,conversation:null,profileImageUrl:l,defaultProfile:k,profileImage:b}])}return f.on("sMessagePiazza",a),()=>{f.off("sMessagePiazza",a)}},[]),n.useEffect(()=>{if(!f)return;function a(p){const{msg:m,userUid:w,id:g,target:h,messageClock:o,messageClockNumber:s,conversation:l,profileImageUrl:k,defaultProfile:b,profileImage:B,piazzaData:L}=p;r(q=>[...q,{msg:m,type:h?"private":"other",userUid:w,id:g,messageClock:o,messageClockNumber:s,conversation:null,profileImageUrl:k,defaultProfile:b,profileImage:B,...L}])}return f.on(`sMessage${i}`,a),()=>{f.off(`sMessage${i}`,a)}},[i]),n.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),n.useEffect(()=>{S(),(async()=>{if(i==="piazza"){const p=se(A,"chats_group"),m=re(p,fe("messageClockNumber","desc"),de(1));(await ge(m)).forEach(async g=>{const h=O(A,`chats_group/${g.id}`),s=(await Y(h)).data(),l=s.piazzaChecked||[];l.indexOf(c.uid)===-1&&(l.splice(-1,c.uid,0),l.push(c.uid),await ee(h,{...s,piazzaChecked:l}))})}else{const p=O(A,`members/${c.uid}`),w=(await Y(p)).data().chattings;w[i]&&(w[i].messageCount=0),await ee(p,{chattings:w})}})()},[t]);const S=()=>{var a;(a=F.current)==null||a.scrollIntoView()};n.useEffect(()=>{const a=async()=>{const m=[],w=se(A,"chats_group"),g=re(w,fe("messageClockNumber","desc"),de(C),Ce(j||"")),h=await ge(g);h.docs.length||V(h.docs.length),h.forEach(o=>{var K,_,G;m.length===h.docs.length-1&&(R(o),V(h.docs.length-1));const s=o.data().message,l=o.data().userUid,k=o.data().userName,b=o.data().messageClock,B=o.data().messageClockNumber,L=(K=o.data())==null?void 0:K.profileImageUrl,q=(_=o.data())==null?void 0:_.defaultProfile,Z=(G=o.data())==null?void 0:G.profileImage,X=o.data();m.push({msg:s,userUid:l,id:k,messageClockNumber:B,messageClock:b,conversation:null,profileImageUrl:L,defaultProfile:q,profileImage:Z||!1,...X})}),m.reverse(),r([...m,...t]),T(!1)},p=async m=>{const w=se(A,`chats_${m}`),g=re(w,fe("messageClockNumber","desc"),de(C),Ce(j||"")),h=await ge(g),o=[];h.docs.length||V(h.docs.length),h.forEach((s,l)=>{var le,Q,ie;o.length===h.docs.length-1&&(R(s),V(h.docs.length-1));const k=s.data().message,b=s.data().userUid,B=s.data().userName,L=s.data().messageClock,q=s.data().messageClockNumber||0,Z=(le=s.data())==null?void 0:le.profileImageUrl,X=(Q=s.data())==null?void 0:Q.defaultProfile,K=(ie=s.data())==null?void 0:ie.profileImage,_=s.data(),G=s.data().userOne,oe=s.data().userOneDisplayName,ae=s.data().userTwo,ne=s.data().userTwoDisplayName;G!==c.uid?(z(G),y(oe)):(z(ae),y(ne)),o.push({msg:k,userUid:b,id:B,messageClockNumber:q,messageClock:L,conversation:null,profileImageUrl:Z,defaultProfile:X,profileImage:K||!1,..._})}),o.reverse(),r([...o,...t]),T(!1)};console.log(t.length),i==="piazza"?(v||!t.length)&&a():(v||!t.length)&&p(i)},[v,I]);const M=()=>{P.current.scrollTop!==0||v||(console.log("scroll"),T(!0))};return n.useEffect(()=>{var a;return(a=P.current)==null||a.addEventListener("scroll",M),()=>{var p;return(p=P.current)==null?void 0:p.removeEventListener("scroll",M)}},[v]),console.log(i),console.log(t),console.log(D),e.jsx(e.Fragment,{children:e.jsx("div",{ref:P,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((a,p)=>{let m;i==="piazza"?m=a:a.userUid===a.userOne?m={userUid:a.userOne,id:a.userOneDisplayName,profileImage:a.userOneProfileImage||a.profileImage,defaultProfile:a.userOneDefaultProfile||a.defaultProfile,profileImageUrl:a.userOneProfileUrl||a.profileImageUrl}:m={userUid:a.userTwo,id:a.userTwoDisplayName,profileImage:a.userTwoProfileImage||a.profileImage,defaultProfile:a.userTwoDefaultProfile||a.defaultProfile,profileImageUrl:a.userTwoProfileUrl||a.profileImageUrl};let w;const g=new Date(a.messageClock);a.userUid===c.uid?w="text-right":w="text-left";let h,o;p>0&&(h=t[p-1].userUid),p<t.length-1&&t[p+1].userUid===c.uid&&(o=new Date(t[p+1].messageClock),g.getFullYear()===o.getFullYear()&&g.getMonth()===o.getMonth()&&g.getDate()===o.getDate()&&g.getHours()===o.getHours()&&(g.getMinutes(),o.getMinutes()));let s,l=g.getHours(),k=(g.getMonth()+1).toString(),b=g.getDate().toString();return l>=13?(s="오후",l!==12&&(l=l-12)):(s="오전",l===0&&(l=l+12)),g.getMonth()+1<10&&(k="0"+k),b.length===1&&(b="0"+b),e.jsxs("li",{ref:p===W?F:null,className:w,children:[h!==a.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${a.userUid!==c.uid?"start":"end"}`,children:w==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(ue,{trigger:e.jsx(pe,{element:m,piazza:()=>u({userUid:m.userUid,displayName:m.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(Ie,{initiateContinuing:()=>R(null),user:D,userObj:c,handleMessagesList:r,displayedName:d})}),e.jsx("div",{children:a.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:a.id}),e.jsx(ue,{trigger:e.jsx(pe,{element:m,piazza:()=>u({userUid:m.userUid,displayName:m.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(Ie,{initiateContinuing:()=>R(null),user:D,userObj:c,handleMessagesList:r,displayedName:d,handleChatUid:z,handleChatDisplayName:y})})]})})}),a.userUid!==c.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),e.jsxs("div",{children:[g.getFullYear(),"-",k,"-",b," ",N==="ko"&&s," ",l,":",g.getMinutes()<10&&"0",g.getMinutes(),N==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[g.getFullYear(),"-",k,"-",b," ",N==="ko"&&s," ",l,":",g.getMinutes()<10&&"0",g.getMinutes(),N==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},p)}),e.jsx("li",{ref:F})]})})})}function Ge({isKeyboardOpen:c,userObj:t,messagesList:r,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:F}){return e.jsx(e.Fragment,{children:c?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(be,{userObj:t,messagesList:r,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:F})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(be,{userObj:t,messagesList:r,handleMessagesList:z,handleChatUid:y,handleChatDisplayName:F})})})}const Ke=Ve(Ae)(({theme:c})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function We(){const c=te(y=>y.languages.value),t=ce(y=>y.piazzaSwitch.value),r=he(),z=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),r(ze("false"))):(window.localStorage.setItem("piazza","true"),r(ze("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:c==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Ke,{onClick:()=>z(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Ee={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Ze=({displayName:c})=>{const t=te(y=>y.languages.value),r=t==="ko"||t==="en"?t:"ko",z=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Fe,{icon:e.jsx(Le,{}),title:z==="piazza"?Ee[r][0]:`${Ee[r][1]} ${c}`}),z==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(We,{})})]})};function Xe(){const[c,t]=n.useState([]),[r,z]=n.useState(!0),[y,F]=n.useState(!0),[P,D]=n.useState(""),[x,d]=n.useState(null),[$,v]=n.useState(null),T=Me(),j=n.useRef(null),R=n.useRef(null),W={audio:!0,video:!1},V=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],I=new RTCPeerConnection({iceServers:[{urls:V.map(s=>s.urls)}]}),H=location.search.slice(4);console.log(location.search.slice(4)),n.useEffect(()=>{(async()=>{await u()})()},[]),n.useEffect(()=>{j.current&&(j.current.srcObject=x)},[x]);async function i(){const s=x;s&&s.getAudioTracks().forEach(l=>l.enabled=!l.enabled),z(!r)}async function N(){const s=x;s&&s.getVideoTracks().forEach(l=>l.enabled=!l.enabled),F(!y)}const U=()=>{j.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(j.current)};n.useEffect(()=>{$&&C($)},[$]);async function u(){try{const l=(await navigator.mediaDevices.enumerateDevices()).filter(k=>k.kind==="videoinput");t(l)}catch(s){console.log(s)}}async function C(s){try{const k=s?{audio:!0,video:{deviceId:{exact:s}}}:W,b=await navigator.mediaDevices.getUserMedia(k);d(b),D("")}catch(l){const k=l==null?void 0:l.toString();k&&D(k),console.log(l)}}function S(s){console.log("icecandidate"),console.log(s),f.emit("ice",s.candidate,H)}function M(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",x),R.current=s.stream}function a(){I.addEventListener("icecandidate",S),I.addEventListener("addstream",M),x&&x.getTracks().forEach(s=>I.addTrack(s,x))}async function p(){await C(null),a()}async function m(){await p(),f.emit("joinRoom",H,p)}n.useEffect(()=>{m()},[]);const w=async()=>{console.log("sent the offer"),console.log(I);const s=await I.createOffer();I.setLocalDescription(s),console.log(s),f.emit("offer",s,H)};n.useEffect(()=>{if(f)return f.on("welcome",w),()=>{f.off("welcome",w)}});const g=async s=>{console.log("received the offer"),I.setRemoteDescription(s);const l=await I.createAnswer();console.log("sent the answer"),I.setLocalDescription(l),f.emit("answer",l,H)};n.useEffect(()=>{if(f)return f.on("offer",g),()=>{f.off("offer",g)}});const h=s=>{console.log("received the answer"),I.setRemoteDescription(s)};n.useEffect(()=>{if(f)return f.on("answer",h),()=>{f.off("answer",h)}});const o=s=>{console.log("received candidate"),I.addIceCandidate(s)};return n.useEffect(()=>{if(f)return f.on("ice",o),()=>{f.off("ice",o)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:j,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(J,{onClick:i,children:r?"unmute":"mute"}),e.jsx(J,{onClick:N,children:y?"turn stream on":"turn stream off"}),e.jsx(J,{onClick:U,children:"stop"})]})}),P&&e.jsx("div",{children:P})]})}const E=new RTCPeerConnection;function Je(){const[c,t]=n.useState([]),[r,z]=n.useState(!0),[y,F]=n.useState(!0),[P,D]=n.useState(""),[x,d]=n.useState(null),[$,v]=n.useState(null),T=Me(),j=n.useRef(null),R=n.useRef(null),W={audio:!0,video:!0},V=location.search.slice(4);console.log(location.search.slice(4)),n.useEffect(()=>{(async()=>{await U()})()},[]),n.useEffect(()=>{j.current&&(j.current.srcObject=x)},[x]);async function I(){const o=x;o&&o.getAudioTracks().forEach(s=>s.enabled=!s.enabled),z(!r)}async function H(){const o=x;o&&o.getVideoTracks().forEach(s=>s.enabled=!s.enabled),F(!y)}const i=()=>{j.current.srcObject.getTracks().forEach(o=>o.stop()),console.log(j.current)};async function N(o){if(j.current.srcObject.getTracks().forEach(s=>s.stop()),v(o.target.value),E&&x){console.log(E.getSenders());const s=x.getVideoTracks()[0];E.getSenders().find(k=>k.track.kind==="video").replaceTrack(s)}}n.useEffect(()=>{$&&u($)},[$]);async function U(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput");t(s)}catch(o){console.log(o)}}async function u(o){try{const l=o?{audio:!0,video:{deviceId:{exact:o}}}:W,k=await navigator.mediaDevices.getUserMedia(l);d(k),D("")}catch(s){const l=s==null?void 0:s.toString();l&&D(l),console.log(s)}}function C(o){console.log("icecandidate"),console.log(o),f.emit("ice",o.candidate,V)}function S(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",x),R.current=o.stream}function M(){E.addEventListener("icecandidate",C),E.addEventListener("addstream",S),x&&x.getTracks().forEach(o=>E.addTrack(o,x))}async function a(){await u(null),M()}async function p(){await a(),f.emit("joinRoom",V,a)}n.useEffect(()=>{p()},[]);const m=async()=>{if(E){console.log("sent the offer"),console.log(E);const o=await E.createOffer();console.log(o),E.setLocalDescription(o),f.emit("offer",o,V)}};n.useEffect(()=>{if(f)return f.on("welcome",m),()=>{f.off("welcome",m)}});const w=async o=>{if(E){console.log("received the offer"),E.setRemoteDescription(o);const s=await E.createAnswer();console.log("sent the answer"),console.log(E),console.log(s),E.setLocalDescription(s),f.emit("answer",s,V)}};n.useEffect(()=>{if(f)return f.on("offer",w),()=>{f.off("offer",w)}});const g=o=>{E&&(console.log("received the answer"),E.setRemoteDescription(o))};n.useEffect(()=>{if(f)return f.on("answer",g),()=>{f.off("answer",g)}});const h=o=>{E&&(console.log("received candidate"),E.addIceCandidate(o))};return n.useEffect(()=>{if(f)return f.on("ice",h),()=>{f.off("ice",h)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!T&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:R,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:j,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(J,{onClick:I,children:r?"unmute":"mute"}),e.jsx(J,{onClick:H,children:y?"turn stream on":"turn stream off"}),e.jsx(J,{onClick:i,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:N,children:c.map((o,s)=>e.jsx("option",{value:o.deviceId,selected:(x==null?void 0:x.getVideoTracks()[0].id)===o.deviceId,children:o.label},s))})]}),P&&e.jsx("div",{children:P})]})}function et({userObj:c}){const[t,r]=n.useState(""),[z,y]=n.useState([]),F=he(),{state:P}=Ue(),[D,x]=n.useState(!1),[d,$]=n.useState(null),[v,T]=n.useState(""),[j,R]=n.useState(""),[W,V]=n.useState(""),I=u=>{T(u)},H=u=>{R(u)},i=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(v),n.useEffect(()=>{P?(T(P.chattingUid),R(P.displayName)):(T(""),R(""))},[i]),n.useEffect(()=>{i&&(async()=>{if(v){const C=O(A,`members/${v}`),S=await Y(C);$(S.data())}})()},[i,v]);const N=ce(u=>u.piazzaForm.value);n.useEffect(()=>{var C;const u=()=>{var M;const S=window.screen.height-300>(((M=window.visualViewport)==null?void 0:M.height)||window.screen.height);D!==S&&x(S)};return window.addEventListener("resize",u),typeof visualViewport<"u"&&((C=window.visualViewport)==null||C.addEventListener("resize",u)),visualViewport==null||visualViewport.addEventListener("resize",u),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",u)),()=>{var S;typeof visualViewport<"u"&&((S=window.visualViewport)==null||S.removeEventListener("resize",u))}},[D]);const U=()=>{var u;V(""),(u=document.getElementById("myScreen"))==null||u.srcObject.getTracks().forEach(C=>C.stop())};return n.useEffect(()=>{F(Be(5))}),e.jsxs(e.Fragment,{children:[!D&&e.jsx(Ze,{multiple:!i,displayName:j}),e.jsx(Ge,{isKeyboardOpen:N,userObj:c,messagesList:z,handleMessagesList:u=>y(u),handleChatUid:I,handleChatDisplayName:H}),e.jsx(qe,{chattingUser:d,userObj:c,multiple:!i,messages:t,handleMessages:u=>r(u),messagesList:z,handleMessagesList:u=>y(u)}),e.jsxs(Se,{children:[e.jsx(je,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(Ne,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(De,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]}),e.jsxs(Se,{children:[e.jsx(je,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(Ne,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Xe,{})}),e.jsx(De,{children:e.jsx("div",{onClick:U,children:"전화 종료"})})]})})]})]})}export{et as default};
