import{u as O,c as ee,H as ce,aR as re,j as a,l as T,g as N,y as $,S as Z,aU as me,f as ae,v as X,aY as Ie,r as h,G as le,O as pe,B as ue,aW as Ue,P as he,aZ as xe,q as se,Q as oe,R as ie,h as ne,aT as we,ap as Pe,a_ as be,I as ve,w as je,a4 as Me}from"./index-eUkIlHau.js";const ke={ko:"메세지를 작성해 주세요",en:"Input message"},ye={ko:"전송",en:"send"};function Ee({chattingUser:s,userObj:l,multiple:k,messages:e,handleMessages:i,messagesList:b,handleMessagesList:p}){const D=O(m=>m.profileColor.value),Y=O(m=>m.piazzaForm.value),f=ee(m=>m.profile.value),Q=ce(),{state:S}=re(),z=S==null?void 0:S.conversation,F=ee(m=>m.languages.value),R=F==="ko"||F==="en"?F:"ko";console.log(s);const w=async m=>{var c;m.preventDefault();const U=e,E=l.uid,V=l.displayName,C=Date.now(),t=new Date().toString();let n,o,u;s&&(n=T(N,`members/${s.uid}`),o=await $(n),u=(c=o.data())==null?void 0:c.messagingToken);const r=f.profileImage?f.profileUrl:f.defaultProfile,d={msg:U,userUid:E,id:V,messageClockNumber:C,messageClock:t,conversation:z,conversationUid:s==null?void 0:s.uid,conversationName:s==null?void 0:s.displayName,profileUrl:r,sendingToken:u};k?d&&U&&(Z.emit("piazzaMessage",d),I()):U&&(b.length!==0?(Z.emit("message",d),console.log("message")):(Z.emit("messageNew",d),console.log("messageNew")),M(),J()),i("")},j=m=>{i(m.target.value)},I=async()=>{try{const m=e,U=l.uid,E=l.displayName,V=new Date().toString(),C=Date.now(),t=f==null?void 0:f.profileImageUrl,n=f==null?void 0:f.defaultProfile,o=f==null?void 0:f.profileImage;m&&(await me(ae(N,"chats_group"),{userUid:U,userName:E,message:m,messageClock:V,messageClockNumber:C,profileImageUrl:t,defaultProfile:n,profileColor:D,piazzaChecked:[l.uid],profileImage:o}),p(u=>[...u,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:V,conversation:null,profileColor:D,messageClockNumber:C,defaultProfile:n,profileImageUrl:t,profileImage:o||!1}]))}catch(m){console.log(m)}},M=async()=>{var U,E,V;const m=e;try{const C=l.uid,t=l.displayName,n=Date.now(),o=new Date().toString(),u=f.profileImage,r=s.profileImage,d=f.profileImageUrl,c=s.profileImageUrl,g=f.defaultProfile,x=s.defaultProfile;let y,v,A,H,B,_,q,G,K,L;if(l.uid<s.uid?(y=l.uid,v=s.uid,A=l.displayName,H=s.displayName,B=d,_=c,q=g,G=x,K=f.profileImage,L=s.profileImage):(y=s.uid,v=l.uid,A=s.displayName,H=l.displayName,B=c,_=d,q=x,G=g,K=s.profileImage,L=f.profileImage),!B){const P=T(N,`members/${y}`);B=(U=(await $(P)).data())==null?void 0:U.profileImageUrl}if(!_){const P=T(N,`members/${v}`);_=(E=(await $(P)).data())==null?void 0:E.profileImageUrl}if(m){const P={userUid:C,userName:t,message:m,messageClock:o,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:_,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:K,userTwoProfileImage:L};await me(ae(N,`chats_${z}`),P);const W=T(N,`members/${C}`),ge=(await $(W)).data().chattings||{},fe=T(N,`members/${s.uid}`),te=(await $(fe)).data().chattings||{},De=((V=te[z])==null?void 0:V.messageCount)||0;ge[z]=P,te[z]={...P,messageCount:De+1},await X(W,{chattings:ge}),await X(fe,{chattings:te}),p(Se=>[...Se,{msg:m,type:"me",userUid:l.uid,id:l.displayName,messageClock:o,conversation:z,userName:t,messageClockNumber:n,userOne:y,userTwo:v,userOneDisplayName:A,userTwoDisplayName:H,userOneProfileUrl:B,userTwoProfileUrl:_,userOneDefaultProfile:q,userTwoDefaultProfile:G,userOneProfileImage:K,userTwoProfileImage:L}])}}catch(C){console.log(C)}},J=async()=>{try{const m=l.uid,U=s.uid,E=T(N,`members/${m}`),C=(await $(E)).data().conversation||[],t=T(N,`members/${U}`),o=(await $(t)).data().conversation||[];C.indexOf(z)===-1&&(await X(E,{conversation:[...C,z]}),Q(Ie())),o.indexOf(z)===-1&&await X(t,{conversation:[...o,z]})}catch(m){console.log(m)}};return a.jsx(a.Fragment,{children:Y?a.jsxs("form",{className:"fixed w-screen bottom-0 flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[R],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[R]})]}):a.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:w,children:[a.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ke[R],onChange:j,value:e,autoFocus:!0}),a.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:ye[R]})]})})}const ze=({initiateContinuing:s,multiple:l,handleMultiple:k,user:e,userObj:i,handleMessagesList:b,displayedName:p})=>{const[D,Y]=h.useState(null),f=ee(Q=>Q.languages.value);return h.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?Y((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):Y(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),a.jsxs("div",{children:[a.jsxs("div",{className:"flex flex-col items-center pt-5",children:[a.jsx(le,{element:e,uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),a.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==p&&a.jsx("div",{children:f==="ko"?a.jsxs("div",{children:["(",p,"에서 개명)"]}):a.jsxs("div",{children:["(Changed name from ",p,")"]})})]}),a.jsxs("div",{className:"flex justify-center p-5",children:[a.jsx(pe,{to:`${location.pathname}?id=${D}`,state:{element:e},children:a.jsx(ue,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),l&&i.uid!==(e==null?void 0:e.uid)&&a.jsx(pe,{to:`${location.pathname}?id=${D}`,state:{conversation:D,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:a.jsx(Ue,{children:a.jsx(ue,{variant:"outlined",onClick:()=>{b([]),k(!1),s()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:s,multiple:l,handleMultiple:k,messagesList:e,handleMessagesList:i}){const b=h.useRef(null),p=h.useRef(null),[D,Y]=h.useState(null),[f,Q]=h.useState(""),[S,z]=h.useState(!1),[F,R]=h.useState(null),[w,j]=h.useState(0);O(t=>t.profileColor.value),O(t=>t.profileUrl.value);const{state:I}=re(),M=(I==null?void 0:I.conversation)||"piazza",J=ee(t=>t.languages.value),m=async({userUid:t,displayName:n})=>{const o=T(N,`members/${t}`),r=(await $(o)).data();Y(r),Q(n)},U=({userUid:t,displayName:n})=>{var o;(o=document.getElementById("drawer"))==null||o.click(),m({userUid:t,displayName:n})},E=20;h.useEffect(()=>{if(!Z)return;function t(n){const{msg:o,userUid:u,id:r,target:d,messageClock:c,messageClockNumber:g,profileImageUrl:x,defaultProfile:y,profileImage:v,conversation:A}=n;i(H=>[...H,{msg:o,type:d?"private":"other",userUid:u,id:r,messageClock:c,messageClockNumber:g,conversation:null,profileImageUrl:x,defaultProfile:y,profileImage:v}])}return Z.on("sMessagePiazza",t),()=>{Z.off("sMessagePiazza",t)}},[]),h.useEffect(()=>{if(!Z)return;function t(n){const{msg:o,userUid:u,id:r,target:d,messageClock:c,messageClockNumber:g,conversation:x,piazzaData:y}=n;i(v=>[...v,{msg:o,type:d?"private":"other",userUid:u,id:r,messageClock:c,messageClockNumber:g,conversation:null,...y}])}return Z.on(`sMessage${M}`,t),()=>{Z.off(`sMessage${M}`,t)}},[]),h.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),h.useEffect(()=>{V(),(async()=>{if(l){const n=ae(N,"chats_group"),o=se(n,ie("messageClockNumber","desc"),oe(1));(await ne(o)).forEach(async r=>{const d=T(N,`chats_group/${r.id}`),g=(await $(d)).data(),x=g.piazzaChecked||[];x.indexOf(s.uid)===-1&&(x.splice(-1,s.uid,0),x.push(s.uid),await X(d,{...g,piazzaChecked:x}))})}else{const n=T(N,`members/${s.uid}`),u=(await $(n)).data().chattings;u[M]&&(u[M].messageCount=0),await X(n,{chattings:u})}})()},[e]);const V=()=>{var t;(t=b.current)==null||t.scrollIntoView()};h.useEffect(()=>{const t=async()=>{const o=[],u=ae(N,"chats_group"),r=se(u,ie("messageClockNumber","desc"),oe(E),we(F||"")),d=await ne(r);d.docs.length||j(d.docs.length),d.forEach(c=>{var G,K,L,P;o.length===d.docs.length-1&&(R(c),j(d.docs.length-1));const g=c.data().message,x=c.data().userUid,y=c.data().userName,v=c.data().messageClock,A=c.data().messageClockNumber;(G=c.data())==null||G.profileColor;const H=(K=c.data())==null?void 0:K.profileImageUrl,B=(L=c.data())==null?void 0:L.defaultProfile,_=(P=c.data())==null?void 0:P.profileImage,q=c.data();o.push({msg:g,userUid:x,id:y,messageClockNumber:A,messageClock:v,conversation:null,profileImageUrl:H,defaultProfile:B,profileImage:_||!1,...q})}),o.reverse(),i([...o,...e]),z(!1)},n=async o=>{const u=ae(N,`chats_${o}`),r=se(u,ie("messageClockNumber","desc"),oe(E),we(F||"")),d=await ne(r),c=[];d.docs.length||j(d.docs.length),d.forEach((g,x)=>{var L,P,W;c.length===d.docs.length-1&&(R(g),j(d.docs.length-1));const y=g.data().message,v=g.data().userUid,A=g.data().userName,H=g.data().messageClock,B=g.data().messageClockNumber||0,_=(L=g.data())==null?void 0:L.profileImageUrl,q=(P=g.data())==null?void 0:P.defaultProfile,G=(W=g.data())==null?void 0:W.profileImage,K=g.data();c.push({msg:y,userUid:v,id:A,messageClockNumber:B,messageClock:H,conversation:null,profileImageUrl:_,defaultProfile:q,profileImage:G||!1,...K})}),c.reverse(),i([...c,...e]),z(!1)};M==="piazza"?(S||!e.length)&&t():(S||!e.length)&&n(M)},[S,M]);const C=()=>{p.current.scrollTop!==0||S||(console.log("scroll"),z(!0))};return h.useEffect(()=>{var t;return(t=p.current)==null||t.addEventListener("scroll",C),()=>{var n;return(n=p.current)==null?void 0:n.removeEventListener("scroll",C)}},[S]),console.log(e),a.jsx(a.Fragment,{children:a.jsx(a.Fragment,{children:a.jsx("div",{ref:p,className:"p-1 border-t rounded-xl overflow-auto",children:a.jsxs("ul",{children:[S&&a.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((t,n)=>{let o;l?o=t:(console.log(t.userUid===s.uid),t.userUid===t.userOne?o={userUid:t.userOne,id:t.userOneDisplayName,profileImage:t.userOneProfileImage,defaultProfile:t.userOneDefaultProfile,profileImageUrl:t.userOneProfileUrl}:o={userUid:t.userTwo,id:t.userTwoDisplayName,profileImage:t.userTwoProfileImage,defaultProfile:t.userTwoDefaultProfile,profileImageUrl:t.userTwoProfileUrl});let u;const r=new Date(t.messageClock);t.userUid===s.uid?u="text-right":u="text-left";let d,c;n>0&&(d=e[n-1].userUid),n<e.length-1&&e[n+1].userUid===s.uid&&(c=new Date(e[n+1].messageClock),r.getFullYear()===c.getFullYear()&&r.getMonth()===c.getMonth()&&r.getDate()===c.getDate()&&r.getHours()===c.getHours()&&(r.getMinutes(),c.getMinutes()));let g,x=r.getHours(),y=(r.getMonth()+1).toString(),v=r.getDate().toString();return x>=13?(g="오후",x!==12&&(x=x-12)):(g="오전",x===0&&(x=x+12)),r.getMonth()+1<10&&(y="0"+y),v.length===1&&(v="0"+v),a.jsxs("li",{ref:n===w?b:null,className:u,children:[d!==t.userUid&&a.jsx("div",{children:a.jsx("div",{className:`flex justify-${t.userUid!==s.uid?"start":"end"}`,children:u==="text-left"?a.jsxs("div",{className:"flex gap-3",children:[a.jsx(he,{trigger:a.jsx(le,{element:o,piazza:()=>U({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>R(null),multiple:l,handleMultiple:k,user:D,userObj:s,handleMessagesList:i,displayedName:f})}),a.jsx("div",{children:t.id})]}):a.jsxs("div",{className:"flex gap-3",children:[a.jsx("div",{children:t.id}),a.jsx(he,{trigger:a.jsx(le,{element:o,piazza:()=>U({userUid:o.userUid,displayName:o.id}),profile:!1}),title:a.jsx(xe,{}),content:a.jsx(ze,{initiateContinuing:()=>R(null),multiple:l,handleMultiple:k,user:D,userObj:s,handleMessagesList:i,displayedName:f})})]})})}),t.userUid!==s.uid?a.jsxs("div",{className:"flex gap-3 justify-start",children:[a.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg}),a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",J==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),J==="en"&&(g==="오전"?"am":"pm")]})]}):a.jsxs("div",{className:"flex gap-3 justify-end",children:[a.jsxs("div",{children:[r.getFullYear(),"-",y,"-",v," ",J==="ko"&&g," ",x,":",r.getMinutes()<10&&"0",r.getMinutes(),J==="en"&&(g==="오전"?"am":"pm")]}),a.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:t.msg})]})]},n)}),a.jsx("li",{ref:b})]})})})})}function Re({isKeyboardOpen:s,userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:b}){return a.jsx(a.Fragment,{children:s?a.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:b})}):a.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:a.jsx(Ne,{userObj:l,multiple:k,handleMultiple:e,messagesList:i,handleMessagesList:b})})})}const Te=Pe(be)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function $e(){const s=ee(i=>i.languages.value),l=O(i=>i.piazzaSwitch.value),k=ce(),e=()=>{l==="true"?(window.localStorage.setItem("piazza","false"),k(ve("false"))):(window.localStorage.setItem("piazza","true"),k(ve("true")))};return a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),a.jsx("div",{className:"flex justify-end",children:a.jsx(Te,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:l==="true"})})]})}const Ce={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Fe=({multiple:s,displayName:l})=>{const k=ee(i=>i.languages.value),e=k==="ko"||k==="en"?k:"ko";return a.jsxs("div",{className:"flex w-screen justify-between",children:[a.jsx(je,{title:s?Ce[e][0]:`${Ce[e][1]} ${l}`}),s&&a.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:a.jsx($e,{})})]})};function Be({userObj:s}){const[l,k]=h.useState(""),[e,i]=h.useState([]),b=ce(),{state:p}=re(),[D,Y]=h.useState(!0),[f,Q]=h.useState(!1),[S,z]=h.useState(null);h.useEffect(()=>{const w=async()=>{if(p.chattingUid){const j=T(N,`members/${p.chattingUid}`),I=await $(j);z(I.data())}};p.multiple||w()},[p]);const F=O(w=>w.piazzaForm.value);h.useEffect(()=>{var j;const w=()=>{var M;const I=window.screen.height-300>(((M=window.visualViewport)==null?void 0:M.height)||window.screen.height);f!==I&&Q(I)};return window.addEventListener("resize",w),typeof visualViewport<"u"&&((j=window.visualViewport)==null||j.addEventListener("resize",w)),visualViewport==null||visualViewport.addEventListener("resize",w),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",w)),()=>{var I;typeof visualViewport<"u"&&((I=window.visualViewport)==null||I.removeEventListener("resize",w))}},[f]),h.useEffect(()=>{(p==null?void 0:p.multiple)!==void 0&&Y(p==null?void 0:p.multiple)},[]),h.useEffect(()=>{b(Me(5))});const R=p==null?void 0:p.displayName;return console.log(p),console.log(S),a.jsxs(a.Fragment,{children:[!f&&a.jsx(Fe,{multiple:D,displayName:R}),a.jsx(Re,{isKeyboardOpen:F,userObj:s,multiple:D,handleMultiple:w=>Y(w),messagesList:e,handleMessagesList:w=>i(w)}),a.jsx(Ee,{chattingUser:S,userObj:s,multiple:D,messages:l,handleMessages:w=>k(w),messagesList:e,handleMessagesList:w=>i(w)})]})}export{Be as default};
