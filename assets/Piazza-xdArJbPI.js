import{c as Ue,u as le,d as se,G as xe,j as e,P as ue,a0 as ve,b8 as we,b7 as pe,b0 as $e,x as Y,p as R,O,a4 as g,b4 as ye,n as oe,E as te,b9 as Ve,a_ as Me,r as c,W as he,a1 as Ce,B as Q,ba as ke,q as de,a2 as fe,a3 as ge,t as me,b2 as ze,s as Ae,S as Fe,X as Se,H as Be,bb as Le,aN as Te,af as He,bc as je,bd as Ne,be as De,bf as Ie}from"./index-D_YS2Tyk.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=Ue("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Ue("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Oe={ko:"메세지를 작성해 주세요",en:"Input message"},qe={ko:"전송",en:"send"};function Ge({chattingUser:l,userObj:t,multiple:r,messages:C,handleMessages:w,messagesList:$,handleMessagesList:E}){const j=le(n=>n.profileColor.value),U=le(n=>n.piazzaForm.value),f=se(n=>n.profile.value),V=xe(),v=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",N=se(n=>n.languages.value),T=N==="ko"||N==="en"?N:"ko",b=async n=>{var s;n.preventDefault();const S=C,M=t.uid,u=t.displayName,y=Date.now(),k=new Date().toString(),P=f==null?void 0:f.profileImageUrl,o=f==null?void 0:f.defaultProfile,h=f==null?void 0:f.profileImage;let p,a,i;l&&(p=Y(R,`members/${l.uid}`),a=await O(p),i=(s=a.data())==null?void 0:s.messagingToken);const x=f.profileImage?f.profileImageUrl:f.defaultProfile;console.log(f);const m={msg:S,userUid:M,id:u,messageClockNumber:y,messageClock:k,conversation:v,conversationUid:l==null?void 0:l.uid,conversationName:l==null?void 0:l.displayName,profileImage:h,defaultProfile:o,profileImageUrl:P,profileUrl:x,sendingToken:i};r?m&&S&&(g.emit("piazzaMessage",m),F()):S&&($.length!==0?(g.emit("message",m),console.log("message")):(g.emit("messageNew",m),console.log("messageNew")),D(),L()),w("")},Z=n=>{w(n.target.value)},F=async()=>{try{const n=C,S=t.uid,M=t.displayName,u=new Date().toString(),y=Date.now(),k=f==null?void 0:f.profileImageUrl,P=f==null?void 0:f.defaultProfile,o=f==null?void 0:f.profileImage;n&&(await ye(oe(R,"chats_group"),{userUid:S,userName:M,message:n,messageClock:u,messageClockNumber:y,profileImageUrl:k,defaultProfile:P,profileColor:j,piazzaChecked:[t.uid],profileImage:o}),E(h=>[...h,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:u,conversation:null,profileColor:j,messageClockNumber:y,defaultProfile:P,profileImageUrl:k,profileImage:o||!1}]))}catch(n){console.log(n)}},D=async()=>{var S,M,u;const n=C;try{const y=t.uid,k=t.displayName,P=Date.now(),o=new Date().toString(),h=f.profileImage,p=l.profileImage,a=f.profileImageUrl,i=l.profileImageUrl,x=f.defaultProfile,m=l.defaultProfile;let s,d,z,I,B,A,q,X,J,K;if(t.uid<l.uid?(s=t.uid,d=l.uid,z=t.displayName,I=l.displayName,B=a,A=i,q=x,X=m,J=f.profileImage,K=l.profileImage):(s=l.uid,d=t.uid,z=l.displayName,I=t.displayName,B=i,A=a,q=m,X=x,J=l.profileImage,K=f.profileImage),!B){const H=Y(R,`members/${s}`);B=(S=(await O(H)).data())==null?void 0:S.profileImageUrl}if(!A){const H=Y(R,`members/${d}`);A=(M=(await O(H)).data())==null?void 0:M.profileImageUrl}if(n){const H={userUid:y,userName:k,message:n,messageClock:o,messageClockNumber:P,userOne:s,userTwo:d,userOneDisplayName:z,userTwoDisplayName:I,userOneProfileUrl:B,userTwoProfileUrl:A,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K};await ye(oe(R,`chats_${v}`),H);const G=Y(R,`members/${y}`),ne=(await O(G)).data().chattings||{},ie=Y(R,`members/${l.uid}`),ee=(await O(ie)).data().chattings||{},ce=((u=ee[v])==null?void 0:u.messageCount)||0;ne[v]=H,ee[v]={...H,messageCount:ce+1},await te(G,{chattings:ne}),await te(ie,{chattings:ee}),E(Re=>[...Re,{msg:n,type:"me",userUid:t.uid,id:t.displayName,messageClock:o,conversation:v,userName:k,messageClockNumber:P,userOne:s,userTwo:d,userOneDisplayName:z,userTwoDisplayName:I,userOneProfileUrl:B,userTwoProfileUrl:A,userOneDefaultProfile:q,userTwoDefaultProfile:X,userOneProfileImage:J,userTwoProfileImage:K}])}}catch(y){console.log(y)}},L=async()=>{try{const n=t.uid,S=l.uid,M=Y(R,`members/${n}`),y=(await O(M)).data().conversation||[],k=Y(R,`members/${S}`),o=(await O(k)).data().conversation||[];y.indexOf(v)===-1&&(await te(M,{conversation:[...y,v]}),V(Ve())),o.indexOf(v)===-1&&await te(k,{conversation:[...o,v]})}catch(n){console.log(n)}};return e.jsxs("form",{className:`fixed w-screen ${U?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:b,children:[v&&v!=="piazza"&&e.jsx(ue,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(Ye,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var n;(n=document.getElementById("videoCall"))==null||n.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx($e,{})}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(ve,{className:"colorOne",sx:{height:"100%"},children:e.jsx(we,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var n;(n=document.getElementById("audioCall"))==null||n.click()},children:e.jsxs(pe,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(_e,{})}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Oe[T],onChange:Z,value:C,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:qe[T]})]})}const be=({initiateContinuing:l,user:t,userObj:r,handleMessagesList:C,displayedName:w,handleChatUid:$,handleChatDisplayName:E})=>{const{state:j}=Me(),U=(j==null?void 0:j.conversation)||"piazza",f=se(N=>N.languages.value),[V,v]=c.useState("");return c.useEffect(()=>{t&&((t==null?void 0:t.uid)<r.uid?v((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):v(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(he,{element:t,uid:r.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==w&&e.jsx("div",{children:f==="ko"?e.jsxs("div",{children:["(",w,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",w,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(Ce,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(Q,{variant:"outlined",onClick:()=>{},children:f==="ko"?"프로필 확인":"Check Profile"})}),U==="piazza"&&r.uid!==(t==null?void 0:t.uid)&&e.jsx(Ce,{to:`${location.pathname}?id=${V}`,state:{conversation:V,displayName:t==null?void 0:t.displayName,userUid:r.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(pe,{children:e.jsx(Q,{variant:"outlined",onClick:()=>{C([]),l()},children:f==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Pe({userObj:l,messagesList:t,handleMessagesList:r,handleChatUid:C,handleChatDisplayName:w}){const $=c.useRef(null),E=c.useRef(null),[j,U]=c.useState(null),[f,V]=c.useState(""),[v,N]=c.useState(!1),[T,b]=c.useState(null),[Z,F]=c.useState(0),[D,L]=c.useState("piazza"),n=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";c.useEffect(()=>{(D!==n||n==="piazza")&&(r([]),b(null),F(0),L(n))},[n]);const S=se(o=>o.languages.value),M=async({userUid:o,displayName:h})=>{const p=Y(R,`members/${o}`),i=(await O(p)).data();U(i),V(h),console.log("practice")},u=({userUid:o,displayName:h})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),M({userUid:o,displayName:h})},y=20;c.useEffect(()=>{if(!g)return;function o(h){const{msg:p,userUid:a,id:i,target:x,messageClock:m,messageClockNumber:s,profileImageUrl:d,defaultProfile:z,profileImage:I,conversation:B}=h;r(A=>[...A,{msg:p,type:x?"private":"other",userUid:a,id:i,messageClock:m,messageClockNumber:s,conversation:null,profileImageUrl:d,defaultProfile:z,profileImage:I}])}return g.on("sMessagePiazza",o),()=>{g.off("sMessagePiazza",o)}},[]),c.useEffect(()=>{if(!g)return;function o(h){const{msg:p,userUid:a,id:i,target:x,messageClock:m,messageClockNumber:s,conversation:d,profileImageUrl:z,defaultProfile:I,profileImage:B,piazzaData:A}=h;r(q=>[...q,{msg:p,type:x?"private":"other",userUid:a,id:i,messageClock:m,messageClockNumber:s,conversation:null,profileImageUrl:z,defaultProfile:I,profileImage:B,...A}])}return g.on(`sMessage${n}`,o),()=>{g.off(`sMessage${n}`,o)}},[n]),c.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),c.useEffect(()=>{k(),(async()=>{if(n==="piazza"){const h=oe(R,"chats_group"),p=de(h,ge("messageClockNumber","desc"),fe(1));(await me(p)).forEach(async i=>{const x=Y(R,`chats_group/${i.id}`),s=(await O(x)).data(),d=s.piazzaChecked||[];d.indexOf(l.uid)===-1&&(d.splice(-1,l.uid,0),d.push(l.uid),await te(x,{...s,piazzaChecked:d}))})}else{const h=Y(R,`members/${l.uid}`),a=(await O(h)).data().chattings;a[n]&&(a[n].messageCount=0),await te(h,{chattings:a})}})()},[t]);const k=()=>{var o;(o=$.current)==null||o.scrollIntoView()};c.useEffect(()=>{const o=async()=>{const p=[],a=oe(R,"chats_group"),i=de(a,ge("messageClockNumber","desc"),fe(y),ze(T||"")),x=await me(i);x.docs.length||F(x.docs.length),x.forEach(m=>{var K,H,G;p.length===x.docs.length-1&&(b(m),F(x.docs.length-1));const s=m.data().message,d=m.data().userUid,z=m.data().userName,I=m.data().messageClock,B=m.data().messageClockNumber,A=(K=m.data())==null?void 0:K.profileImageUrl,q=(H=m.data())==null?void 0:H.defaultProfile,X=(G=m.data())==null?void 0:G.profileImage,J=m.data();p.push({msg:s,userUid:d,id:z,messageClockNumber:B,messageClock:I,conversation:null,profileImageUrl:A,defaultProfile:q,profileImage:X||!1,...J})}),p.reverse(),r([...p,...t]),N(!1)},h=async p=>{const a=oe(R,`chats_${p}`),i=de(a,ge("messageClockNumber","desc"),fe(y),ze(T||"")),x=await me(i),m=[];x.docs.length||F(x.docs.length),x.forEach((s,d)=>{var re,ee,ce;m.length===x.docs.length-1&&(b(s),F(x.docs.length-1));const z=s.data().message,I=s.data().userUid,B=s.data().userName,A=s.data().messageClock,q=s.data().messageClockNumber||0,X=(re=s.data())==null?void 0:re.profileImageUrl,J=(ee=s.data())==null?void 0:ee.defaultProfile,K=(ce=s.data())==null?void 0:ce.profileImage,H=s.data(),G=s.data().userOne,ae=s.data().userOneDisplayName,ne=s.data().userTwo,ie=s.data().userTwoDisplayName;G!==l.uid?(C(G),w(ae)):(C(ne),w(ie)),m.push({msg:z,userUid:I,id:B,messageClockNumber:q,messageClock:A,conversation:null,profileImageUrl:X,defaultProfile:J,profileImage:K||!1,...H})}),m.reverse(),r([...m,...t]),N(!1)};console.log(t.length),n==="piazza"?(v||!t.length)&&o():(v||!t.length)&&h(n)},[v,D]);const P=()=>{E.current.scrollTop!==0||v||(console.log("scroll"),N(!0))};return c.useEffect(()=>{var o;return(o=E.current)==null||o.addEventListener("scroll",P),()=>{var h;return(h=E.current)==null?void 0:h.removeEventListener("scroll",P)}},[v]),console.log(n),console.log(t),console.log(j),e.jsx(e.Fragment,{children:e.jsx("div",{ref:E,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[v&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((o,h)=>{let p;n==="piazza"?p=o:o.userUid===o.userOne?p={userUid:o.userOne,id:o.userOneDisplayName,profileImage:o.userOneProfileImage||o.profileImage,defaultProfile:o.userOneDefaultProfile||o.defaultProfile,profileImageUrl:o.userOneProfileUrl||o.profileImageUrl}:p={userUid:o.userTwo,id:o.userTwoDisplayName,profileImage:o.userTwoProfileImage||o.profileImage,defaultProfile:o.userTwoDefaultProfile||o.defaultProfile,profileImageUrl:o.userTwoProfileUrl||o.profileImageUrl};let a;const i=new Date(o.messageClock);o.userUid===l.uid?a="text-right":a="text-left";let x,m;h>0&&(x=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===l.uid&&(m=new Date(t[h+1].messageClock),i.getFullYear()===m.getFullYear()&&i.getMonth()===m.getMonth()&&i.getDate()===m.getDate()&&i.getHours()===m.getHours()&&(i.getMinutes(),m.getMinutes()));let s,d=i.getHours(),z=(i.getMonth()+1).toString(),I=i.getDate().toString();return d>=13?(s="오후",d!==12&&(d=d-12)):(s="오전",d===0&&(d=d+12)),i.getMonth()+1<10&&(z="0"+z),I.length===1&&(I="0"+I),e.jsxs("li",{ref:h===Z?$:null,className:a,children:[x!==o.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${o.userUid!==l.uid?"start":"end"}`,children:a==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(ue,{trigger:e.jsx(he,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>b(null),user:j,userObj:l,handleMessagesList:r,displayedName:f})}),e.jsx("div",{children:o.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:o.id}),e.jsx(ue,{trigger:e.jsx(he,{element:p,piazza:()=>u({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ke,{}),content:e.jsx(be,{initiateContinuing:()=>b(null),user:j,userObj:l,handleMessagesList:r,displayedName:f,handleChatUid:C,handleChatDisplayName:w})})]})})}),o.userUid!==l.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg}),e.jsxs("div",{children:[i.getFullYear(),"-",z,"-",I," ",S==="ko"&&s," ",d,":",i.getMinutes()<10&&"0",i.getMinutes(),S==="en"&&(s==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[i.getFullYear(),"-",z,"-",I," ",S==="ko"&&s," ",d,":",i.getMinutes()<10&&"0",i.getMinutes(),S==="en"&&(s==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:o.msg})]})]},h)}),e.jsx("li",{ref:$})]})})})}function Ke({isKeyboardOpen:l,userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$}){return e.jsx(e.Fragment,{children:l?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Pe,{userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Pe,{userObj:t,messagesList:r,handleMessagesList:C,handleChatUid:w,handleChatDisplayName:$})})})}const We=Ae(Fe)(({theme:l})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(l.palette.getContrastText(l.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function Ze(){const l=se(w=>w.languages.value),t=le(w=>w.piazzaSwitch.value),r=xe(),C=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),r(Se("false"))):(window.localStorage.setItem("piazza","true"),r(Se("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:l==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(We,{onClick:()=>C(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const Ee={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Xe=({displayName:l})=>{const t=se(w=>w.languages.value),r=t==="ko"||t==="en"?t:"ko",C=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Be,{icon:e.jsx(Le,{}),title:C==="piazza"?Ee[r][0]:`${Ee[r][1]} ${l}`}),C==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(Ze,{})})]})};function Je(){const[l,t]=c.useState([]),[r,C]=c.useState(!0),[w,$]=c.useState(!0),[E,j]=c.useState(""),[U,f]=c.useState(null),[V,v]=c.useState(null),N=Te(),T=c.useRef(null),b=c.useRef(null),Z={audio:!0,video:!1},F=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],D=new RTCPeerConnection({iceServers:[{urls:F.map(s=>s.urls)}]}),L=location.search.slice(4);console.log(location.search.slice(4)),c.useEffect(()=>{(async()=>{await u()})()},[]),c.useEffect(()=>{T.current&&(T.current.srcObject=U)},[U]);async function n(){const s=U;s&&s.getAudioTracks().forEach(d=>d.enabled=!d.enabled),C(!r)}async function S(){const s=U;s&&s.getVideoTracks().forEach(d=>d.enabled=!d.enabled),$(!w)}const M=()=>{T.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(T.current)};c.useEffect(()=>{V&&y(V)},[V]);async function u(){try{const d=(await navigator.mediaDevices.enumerateDevices()).filter(z=>z.kind==="videoinput");t(d)}catch(s){console.log(s)}}async function y(s){try{const z=s?{audio:!0,video:{deviceId:{exact:s}}}:Z,I=await navigator.mediaDevices.getUserMedia(z);f(I),j("")}catch(d){const z=d==null?void 0:d.toString();z&&j(z),console.log(d)}}function k(s){console.log("icecandidate"),console.log(s),g.emit("ice",s.candidate,L)}function P(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",U),b.current=s.stream}function o(){D.addEventListener("icecandidate",k),D.addEventListener("addstream",P),U&&U.getTracks().forEach(s=>D.addTrack(s,U))}async function h(){await y(null),o()}async function p(){await h(),g.emit("joinRoom",L,h)}c.useEffect(()=>{p()},[]);const a=async()=>{console.log("sent the offer"),console.log(D);const s=await D.createOffer();D.setLocalDescription(s),console.log(s),g.emit("offer",s,L)};c.useEffect(()=>{if(g)return g.on("welcome",a),()=>{g.off("welcome",a)}});const i=async s=>{console.log("received the offer"),D.setRemoteDescription(s);const d=await D.createAnswer();console.log("sent the answer"),D.setLocalDescription(d),g.emit("answer",d,L)};c.useEffect(()=>{if(g)return g.on("offer",i),()=>{g.off("offer",i)}});const x=s=>{console.log("received the answer"),D.setRemoteDescription(s)};c.useEffect(()=>{if(g)return g.on("answer",x),()=>{g.off("answer",x)}});const m=s=>{console.log("received candidate"),D.addIceCandidate(s)};return c.useEffect(()=>{if(g)return g.on("ice",m),()=>{g.off("ice",m)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!N&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:b,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:T,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:n,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:S,children:w?"turn stream on":"turn stream off"}),e.jsx(Q,{onClick:M,children:"stop"})]})}),E&&e.jsx("div",{children:E})]})}let W,_;function Qe(){const[l,t]=c.useState([]),[r,C]=c.useState(!0),[w,$]=c.useState(!0),[E,j]=c.useState(""),[U,f]=c.useState(null);c.useState(null);const V=Te(),v=document.getElementById("myScreen"),N=document.getElementById("devices"),T={audio:!0,video:!0},b=location.search.slice(4);console.log(location.search.slice(4));async function Z(){const a=W;a&&a.getAudioTracks().forEach(i=>i.enabled=!i.enabled),C(!r)}async function F(){const a=W;a&&a.getVideoTracks().forEach(i=>i.enabled=!i.enabled),$(!w)}async function D(){console.log(N.value),W.getTracks().forEach(i=>i.stop()),f(N.value),await n(N.value)}c.useEffect(()=>{n(U)},[N]);async function L(){try{const i=(await navigator.mediaDevices.enumerateDevices()).filter(x=>x.kind==="videoinput");t(i)}catch(a){console.log(a)}}async function n(a){try{const x=a?{audio:!0,video:{deviceId:{exact:a}}}:T;W=await navigator.mediaDevices.getUserMedia(x);const m=await navigator.mediaDevices.enumerateDevices();v.srcObject=W,await L(),j("")}catch(i){console.log(i),j(i)}}function S(a){console.log("icecandidate"),console.log(a),g.emit("ice",a.candidate,b)}function M(a){console.log("got a stream from peer"),console.log("Peer Stream",a.stream),console.log("My Stream",W);const i=document.getElementById("yourScreen");i.srcObject=a.stream}function u(){_=new RTCPeerConnection,_.addEventListener("icecandidate",S),_.addEventListener("addstream",M),W&&W.getTracks().forEach(a=>_.addTrack(a,W))}async function y(){await n(null),u()}async function k(){await y(),g.emit("joinRoom",b,y)}c.useEffect(()=>{k()},[]);const P=async()=>{console.log("sent the offer"),console.log(_);const a=await _.createOffer();_.setLocalDescription(a),console.log(a),g.emit("offer",a,b)};c.useEffect(()=>{if(g)return g.on("welcome",P),()=>{g.off("welcome",P)}});const o=async a=>{console.log("received the offer"),_.setRemoteDescription(a);const i=await _.createAnswer();console.log("sent the answer"),_.setLocalDescription(i),g.emit("answer",i,b)};c.useEffect(()=>{if(g)return g.on("offer",o),()=>{g.off("offer",o)}});const h=a=>{console.log("received the answer"),_.setRemoteDescription(a)};c.useEffect(()=>{if(g)return g.on("answer",h),()=>{g.off("answer",h)}});const p=a=>{console.log("received candidate"),_.addIceCandidate(a)};return c.useEffect(()=>{if(g)return g.on("ice",p),()=>{g.off("ice",p)}}),e.jsxs("div",{id:"myStream",children:[e.jsxs("div",{className:`flex ${!V&&"flex-col"} gap-1`,children:[e.jsx("video",{id:"myScreen",width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0}),e.jsx("video",{id:"yourScreen",width:"320",height:"240",controls:!0,autoPlay:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(Q,{onClick:Z,children:r?"unmute":"mute"}),e.jsx(Q,{onClick:F,children:w?"turn stream on":"turn stream off"})]}),e.jsx("select",{id:"devices",onChange:D,children:l.map((a,i)=>e.jsx("option",{value:a.deviceId,children:a.label},i))})]}),E&&e.jsx("div",{children:E.toString()})]})}function tt({userObj:l}){const[t,r]=c.useState(""),[C,w]=c.useState([]),$=xe(),{state:E}=Me(),[j,U]=c.useState(!1),[f,V]=c.useState(null),[v,N]=c.useState(""),[T,b]=c.useState(""),[Z,F]=c.useState(""),D=u=>{N(u)},L=u=>{b(u)},n=location.search.slice(location.search.indexOf("=")+1);console.log(f),console.log(v),c.useEffect(()=>{E?(N(E.chattingUid),b(E.displayName)):(N(""),b(""))},[n]),c.useEffect(()=>{n&&(async()=>{if(v){const y=Y(R,`members/${v}`),k=await O(y);V(k.data())}})()},[n,v]);const S=le(u=>u.piazzaForm.value);c.useEffect(()=>{var y;const u=()=>{var P;const k=window.screen.height-300>(((P=window.visualViewport)==null?void 0:P.height)||window.screen.height);j!==k&&U(k)};return window.addEventListener("resize",u),typeof visualViewport<"u"&&((y=window.visualViewport)==null||y.addEventListener("resize",u)),visualViewport==null||visualViewport.addEventListener("resize",u),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",u)),()=>{var k;typeof visualViewport<"u"&&((k=window.visualViewport)==null||k.removeEventListener("resize",u))}},[j]);const M=()=>{var u;F(""),(u=document.getElementById("myScreen"))==null||u.srcObject.getTracks().forEach(y=>y.stop())};return c.useEffect(()=>{$(He(5))}),e.jsxs(e.Fragment,{children:[!j&&e.jsx(Xe,{multiple:!n,displayName:T}),e.jsx(Ke,{isKeyboardOpen:S,userObj:l,messagesList:C,handleMessagesList:u=>w(u),handleChatUid:D,handleChatDisplayName:L}),e.jsx(Ge,{chattingUser:f,userObj:l,multiple:!n,messages:t,handleMessages:u=>r(u),messagesList:C,handleMessagesList:u=>w(u)}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Qe,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:M,children:"전화 종료"})})]})})]}),e.jsxs(je,{children:[e.jsx(Ne,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(De,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ie,{children:e.jsx("div",{onClick:M,children:"전화 종료"})})]})})]})]})}export{tt as default};
