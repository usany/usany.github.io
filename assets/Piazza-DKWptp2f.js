import{r as f,j as s,ay as ga,aA as fa,aN as J,ax as pa,O as Z,ad as B,v as ha,bk as xa,M as A,a3 as W,bl as q,aU as Na,N as u,aL as wa,Q as I,S as C,U as L,aK as K,Z as E,$ as Q,a0 as Y,a1 as G,ac as R,bm as ya}from"./index-eG1w-DuV.js";const ua=({multiple:t,selectUser:x,user:a,handleClose:N,userObj:l,handleMsgList:w,handleChangeMessage:$,displayedName:S})=>{const[b,P]=f.useState(null);return f.useEffect(()=>{x&&((a==null?void 0:a.uid)<l.uid?P((a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])+l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]):P(l.uid[0]+l.uid[1]+l.uid[2]+l.uid[3]+l.uid[4]+l.uid[5]+(a==null?void 0:a.uid[0])+(a==null?void 0:a.uid[1])+(a==null?void 0:a.uid[2])+(a==null?void 0:a.uid[3])+(a==null?void 0:a.uid[4])+(a==null?void 0:a.uid[5])))},[x]),s.jsxs(ga,{open:x,onClose:N,children:[s.jsxs(fa,{children:[s.jsx("div",{children:s.jsx(J,{alt:a==null?void 0:a.displayName,sx:{bgcolor:(a==null?void 0:a.profileColor)||"#2196f3"},src:(a==null?void 0:a.profileImageUrl)||"./src",variant:"rounded"})}),s.jsx("div",{children:a==null?void 0:a.displayName}),(a==null?void 0:a.displayName)!==S&&s.jsxs("div",{children:["(",S,"에서 개명)"]})]}),s.jsxs(pa,{children:[s.jsx(Z,{to:"/profile",state:{element:a},children:s.jsx(B,{variant:"outlined",onClick:()=>{N()},children:"프로필 확인"})}),t&&l.uid!==(a==null?void 0:a.uid)&&s.jsx(Z,{to:"/piazza",state:{conversation:b,displayName:a==null?void 0:a.displayName,userUid:l.uid,chattingUid:a==null?void 0:a.uid,multiple:!1,profileUrl:a==null?void 0:a.profileImageUrl},children:s.jsx(B,{variant:"outlined",onClick:()=>{w([]),$(!0),N()},children:"개인 대화"})}),s.jsx(B,{variant:"outlined",onClick:()=>{N()},children:"닫기"})]})]})},Ca=ha(xa)(({theme:t})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(t.palette.getContrastText(t.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function va(){const t=A(N=>N.piazzaSwitch.value),x=W(),a=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),x(q("false"))):(window.localStorage.setItem("piazza","true"),x(q("true")))};return s.jsxs("div",{className:"flex flex-col",children:[s.jsx("div",{className:"text-sm",children:"단체 대화 알림 받기"}),s.jsx("div",{className:"flex justify-end",children:s.jsx(Ca,{onClick:()=>a(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}function ka({userObj:t}){const x=f.useRef(null),[a,N]=f.useState(""),[l,w]=f.useState([]),[$,S]=f.useState(!0),[b,P]=f.useState(""),[X,O]=f.useState(null),[aa,_]=f.useState(!1),T=A(e=>e.profileColor.value),k=A(e=>e.profileUrl.value),[ea,sa]=f.useState(null),H=W(),{state:n}=Na(),M=n==null?void 0:n.multiple,p=n==null?void 0:n.conversation;f.useEffect(()=>{if(!u)return;function e(c){const{msg:o,userUid:g,id:d,target:r,messageClock:i,messageClockNumber:m,conversation:y}=c;w(h=>[...h,{msg:o,type:r?"private":"other",userUid:g,id:d,messageClock:i,messageClockNumber:m,conversation:null,profileImageUrl:k,profileColor:T}])}return u.on("sMessagePiazza",e),()=>{u.off("sMessagePiazza",e)}},[]),f.useEffect(()=>{if(!u)return;function e(c){const{msg:o,userUid:g,id:d,target:r,messageClock:i,messageClockNumber:m,conversation:y}=c;w(h=>[...h,{msg:o,type:r?"private":"other",userUid:g,id:d,messageClock:i,messageClockNumber:m,conversation:null}])}return u.on(`sMessage${p}`,e),()=>{u.off(`sMessage${p}`,e)}},[]),f.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),f.useEffect(()=>{ta()},[l]),f.useEffect(()=>{H(wa(5))});const ta=()=>{var e;(e=x.current)==null||e.scrollIntoView()},ia=e=>{e.preventDefault();const c=a,o=t.uid,g=t.displayName,d=Date.now(),r=new Date().toString(),i={msg:c,userUid:o,id:g,messageClockNumber:d,messageClock:r,target:b,conversation:null};M?i&&c&&(u.emit("message",i),la()):c&&(l.length!==0?(u.emit("message",i),console.log("message")):(u.emit("messageNew",i),console.log("messageNew")),da(),ma()),N("")},oa=e=>{N(e.target.value)},na=async({userUid:e,displayName:c})=>{const o=I(C,`members/${e}`),d=(await L(o)).data();O(d),_(!0),sa(c)},ca=()=>{_(!1)},la=async()=>{try{const e=a,c=t.uid,o=t.displayName,g=new Date().toString(),d=Date.now();e&&(await K(E(C,"chats_group"),{userUid:c,userName:o,message:e,messageClock:g,messageClockNumber:d,profileImageUrl:k,profileColor:T}),w(r=>[...r,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:g,conversation:null,profileImageUrl:k,profileColor:T}]))}catch(e){console.log(e)}};f.useEffect(()=>{$&&(M?((async()=>{const o=[],g=E(C,"chats_group"),d=Q(g,Y("messageClockNumber"));(await G(d)).forEach(i=>{var j,z;const m=i.data().message,y=i.data().userUid,h=i.data().userName,v=i.data().messageClock,U=i.data().messageClockNumber,D=(j=i.data())==null?void 0:j.profileColor,F=(z=i.data())==null?void 0:z.profileImageUrl;o.push({msg:m,type:"me",userUid:y,id:h,messageClockNumber:U,messageClock:v,conversation:null,profileColor:D,profileImageUrl:F}),w(o)})})(),S(!1)):((async o=>{const g=E(C,`chats_${o}`),d=Q(g,Y("messageClockNumber")),r=await G(d),i=[];r.forEach(m=>{const y=m.data().message,h=m.data().userUid,v=m.data().userName,U=m.data().messageClock,D=m.data().messageClockNumber||0;i.push({msg:y,type:"me",userUid:h,id:v,messageClock:U,messageClockNumber:D}),w(i)})})(p),S(!1)))},[$]);const da=async()=>{const e=a;try{const c=t.uid,o=t.displayName,g=Date.now(),d=new Date().toString();let r,i,m,y,h,v;if(n.userUid<n.chattingUid?(r=n.userUid,i=n.chattingUid,m=t.displayName,y=n.displayName,h=k,v=n.profileUrl):(r=n.chattingUid,i=n.userUid,m=n.displayName,y=t.displayName,h=n.profileUrl,v=k),console.log(n),console.log(k),e){const U={userUid:c,userName:o,message:e,messageClock:d,messageClockNumber:g,userOne:r,userTwo:i,userOneDisplayName:m,userTwoDisplayName:y,userOneProfileUrl:h,userTwoProfileUrl:v};await K(E(C,`chats_${p}`),U);const D=I(C,`members/${c}`),j=(await L(D)).data().chattings||{},z=I(C,`members/${n.chattingUid}`),V=(await L(z)).data().chattings||{};j[p]=U,V[p]=U,await R(D,{chattings:j}),await R(z,{chattings:V}),w(ra=>[...ra,{msg:e,type:"me",userUid:t.uid,id:t.displayName,messageClock:d,conversation:p}])}}catch(c){console.log(c)}},ma=async()=>{try{const e=t.uid,c=n.chattingUid,o=I(C,`members/${e}`),d=(await L(o)).data().conversation||[],r=I(C,`members/${c}`),m=(await L(r)).data().conversation||[];d.indexOf(p)===-1&&(await R(o,{conversation:[...d,p]}),H(ya())),m.indexOf(p)===-1&&await R(r,{conversation:[...m,p]})}catch(e){console.log(e)}};return s.jsxs("div",{children:[s.jsxs("div",{className:"flex text-2xl p-5",children:[s.jsx("div",{className:"w-screen",children:M?"단체 대화":`개인 대화 ${n==null?void 0:n.displayName}`}),M&&s.jsx("div",{className:"flex w-2/3 pt-1 justify-end",children:s.jsx(va,{})})]}),s.jsx("div",{className:"app-container",children:s.jsxs("div",{className:"wrap",children:[s.jsxs("div",{className:"chat-box",children:[s.jsxs("ul",{className:"chat",children:[l.map((e,c)=>{if(e.type==="welcome")return s.jsxs("li",{className:"welcome",children:[s.jsx("div",{className:"line"}),s.jsx("div",{children:e.msg}),s.jsx("div",{className:"line"})]});{let o;return e.userUid===t.uid?o="me":o="other",s.jsxs("li",{className:o,name:e.id,"data-id":e.id,onClick:()=>na({userUid:e.userUid,displayName:e.id}),children:[s.jsx("div",{className:`flex justify-${e.userUid!==t.uid?"start":"end"}`,children:s.jsx(J,{alt:e.id,sx:{bgcolor:e.profileColor||"#2196f3"},src:e.profileImageUrl||"./src",variant:"rounded"})}),s.jsx("div",{className:e.id===b?"private-user":"userId","data-id":e.id,name:e.id,children:e.id}),e.userUid!==t.uid?s.jsxs("div",{className:"flex justify-start",children:[s.jsx("div",{className:"other","data-id":e.id,name:e.id,children:e.msg}),s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock})]}):s.jsxs("div",{className:"flex justify-end",children:[s.jsx("div",{"data-id":e.id,name:e.id,children:e.messageClock}),s.jsx("div",{className:"me","data-id":e.id,name:e.id,children:e.msg})]})]},`${c}_li`)}}),s.jsx("li",{ref:x})]}),s.jsxs("form",{className:"send-form",onSubmit:ia,children:[s.jsx("input",{placeholder:"메세지를 작성해 주세요",onChange:oa,value:a,autoFocus:!0}),s.jsx("button",{type:"submit",children:"전송"})]})]}),s.jsx(ua,{multiple:M,selectUser:aa,user:X,handleClose:ca,userObj:t,handleMsgList:e=>w(e),handleChangeMessage:e=>S(e),displayedName:ea})]})})]})}export{ka as default};
