import{r as u,c as Z,j as t,J,Q as le,B as ce,aB as ue,u as H,aN as Q,V as T,P as re,aT as de,_ as xe,aU as ve,f as W,g as y,q as te,Z as ae,E as se,h as ie,k as P,W as $,v as Y,aR as ge,L as K,aS as me,aV as we,af as Ce,aW as ke,R as fe,w as Ue,a7 as ye}from"./index-xTOboj-e.js";const pe=({initiateContinuing:s,multiple:k,handleMultiple:x,user:e,userObj:i,handleMessagesList:j,displayedName:m})=>{const[w,U]=u.useState(null),r=Z(p=>p.languages.value);return u.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?U((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):U(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(J,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==m&&t.jsx("div",{children:r==="ko"?t.jsxs("div",{children:["(",m,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",m,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:"/profile",state:{element:e},children:t.jsx(ce,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),k&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:"/piazza",state:{conversation:w,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ue,{children:t.jsx(ce,{variant:"outlined",onClick:()=>{j([]),x(!1),s()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ne({userObj:s,multiple:k,handleMultiple:x,messagesList:e,handleMessagesList:i}){var M;const j=u.useRef(null),m=u.useRef(null),[w,U]=u.useState(null),[r,p]=u.useState(""),[I,L]=u.useState(!1),[_,A]=u.useState(null),[X,V]=u.useState(0),O=H(a=>a.profileColor.value),f=H(a=>a.profileUrl.value),{state:N}=Q(),C=N==null?void 0:N.conversation,S=Z(a=>a.languages.value),D=async({userUid:a,displayName:l})=>{const c=P(y,`members/${a}`),h=(await $(c)).data();U(h),p(l)},b=({userUid:a,displayName:l})=>{var c;(c=document.getElementById("drawer"))==null||c.click(),D({userUid:a,displayName:l})},F=10;u.useEffect(()=>{if(!T)return;function a(l){const{msg:c,userUid:n,id:h,target:o,messageClock:d,messageClockNumber:g,conversation:v}=l;i(z=>[...z,{msg:c,type:o?"private":"other",userUid:n,id:h,messageClock:d,messageClockNumber:g,conversation:null,profileImageUrl:f,profileColor:O}])}return T.on("sMessagePiazza",a),()=>{T.off("sMessagePiazza",a)}},[]),u.useEffect(()=>{if(!T)return;function a(l){const{msg:c,userUid:n,id:h,target:o,messageClock:d,messageClockNumber:g,conversation:v}=l;i(z=>[...z,{msg:c,type:o?"private":"other",userUid:n,id:h,messageClock:d,messageClockNumber:g,conversation:null}])}return T.on(`sMessage${C}`,a),()=>{T.off(`sMessage${C}`,a)}},[]),u.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),u.useEffect(()=>{R(),(async()=>{if(k){const l=W(y,"chats_group"),c=te(l,se("messageClockNumber","desc"),ae(1));(await ie(c)).forEach(async h=>{const o=P(y,`chats_group/${h.id}`),g=(await $(o)).data(),v=g.piazzaChecked||[];v.indexOf(s.uid)===-1&&(v.splice(-1,s.uid,0),v.push(s.uid),await Y(o,{...g,piazzaChecked:v}))})}else{const l=P(y,`members/${s.uid}`),n=(await $(l)).data().chattings;n[C].messageCount=0,await Y(l,{chattings:n})}})()},[e]);const R=()=>{var a;(a=j.current)==null||a.scrollIntoView()};u.useEffect(()=>{const a=async()=>{const c=[],n=W(y,"chats_group"),h=te(n,se("messageClockNumber","desc"),ae(F),ge(_||"")),o=await ie(h);o.docs.length||V(o.docs.length),o.forEach(d=>{var ne,oe;c.length===o.docs.length-1&&(A(d),V(o.docs.length-1));const g=d.data().message,v=d.data().userUid,z=d.data().userName,B=d.data().messageClock,q=d.data().messageClockNumber,G=(ne=d.data())==null?void 0:ne.profileColor,ee=(oe=d.data())==null?void 0:oe.profileImageUrl;c.push({msg:g,type:"me",userUid:v,id:z,messageClockNumber:q,messageClock:B,conversation:null,profileColor:G,profileImageUrl:ee})}),c.reverse(),i([...c,...e]),L(!1)},l=async c=>{const n=W(y,`chats_${c}`),h=te(n,se("messageClockNumber","desc"),ae(F),ge(_||"")),o=await ie(h),d=[];o.docs.length||V(o.docs.length),o.forEach((g,v)=>{d.length===o.docs.length-1&&(A(g),V(o.docs.length-1));const z=g.data().message,B=g.data().userUid,q=g.data().userName,G=g.data().messageClock,ee=g.data().messageClockNumber||0;d.push({msg:z,type:"me",userUid:B,id:q,messageClock:G,messageClockNumber:ee})}),d.reverse(),i([...d,...e]),L(!1)};C?(I||!e.length)&&l(C):(I||!e.length)&&a()},[I,C]);const E=()=>{m.current.scrollTop!==0||I||(console.log("scroll"),L(!0))};return u.useEffect(()=>{var a;return(a=m.current)==null||a.addEventListener("scroll",E),()=>{var l;return(l=m.current)==null?void 0:l.removeEventListener("scroll",E)}},[I]),console.log(e),t.jsx(t.Fragment,{children:t.jsx("div",{className:"flex flex-col pt-5",children:t.jsx("div",{ref:m,className:"p-1 border-t rounded-xl h-[60vh] overflow-auto",children:t.jsxs("ul",{children:[I&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((a,l)=>{let c;const n=new Date(a.messageClock);a.userUid===s.uid?c="text-right":c="text-left";let h,o;l>0&&(h=e[l-1].userUid),l<e.length-1&&e[l+1].userUid===s.uid&&(o=new Date(e[l+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let d,g=n.getHours(),v=(n.getMonth()+1).toString(),z=n.getDate().toString();return g>=13?(d="오후",g!==12&&(g=g-12)):(d="오전",g===0&&(g=g+12)),n.getMonth()+1<10&&(v="0"+v),z.length===1&&(z="0"+z),t.jsxs("li",{ref:l===X?j:null,className:c,children:[h!==a.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${a.userUid!==s.uid?"start":"end"}`,children:c==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(re,{trigger:t.jsx(J,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>b({userUid:a.userUid,displayName:a.id})}),title:t.jsx(de,{}),content:t.jsx(pe,{initiateContinuing:()=>A(null),multiple:k,handleMultiple:x,user:w,userObj:s,handleMessagesList:i,displayedName:r})}),t.jsx("div",{children:a.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:a.id}),t.jsx(re,{trigger:t.jsx(J,{uid:s.uid,profile:!1,profileColor:"",profileUrl:a==null?void 0:a.profileImageUrl,piazza:()=>b({userUid:a.userUid,displayName:a.id})}),title:t.jsx(de,{}),content:t.jsx(pe,{initiateContinuing:()=>A(null),multiple:k,handleMultiple:x,user:w,userObj:s,handleMessagesList:i,displayedName:r})})]})})}),a.userUid!==s.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",z," ",S==="ko"&&d," ",g,":",n.getMinutes()<10&&"0",n.getMinutes(),S==="en"&&(d==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",z," ",S==="ko"&&d," ",g,":",n.getMinutes()<10&&"0",n.getMinutes(),S==="en"&&(d==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:a.msg})]})]},l)}),t.jsxs(xe,{mapId:"77db85c9c2270baa",defaultCenter:{lat:59.9156636,lng:10.7507967},defaultZoom:17,gestureHandling:"greedy",disableDefaultUI:!0,style:{width:"20vw",height:"20vh",border:"2px solid blue"},children:["location",t.jsx(ve,{position:{lat:59.9156636,lng:10.7507967},children:t.jsx(J,{uid:s.uid,profile:!1,profileColor:"",profileUrl:(M=e[0])==null?void 0:M.profileImageUrl})})]}),t.jsx("li",{ref:j})]})})})})}const ze={ko:"메세지를 작성해 주세요",en:"Input message"},Se={ko:"전송",en:"send"};function De({userObj:s,multiple:k,messages:x,handleMessages:e,messagesList:i,handleMessagesList:j}){const m=H(f=>f.profileColor.value),w=H(f=>f.profileUrl.value),U=K(),{state:r}=Q(),p=r==null?void 0:r.conversation,I=Z(f=>f.languages.value),L=I==="ko"||I==="en"?I:"ko",_=async f=>{var a;f.preventDefault();const N=x,C=s.uid,S=s.displayName,D=Date.now(),b=new Date().toString();let F,R,E;r.chattingUid&&(F=P(y,`members/${r.chattingUid}`),R=await $(F),E=(a=R.data())==null?void 0:a.messagingToken);const M={msg:N,userUid:C,id:S,messageClockNumber:D,messageClock:b,conversation:p,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:w,sendingToken:E};k?M&&N&&(T.emit("piazzaMessage",M),X()):N&&(i.length!==0?(T.emit("message",M),console.log("message")):(T.emit("messageNew",M),console.log("messageNew")),V(),O()),e("")},A=f=>{e(f.target.value)},X=async()=>{try{const f=x,N=s.uid,C=s.displayName,S=new Date().toString(),D=Date.now();f&&(await me(W(y,"chats_group"),{userUid:N,userName:C,message:f,messageClock:S,messageClockNumber:D,profileImageUrl:w,profileColor:m,piazzaChecked:[s.uid]}),j(b=>[...b,{msg:f,type:"me",userUid:s.uid,id:s.displayName,messageClock:S,conversation:null,profileImageUrl:w,profileColor:m}]))}catch(f){console.log(f)}},V=async()=>{var N,C,S;const f=x;try{const D=s.uid,b=s.displayName,F=Date.now(),R=new Date().toString();let E,M,a,l,c,n;if(r.userUid<r.chattingUid?(E=r.userUid,M=r.chattingUid,a=s.displayName,l=r.displayName,c=w,n=r.profileUrl):(E=r.chattingUid,M=r.userUid,a=r.displayName,l=s.displayName,c=r.profileUrl,n=w),!c){const h=P(y,`members/${E}`);c=(N=(await $(h)).data())==null?void 0:N.profileImageUrl}if(!n){const h=P(y,`members/${M}`);n=(C=(await $(h)).data())==null?void 0:C.profileImageUrl}if(f){const h={userUid:D,userName:b,message:f,messageClock:R,messageClockNumber:F,userOne:E,userTwo:M,userOneDisplayName:a,userTwoDisplayName:l,userOneProfileUrl:c,userTwoProfileUrl:n};await me(W(y,`chats_${p}`),h);const o=P(y,`members/${D}`),g=(await $(o)).data().chattings||{},v=P(y,`members/${r.chattingUid}`),B=(await $(v)).data().chattings||{},q=((S=B[p])==null?void 0:S.messageCount)||0;g[p]=h,B[p]={...h,messageCount:q+1},await Y(o,{chattings:g}),await Y(v,{chattings:B}),j(G=>[...G,{msg:f,type:"me",userUid:s.uid,id:s.displayName,messageClock:R,conversation:p}])}}catch(D){console.log(D)}},O=async()=>{try{const f=s.uid,N=r.chattingUid,C=P(y,`members/${f}`),D=(await $(C)).data().conversation||[],b=P(y,`members/${N}`),R=(await $(b)).data().conversation||[];D.indexOf(p)===-1&&(await Y(C,{conversation:[...D,p]}),U(we())),R.indexOf(p)===-1&&await Y(b,{conversation:[...R,p]})}catch(f){console.log(f)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"flex gap-px",onSubmit:_,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:ze[L],onChange:A,value:x,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Se[L]})]})})}const Me=Ce(ke)(({theme:s})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(s.palette.getContrastText(s.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function je(){const s=Z(i=>i.languages.value),k=H(i=>i.piazzaSwitch.value),x=K(),e=()=>{k==="true"?(window.localStorage.setItem("piazza","false"),x(fe("false"))):(window.localStorage.setItem("piazza","true"),x(fe("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:s==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Me,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:k==="true"})})]})}const he={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},be=({multiple:s,displayName:k})=>{const x=Z(i=>i.languages.value),e=x==="ko"||x==="en"?x:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(Ue,{title:s?he[e][0]:`${he[e][1]} ${k}`}),s&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(je,{})})]})};function Ie({userObj:s,multiple:k,messages:x,handleMessages:e,messagesList:i,handleMessagesList:j}){H(U=>U.profileColor.value),H(U=>U.profileUrl.value),K();const{state:m}=Q();m==null||m.conversation,Z(U=>U.languages.value);const w=()=>{};return t.jsx(t.Fragment,{children:t.jsx("div",{className:"rounded bg-light-1 dark:bg-dark-1 border w-[10vw]",onClick:w,children:"위치 알리기"})})}function Ee({userObj:s}){const[k,x]=u.useState(""),[e,i]=u.useState([]),j=K(),{state:m}=Q(),[w,U]=u.useState(!0);u.useEffect(()=>{(m==null?void 0:m.multiple)!==void 0&&U(m==null?void 0:m.multiple)},[]),u.useEffect(()=>{j(ye(5))});const r=m==null?void 0:m.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(be,{multiple:w,displayName:r}),t.jsx(Ne,{userObj:s,multiple:w,handleMultiple:p=>U(p),messagesList:e,handleMessagesList:p=>i(p)}),t.jsx(Ie,{}),t.jsx(De,{userObj:s,multiple:w,messages:k,handleMessages:p=>x(p),messagesList:e,handleMessagesList:p=>i(p)})]})}export{Ee as default};
