import{b3 as Ee,u as ie,c as ee,Q as pe,j as e,P as ge,Y as he,b4 as xe,b2 as ue,aY as Te,w as Y,n as V,J as _,a0 as g,a$ as ve,m as te,D as X,b5 as Re,aW as Pe,r as a,O as me,Z as we,B as J,b6 as ye,q as le,_ as re,$ as de,p as fe,aZ as ke,s as $e,S as Ve,R as Ce,E as Ae,b7 as Fe,aK as Ue,ab as Le,b8 as ze,b9 as Se,ba as je,bb as Ne}from"./index-DpblGWAF.js";/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=Ee("AlarmClockCheck",[["circle",{cx:"12",cy:"13",r:"8",key:"3y4lt7"}],["path",{d:"M5 3 2 6",key:"18tl5t"}],["path",{d:"m22 6-3-3",key:"1opdir"}],["path",{d:"M6.38 18.7 4 21",key:"17xu3x"}],["path",{d:"M17.64 18.67 20 21",key:"kv2oe2"}],["path",{d:"m9 13 2 2 4-4",key:"6343dt"}]]);/**
 * @license lucide-react v0.381.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=Ee("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ye={ko:"메세지를 작성해 주세요",en:"Input message"},_e={ko:"전송",en:"send"};function Oe({chattingUser:c,userObj:t,multiple:r,messages:j,handleMessages:C,messagesList:A,handleMessagesList:E}){const b=ie(i=>i.profileColor.value),y=ie(i=>i.piazzaForm.value),d=ee(i=>i.profile.value),$=pe(),w=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza",M=ee(i=>i.languages.value),D=M==="ko"||M==="en"?M:"ko",T=async i=>{var o;i.preventDefault();const I=j,P=t.uid,m=t.displayName,S=Date.now(),N=new Date().toString(),U=d==null?void 0:d.profileImageUrl,n=d==null?void 0:d.defaultProfile,h=d==null?void 0:d.profileImage;let p,k,u;c&&(p=Y(V,`members/${c.uid}`),k=await _(p),u=(o=k.data())==null?void 0:o.messagingToken);const v=d.profileImage?d.profileImageUrl:d.defaultProfile;console.log(d);const f={msg:I,userUid:P,id:m,messageClockNumber:S,messageClock:N,conversation:w,conversationUid:c==null?void 0:c.uid,conversationName:c==null?void 0:c.displayName,profileImage:h,defaultProfile:n,profileImageUrl:U,profileUrl:v,sendingToken:u};r?f&&I&&(g.emit("piazzaMessage",f),B()):I&&(A.length!==0?(g.emit("message",f),console.log("message")):(g.emit("messageNew",f),console.log("messageNew")),x(),F()),C("")},q=i=>{C(i.target.value)},B=async()=>{try{const i=j,I=t.uid,P=t.displayName,m=new Date().toString(),S=Date.now(),N=d==null?void 0:d.profileImageUrl,U=d==null?void 0:d.defaultProfile,n=d==null?void 0:d.profileImage;i&&(await ve(te(V,"chats_group"),{userUid:I,userName:P,message:i,messageClock:m,messageClockNumber:S,profileImageUrl:N,defaultProfile:U,profileColor:b,piazzaChecked:[t.uid],profileImage:n}),E(h=>[...h,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:m,conversation:null,profileColor:b,messageClockNumber:S,defaultProfile:U,profileImageUrl:N,profileImage:n||!1}]))}catch(i){console.log(i)}},x=async()=>{var I,P,m;const i=j;try{const S=t.uid,N=t.displayName,U=Date.now(),n=new Date().toString(),h=d.profileImage,p=c.profileImage,k=d.profileImageUrl,u=c.profileImageUrl,v=d.defaultProfile,f=c.defaultProfile;let o,s,l,z,R,L,O,W,G,Z;if(t.uid<c.uid?(o=t.uid,s=c.uid,l=t.displayName,z=c.displayName,R=k,L=u,O=v,W=f,G=d.profileImage,Z=c.profileImage):(o=c.uid,s=t.uid,l=c.displayName,z=t.displayName,R=u,L=k,O=f,W=v,G=c.profileImage,Z=d.profileImage),!R){const H=Y(V,`members/${o}`);R=(I=(await _(H)).data())==null?void 0:I.profileImageUrl}if(!L){const H=Y(V,`members/${s}`);L=(P=(await _(H)).data())==null?void 0:P.profileImageUrl}if(i){const H={userUid:S,userName:N,message:i,messageClock:n,messageClockNumber:U,userOne:o,userTwo:s,userOneDisplayName:l,userTwoDisplayName:z,userOneProfileUrl:R,userTwoProfileUrl:L,userOneDefaultProfile:O,userTwoDefaultProfile:W,userOneProfileImage:G,userTwoProfileImage:Z};await ve(te(V,`chats_${w}`),H);const K=Y(V,`members/${S}`),oe=(await _(K)).data().chattings||{},ne=Y(V,`members/${c.uid}`),Q=(await _(ne)).data().chattings||{},ae=((m=Q[w])==null?void 0:m.messageCount)||0;oe[w]=H,Q[w]={...H,messageCount:ae+1},await X(K,{chattings:oe}),await X(ne,{chattings:Q}),E(Me=>[...Me,{msg:i,type:"me",userUid:t.uid,id:t.displayName,messageClock:n,conversation:w,userName:N,messageClockNumber:U,userOne:o,userTwo:s,userOneDisplayName:l,userTwoDisplayName:z,userOneProfileUrl:R,userTwoProfileUrl:L,userOneDefaultProfile:O,userTwoDefaultProfile:W,userOneProfileImage:G,userTwoProfileImage:Z}])}}catch(S){console.log(S)}},F=async()=>{try{const i=t.uid,I=c.uid,P=Y(V,`members/${i}`),S=(await _(P)).data().conversation||[],N=Y(V,`members/${I}`),n=(await _(N)).data().conversation||[];S.indexOf(w)===-1&&(await X(P,{conversation:[...S,w]}),$(Re())),n.indexOf(w)===-1&&await X(N,{conversation:[...n,w]})}catch(i){console.log(i)}};return e.jsxs("form",{className:`fixed w-screen ${y?"bottom-0":"bottom-[60px]"} flex gap-px`,onSubmit:T,children:[w&&w!=="piazza"&&e.jsx(ge,{trigger:e.jsx("div",{className:"flex items-center px-1 h-full rounded bg-light-2 dark:bg-dark-2",children:e.jsx(He,{})}),title:e.jsx("div",{children:"전화 선택"}),content:e.jsxs("div",{className:"flex justify-center gap-5 p-5",children:[e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("videoCall"))==null||i.click()},children:e.jsxs(ue,{children:[e.jsx(Te,{}),e.jsx("div",{children:"화상 전화"})]})})})}),e.jsx(he,{className:"colorOne",sx:{height:"100%"},children:e.jsx(xe,{children:e.jsx("div",{className:"flex flex-col items-center gap-5",onClick:()=>{var i;(i=document.getElementById("audioCall"))==null||i.click()},children:e.jsxs(ue,{children:[e.jsx(Be,{}),e.jsx("div",{children:"음성 전화"})]})})})})]})}),e.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ye[D],onChange:q,value:j,autoFocus:!0}),e.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:_e[D]})]})}const De=({initiateContinuing:c,user:t,userObj:r,handleMessagesList:j,displayedName:C,handleChatUid:A,handleChatDisplayName:E})=>{const{state:b}=Pe(),y=(b==null?void 0:b.conversation)||"piazza",d=ee(M=>M.languages.value),[$,w]=a.useState("");return a.useEffect(()=>{t&&((t==null?void 0:t.uid)<r.uid?w((t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])+r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]):w(r.uid[0]+r.uid[1]+r.uid[2]+r.uid[3]+r.uid[4]+r.uid[5]+(t==null?void 0:t.uid[0])+(t==null?void 0:t.uid[1])+(t==null?void 0:t.uid[2])+(t==null?void 0:t.uid[3])+(t==null?void 0:t.uid[4])+(t==null?void 0:t.uid[5])))},[t]),e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col items-center pt-5",children:[e.jsx(me,{element:t,uid:r.uid,profile:!0,profileColor:"",profileUrl:t==null?void 0:t.profileImageUrl,fallback:"",piazza:null}),e.jsx("div",{children:t==null?void 0:t.displayName}),(t==null?void 0:t.displayName)!==C&&e.jsx("div",{children:d==="ko"?e.jsxs("div",{children:["(",C,"에서 개명)"]}):e.jsxs("div",{children:["(Changed name from ",C,")"]})})]}),e.jsxs("div",{className:"flex justify-center p-5",children:[e.jsx(we,{to:`/profile?id=${t==null?void 0:t.uid}`,state:{element:t},children:e.jsx(J,{variant:"outlined",onClick:()=>{},children:d==="ko"?"프로필 확인":"Check Profile"})}),y==="piazza"&&r.uid!==(t==null?void 0:t.uid)&&e.jsx(we,{to:`${location.pathname}?id=${$}`,state:{conversation:$,displayName:t==null?void 0:t.displayName,userUid:r.uid,chattingUid:t==null?void 0:t.uid,multiple:!1,profileUrl:t==null?void 0:t.profileImageUrl},children:e.jsx(ue,{children:e.jsx(J,{variant:"outlined",onClick:()=>{j([]),c()},children:d==="ko"?"개인 대화":"Private messaging"})})})]})]})};function Ie({userObj:c,messagesList:t,handleMessagesList:r,handleChatUid:j,handleChatDisplayName:C}){const A=a.useRef(null),E=a.useRef(null),[b,y]=a.useState(null),[d,$]=a.useState(""),[w,M]=a.useState(!1),[D,T]=a.useState(null),[q,B]=a.useState(0),[x,F]=a.useState("piazza"),i=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";a.useEffect(()=>{(x!==i||i==="piazza")&&(r([]),T(null),B(0),F(i))},[i]);const I=ee(n=>n.languages.value),P=async({userUid:n,displayName:h})=>{const p=Y(V,`members/${n}`),u=(await _(p)).data();y(u),$(h),console.log("practice")},m=({userUid:n,displayName:h})=>{var p;(p=document.getElementById("drawer"))==null||p.click(),P({userUid:n,displayName:h})},S=20;a.useEffect(()=>{if(!g)return;function n(h){const{msg:p,userUid:k,id:u,target:v,messageClock:f,messageClockNumber:o,profileImageUrl:s,defaultProfile:l,profileImage:z,conversation:R}=h;r(L=>[...L,{msg:p,type:v?"private":"other",userUid:k,id:u,messageClock:f,messageClockNumber:o,conversation:null,profileImageUrl:s,defaultProfile:l,profileImage:z}])}return g.on("sMessagePiazza",n),()=>{g.off("sMessagePiazza",n)}},[]),a.useEffect(()=>{if(!g)return;function n(h){const{msg:p,userUid:k,id:u,target:v,messageClock:f,messageClockNumber:o,conversation:s,profileImageUrl:l,defaultProfile:z,profileImage:R,piazzaData:L}=h;r(O=>[...O,{msg:p,type:v?"private":"other",userUid:k,id:u,messageClock:f,messageClockNumber:o,conversation:null,profileImageUrl:l,defaultProfile:z,profileImage:R,...L}])}return g.on(`sMessage${i}`,n),()=>{g.off(`sMessage${i}`,n)}},[i]),a.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),a.useEffect(()=>{N(),(async()=>{if(i==="piazza"){const h=te(V,"chats_group"),p=le(h,de("messageClockNumber","desc"),re(1));(await fe(p)).forEach(async u=>{const v=Y(V,`chats_group/${u.id}`),o=(await _(v)).data(),s=o.piazzaChecked||[];s.indexOf(c.uid)===-1&&(s.splice(-1,c.uid,0),s.push(c.uid),await X(v,{...o,piazzaChecked:s}))})}else{const h=Y(V,`members/${c.uid}`),k=(await _(h)).data().chattings;k[i]&&(k[i].messageCount=0),await X(h,{chattings:k})}})()},[t]);const N=()=>{var n;(n=A.current)==null||n.scrollIntoView()};a.useEffect(()=>{const n=async()=>{const p=[],k=te(V,"chats_group"),u=le(k,de("messageClockNumber","desc"),re(S),ke(D||"")),v=await fe(u);v.docs.length||B(v.docs.length),v.forEach(f=>{var Z,H,K;p.length===v.docs.length-1&&(T(f),B(v.docs.length-1));const o=f.data().message,s=f.data().userUid,l=f.data().userName,z=f.data().messageClock,R=f.data().messageClockNumber,L=(Z=f.data())==null?void 0:Z.profileImageUrl,O=(H=f.data())==null?void 0:H.defaultProfile,W=(K=f.data())==null?void 0:K.profileImage,G=f.data();p.push({msg:o,userUid:s,id:l,messageClockNumber:R,messageClock:z,conversation:null,profileImageUrl:L,defaultProfile:O,profileImage:W||!1,...G})}),p.reverse(),r([...p,...t]),M(!1)},h=async p=>{const k=te(V,`chats_${p}`),u=le(k,de("messageClockNumber","desc"),re(S),ke(D||"")),v=await fe(u),f=[];v.docs.length||B(v.docs.length),v.forEach((o,s)=>{var ce,Q,ae;f.length===v.docs.length-1&&(T(o),B(v.docs.length-1));const l=o.data().message,z=o.data().userUid,R=o.data().userName,L=o.data().messageClock,O=o.data().messageClockNumber||0,W=(ce=o.data())==null?void 0:ce.profileImageUrl,G=(Q=o.data())==null?void 0:Q.defaultProfile,Z=(ae=o.data())==null?void 0:ae.profileImage,H=o.data(),K=o.data().userOne,se=o.data().userOneDisplayName,oe=o.data().userTwo,ne=o.data().userTwoDisplayName;K!==c.uid?(j(K),C(se)):(j(oe),C(ne)),f.push({msg:l,userUid:z,id:R,messageClockNumber:O,messageClock:L,conversation:null,profileImageUrl:W,defaultProfile:G,profileImage:Z||!1,...H})}),f.reverse(),r([...f,...t]),M(!1)};console.log(t.length),i==="piazza"?(w||!t.length)&&n():(w||!t.length)&&h(i)},[w,x]);const U=()=>{E.current.scrollTop!==0||w||(console.log("scroll"),M(!0))};return a.useEffect(()=>{var n;return(n=E.current)==null||n.addEventListener("scroll",U),()=>{var h;return(h=E.current)==null?void 0:h.removeEventListener("scroll",U)}},[w]),console.log(i),console.log(t),console.log(b),e.jsx(e.Fragment,{children:e.jsx("div",{ref:E,className:"p-1 border-t rounded-xl overflow-auto",children:e.jsxs("ul",{children:[w&&e.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),t.map((n,h)=>{let p;i==="piazza"?p=n:n.userUid===n.userOne?p={userUid:n.userOne,id:n.userOneDisplayName,profileImage:n.userOneProfileImage||n.profileImage,defaultProfile:n.userOneDefaultProfile||n.defaultProfile,profileImageUrl:n.userOneProfileUrl||n.profileImageUrl}:p={userUid:n.userTwo,id:n.userTwoDisplayName,profileImage:n.userTwoProfileImage||n.profileImage,defaultProfile:n.userTwoDefaultProfile||n.defaultProfile,profileImageUrl:n.userTwoProfileUrl||n.profileImageUrl};let k;const u=new Date(n.messageClock);n.userUid===c.uid?k="text-right":k="text-left";let v,f;h>0&&(v=t[h-1].userUid),h<t.length-1&&t[h+1].userUid===c.uid&&(f=new Date(t[h+1].messageClock),u.getFullYear()===f.getFullYear()&&u.getMonth()===f.getMonth()&&u.getDate()===f.getDate()&&u.getHours()===f.getHours()&&(u.getMinutes(),f.getMinutes()));let o,s=u.getHours(),l=(u.getMonth()+1).toString(),z=u.getDate().toString();return s>=13?(o="오후",s!==12&&(s=s-12)):(o="오전",s===0&&(s=s+12)),u.getMonth()+1<10&&(l="0"+l),z.length===1&&(z="0"+z),e.jsxs("li",{ref:h===q?A:null,className:k,children:[v!==n.userUid&&e.jsx("div",{children:e.jsx("div",{className:`flex justify-${n.userUid!==c.uid?"start":"end"}`,children:k==="text-left"?e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx(ge,{trigger:e.jsx(me,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>T(null),user:b,userObj:c,handleMessagesList:r,displayedName:d})}),e.jsx("div",{children:n.id})]}):e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsx("div",{children:n.id}),e.jsx(ge,{trigger:e.jsx(me,{element:p,piazza:()=>m({userUid:p.userUid,displayName:p.id}),profile:!1}),title:e.jsx(ye,{}),content:e.jsx(De,{initiateContinuing:()=>T(null),user:b,userObj:c,handleMessagesList:r,displayedName:d,handleChatUid:j,handleChatDisplayName:C})})]})})}),n.userUid!==c.uid?e.jsxs("div",{className:"flex gap-3 justify-start",children:[e.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg}),e.jsxs("div",{children:[u.getFullYear(),"-",l,"-",z," ",I==="ko"&&o," ",s,":",u.getMinutes()<10&&"0",u.getMinutes(),I==="en"&&(o==="오전"?"am":"pm")]})]}):e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsxs("div",{children:[u.getFullYear(),"-",l,"-",z," ",I==="ko"&&o," ",s,":",u.getMinutes()<10&&"0",u.getMinutes(),I==="en"&&(o==="오전"?"am":"pm")]}),e.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:n.msg})]})]},h)}),e.jsx("li",{ref:A})]})})})}function Ke({isKeyboardOpen:c,userObj:t,messagesList:r,handleMessagesList:j,handleChatUid:C,handleChatDisplayName:A}){return e.jsx(e.Fragment,{children:c?e.jsx("div",{className:"fixed bottom-[50px] w-screen h-full bg-light-3 dark:bg-dark-3 flex flex-col pt-[120px]",children:e.jsx(Ie,{userObj:t,messagesList:r,handleMessagesList:j,handleChatUid:C,handleChatDisplayName:A})}):e.jsx("div",{className:"fixed bottom-[110px] w-screen h-[60%] bg-light-3 dark:bg-dark-3 flex flex-col",children:e.jsx(Ie,{userObj:t,messagesList:r,handleMessagesList:j,handleChatUid:C,handleChatDisplayName:A})})})}const Ze=$e(Ve)(({theme:c})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(c.palette.getContrastText(c.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function qe(){const c=ee(C=>C.languages.value),t=ie(C=>C.piazzaSwitch.value),r=pe(),j=()=>{t==="true"?(window.localStorage.setItem("piazza","false"),r(Ce("false"))):(window.localStorage.setItem("piazza","true"),r(Ce("true")))};return e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm",children:c==="ko"?"단체 대화 메세지에 추가":"Group Message in My Messages"}),e.jsx("div",{className:"flex justify-end",children:e.jsx(Ze,{onClick:()=>j(),inputProps:{"aria-label":"ant design"},checked:t==="true"})})]})}const be={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},We=({displayName:c})=>{const t=ee(C=>C.languages.value),r=t==="ko"||t==="en"?t:"ko",j=location.search?location.search.slice(location.search.indexOf("=")+1):"piazza";return e.jsxs("div",{className:"flex w-screen justify-between",children:[e.jsx(Ae,{icon:e.jsx(Fe,{}),title:j==="piazza"?be[r][0]:`${be[r][1]} ${c}`}),j==="piazza"&&e.jsx("div",{className:"flex w-1/2 justify-end px-5 pt-5",children:e.jsx(qe,{})})]})};function Ge(){const[c,t]=a.useState([]),[r,j]=a.useState(!0),[C,A]=a.useState(!0),[E,b]=a.useState(""),[y,d]=a.useState(null),[$,w]=a.useState(null),M=Ue(),D=a.useRef(null),T=a.useRef(null),q={audio:!0,video:!1},B=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],x=new RTCPeerConnection({iceServers:[{urls:B.map(o=>o.urls)}]}),F=location.search.slice(4);console.log(location.search.slice(4)),a.useEffect(()=>{(async()=>{await m()})()},[]),a.useEffect(()=>{D.current&&(D.current.srcObject=y)},[y]);async function i(){const o=y;o&&o.getAudioTracks().forEach(s=>s.enabled=!s.enabled),j(!r)}async function I(){const o=y;o&&o.getVideoTracks().forEach(s=>s.enabled=!s.enabled),A(!C)}const P=()=>{D.current.srcObject.getTracks().forEach(o=>o.stop()),console.log(D.current)};a.useEffect(()=>{$&&S($)},[$]);async function m(){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(l=>l.kind==="videoinput");t(s)}catch(o){console.log(o)}}async function S(o){try{const l=o?{audio:!0,video:{deviceId:{exact:o}}}:q,z=await navigator.mediaDevices.getUserMedia(l);d(z),b("")}catch(s){const l=s==null?void 0:s.toString();l&&b(l),console.log(s)}}function N(o){console.log("icecandidate"),console.log(o),g.emit("ice",o.candidate,F)}function U(o){console.log("got a stream from peer"),console.log("Peer Stream",o.stream),console.log("My Stream",y),T.current=o.stream}function n(){x.addEventListener("icecandidate",N),x.addEventListener("addstream",U),y&&y.getTracks().forEach(o=>x.addTrack(o,y))}async function h(){await S(null),n()}async function p(){await h(),g.emit("joinRoom",F,h)}a.useEffect(()=>{p()},[]);const k=async()=>{console.log("sent the offer"),console.log(x);const o=await x.createOffer();x.setLocalDescription(o),console.log(o),g.emit("offer",o,F)};a.useEffect(()=>{if(g)return g.on("welcome",k),()=>{g.off("welcome",k)}});const u=async o=>{console.log("received the offer"),x.setRemoteDescription(o);const s=await x.createAnswer();console.log("sent the answer"),x.setLocalDescription(s),g.emit("answer",s,F)};a.useEffect(()=>{if(g)return g.on("offer",u),()=>{g.off("offer",u)}});const v=o=>{console.log("received the answer"),x.setRemoteDescription(o)};a.useEffect(()=>{if(g)return g.on("answer",v),()=>{g.off("answer",v)}});const f=o=>{console.log("received candidate"),x.addIceCandidate(o)};return a.useEffect(()=>{if(g)return g.on("ice",f),()=>{g.off("ice",f)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!M&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:T,controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:D,controls:!0,autoPlay:!0,muted:!0})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx(J,{onClick:i,children:r?"unmute":"mute"}),e.jsx(J,{onClick:I,children:C?"turn stream on":"turn stream off"}),e.jsx(J,{onClick:P,children:"stop"})]})}),E&&e.jsx("div",{children:E})]})}function Je(){const[c,t]=a.useState([]),[r,j]=a.useState(!0),[C,A]=a.useState(!0),[E,b]=a.useState(""),[y,d]=a.useState(null),[$,w]=a.useState(null),M=Ue(),D=a.useRef(null),T=a.useRef(null),q={audio:!0,video:!0},B=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.l.google.com:5349"},{urls:"stun:stun1.l.google.com:3478"},{urls:"stun:stun1.l.google.com:5349"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun2.l.google.com:5349"},{urls:"stun:stun3.l.google.com:3478"},{urls:"stun:stun3.l.google.com:5349"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun4.l.google.com:5349"}],x=new RTCPeerConnection({iceServers:[{urls:B.map(s=>s.urls)}]}),F=location.search.slice(4);console.log(location.search.slice(4)),a.useEffect(()=>{(async()=>{await S()})()},[]),a.useEffect(()=>{D.current&&(D.current.srcObject=y)},[y]);async function i(){const s=y;s&&s.getAudioTracks().forEach(l=>l.enabled=!l.enabled),j(!r)}async function I(){const s=y;s&&s.getVideoTracks().forEach(l=>l.enabled=!l.enabled),A(!C)}const P=()=>{D.current.srcObject.getTracks().forEach(s=>s.stop()),console.log(D.current)};async function m(s){if(D.current.srcObject.getTracks().forEach(l=>l.stop()),w(s.target.value),x){console.log(x.getSenders());const l=y.getVideoTracks()[0];x.getSenders().find(R=>R.track.kind==="video").replaceTrack(l)}}a.useEffect(()=>{$&&N($)},[$]);async function S(){try{const l=(await navigator.mediaDevices.enumerateDevices()).filter(z=>z.kind==="videoinput");t(l)}catch(s){console.log(s)}}async function N(s){try{const z=s?{audio:!0,video:{deviceId:{exact:s}}}:q,R=await navigator.mediaDevices.getUserMedia(z);d(R),b("")}catch(l){const z=l==null?void 0:l.toString();z&&b(z),console.log(l)}}function U(s){console.log("icecandidate"),console.log(s),g.emit("ice",s.candidate,F)}function n(s){console.log("got a stream from peer"),console.log("Peer Stream",s.stream),console.log("My Stream",y),T.current=s.stream}function h(){x.addEventListener("icecandidate",U),x.addEventListener("addstream",n),y&&y.getTracks().forEach(s=>x.addTrack(s,y))}async function p(){await N(null),h()}async function k(){await p(),g.emit("joinRoom",F,p)}a.useEffect(()=>{k()},[]);const u=async()=>{console.log("sent the offer"),console.log(x);const s=await x.createOffer();x.setLocalDescription(s),console.log(s),g.emit("offer",s,F)};a.useEffect(()=>{if(g)return g.on("welcome",u),()=>{g.off("welcome",u)}});const v=async s=>{console.log("received the offer"),x.setRemoteDescription(s);const l=await x.createAnswer();console.log("sent the answer"),x.setLocalDescription(l),g.emit("answer",l,F)};a.useEffect(()=>{if(g)return g.on("offer",v),()=>{g.off("offer",v)}});const f=s=>{console.log("received the answer"),x.setRemoteDescription(s)};a.useEffect(()=>{if(g)return g.on("answer",f),()=>{g.off("answer",f)}});const o=s=>{console.log("received candidate"),x.addIceCandidate(s)};return a.useEffect(()=>{if(g)return g.on("ice",o),()=>{g.off("ice",o)}}),e.jsxs("div",{children:[e.jsxs("div",{className:`flex ${!M&&"flex-col"} gap-1`,children:[e.jsx("video",{ref:T,width:"320",height:"240",controls:!0,autoPlay:!0}),e.jsx("video",{id:"myScreen",ref:D,width:"320",height:"240",controls:!0,autoPlay:!0,muted:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-5",children:[e.jsx(J,{onClick:i,children:r?"unmute":"mute"}),e.jsx(J,{onClick:I,children:C?"turn stream on":"turn stream off"}),e.jsx(J,{onClick:P,children:"stop"})]}),e.jsx("select",{id:"devices",onChange:m,children:c.map((s,l)=>e.jsx("option",{value:s.deviceId,selected:(y==null?void 0:y.getVideoTracks()[0].id)===s.deviceId,children:s.label},l))})]}),E&&e.jsx("div",{children:E})]})}function Xe({userObj:c}){const[t,r]=a.useState(""),[j,C]=a.useState([]),A=pe(),{state:E}=Pe(),[b,y]=a.useState(!1),[d,$]=a.useState(null),[w,M]=a.useState(""),[D,T]=a.useState(""),[q,B]=a.useState(""),x=m=>{M(m)},F=m=>{T(m)},i=location.search.slice(location.search.indexOf("=")+1);console.log(d),console.log(w),a.useEffect(()=>{E?(M(E.chattingUid),T(E.displayName)):(M(""),T(""))},[i]),a.useEffect(()=>{i&&(async()=>{if(w){const S=Y(V,`members/${w}`),N=await _(S);$(N.data())}})()},[i,w]);const I=ie(m=>m.piazzaForm.value);a.useEffect(()=>{var S;const m=()=>{var U;const N=window.screen.height-300>(((U=window.visualViewport)==null?void 0:U.height)||window.screen.height);b!==N&&y(N)};return window.addEventListener("resize",m),typeof visualViewport<"u"&&((S=window.visualViewport)==null||S.addEventListener("resize",m)),visualViewport==null||visualViewport.addEventListener("resize",m),typeof visualViewport<"u"&&(visualViewport==null||visualViewport.addEventListener("resize",m)),()=>{var N;typeof visualViewport<"u"&&((N=window.visualViewport)==null||N.removeEventListener("resize",m))}},[b]);const P=()=>{var m;B(""),(m=document.getElementById("myScreen"))==null||m.srcObject.getTracks().forEach(S=>S.stop())};return a.useEffect(()=>{A(Le(5))}),e.jsxs(e.Fragment,{children:[!b&&e.jsx(We,{multiple:!i,displayName:D}),e.jsx(Ke,{isKeyboardOpen:I,userObj:c,messagesList:j,handleMessagesList:m=>C(m),handleChatUid:x,handleChatDisplayName:F}),e.jsx(Oe,{chattingUser:d,userObj:c,multiple:!i,messages:t,handleMessages:m=>r(m),messagesList:j,handleMessagesList:m=>C(m)}),e.jsxs(ze,{children:[e.jsx(Se,{children:e.jsx("div",{id:"videoCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Je,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]}),e.jsxs(ze,{children:[e.jsx(Se,{children:e.jsx("div",{id:"audioCall"})}),e.jsx(je,{children:e.jsxs("div",{children:[e.jsx("div",{className:"flex gap-5",children:e.jsx(Ge,{})}),e.jsx(Ne,{children:e.jsx("div",{onClick:P,children:"전화 종료"})})]})})]})]})}export{Xe as default};
