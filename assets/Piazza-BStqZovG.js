import{r as p,u as q,K as se,aE as ae,c as G,j as t,k as I,g as N,V as R,S as P,aJ as oe,f as K,v as _,aL as he,I as te,O as le,B as ce,as as ue,P as re,aM as de,q as W,U as X,E as O,h as ee,aH as ge,ad as we,aN as xe,Q as me,w as ve,a5 as ye}from"./index-CGLVuUHK.js";const ke=(a=300,U)=>{const[h,e]=p.useState(!1);return p.useEffect(()=>{var S;const i=()=>{var x;const g=window.screen.height-a>(((x=window.visualViewport)==null?void 0:x.height)||window.screen.height);h!==g&&e(g)};return typeof visualViewport<"u"&&((S=window.visualViewport)==null||S.addEventListener("resize",i)),()=>{var g;typeof visualViewport<"u"&&((g=window.visualViewport)==null||g.removeEventListener("resize",i))}},[]),h},Ce={ko:"메세지를 작성해 주세요",en:"Input message"},Ue={ko:"전송",en:"send"};function Ne({userObj:a,multiple:U,messages:h,handleMessages:e,messagesList:i,handleMessagesList:S}){const g=q(f=>f.profileColor.value),x=q(f=>f.profileUrl.value),$=se(),{state:r}=ae(),y=r==null?void 0:r.conversation,w=G(f=>f.languages.value),F=w==="ko"||w==="en"?w:"ko",H=async f=>{var l;f.preventDefault();const z=h,k=a.uid,D=a.displayName,M=Date.now(),b=new Date().toString();let T,j,E;r.chattingUid&&(T=I(N,`members/${r.chattingUid}`),j=await R(T),E=(l=j.data())==null?void 0:l.messagingToken);const s={msg:z,userUid:k,id:D,messageClockNumber:M,messageClock:b,conversation:y,conversationUid:r.chattingUid,conversationName:r.displayName,profileUrl:x,sendingToken:E};U?s&&z&&(P.emit("piazzaMessage",s),J()):z&&(i.length!==0?(P.emit("message",s),console.log("message")):(P.emit("messageNew",s),console.log("messageNew")),L(),Q()),e("")},B=f=>{e(f.target.value)},J=async()=>{try{const f=h,z=a.uid,k=a.displayName,D=new Date().toString(),M=Date.now();f&&(await oe(K(N,"chats_group"),{userUid:z,userName:k,message:f,messageClock:D,messageClockNumber:M,profileImageUrl:x,profileColor:g,piazzaChecked:[a.uid]}),S(b=>[...b,{msg:f,type:"me",userUid:a.uid,id:a.displayName,messageClock:D,conversation:null,profileImageUrl:x,profileColor:g}]))}catch(f){console.log(f)}},L=async()=>{var z,k,D;const f=h;try{const M=a.uid,b=a.displayName,T=Date.now(),j=new Date().toString();let E,s,l,m,n,u;if(r.userUid<r.chattingUid?(E=r.userUid,s=r.chattingUid,l=a.displayName,m=r.displayName,n=x,u=r.profileUrl):(E=r.chattingUid,s=r.userUid,l=r.displayName,m=a.displayName,n=r.profileUrl,u=x),!n){const o=I(N,`members/${E}`);n=(z=(await R(o)).data())==null?void 0:z.profileImageUrl}if(!u){const o=I(N,`members/${s}`);u=(k=(await R(o)).data())==null?void 0:k.profileImageUrl}if(f){const o={userUid:M,userName:b,message:f,messageClock:j,messageClockNumber:T,userOne:E,userTwo:s,userOneDisplayName:l,userTwoDisplayName:m,userOneProfileUrl:n,userTwoProfileUrl:u};await oe(K(N,`chats_${y}`),o);const c=I(N,`members/${M}`),v=(await R(c)).data().chattings||{},C=I(N,`members/${r.chattingUid}`),V=(await R(C)).data().chattings||{},A=((D=V[y])==null?void 0:D.messageCount)||0;v[y]=o,V[y]={...o,messageCount:A+1},await _(c,{chattings:v}),await _(C,{chattings:V}),S(Y=>[...Y,{msg:f,type:"me",userUid:a.uid,id:a.displayName,messageClock:j,conversation:y}])}}catch(M){console.log(M)}},Q=async()=>{try{const f=a.uid,z=r.chattingUid,k=I(N,`members/${f}`),M=(await R(k)).data().conversation||[],b=I(N,`members/${z}`),j=(await R(b)).data().conversation||[];M.indexOf(y)===-1&&(await _(k,{conversation:[...M,y]}),$(he())),j.indexOf(y)===-1&&await _(b,{conversation:[...j,y]})}catch(f){console.log(f)}};return t.jsx(t.Fragment,{children:t.jsxs("form",{className:"fixed w-screen bottom-[60px] flex gap-px",onSubmit:H,children:[t.jsx("input",{className:"w-full p-3 rounded bg-light-1 dark:bg-dark-1",placeholder:Ce[F],onChange:B,value:h,autoFocus:!0}),t.jsx("button",{className:"w-1/6 rounded bg-light-2 dark:bg-dark-2",type:"submit",children:Ue[F]})]})})}const fe=({initiateContinuing:a,multiple:U,handleMultiple:h,user:e,userObj:i,handleMessagesList:S,displayedName:g})=>{const[x,$]=p.useState(null),r=G(y=>y.languages.value);return p.useEffect(()=>{e&&((e==null?void 0:e.uid)<i.uid?$((e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])+i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]):$(i.uid[0]+i.uid[1]+i.uid[2]+i.uid[3]+i.uid[4]+i.uid[5]+(e==null?void 0:e.uid[0])+(e==null?void 0:e.uid[1])+(e==null?void 0:e.uid[2])+(e==null?void 0:e.uid[3])+(e==null?void 0:e.uid[4])+(e==null?void 0:e.uid[5])))},[e]),t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col items-center pt-5",children:[t.jsx(te,{uid:i.uid,profile:!0,profileColor:"",profileUrl:e==null?void 0:e.profileImageUrl,fallback:"",piazza:null}),t.jsx("div",{children:e==null?void 0:e.displayName}),(e==null?void 0:e.displayName)!==g&&t.jsx("div",{children:r==="ko"?t.jsxs("div",{children:["(",g,"에서 개명)"]}):t.jsxs("div",{children:["(Changed name from ",g,")"]})})]}),t.jsxs("div",{className:"flex justify-center p-5",children:[t.jsx(le,{to:"/profile",state:{element:e},children:t.jsx(ce,{variant:"outlined",onClick:()=>{},children:r==="ko"?"프로필 확인":"Check Profile"})}),U&&i.uid!==(e==null?void 0:e.uid)&&t.jsx(le,{to:"/piazza",state:{conversation:x,displayName:e==null?void 0:e.displayName,userUid:i.uid,chattingUid:e==null?void 0:e.uid,multiple:!1,profileUrl:e==null?void 0:e.profileImageUrl},children:t.jsx(ue,{children:t.jsx(ce,{variant:"outlined",onClick:()=>{S([]),h(!1),a()},children:r==="ko"?"개인 대화":"Private messaging"})})})]})]})};function ze({userObj:a,multiple:U,handleMultiple:h,messagesList:e,handleMessagesList:i}){const S=p.useRef(null),g=p.useRef(null),[x,$]=p.useState(null),[r,y]=p.useState(""),[w,F]=p.useState(!1),[H,B]=p.useState(null),[J,L]=p.useState(0),Q=q(s=>s.profileColor.value),f=q(s=>s.profileUrl.value),{state:z}=ae(),k=z==null?void 0:z.conversation,D=G(s=>s.languages.value),M=async({userUid:s,displayName:l})=>{const m=I(N,`members/${s}`),u=(await R(m)).data();$(u),y(l)},b=({userUid:s,displayName:l})=>{var m;(m=document.getElementById("drawer"))==null||m.click(),M({userUid:s,displayName:l})},T=20;p.useEffect(()=>{if(!P)return;function s(l){const{msg:m,userUid:n,id:u,target:o,messageClock:c,messageClockNumber:d,conversation:v}=l;i(C=>[...C,{msg:m,type:o?"private":"other",userUid:n,id:u,messageClock:c,messageClockNumber:d,conversation:null,profileImageUrl:f,profileColor:Q}])}return P.on("sMessagePiazza",s),()=>{P.off("sMessagePiazza",s)}},[]),p.useEffect(()=>{if(!P)return;function s(l){const{msg:m,userUid:n,id:u,target:o,messageClock:c,messageClockNumber:d,conversation:v}=l;i(C=>[...C,{msg:m,type:o?"private":"other",userUid:n,id:u,messageClock:c,messageClockNumber:d,conversation:null}])}return P.on(`sMessage${k}`,s),()=>{P.off(`sMessage${k}`,s)}},[]),p.useEffect(()=>{document.documentElement.scrollTo({top:0,left:0,behavior:"instant"})},[]),p.useEffect(()=>{j(),(async()=>{if(U){const l=K(N,"chats_group"),m=W(l,O("messageClockNumber","desc"),X(1));(await ee(m)).forEach(async u=>{const o=I(N,`chats_group/${u.id}`),d=(await R(o)).data(),v=d.piazzaChecked||[];v.indexOf(a.uid)===-1&&(v.splice(-1,a.uid,0),v.push(a.uid),await _(o,{...d,piazzaChecked:v}))})}else{const l=I(N,`members/${a.uid}`),n=(await R(l)).data().chattings;n[k].messageCount=0,await _(l,{chattings:n})}})()},[e]);const j=()=>{var s;(s=S.current)==null||s.scrollIntoView()};p.useEffect(()=>{const s=async()=>{const m=[],n=K(N,"chats_group"),u=W(n,O("messageClockNumber","desc"),X(T),ge(H||"")),o=await ee(u);o.docs.length||L(o.docs.length),o.forEach(c=>{var ie,ne;m.length===o.docs.length-1&&(B(c),L(o.docs.length-1));const d=c.data().message,v=c.data().userUid,C=c.data().userName,Z=c.data().messageClock,V=c.data().messageClockNumber,A=(ie=c.data())==null?void 0:ie.profileColor,Y=(ne=c.data())==null?void 0:ne.profileImageUrl;m.push({msg:d,type:"me",userUid:v,id:C,messageClockNumber:V,messageClock:Z,conversation:null,profileColor:A,profileImageUrl:Y})}),m.reverse(),i([...m,...e]),F(!1)},l=async m=>{const n=K(N,`chats_${m}`),u=W(n,O("messageClockNumber","desc"),X(T),ge(H||"")),o=await ee(u),c=[];o.docs.length||L(o.docs.length),o.forEach((d,v)=>{c.length===o.docs.length-1&&(B(d),L(o.docs.length-1));const C=d.data().message,Z=d.data().userUid,V=d.data().userName,A=d.data().messageClock,Y=d.data().messageClockNumber||0;c.push({msg:C,type:"me",userUid:Z,id:V,messageClock:A,messageClockNumber:Y})}),c.reverse(),i([...c,...e]),F(!1)};k?(w||!e.length)&&l(k):(w||!e.length)&&s()},[w,k]);const E=()=>{g.current.scrollTop!==0||w||(console.log("scroll"),F(!0))};return p.useEffect(()=>{var s;return(s=g.current)==null||s.addEventListener("scroll",E),()=>{var l;return(l=g.current)==null?void 0:l.removeEventListener("scroll",E)}},[w]),t.jsx(t.Fragment,{children:t.jsx("div",{className:"fixed bottom-[110px] w-screen flex flex-col pt-5",children:t.jsx("div",{ref:g,className:"p-1 border-t rounded-xl h-[50vh] overflow-auto",children:t.jsxs("ul",{children:[w&&t.jsx("div",{className:"flex justify-center bg-light-2 dark:bg-dark-2 rounded",children:"로딩"}),e.map((s,l)=>{let m;const n=new Date(s.messageClock);s.userUid===a.uid?m="text-right":m="text-left";let u,o;l>0&&(u=e[l-1].userUid),l<e.length-1&&e[l+1].userUid===a.uid&&(o=new Date(e[l+1].messageClock),n.getFullYear()===o.getFullYear()&&n.getMonth()===o.getMonth()&&n.getDate()===o.getDate()&&n.getHours()===o.getHours()&&(n.getMinutes(),o.getMinutes()));let c,d=n.getHours(),v=(n.getMonth()+1).toString(),C=n.getDate().toString();return d>=13?(c="오후",d!==12&&(d=d-12)):(c="오전",d===0&&(d=d+12)),n.getMonth()+1<10&&(v="0"+v),C.length===1&&(C="0"+C),t.jsxs("li",{ref:l===J?S:null,className:m,children:[u!==s.userUid&&t.jsx("div",{children:t.jsx("div",{className:`flex justify-${s.userUid!==a.uid?"start":"end"}`,children:m==="text-left"?t.jsxs("div",{className:"flex gap-3",children:[t.jsx(re,{trigger:t.jsx(te,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>b({userUid:s.userUid,displayName:s.id})}),title:t.jsx(de,{}),content:t.jsx(fe,{initiateContinuing:()=>B(null),multiple:U,handleMultiple:h,user:x,userObj:a,handleMessagesList:i,displayedName:r})}),t.jsx("div",{children:s.id})]}):t.jsxs("div",{className:"flex gap-3",children:[t.jsx("div",{children:s.id}),t.jsx(re,{trigger:t.jsx(te,{uid:a.uid,profile:!1,profileColor:"",profileUrl:s==null?void 0:s.profileImageUrl,piazza:()=>b({userUid:s.userUid,displayName:s.id})}),title:t.jsx(de,{}),content:t.jsx(fe,{initiateContinuing:()=>B(null),multiple:U,handleMultiple:h,user:x,userObj:a,handleMessagesList:i,displayedName:r})})]})})}),s.userUid!==a.uid?t.jsxs("div",{className:"flex gap-3 justify-start",children:[t.jsx("div",{className:"other rounded-tr-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg}),t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",C," ",D==="ko"&&c," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),D==="en"&&(c==="오전"?"am":"pm")]})]}):t.jsxs("div",{className:"flex gap-3 justify-end",children:[t.jsxs("div",{children:[n.getFullYear(),"-",v,"-",C," ",D==="ko"&&c," ",d,":",n.getMinutes()<10&&"0",n.getMinutes(),D==="en"&&(c==="오전"?"am":"pm")]}),t.jsx("div",{className:"me rounded-tl-lg rounded-bl-lg rounded-br-lg p-1 bg-light-1 dark:bg-dark-1",children:s.msg})]})]},l)}),t.jsx("li",{ref:S})]})})})})}const Se=we(xe)(({theme:a})=>({padding:8,"& .MuiSwitch-track":{borderRadius:22/2,"&::before, &::after":{content:'""',position:"absolute",top:"50%",transform:"translateY(-50%)",width:16,height:16},"&::before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>')`,left:12},"&::after":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 24 24"><path fill="${encodeURIComponent(a.palette.getContrastText(a.palette.primary.main))}" d="M19,13H5V11H19V13Z" /></svg>')`,right:12}},"& .MuiSwitch-thumb":{boxShadow:"none",width:16,height:16,margin:2}}));function De(){const a=G(i=>i.languages.value),U=q(i=>i.piazzaSwitch.value),h=se(),e=()=>{U==="true"?(window.localStorage.setItem("piazza","false"),h(me("false"))):(window.localStorage.setItem("piazza","true"),h(me("true")))};return t.jsxs("div",{className:"flex flex-col",children:[t.jsx("div",{className:"text-sm",children:a==="ko"?"단체 대화 알림 받기":"Receive Group Messaging notice"}),t.jsx("div",{className:"flex justify-end",children:t.jsx(Se,{onClick:()=>e(),inputProps:{"aria-label":"ant design"},checked:U==="true"})})]})}const pe={ko:["단체 대화","개인 대화"],en:["Group Messaging","Messaging"]},Me=({multiple:a,displayName:U})=>{const h=G(i=>i.languages.value),e=h==="ko"||h==="en"?h:"ko";return t.jsxs("div",{className:"flex w-screen justify-between",children:[t.jsx(ve,{title:a?pe[e][0]:`${pe[e][1]} ${U}`}),a&&t.jsx("div",{className:"flex w-2/3 justify-end px-5 pt-5",children:t.jsx(De,{})})]})};function je({userObj:a}){const[U,h]=p.useState(""),[e,i]=p.useState([]),S=se(),{state:g}=ae(),[x,$]=p.useState(!0),r=ke();console.log(r),p.useEffect(()=>{(g==null?void 0:g.multiple)!==void 0&&$(g==null?void 0:g.multiple)},[]),window.addEventListener("resize",()=>{window.visualViewport&&console.log(window.visualViewport.height)}),p.useEffect(()=>{S(ye(5))});const y=g==null?void 0:g.displayName;return t.jsxs(t.Fragment,{children:[t.jsx(Me,{multiple:x,displayName:y}),r?t.jsx("div",{children:"open"}):t.jsx("div",{children:"closed"}),t.jsx(ze,{userObj:a,multiple:x,handleMultiple:w=>$(w),messagesList:e,handleMessagesList:w=>i(w)}),t.jsx(Ne,{userObj:a,multiple:x,messages:U,handleMessages:w=>h(w),messagesList:e,handleMessagesList:w=>i(w)})]})}export{je as default};
